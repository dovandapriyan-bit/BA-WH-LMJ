<!DOCTYPE html>
<html lang="id">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Sistem Berita Acara</title>

    <style type="text/css">
        /* ==========================================================================
           GLOBAL & UTILITY STYLES
           ========================================================================== */
        html, body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            overscroll-behavior-y: contain;
        }

        /* Field validation styles */
        .required-field {
            position: relative;
        }
        .required-field::after {
            content: " *";
            color: red;
            position: absolute;
            right: -10px;
            top: 0;
        }
        .error-field {
            border-bottom: 2px solid red !important;
            background-color: rgba(255, 0, 0, 0.05) !important;
        }

        /* General input & table styles */
        input[type="text"], input[type="date"], input[type="email"], input[type="password"], input[type="file"], select, textarea {
            border: none;
            border-bottom: 1px solid #000;
            background: transparent;
            font-family: Arial;
            font-size: 9pt;
            width: 100%;
            padding: 2px;
            box-sizing: border-box;
            color: #000;
        }
        input[type="checkbox"] {
            margin-right: 3px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        td {
            padding: 3px;
            vertical-align: top;
        }
        .main-table {
            width: 100%;
            border: 1px solid #000;
        }
        .main-table td {
            border: 1px solid #000;
            padding: 5px;
        }
        .data-table {
            width: 100%;
            border: none;
        }
        .data-table td {
            border: none;
            padding: 2px;
        }

        /* Buttons */
        .scan-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 8pt;
            cursor: pointer;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .scan-btn i { font-size: 10px; }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }

        /* ==========================================================================
       LOGIN PAGE STYLES (REDESIGNED)
       ========================================================================== */
    #loginPage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    #loginPage::before {
        content: '';
        position: absolute;
        width: 150%;
        height: 150%;
        background-color: #e74c3c;
        top: 25%;
        right: -75%;
        border-radius: 50%;
        z-index: -1;

    }
    .login-container {
        background: #ffffff; /* Solid white background */
        border-radius: 8px;
        padding: 48px;
        width: 90%;
        max-width: 250px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.08); /* Subtle, soft shadow */
        border: 3px solid #e1e4e8; /* Light border for definition */
        text-align: center;
    }
    .login-header {
        margin-bottom: 32px;
    }
    .login-header h2 {
        color: #24292e; /* Dark, professional text color */
        font-size: 28px;
        font-weight: 600;
        margin: 0 0 8px;
    }
    .login-header p {
        color: #000000; /* Muted gray for subtext */
        font-size: 16px;
        font-weight: 500;
        margin: 0;
    }
    /* Removed the tech animation for a cleaner look */
    .login-form {
        margin-top: 0;
    }
    .form-group {
        margin-bottom: 20px;
        text-align: left;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #24292e;
        font-weight: 500;
        font-size: 14px;
    }
    .form-group input {
        width: 50%;
        padding: 12px 16px;
        border: 1px solid #d1d5da;
        border-radius: 6px;
        font-size: 15px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background-color: #ffffff;
        box-sizing: border-box;
    }
    .form-group input:focus {
        outline: none;
        border-color: #e74c3c; /* Red accent on focus */
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.15); /* Subtle red glow */
    }
    .login-btn {
        width: 50%;
        padding: 5px;
        background-color: #e74c3c; /* Solid red, no gradient for a cleaner look */
        color: #ffffff;
        border: 1px solid transparent;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        margin-top: 8px;
    }
    .login-btn:hover {
        background-color: #c0392b; /* Darker red on hover */
    }
    .login-btn:active {
        background-color: #a93226; /* Even darker on active */
    }
    .error-message {
        color: #e74c3c;
        font-size: 13px;
        margin-top: 6px;
        display: none;
        font-weight: 500;
    }

        /* ==========================================================================
           DASHBOARD & MAIN LAYOUT STYLES
           ========================================================================== */
        #dashboardPage {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            z-index: 9998;
            overflow-y: auto;
        }
        .main-content {
            margin-left: 260px;
            padding: 25px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            overflow-y: auto;
        }

                /* --- MODERN & CLEAN HEADER --- */
        .header {
            background: #ffffff;
            padding: 0 25px;
            border-radius: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            height: 70px; /* Memberikan tinggi tetap untuk header */
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .header-left h1 {
            color: #2c3e50;
            font-size: 24px;
            margin: 0;
            font-weight: 700;
        }
        .header-left p {
            display: none; /* Sembunyikan subjudul */
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* --- CLEAN USER INFO --- */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-right: 20px;
            border-right: 1px solid #eaeaea; /* Pemisah visual */
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e74c3c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }
        .user-details {
            text-align: right;
        }
        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            line-height: 1.2;
        }
        .user-role {
            font-size: 12px;
            color: #7f8c8d;
        }
        .logout-btn {
            background-color: transparent;
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }
        .logout-btn:hover {
            background-color: #e74c3c;
            color: white;
        }

        /* --- NEW & IMPROVED SIDEBAR --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: #ffffff;
            transition: left 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 20px rgba(0,0,0,0.06);
            overflow-y: auto;
            border-right: 1px solid #e8e8e8;
        }
        .sidebar-header {
            padding: 28px 24px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
            position: relative;
        }
        .sidebar-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 24px;
            right: 24px;
            height: 2px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        .sidebar-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .sidebar-header h3 i { color: #e74c3c; font-size: 20px; }
        .sidebar-menu { padding: 20px 0; }
        .sidebar-item {
            padding: 16px 24px;
            color: #64748b;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 2px 16px;
            border-radius: 0 8px 8px 0;
            position: relative;
        }
        .sidebar-item:hover {
            color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.08) 0%, rgba(231, 76, 60, 0.02) 100%);
            border-left-color: #e74c3c;
            transform: translateX(2px);
        }
        .sidebar-item.active {
            color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.12) 0%, rgba(231, 76, 60, 0.04) 100%);
            border-left-color: #e74c3c;
            font-weight: 600;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.1);
        }
        .sidebar-item i {
            font-size: 18px;
            width: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .sidebar-item:hover i,
        .sidebar-item.active i { transform: scale(1.1); }

       /* --- NEW & IMPROVED HAMBURGER BUTTON --- */
.hamburger-btn {
    display: flex !important; /* SELALU tampilkan hamburger di semua layar */
    align-items: center;
    justify-content: center;
    background-color: #e74c3c;
    color: white;
    border: none;
    font-size: 18px;
    cursor: pointer;
    padding: 10px;
    border-radius: 6px;
    transition: background-color 0.2s ease;
    margin-right: 15px;
    z-index: 1001; /* Pastikan di atas sidebar */
    position: relative; /* Agar z-index bekerja */
}

.hamburger-btn:hover {
    background-color: #c0392b;
}

        .hamburger-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.5s ease;
        }
        .hamburger-btn:hover::before { left: 100%; }

        /* --- NEW & IMPROVED CARDS & CONTENT AREA --- */
        .content-area {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .content-area.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.05) 0%, rgba(231, 76, 60, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        .card:hover::after { opacity: 1; }
        .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            color: white;
            font-size: 30px;
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3);
            position: relative;
            overflow: hidden;
        }
        .card-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
            animation: shine 3s infinite;
        }
        .card h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 20px;
            font-weight: 600;
            position: relative;
        }
        .card p {
            color: #7f8c8d;
            font-size: 15px;
            line-height: 1.6;
            font-weight: 400;
        }

        /* --- TABLES, FORMS, BUTTONS STYLES (Mostly unchanged but cleaned up) --- */
        .table-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            overflow-x: auto;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .table-title {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .table-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .table-controls input, .table-controls select, .table-controls button {
            padding: 10px 18px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .table-controls input:focus, .table-controls select:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .table-controls button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        .table-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        .data-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px 18px;
            text-align: left;
            color: #2c3e50;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        .data-table td {
            padding: 15px 18px;
            border-bottom: 1px solid #ecf0f1;
            color: #495057;
            font-size: 14px;
        }
        .data-table tr:hover { background: #f8f9fa; }
        .status-active {
            color: #27ae60;
            font-weight: 600;
            background: rgba(39, 174, 96, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .status-inactive {
            color: #e74c3c;
            font-weight: 600;
            background: rgba(231, 76, 60, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .btn-action {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            margin: 2px;
        }
        .btn-edit { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .btn-delete { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .btn-toggle { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .form-container {
            background: white;
            border-radius: 16px;
            padding: 35px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .form-group { margin-bottom: 25px; }
        .form-row { display: flex; gap: 25px; margin-bottom: 25px; }
        .form-row .form-group { flex: 1; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .btn-submit {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 14px 35px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        .jabatan-select {
            padding: 6px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-width: 110px;
            transition: all 0.3s ease;
        }
        .jabatan-select:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .jabatan-select:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ==========================================================================
           MODALS, NOTIFICATIONS, OVERLAYS
           ========================================================================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 35px;
            width: 90%;
            max-width: 520px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .scanner-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        .scanner-content {
            position: relative;
            margin: 5% auto;
            width: 90%;
            max-width: 500px;
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .scanner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .scanner-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
        .close-scanner { background: none; border: none; font-size: 24px; color: #7f8c8d; cursor: pointer; }
        .scanner-video {
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .scanner-controls { display: flex; justify-content: center; gap: 15px; }
        .scanner-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .capture-btn { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .cancel-btn { background: #ecf0f1; color: #2c3e50; }
        .scanner-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .scanner-input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .manual-entry { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ecf0f1; }
        .manual-title { font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 10px; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        .notification.error { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .notification.warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .notification.info { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #e74c3c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text { color: white; margin-left: 15px; font-size: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ==========================================================================
           BA FORM PAGE STYLES
           ========================================================================== */
        #baFormPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
            z-index: 9999;
            overflow-y: auto;
            display: none;
        }
        #baFormPage .page-container {
            margin: 60px auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .page-size-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .page-size-btn {
            margin: 2px;
            padding: 5px 10px;
            font-size: 10px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #f5f5f5;
            border-radius: 3px;
        }
        .page-size-btn.active {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        .container-a4 { width: 200mm; min-height: 297mm; background: white; margin: 20px auto; padding: 10mm; box-sizing: border-box; font-family: Arial; font-size: 9pt; }
        .container-a5 { width: 148mm; min-height: 210mm; background: white; margin: 20px auto; padding: 8mm; box-sizing: border-box; font-family: Arial; font-size: 8pt; }
        .container-letter { width: 216mm; min-height: 279mm; background: white; margin: 20px auto; padding: 10mm; box-sizing: border-box; font-family: Arial; font-size: 9pt; }
        .container-landscape { width: 297mm; min-height: 210mm; background: white; margin: 20px auto; padding: 10mm; box-sizing: border-box; font-family: Arial; font-size: 9pt; }
        .test-table { width: 100%; border: 1px solid #000; }
        .test-table th, .test-table td { border: 1px solid #000; padding: 5px; text-align: center; font-size: 8pt; }
        .signature-box { border: 1px dashed #000; height: 80px; position: relative; }
        canvas {
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        .zoom-on-focus { transition: transform 0.3s ease; }
        .zoom-on-focus:focus {
            transform: scale(1.2);
            position: relative;
            z-index: 100;
        }

        /* ==========================================================================
           SCROLL & UTILITY STYLES
           ========================================================================== */
        .scroll-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .scroll-indicator.show { opacity: 1; }
        .scroll-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .scroll-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            z-index: 10000;
            transition: width 0.1s ease;
        }
        .file-upload {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 45px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .file-upload:hover {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }
        .file-upload i { font-size: 52px; color: #e74c3c; margin-bottom: 18px; }
        .file-upload p { color: #6c757d; margin-bottom: 12px; font-size: 15px; }
        .file-upload span { color: #e74c3c; font-weight: 600; }

        /* ==========================================================================
           PRINT STYLES
           ========================================================================== */
        @media print {
            .page-size-controls, .hamburger-btn, .scan-btn, .loading-overlay {
                display: none !important;
            }
            .container-a4, .container-a5, .container-letter, .container-landscape {
                margin: 0;
                box-shadow: none;
            }
        }

        /* ==========================================================================
           RESPONSIVE STYLES
           ========================================================================== */
       @media screen and (max-width: 768px) {
    /* Header */
    .header {
        padding: 15px 20px;
        flex-direction: row; /* Tetap row, jangan column */
        gap: 15px;
        justify-content: space-between;
        position: relative;
        z-index: 1002;
        background: white;
    }

    .header-left {
        width: auto; /* Jangan full width */
        position: relative;
        text-align: left; /* Kiri align */
        justify-content: flex-start;
        display: flex;
        align-items: center;
    }

    .hamburger-btn {
        display: flex !important; /* Selalu tampilkan */
        position: relative; /* Bukan absolute */
        left: auto;
        top: auto;
        margin-right: 10px;
    }

    .header-left h1 {
        font-size: 18px;
        margin: 0;
    }

    .user-info {
        width: auto; /* Jangan full width */
        justify-content: flex-end; /* Rata kanan */
    }

    /* Sidebar */
    .sidebar {
        left: -260px;
        transition: left 0.3s ease;
        box-shadow: 2px 0 15px rgba(0,0,0,0.3);
        z-index: 1000; /* Di bawah hamburger */
    }

    .sidebar.open {
        left: 0;
    }

    /* Main Content */
    .main-content {
        margin-left: 0 !important;
        padding: 15px;
        position: relative;
    }

            /* Sidebar */
            .sidebar {
                left: -260px;
                transition: left 0.3s ease;
                box-shadow: 2px 0 15px rgba(0,0,0,0.3);
            }
            .sidebar.open { left: 0; }
            .sidebar-item span { display: none; }
            .sidebar.open .sidebar-item span { display: inline-block; margin-left: 10px; }

            /* Main Content */
            .main-content { margin-left: 0 !important; padding: 15px; }

            /* Cards */
            .cards-container { grid-template-columns: 1fr; gap: 15px; }
            .card { padding: 20px; }
            .card-icon { width: 60px; height: 60px; font-size: 24px; }

            /* Tables */
            .table-container { padding: 15px; overflow-x: auto; }
            .data-table { min-width: 600px; font-size: 12px; }
        }

        @media screen and (max-width: 480px) {
            .header-left h1 { font-size: 18px; margin-left: 40px; }
            .user-info { font-size: 12px; }
            .user-avatar { width: 40px; height: 40px; font-size: 16px; }
            .user-name { font-size: 14px; }
            .user-role { font-size: 11px; }
            .scroll-indicator {
                bottom: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
            }
        }

        /* Tambahkan di bagian CSS */
    .signature-required {
        position: relative;
        color: red;
        font-weight: bold;
    }

    .signature-required::after {
        content: " *";
        color: red;
        position: absolute;
        right: -10px;
        top: 0;
    }

    .signature-box.error {
        border-color: red !important;
        background-color: rgba(255, 0, 0, 0.05) !important;
    }

    /* Styling untuk tanda tangan required */
    .signature-required {
        position: relative;
        color: #2c3e50;
        font-weight: bold;
        margin-bottom: 8px;
        display: inline-block;
    }

    .signature-required::after {
        content: " *";
        color: red;
        font-size: 14px;
        position: absolute;
        right: -12px;
        top: 0;
    }

    .signature-box {
        border: 1px dashed #000;
        height: 80px;
        position: relative;
        margin-bottom: 5px;
        transition: all 0.3s ease;
    }

    .signature-box.error {
        border: 2px solid red !important;
        background-color: rgba(255, 0, 0, 0.05) !important;
        animation: pulseError 0.5s ease-in-out;
    }

    @keyframes pulseError {
        0% { border-color: red; }
        50% { border-color: #ff6666; }
        100% { border-color: red; }
    }

    .signature-error {
        color: red;
        font-size: 10px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .signature-error i {
        font-size: 12px;
    }

    /* Tombol untuk draft */
    .btn-draft {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
        color: white;
    }

    .btn-draft:hover {
        background: linear-gradient(135deg, #2980b9 0%, #1c6ea4 100%) !important;
        transform: translateY(-2px);
    }

    .status-draft {
        color: #f39c12;
        font-weight: 600;
        background: rgba(243, 156, 18, 0.1);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
    }

    .sidebar-brand {
        position: absolute;
        bottom: 15px;
        left: 0;
        width: 100%;
        text-align: center;
        color: #504f4f; /* Warna abu-abu seperti copyright */
        font-size: 11px; /* Ukuran font kecil */
        font-weight: 400; /* Tidak tebal */
        padding: 10px 0;
        border-top: 1px solid #f0f0f0;
    }

    /* ==========================================================================
       PERBAIKAN KHUSUS UNTUK PRINT/PDF AGAR TIDAK TERPOTONG
       ========================================================================== */
    @media print {
        #page-container {
            width: 100% !important; /* Pastikan container tidak melebihi lebar halaman */
            overflow: visible !important;
        }
        #page-container .main-table {
            width: 100% !important;
            table-layout: fixed !important; /* Paksa tabel untuk menggunakan lebar yang ditentukan */
        }
        #page-container .main-table tr td {
            /* PERBAIKAN UTAMA: GANTI LEBAR KOLOM YANG BERMASALAH */
            width: 48% !important; /* Ganti 55% dan 50% menjadi 48% agar muat di A4 */
            box-sizing: border-box !important;
            word-wrap: break-word !important;
        }
        /* Sembunyikan elemen yang tidak perlu di PDF */
        .page-size-controls, #baFormActions, .scan-btn, .loading-overlay {
            display: none !important;
        }
    }

    /* ==========================================================================
       BA FORM INPUT & BUTTON ALIGNMENT FIX
       ========================================================================== */

    /* Target khusus input di dalam form BA */
    #baFormPage input[type="text"],
    #baFormPage input[type="date"],
    #baFormPage input[type="email"],
    #baFormPage input[type="password"],
    #baFormPage input[type="file"],
    #baFormPage select,
    #baFormPage textarea {
        /* Ini menimpa style global agar bisa sejajar dengan tombol */
        display: inline-block;
        width: calc(100% - 50px); /* Kurangi lebar untuk tombol */
        vertical-align: middle;
    }

    #baFormPage .scan-btn {
        /* Pastikan tombol juga sejajar */
        display: inline-block;
        vertical-align: middle;
        margin-left: 5px;
        margin-bottom: 2px; /* Sesuaikan agar rapi */
    }

    /* Perbaikan khusus untuk tabel di form BA */
    #baFormPage .main-table td {
        /* Cegah konten di dalam td pindah baris */
        white-space: nowrap;
    }

    /* ==========================================================================
       PDF LAYOUT FIX
       ========================================================================== */

    /* Class ini akan menata ulang layout menjadi 1 kolom saat PDF dibuat */
    .pdf-layout .main-table tr {
        display: flex;
        flex-direction: column;
    }

    .pdf-layout .main-table td {
        width: 100% !important;
        display: block;
        border: 1px solid #000; /* Kembalikan border */
        padding: 5px;
        box-sizing: border-box;
        margin-bottom: 10px; /* Beri jarak antar kolom yang sekarang bertumpuk */
    }
/* Sidebar Collapsed untuk Desktop */
@media screen and (min-width: 769px) {
    .sidebar.collapsed {
        width: 80px !important;
    }

    .sidebar.collapsed .sidebar-header h3 {
        font-size: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sidebar.collapsed .sidebar-header h3 i {
        font-size: 24px;
        margin-right: 0;
    }

    .sidebar.collapsed .sidebar-item span {
        display: none;
    }

    .sidebar.collapsed .sidebar-item {
        justify-content: center;
        padding: 16px 0;
        margin: 2px 8px;
    }

    .sidebar.collapsed .sidebar-item i {
        font-size: 20px;
        width: 30px;
        margin: 0;
    }

    .sidebar.collapsed .sidebar-brand {
        font-size: 0;
        line-height: 0;
        padding: 5px 0;
        overflow: hidden;
    }

    .sidebar.collapsed .sidebar-brand br {
        display: none;
    }

    .sidebar.collapsed ~ .main-content {
        margin-left: 80px !important;
    }
}



    </style>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- QuaggaJS for barcode scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
<!-- === LOGIN PAGE === -->
<div id="loginPage">
    <div class="login-container">
        <div class="login-header">
            <h2>Berita Acara Digital</h2>
            <p>by X-SOFTWARE</p>
        </div>

        <div class="tech-animation">
            <div class="circuit-line">
                <div class="node"></div>
                <div class="node"></div>
                <div class="node"></div>
            </div>
        </div>

        <div class="login-form">
            <div class="form-group">
                <label for="email"><i class="fas fa-envelope"></i> Email</label>
                <input type="email" id="email" placeholder="Masukkan email terdaftar">
                <div class="error-message" id="emailError">Email tidak valid</div>
            </div>

            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" placeholder="Masukkan password">
                <div class="error-message" id="passwordError">Password minimal 6 karakter</div>
            </div>

            <button class="login-btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        </div>
    </div>
</div>

<!-- === DASHBOARD === -->
<div id="dashboardPage">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-file-contract"></i> Berita Acara Digital</h3>
        </div>

        <div class="sidebar-menu">
            <!-- Cari bagian ini dan tambahkan data-role="admin" -->
            <div class="sidebar-item" data-role="admin" onclick="showContent('technician')">
                <i class="fas fa-users-cog"></i> Teknisi
            </div>

            <div class="sidebar-item" data-role="Teknisi" onclick="showContent('createBA')">
                <i class="fas fa-file-medical"></i> Buat BA
            </div>

            <div class="sidebar-item" data-role="admin" onclick="showContent('masterTech')">
                <i class="fas fa-database"></i> Data Master
            </div>

            <div class="sidebar-item" data-role="admin" onclick="showContent('reports')">
                <i class="fas fa-chart-bar"></i> Laporan
            </div>

            <div class="sidebar-brand">
                Â© 2025 Powered by<br>
                X-SOFTWARE | Your Business Solution
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="hamburger-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Dashboard</h1>
                <p>Sistem Manajemen Berita Acara</p>
            </div>

            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role" id="userRole">ADMIN</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div id="contentArea">
            <!-- Dashboard Content -->
            <div class="content-area active" id="dashboardContent">
                <div class="cards-container">
                    <div class="card" onclick="showContent('createBA')">
                        <div class="card-icon">
                            <i class="fas fa-file-medical"></i>
                        </div>
                        <h3>Buat BA Baru</h3>
                        <p>Buat Berita Acara baru untuk pekerjaan yang telah diselesaikan</p>
                    </div>

                    <div class="card" onclick="showContent('technician')">
                        <div class="card-icon">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <h3>Kelola Teknisi</h3>
                        <p>Kelola data teknisi, status aktif/nonaktif, dan informasi lainnya</p>
                    </div>

                    <div class="card" onclick="showContent('masterTech')">
                        <div class="card-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <h3>Data Master</h3>
                        <p>Import data teknisi dari Excel dan kelola data master</p>
                    </div>

                    <div class="card" onclick="showContent('reports')">
                        <div class="card-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>Laporan & Analisis</h3>
                        <p>Lihat laporan dan analisis data BA berdasarkan filter tertentu</p>
                    </div>
                </div>

                <div class="table-container">
                    <h3 class="table-title">Aktivitas Terbaru</h3>
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>NIK</th>
                            <th>Jabatan</th>
                            <th>Mitra</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                        </thead>
                        <tbody id="dashboardActivityTable">
                        <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>



            <!-- Menu Teknisi Content -->
            <div class="content-area" id="technicianContent">
                <div class="table-container">
                    <h3 class="table-title">Daftar Teknisi</h3>

                    <div class="table-controls">
                        <input type="text" id="searchTech" placeholder="Cari teknisi..." onkeyup="searchTechnicians()">
                        <button onclick="exportTechnicians()"><i class="fas fa-download"></i> Export</button>
                        <button onclick="showAddUserModal()"><i class="fas fa-plus"></i> Tambah Teknisi</button>
                        <button onclick="importTechData()"><i class="fas fa-file-import"></i> Import Data</button>
                    </div>

                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>NIK</th>
                            <th>Jabatan</th>
                            <th>Mitra</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                        </thead>
                        <tbody id="technicianTable">
                        <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Buat BA Content -->
            <div class="content-area" id="createBAContent">
                <div class="table-container">
                    <!-- TOMBOL BUAT BA -->
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 15px;">Buat Berita Acara Baru</h3>
                        <button class="btn-submit" onclick="openBAForm()" style="padding: 15px 50px; font-size: 16px;">
                            <i class="fas fa-file-medical"></i> Buka Form BA
                        </button>
                        <p style="color: #666; margin-top: 15px; font-size: 14px;">
                            Klik tombol di atas untuk membuka form pengisian Berita Acara
                        </p>
                    </div>

                    <!-- LIST BA SAYA -->
                    <div>
                        <h3 style="color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e74c3c;">
                            <i class="fas fa-list"></i> Daftar BA Saya
                        </h3>

                        <div class="table-controls">
                            <input type="date" id="filterTanggalSaya">
                            <input type="text" id="searchNoInetSaya" placeholder="Cari No Internet" onkeyup="filterBASaya()">
                            <button onclick="exportBASaya()"><i class="fas fa-download"></i> Export</button>
                            <button onclick="refreshBASaya()"><i class="fas fa-sync"></i> Refresh</button>
                        </div>

                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>No BA</th>
                                <th>Tanggal</th>
                                <th>Pelanggan</th>
                                <th>No Internet</th>
                                <th>STO</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                            </thead>
                            <tbody id="myBATable">
                            <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Master Teknisi Content -->
            <div class="content-area" id="masterTechContent">
                <div class="table-container">
                    <h3 class="table-title">Master Data</h3>

                    <div class="table-controls">
                        <input type="text" id="searchMaster" placeholder="Cari data master..." onkeyup="searchMasterData()">
                        <button onclick="showAddMasterModal()"><i class="fas fa-plus"></i> Tambah Data</button>
                        <button onclick="importExcel()"><i class="fas fa-file-import"></i> Import Excel</button>
                        <button onclick="refreshMaster()"><i class="fas fa-sync"></i> Refresh</button>
                    </div>

                    <div class="file-upload" onclick="document.getElementById('excelFile').click()" id="dropZone">
                        <i class="fas fa-file-excel"></i>
                        <p>Drag & drop file Excel di sini atau klik untuk memilih</p>
                        <span>Format: .xlsx, .xls</span>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" hidden onchange="handleExcelUpload(this)">
                    </div>

                    <table class="data-table mt-20">
                        <thead>
                        <tr>
                            <th>No</th>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>NIK</th>
                            <th>Jabatan</th>
                            <th>Mitra</th>
                            <th>Tanggal Import</th>
                            <th>Aksi</th>
                        </tr>
                        </thead>
                        <tbody id="masterTable">
                        <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- === MODAL TAMBAH DATA MASTER === -->
            <div id="addMasterModal" class="modal">
                <div class="modal-content">
                    <h3 style="color: #333; margin-bottom: 20px;">
                        <i class="fas fa-user-plus"></i> Tambah Data Master
                    </h3>

                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="newMasterName" placeholder="Masukkan nama lengkap" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>NIK</label>
                        <input type="text" id="newMasterNIK" placeholder="Masukkan NIK" class="form-control" maxlength="20">
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="newMasterEmail" placeholder="Masukkan email" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Jabatan</label>
                        <select id="newMasterJabatan" class="form-control">
                            <option value="Teknisi">Teknisi</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Mitra</label>
                        <input type="text" id="newMasterMitra" placeholder="Nama mitra" class="form-control">
                    </div>

                    <div id="newMasterError" style="color: #ff4757; margin: 10px 0; display: none;"></div>

                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button onclick="closeAddMasterModal()" style="flex: 1; padding: 12px; background: #ddd; border: none; border-radius: 8px; cursor: pointer;">
                            Batal
                        </button>
                        <button onclick="submitNewMaster()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Laporan Content -->
            <div class="content-area" id="reportsContent">
                <div class="table-container">
                    <h3 class="table-title">Laporan BA</h3>

                    <div class="table-controls">
                        <input type="date" id="startDate">
                        <input type="date" id="endDate">
                        <select id="monthFilter">
                            <option value="">Pilih Bulan</option>
                            <option value="01">Januari</option>
                            <option value="02">Februari</option>
                            <option value="03">Maret</option>
                            <option value="04">April</option>
                            <option value="05">Mei</option>
                            <option value="06">Juni</option>
                            <option value="07">Juli</option>
                            <option value="08">Agustus</option>
                            <option value="09">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                        <input type="text" id="searchInet" placeholder="No Internet Pelanggan">
                        <button onclick="filterReports()"><i class="fas fa-filter"></i> Filter</button>
                        <button onclick="exportReports()"><i class="fas fa-file-export"></i> Export</button>
                    </div>

                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>No BA</th>
                            <th>Tanggal</th>
                            <th>Pelanggan</th>
                            <th>No Internet</th>
                            <th>Teknisi</th>
                            <th>Layanan</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody id="reportsTable">
                        <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- === MODAL TAMBAH USER === -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <h3 style="color: #333; margin-bottom: 20px;">
            <i class="fas fa-user-plus"></i> Tambah User Baru
        </h3>

        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="newUserName" placeholder="Masukkan nama lengkap" class="form-control">
        </div>

        <div class="form-group">
            <label>NIK</label>
            <input type="text" id="newUserNIK" placeholder="Masukkan NIK" class="form-control" maxlength="20">
        </div>

        <div class="form-group">
            <label>Email</label>
            <input type="email" id="newUserEmail" placeholder="Masukkan email" class="form-control">
        </div>

        <div class="form-group">
            <label>Password</label>
            <input type="password" id="newUserPassword" placeholder="Minimal 6 karakter" class="form-control">
        </div>

        <div class="form-group">
            <label>Jabatan</label>
            <select id="newUserJabatan" class="form-control">
                <option value="Teknisi">Teknisi</option>
                <option value="Admin">Admin</option>
            </select>
        </div>

        <div class="form-group">
            <label>Mitra</label>
            <input type="text" id="newUserMitra" placeholder="Nama mitra" class="form-control">
        </div>

        <div id="newUserError" style="color: #ff4757; margin: 10px 0; display: none;"></div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button onclick="closeAddUserModal()" style="flex: 1; padding: 12px; background: #ddd; border: none; border-radius: 8px; cursor: pointer;">
                Batal
            </button>
            <button onclick="submitNewUser()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-save"></i> Simpan
            </button>
        </div>
    </div>
</div>

<!-- === SCANNER MODAL === -->
<div id="scannerModal" class="scanner-modal">
    <div class="scanner-content">
        <div class="scanner-header">
            <h3 class="scanner-title">Scan Barcode</h3>
            <button class="close-scanner" onclick="closeScanner()">&times;</button>
        </div>

        <div id="scanner-video" class="scanner-video">
            <!-- Camera feed will be displayed here -->
        </div>

        <div class="scanner-controls">
            <button class="scanner-btn capture-btn" onclick="startScanning()">
                <i class="fas fa-camera"></i> Mulai Scan
            </button>
            <button class="scanner-btn cancel-btn" onclick="closeScanner()">
                <i class="fas fa-times"></i> Batal
            </button>
        </div>

        <div class="manual-entry">
            <h4 class="manual-title">Atau masukkan secara manual:</h4>
            <input type="text" id="manualInput" class="scanner-input" placeholder="Masukkan kode barcode">
            <button class="scanner-btn capture-btn" onclick="useManualInput()">
                <i class="fas fa-keyboard"></i> Gunakan Input Manual
            </button>
        </div>
    </div>
</div>

<!-- === LOADING OVERLAY === -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Sedang mengkonfigurasi sistem...</div>
</div>




<!-- === BA FORM === -->
<div id="baFormPage" style="display: none;">
    <div class="page-size-controls">
        <strong>Ukuran Kertas:</strong><br>
        <button class="page-size-btn active" onclick="changePageSize('A4')">A4</button>
        <button class="page-size-btn" onclick="changePageSize('A5')">A5</button>
        <button class="page-size-btn" onclick="changePageSize('Letter')">Letter</button>
        <button class="page-size-btn" onclick="changePageSize('A4 landscape')">Landscape</button>
    </div>

    <div id="page-container" class="container-a4">
        <!-- === MODAL PREVIEW PDF === -->
        <div id="pdfPreviewModal" class="modal">
            <div class="modal-content" style="width: 90%; max-width: 900px; height: 100%; padding: 0; display: flex; flex-direction: column;">
                <div class="scanner-header" style="padding: 15px 20px; border-bottom: 1px solid #eaeaea;">
                    <h3 class="scanner-title">Preview Berita Acara</h3>
                    <button class="close-scanner" onclick="closePDFPreview()">&times;</button>
                </div>
                <div style="flex-grow: 1; padding: 10px; background-color: #f0f0f0; overflow: hidden;">
                    <iframe id="pdfPreviewFrame" style="width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 4px;"></iframe>
                </div>
                <div style="padding: 15px 20px; text-align: right; border-top: 1px solid #eaeaea; background-color: #fff;">
                    <button class="scanner-btn cancel-btn" onclick="closePDFPreview()">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                    <button class="scanner-btn capture-btn" id="downloadPdfFromPreviewBtn" style="margin-left: 10px;">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>

        <table style="width: 100%; border: none; margin-bottom: 10px;">
            <tr>
                <td style="width: 15%; text-align: left; border: none; vertical-align: middle;">
                    <div style="border: 0px dashed #000; width: 100px; height: 50px; position: relative; overflow: hidden; cursor: pointer;"
                         onclick="document.getElementById('uploadKiri').click()"
                         onmouseover="this.style.borderColor='#e74c3c'; this.style.boxShadow='0 0 10px rgba(231, 76, 60, 0.3)'"
                         onmouseout="this.style.borderColor='#000'; this.style.boxShadow='none'">
                        <img id="logoKiri" src="" style="width: 100%; height: 100%; object-fit: contain; display: none; cursor: pointer;">
                        <div id="placeholderKiri" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <button type="button"
                                    style="background: rgba(231, 76, 60, 0.9); color: white; border: none;
                                   padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;"
                                    onmouseover="this.style.background='#c0392b'"
                                    onmouseout="this.style.background='rgba(231, 76, 60, 0.9)'">
                                <i class="fas fa-upload"></i> Logo
                            </button>
                            <div style="font-size: 8px; color: #666; margin-top: 2px;">Klik untuk upload</div>
                        </div>
                        <input type="file" id="uploadKiri" accept="image/*" onchange="uploadImage('kiri', this)" style="display: none;">
                    </div>
                </td>

                <td style="width: 80%; text-align: center; border: none; vertical-align: middle;">
                    <h1 style="font-size: 12pt; margin: 0; font-weight: bold;">LAPORAN PENYELESAIAN PEKERJAAN</h1>
                </td>

                <td style="width:70%; text-align: right; border: none; vertical-align: middle;">
                    <div style="border: 0px dashed #000; width: 100px; height: 50px; position: relative; overflow: hidden; cursor: pointer;"
                         onclick="document.getElementById('uploadKanan').click()"
                         onmouseover="this.style.borderColor='#e74c3c'; this.style.boxShadow='0 0 10px rgba(231, 76, 60, 0.3)'"
                         onmouseout="this.style.borderColor='#000'; this.style.boxShadow='none'">
                        <img id="logoKanan" src="" style="width: 100%; height: 100%; object-fit: contain; display: none; cursor: pointer;">
                        <div id="placeholderKanan" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <button type="button"
                                    style="background: rgba(231, 76, 60, 0.9); color: white; border: none;
                                   padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;"
                                    onmouseover="this.style.background='#c0392b'"
                                    onmouseout="this.style.background='rgba(231, 76, 60, 0.9)'">
                                <i class="fas fa-upload"></i> Logo
                            </button>
                            <div style="font-size: 8px; color: #666; margin-top: 2px;">Klik untuk upload</div>
                        </div>
                        <input type="file" id="uploadKanan" accept="image/*" onchange="uploadImage('kanan', this)" style="display: none;">
                    </div>
                </td>
            </tr>
        </table>

        <table style="width: 100%; margin-bottom: 5px; border: none;">
            <tr>
                <td style="border: none;">
                    <strong>Nama Mitra :</strong> <span id="nama_mitra" style="width: 150px;font-weight: bold; margin-left: 5px;"></span>
                </td>
                <td style="border: none; text-align: right;">
                    <strong>No BA :</strong> <span id="noBADisplay" style="font-weight: bold; margin-left: 5px;">BA-001</span>
                </td>
            </tr>
            <tr>
                <td style="border: none;">
                    <strong>Nama Teknisi :</strong> <span id="namaTeknisiDisplay" style="font-weight: bold; margin-left: 5px;"></span>
                </td>
                <td style="border: none; text-align: right;"></td>
            </tr>
        </table>

        <table class="main-table">
            <tr>
                <td style="width: 55%; vertical-align: top;">
                    <table style="width: 100%; border: none;">
                        <tr><td style="width: 35%; border: none; white-space: nowrap;" class="required-field">1. STO</td><td style="width: 1%; border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="width: 100%; border: none;"><input type="text" name="sto" class="required-field zoom-on-focus" style="text-transform: uppercase;"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">2. No Permintaan/WO</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_permintaan" class="required-field zoom-on-focus" pattern="[A-Za-z0-9]+" title="Hanya huruf dan angka"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;">3. No Telepon</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_telepon" pattern="[0-9]+" title="Hanya angka"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">4. No Inet</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_inet" class="required-field zoom-on-focus" pattern="[0-9]+" title="Hanya angka"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">5. Tanggal WO</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="date" name="tanggal_wo" class="required-field zoom-on-focus"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;">6. Tanggal Transaksi</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="date" name="tanggal_transaksi"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">7. Nama Pelanggan</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="nama_pelanggan" class="required-field zoom-on-focus"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">8. No Kontak</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_kontak" class="required-field zoom-on-focus" pattern="[0-9]+" title="Hanya angka"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">9. Alamat Pelanggan</td><td style="border: none; padding-left: 1x; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="alamat_pelanggan" class="required-field zoom-on-focus"></td></tr>
                    </table>

                    <table style="margin-top: 5px; width: 100%; border: none;">
                        <tr style="border: none;"><td colspan="3" style="border: none;"><strong>DATEK</strong></td></tr>
                        <tr style="border: none;"><td style="width: 1%; border: none; white-space: nowrap;">1. RK/MSAN/ODC</td><td style="width: 3%; border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="width: 100%; border: none;"><input type="text" name="rk_msan_odc"></td></tr>
                        <tr style="border: none;"><td style="border: none; white-space: nowrap;">2. DP/ODP</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="dp_odp"></td></tr>
                        <tr style="border: none;"><td style="border: none; white-space: nowrap;">3. Klem Primer/Feeder</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="klem_primer_feeder"></td></tr>
                        <tr style="border: none;"><td style="border: none; white-space: nowrap;">4. Kec sec/Distribusi</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="kec_sec_distribusi"></td></tr>
                    </table>

                    <table style="margin-top: 5px; width: 100%; border: none;">
                        <tr style="border: none;"><td colspan="3" style="border: none;"><strong>Material</strong></td></tr>
                        <tr style="border: none;">
                            <td style="width: 2%; border: none; white-space: nowrap;">1.</td>
                            <td style="width: 1%; border: none;"></td>
                            <td style="width: 100%; border: none;">
                                <input type="text" name="material1_kiri" style="width: 45%;"> : <input type="text" name="material1_kanan" style="width: 45%;">
                            </td>
                        </tr>
                        <tr style="border: none;">
                            <td style="border: none; white-space: nowrap;">2.</td>
                            <td style="border: none;"></td>
                            <td style="border: none;">
                                <input type="text" name="material2_kiri" style="width: 45%;"> : <input type="text" name="material2_kanan" style="width: 45%;">
                            </td>
                        </tr>
                        <tr style="border: none;">
                            <td style="border: none; white-space: nowrap;">3.</td>
                            <td style="border: none;"></td>
                            <td style="border: none;">
                                <input type="text" name="material3_kiri" style="width: 45%;"> : <input type="text" name="material3_kanan" style="width: 45%;">
                            </td>
                        </tr>
                        <tr style="border: none;">
                            <td style="border: none; white-space: nowrap;">4.</td>
                            <td style="border: none;"></td>
                            <td style="border: none;">
                                <input type="text" name="material4_kiri" style="width: 45%;"> : <input type="text" name="material4_kanan" style="width: 45%;">
                            </td>
                        </tr>
                        <tr style="border: none;">
                            <td style="border: none; white-space: nowrap;">5.</td>
                            <td style="border: none;"></td>
                            <td style="border: none;">
                                <input type="text" name="material5_kiri" style="width: 45%;"> : <input type="text" name="material5_kanan" style="width: 45%;">
                            </td>
                        </tr>
                    </table>
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <table border="1" cellpadding="1" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td colspan="5" style="text-align: center; font-weight: bold; font-size: 10pt;">TEST USAGE</td>
                        </tr>
                        <tr>
                            <td rowspan="2" style="text-align: center; font-weight: bold; width: 25%;">Tes Layanan</td>
                            <td rowspan="2" style="text-align: center; font-weight: bold; width: 25%;">Contoh</td>
                            <td colspan="2" style="text-align: center; font-weight: bold; width: 50%;">Kualitas</td>
                        </tr>
                        <tr>
                            <td style="text-align: center;">Baik</td>
                            <td style="text-align: center;">Tidak</td>
                        </tr>
                        <tr>
                            <td style="text-align: center;">Test Voice</td>
                            <td style="text-align: center;"></td>
                            <td style="text-align: center;"><input type="checkbox" name="voice_baik" class="test-checkbox" data-group="voice"></td>
                            <td style="text-align: center;"><input type="checkbox" name="voice_tidak" class="test-checkbox" data-group="voice"></td>
                        </tr>
                        <tr>
                            <td style="text-align: center;">Test Internet</td>
                            <td style="text-align: center;"></td>
                            <td style="text-align: center;"><input type="checkbox" name="inet_baik" class="test-checkbox" data-group="inet"></td>
                            <td style="text-align: center;"><input type="checkbox" name="inet_tidak" class="test-checkbox" data-group="inet"></td>
                        </tr>
                        <tr>
                            <td style="text-align: center;">Test UseeTv</td>
                            <td style="text-align: center;"></td>
                            <td style="text-align: center;"><input type="checkbox" name="usetv_baik" class="test-checkbox" data-group="usetv"></td>
                            <td style="text-align: center;"><input type="checkbox" name="usetv_tidak" class="test-checkbox" data-group="usetv"></td>
                        </tr>
                    </table>

                    <div style="border: 1px solid #000; padding: 5px; margin-top: 10px;">
                        <strong>Tes Internet :</strong><br>
                        1. Tes Ping&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_ping" style="width: 80px;"> ms<br>                            2. Tes Upload&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_upload" style="width: 80px;"> Mbps<br>
                        3. Tes Download &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_download" style="width: 80px;"> Mbps<br>
                        4. Hasil Ukur Redaman&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="hasil_ukur_redaman" style="width: 90px;">
                    </div>

                    <div style="border: 1px solid #000; padding: 100px; margin-top: 10px;"></div>
                </td>
            </tr>
        </table>

        <table class="main-table" style="margin-top: 10px;">
            <tr>
                <td style="width: 60%; vertical-align: top;">
                    <table style="width: 90%; border: none;">
                        <tr><td style="width: 20%; border: none; white-space: nowrap;" class="required-field">ONT yang DITARIK / ONT BEKAS</td><td style="width: 5%; border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="width: 50%; border: none;">
                            <input type="text" name="ONT_yang_DIPASANG_/_DITARIK" class="required-field zoom-on-focus" id="ont_ditarik">
                            <button class="scan-btn" onclick="openScanner('ont_ditarik')"><i class="fas fa-camera"></i></button>

                        </td></tr>
                        <tr><td style="border: none; white-space: nowrap;">lampu Indikator ONT Nyala</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="checkbox" name="power"> Power <input type="checkbox" name="dsl"> DSL <input type="checkbox" name="internet"> Internet</td></tr>
                        <tr><td style="border: none; white-space: nowrap;">Nama / Notel Teknisi</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="nama_teknisi"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">STB ID</td><td style="width: 5%; border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="width: 55%; border: none;">
                            <input type="text" name="stb_id" class="required-field zoom-on-focus" id="stb_id">
                            <button class="scan-btn" onclick="openScanner('stb_id')"><i class="fas fa-camera"></i></button>

                        </td></tr>
                    </table>
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <table style="width: 100%; border: none;">
                        <tr><td style="width: 30%; border: none; white-space: nowrap;" class="required-field">SN ONT BARU</td><td style="width: 5%; border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="width: 65%; border: none;">
                            <input type="text" name="sn_ont" class="required-field zoom-on-focus" id="sn_ont">
                            <button class="scan-btn" onclick="openScanner('sn_ont')"><i class="fas fa-camera"></i></button>
                        </td></tr>
                        <tr><td style="border: none; white-space: nowrap;">SN PLC</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="sn_plc"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;">SN WIFI EXT</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="sn_wifi_ext"></td></tr>
                    </table>
                </td>
            </tr>
        </table>

        <table class="main-table" style="margin-top: 10px;">
            <tr>
                <td style="width: 50%; vertical-align: top;">
                    <strong>PSB</strong><br>
                    <input type="checkbox" name="psb_1p_voice"> 1P [Voice]/1P [Internet] &nbsp;
                    <input type="checkbox" name="psb_3p"> 3P<br>
                    <input type="checkbox" name="psb_2p"> 2P [Voice + Internet] / 2P [Internet + UseeTv]
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <strong>Tambahan</strong><br>
                    <input type="checkbox" name="ganti_stb"> Ganti STB / ONT &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="checkbox" name="plc"> PLC &nbsp;
                    <input type="checkbox" name="indibox"> IndiBox<br>
                    <input type="checkbox" name="stb_belum_terpasang"> STB Belum Terpasang &nbsp;
                    <input type="checkbox" name="wifi_extender"> Wifi Extender
                </td>
            </tr>
        </table>

        <table class="main-table" style="margin-top: 10px;">
            <tr>
                <td>
                    <strong>Migrasi</strong><br>
                    <strong>Infrastruktur:</strong><br>
                    <input type="checkbox" name="infra_1p1p_voice"> 1P-1P [Voice]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="checkbox" name="infra_1p2p_voice"> 1P-2P [Voice+Internet]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="checkbox" name="infra_2p2p_voice"> 2P-2P [Internet+Voice]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="checkbox" name="infra_1p3p"> 1P-3P&nbsp;
                    <input type="checkbox" name="infra_3p3p"> 3P-3P<br>
                    <input type="checkbox" name="infra_1p1p_internet"> 1P-1P [Internet] &nbsp;
                    <input type="checkbox" name="infra_1p2p_usetv"> 1P-2P [Internet+UseeTv] &nbsp;
                    <input type="checkbox" name="infra_2p2p_usetv"> 2P-2P [Internet+UseeTv] &nbsp;
                    <input type="checkbox" name="infra_2p3p"> 2P-3P<br>

                    <strong>Layanan:</strong><br>
                    <input type="checkbox" name="layanan_1p2p_voice"> 1P-2P [Internet+Voice] &nbsp;
                    <input type="checkbox" name="layanan_1p2p_usetv"> 1P-2P [Internet+UseeTv] &nbsp;
                    <input type="checkbox" name="layanan_1p3p"> 1P-3P &nbsp;
                    <input type="checkbox" name="layanan_2p3p"> 2P-3P
                </td>
            </tr>
        </table>

        <table style="width: 100%; margin: 10px 0; border: none;">
            <tr>
                <td style="border: none;">
                    <strong>Speed :</strong> 10MB 20MB 30MB 40MB 50MB 100MB 200MB 300MB 1 GB other
                </td>
            </tr>
        </table>

        <table class="main-table">
            <tr>
                <td style="font-size: 9pt; white-space: normal; word-wrap: break-word; overflow-wrap: break-word;">
                    1. Perangkat (ONT/Modem/STB) yang dipasang di rumah pelanggan adalah MILIK TELKOM yang dipinjamkan selama menjadi pelanggan TELKOM. Modem yang tidak dipakai karena Migrasi ke Fiber akan ditarik Kembali.<br>
                    2. Telkom dapat mengambil Perangkat bila tidak ada penggunaan selama 3 bulan berturut-turut.<br>
                    3. Untuk progress pemilihan dan monitoring diharapkan power perangkat selalu dalam kondisi hidup (ON)<br>
                    4. Disarankan untuk segera merubah password yang ada untuk menjaga agar tidak dipergunakan oleh pihak-pihak yang tidak dikehendaki<br>
                    5. Pelanggan sudah mendapatkan penjelasan dari sales/seller atau menerima buku petunjuk menggunakan modem internet yang telah dipasang.
                </td>
            </tr>
        </table>

        <div style="text-align: right; margin-top: 10px; margin-right: 25%;">
            Lumajang, <input type="date" name="tanggal_lumajang" style="border: none; border-bottom: 1px solid #000; text-align: center; width: 120px;">
        </div>

        <table class="main-table" style="margin-top: 10px;">
            <tr>
                <td style="width: 50%; text-align: center;">
                    <div>Pelanggan</div>
                    <div id="namaPelangganTTD" style="margin-bottom: 5px; font-weight: bold;"></div>
                    <div class="signature-box">
                        <canvas id="signature-pelanggan" width="200" height="70"></canvas>
                        <button type="button" onclick="clearSignature('pelanggan')" style="position: absolute; bottom: 5px; right: 5px; font-size: 8px;">Hapus</button>
                    </div>
                    <button type="button" onclick="saveSignature('pelanggan')" style="margin-top: 5px; font-size: 8px; padding: 3px 8px;">Save TTD</button>
                </td>
                <td style="width: 50%; text-align: center;">
                    <div>Petugas Lapangan</div>
                    <div id="namaTeknisiTTD" style="margin-bottom: 5px; font-weight: bold;"></div>
                    <div class="signature-box">
                        <canvas id="signature-petugas" width="200" height="70"></canvas>
                        <button type="button" onclick="clearSignature('petugas')" style="position: absolute; bottom: 5px; right: 5px; font-size: 8px;">Hapus</button>
                    </div>
                    <button type="button" onclick="saveSignature('petugas')" style="margin-top: 5px; font-size: 8px; padding: 3px 8px;">Save TTD</button>
                </td>
            </tr>
        </table>

        <!-- Tambahkan tombol ini di bagian bawah form BA (setelah tombol Simpan BA) -->
        <div id="baFormActions" style="text-align: center; margin-top: 20px;">
            <button type="button" onclick="saveDraft()"
                    style="padding: 10px 30px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt; margin-right: 10px;">
                <i class="fas fa-save"></i> Save Draft
            </button>
            <button type="button" onclick="saveBA()"
                    style="padding: 10px 30px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt; margin-right: 10px;">
                <i class="fas fa-save"></i> Simpan BA ke Database
            </button>
            <button type="button" onclick="closeBAForm()"
                    style="padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt;">
                <i class="fas fa-times"></i> Batal
            </button>
        </div>
    </div>
</div>

<!-- Scroll Progress Bar -->
<div class="scroll-progress" id="scrollProgress"></div>

<!-- Scroll to Top Button -->
<div id="scrollIndicator" class="scroll-indicator" onclick="scrollToTop()">
    <i class="fas fa-arrow-up"></i>
</div>

<!-- Tambahkan ini di dalam <body>, di atas modal scanner yang sudah ada -->
<!-- Modal Kamera -->
<div id="cameraModal" class="scanner-modal" style="display: none;">
    <div class="scanner-content">
        <div class="scanner-header">
            <h3 class="scanner-title">Ambil Foto</h3>
            <button class="close-scanner" onclick="closeCameraModal()">&times;</button>
        </div>

        <!-- Video untuk menampilkan preview kamera -->
        <video id="camera-video" class="scanner-video" autoplay playsinline></video>

        <div class="scanner-controls">
            <button class="scanner-btn capture-btn" onclick="capturePhoto()">
                <i class="fas fa-camera"></i> Ambil Foto
            </button>
            <button class="scanner-btn cancel-btn" onclick="closeCameraModal()">
                <i class="fas fa-times"></i> Batal
            </button>
        </div>
    </div>
</div>

<script>
    // === FIREBASE CONFIGURATION ===
const firebaseConfig = {
apiKey: "AIzaSyDtoOYW8SCReBXngT4kc_WtEdOo0LoGvdE",
authDomain: "ba-lmj.firebaseapp.com",
projectId: "ba-lmj",
storageBucket: "ba-lmj.appspot.com",
messagingSenderId: "757213966308",
appId: "1:757213966308:web:07d158f711b8c8037e21f1",
measurementId: "G-Q3J1T124PN"
};

// === GLOBAL VARIABLES ===
let firebaseApp;
let firestore;
let auth;
let currentUser = null;
let pelangganSigned = false;
let petugasSigned = false;
let currentScannerField = null;
let inactivityTimer;
const INACTIVITY_LIMIT = 10 * 60 * 1000; //10 menit dalam milidetik

// === FIREBASE INDEX MANAGEMENT ===
class FirebaseIndexManager {
constructor(firestore) {
    this.firestore = firestore;
    this.indexes = [
        {
            collection: 'ba_documents',
            fields: [
                { fieldPath: 'userEmail', order: 'ASCENDING' },
                { fieldPath: 'tanggalDibuat', order: 'DESCENDING' }
            ]
        },
        {
            collection: 'ba_documents',
            fields: [
                { fieldPath: 'tanggalDibuat', order: 'DESCENDING' }
            ]
        }
    ];
}

async createIndexes() {
    try {
        const projectId = firebaseConfig.projectId;
        const baseUrl = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/indexes`;

        for (const index of this.indexes) {
            try {
                const indexDefinition = {
                    name: `${baseUrl}?indexId=${this.generateIndexId(index)}`,
                    queryScope: 'COLLECTION',
                    fields: index.fields
                };

                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await this.getAuthToken()}`
                    },
                    body: JSON.stringify(indexDefinition)
                });

                if (response.ok) {
                    console.log('â Index created successfully:', index.collection);
                } else if (response.status === 409) {
                    console.log('â¹ï¸ Index already exists:', index.collection);
                } else {
                    console.warn('â ï¸ Failed to create index:', index.collection);
                }
            } catch (error) {
                console.warn('â ï¸ Error creating index:', error);
            }
        }
    } catch (error) {
        console.warn('â ï¸ Index creation failed:', error);
    }
}

generateIndexId(index) {
    const fields = index.fields.map(f => `${f.fieldPath}_${f.order}`).join('_');
    return `${index.collection}_${fields}`;
}

async getAuthToken() {
    try {
        const user = auth.currentUser;
        if (user) {
            return await user.getIdToken();
        }
    } catch (error) {
        console.warn('â ï¸ Could not get auth token:', error);
    }
    return null;
}

async waitForIndexes(maxWaitTime = 60000) {
    const startTime = Date.now();

    while (Date.now() - startTime < maxWaitTime) {
        try {
            await this.firestore.collection('ba_documents')
                .where('userEmail', '==', 'test@test.com')
                .orderBy('tanggalDibuat', 'desc')
                .limit(1)
                .get();

            console.log('â Indexes are ready');
            return true;
        } catch (error) {
            if (error.message.includes('requires an index')) {
                console.log('â³ Waiting for indexes to be ready...');
                await new Promise(resolve => setTimeout(resolve, 2000));
            } else {
                break;
            }
        }
    }

    return false;
}
}

// === INITIALIZE FIREBASE ===
async function initializeFirebase() {
try {
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDK tidak terload!');
        showNotification('Firebase SDK tidak terload. Muat ulang halaman.', 'error');
        return false;
    }

    firebaseApp = firebase.initializeApp(firebaseConfig);
    firestore = firebase.firestore();
    auth = firebase.auth();

    console.log('â Firebase initialized successfully');

    const indexManager = new FirebaseIndexManager(firestore);
    await indexManager.createIndexes();

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log('ð¤ User logged in:', user.email);
            await handleLoggedInUser(user);
        } else {
            console.log('ð¤ User logged out');
            currentUser = null;
        }
    });

    return true;

} catch (error) {
    console.error('â Firebase initialization error:', error);
    showNotification('Firebase gagal diinisialisasi. Periksa koneksi internet.', 'error');
    return false;
}
}

// === UPDATE USER UI FUNCTION ===
function updateUserUI() {
if (!currentUser) return;

const userNameEl = document.getElementById('userName');
const userRoleEl = document.getElementById('userRole');
const userAvatarEl = document.getElementById('userAvatar');

if (userNameEl) userNameEl.textContent = currentUser.name;
if (userRoleEl) userRoleEl.textContent = currentUser.jabatan || currentUser.role || 'User';
if (userAvatarEl) userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();

// --- PERBAIKAN: SEMBUNYIKAN MENU UNTUK TEKNISI ---
if (currentUser.role === 'teknisi') {
    // Sembunyikan menu Dashboard
    const dashboardMenu = document.querySelector('.sidebar-item[onclick*="dashboard"]');
    if (dashboardMenu) dashboardMenu.style.display = 'none';

    // Sembunyikan menu Manajemen Teknisi
    const technicianMenu = document.querySelector('.sidebar-item[onclick*="technician"]');
    if (technicianMenu) technicianMenu.style.display = 'none';

    // Sembunyikan menu Data Master
    const masterTechMenu = document.querySelector('.sidebar-item[onclick*="masterTech"]');
    if (masterTechMenu) masterTechMenu.style.display = 'none';
}
// --- AKHIR PERBAIKAN ---

console.log('User UI Updated:', {
    name: currentUser.name,
    role: currentUser.jabatan || currentUser.role,
    email: currentUser.email
});
}

// Fungsi ini akan dipanggil oleh tombol HTML
function requestCameraPermissionFromJS(fieldId) {
    // Simpan dulu field ID ke variabel global
    currentScannerField = fieldId; 
    
    // Kirim sinyal ke Kodular untuk meminta izin
    if (typeof window.AppInventor !== 'undefined') {
        window.AppInventor.setWebViewString('REQUEST_CAMERA_PERMISSION');
    } else {
        // Fallback jika tidak di webview (untuk testing di browser)
        console.log('Meminta izin kamera untuk field:', fieldId);
        // Di browser, kita coba langsung jalankan scanner
        startScanning(); 
    }
}

// Tambahkan variabel global untuk stream kamera
let cameraStream = null;
let currentPhotoField = null; // Untuk menyimpan field tempat foto akan disimpan

// Fungsi untuk membuka modal kamera
function openCameraModal(fieldId) {
    currentPhotoField = fieldId; // Simpan ID field tujuan
    const modal = document.getElementById('cameraModal');
    const video = document.getElementById('camera-video');

    modal.style.display = 'block';

    // Mintak akses kamera dan tampilkan preview di video
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(function(stream) {
                cameraStream = stream;
                video.srcObject = stream;
            })
            .catch(function(error) {
                console.error("Tidak dapat mengakses kamera:", error);
                showToast("Tidak dapat mengakses kamera. Pastikan izin kamera sudah diberikan.");
                closeCameraModal();
            });
    } else {
        showToast("Browser Anda tidak mendukung fitur kamera.");
        closeCameraModal();
    }
}

// Fungsi untuk menutup modal kamera
function closeCameraModal() {
    const modal = document.getElementById('cameraModal');
    const video = document.getElementById('camera-video');

    // Hentikan stream kamera untuk membebaskan sumber daya
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }

    video.srcObject = null;
    modal.style.display = 'none';
}

// Fungsi untuk mengambil foto dari video
function capturePhoto() {
    const video = document.getElementById('camera-video');

    // Buat elemen canvas sementara untuk menangkap frame
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');

    // Gambar frame video ke canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Ubah canvas menjadi data URL (format gambar)
    const dataUrl = canvas.toDataURL('image/jpeg');

    // Simpan data URL ke field yang dituju
    if (currentPhotoField) {
        // Di sini Anda bisa menampilkan foto yang diambil
        // Misalnya, dengan membuat elemen <img> baru
        const imgContainer = document.getElementById(currentPhotoField + '_preview');
        if (imgContainer) {
            imgContainer.src = dataUrl;
            imgContainer.style.display = 'block';
        }

        // Simpan data URL ke input hidden untuk disimpan ke database
        const hiddenInput = document.getElementById(currentPhotoField + '_data');
        if (hiddenInput) {
            hiddenInput.value = dataUrl;
        }
    }

    // Tutup modal kamera
    closeCameraModal();
    showToast("Foto berhasil diambil!");
}

// === MODIFIED HANDLE LOGGED IN USER FUNCTION ===
async function handleLoggedInUser(user) {
try {
    const userDoc = await firestore.collection('users').doc(user.uid).get();

    if (!userDoc.exists) {
        console.log('â User tidak terdaftar, auto logout:', user.email);
        await auth.signOut();
        showNotification('Akun Anda tidak terdaftar dalam sistem', 'error');
        return;
    }

    const userData = userDoc.data();

    currentUser = {
        id: user.uid,
        name: userData.name || user.email.split('@')[0],
        email: user.email,
        jabatan: userData.jabatan || 'Teknisi',
        role: userData.role || 'teknisi',
        avatar: user.email.charAt(0).toUpperCase(),
        mitra: userData.mitra || ''
    };

    if (document.getElementById('loginPage').style.display !== 'none') {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('dashboardPage').style.display = 'block';

        updateUserUI();

        if (currentUser.role === 'teknisi') {
            document.getElementById('namaTeknisiDisplay').textContent = currentUser.name;
            document.getElementById('namaTeknisiTTD').textContent = currentUser.name;

            if (currentUser.mitra) {
                document.querySelector('input[name="nama_mitra"]').value = currentUser.mitra;
            } else {
                loadUserMitraFromFirebase();
            }
        }

        loadDashboardData();
        loadTechnicians();
        loadBASaya();
        loadReports();
    }

    // --- TAMBAHKAN INI: INISIALISASI KOLEKSI FIRESTORE ---
    await initializeFirestoreCollections();
    // --- AKHIR TAMBAHAN ---

} catch (error) {
    console.error('Error handling logged in user:', error);
}
}

// === MODIFIED LOGIN FUNCTION ===
async function login() {
const email = document.getElementById('email').value;
const password = document.getElementById('password').value;

try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const user = userCredential.user;

    const userDoc = await firestore.collection('users').doc(user.uid).get();

    if (!userDoc.exists) {
        const isAdmin = email.includes('admin');

        await firestore.collection('users').doc(user.uid).set({
            name: email.split('@')[0],
            email: email,
            jabatan: isAdmin ? 'Admin' : 'Teknisi',
            role: isAdmin ? 'admin' : 'teknisi',
            mitra: '',
            status: 'active',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('dashboardPage').style.display = 'block';

    const isAdmin = email.includes('admin');
    currentUser = {
        id: user.uid,
        name: email.split('@')[0],
        email: email,
        jabatan: isAdmin ? 'Admin' : 'Teknisi',
        role: isAdmin ? 'admin' : 'teknisi',
        avatar: email.charAt(0).toUpperCase(),
        mitra: ''
    };

    updateUserUI();
    showDashboardContent();

    loadDashboardData();
    loadTechnicians();
    loadBASaya();
    loadReports();

    setupInactivityDetection();

} catch (error) {
    showNotification('Login gagal! Periksa email dan password Anda.', 'error');
    console.error(error);
}
}

// === AUTO LOGOUT FUNCTIONALITY ===
function resetInactivityTimer() {
clearTimeout(inactivityTimer);
inactivityTimer = setTimeout(() => {
    if (currentUser) {
        showNotification('Sesi Anda telah berakhir karena tidak ada aktivitas selama 10 menit', 'warning');
        logout();
    }
}, INACTIVITY_LIMIT);
}

function setupInactivityDetection() {
const events = [
    'mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'
];

events.forEach(event => {
    document.addEventListener(event, resetInactivityTimer, true);
});

resetInactivityTimer();
}

// === MODIFIED LOGOUT FUNCTION ===
async function logout() {
try {
    clearTimeout(inactivityTimer);

    if (auth) {
        await auth.signOut();
    }
} catch (error) {
    console.error('Logout error:', error);
}

currentUser = null;
document.getElementById('dashboardPage').style.display = 'none';
document.getElementById('baFormPage').style.display = 'none';
document.getElementById('loginPage').style.display = 'flex';

document.getElementById('email').value = '';
document.getElementById('password').value = '';
}

// === NEW FUNCTION TO SHOW DASHBOARD ===
function showDashboardContent() {
document.querySelectorAll('.content-area').forEach(el => {
    el.classList.remove('active');
});

document.getElementById('dashboardContent').classList.add('active');

document.querySelectorAll('.sidebar-item').forEach(el => {
    el.classList.remove('active');
});
document.querySelector('.sidebar-item').classList.add('active');

const header = document.querySelector('.header-left');
header.innerHTML = '<h1>Dashboard</h1><p>Sistem Manajemen Berita Acara</p>';
}

// === MODIFIED SHOW CONTENT FUNCTION ===
function showContent(contentId) {
// --- PERBAIKAN: CEK ROLE UNTUK MENU MASTER ---
if (contentId === 'masterTech' && currentUser.role !== 'admin') {
    showNotification('Anda tidak memiliki akses ke halaman ini', 'error');
    return; // Cegah teknisi membuka halaman
}
// --- AKHIR PERBAIKAN ---

updateUserUI();

document.querySelectorAll('.content-area').forEach(el => {
    el.classList.remove('active');
});

if (contentId === 'createBA' && window.innerWidth <= 768) {
    document.querySelector('.sidebar').classList.remove('open');
}

document.querySelectorAll('.sidebar-item').forEach(el => {
    el.classList.remove('active');
});

document.getElementById(contentId + 'Content').classList.add('active');
event.currentTarget.classList.add('active');

if (contentId === 'createBA') {
    setTimeout(() => {
        loadBASaya();
    }, 100);
}

const header = document.querySelector('.header-left');
if (contentId === 'technician') {
    header.innerHTML = '<h1>Manajemen Teknisi</h1><p>Kelola data teknisi</p>';
} else if (contentId === 'createBA') {
    header.innerHTML = '<h1>Buat Berita Acara</h1><p>Form pengisian BA</p>';
} else if (contentId === 'masterTech') {
    header.innerHTML = '<h1>Data Master</h1><p>Import dan kelola data master</p>';
} else if (contentId === 'reports') {
    header.innerHTML = '<h1>Laporan</h1><p>Analisis data BA</p>';
} else if (contentId === 'dashboard') {
    header.innerHTML = '<h1>Dashboard</h1><p>Sistem Manajemen Berita Acara</p>';
}
}

// === DASHBOARD FUNCTIONS ===
function loadDashboardData() {
const activities = [
    { no: 'BA-001', customer: 'Budi Santoso', technician: 'Ahmad Rizki', date: '2024-01-15', status: 'Selesai' },
    { no: 'BA-002', customer: 'Siti Aisyah', technician: 'Muhammad Ali', date: '2024-01-14', status: 'Pending' },
    { no: 'BA-003', customer: 'Joko Widodo', technician: 'Ahmad Rizki', date: '2024-01-13', status: 'Selesai' },
    { no: 'BA-004', customer: 'Ani Wijaya', technician: 'Budi Hartono', date: '2024-01-12', status: 'Selesai' },
    { no: 'BA-005', customer: 'Rina Melati', technician: 'Muhammad Ali', date: '2024-01-11', status: 'Pending' }
];

const tbody = document.getElementById('recentActivity');
if (tbody) {
    tbody.innerHTML = '';

    activities.forEach(activity => {
        const statusClass = activity.status === 'Selesai' ? 'status-active' : 'status-inactive';
        tbody.innerHTML += `
            <tr>
                <td>${activity.no}</td>
                <td>${activity.customer}</td>
                <td>${activity.technician}</td>
                <td>${activity.date}</td>
                <td class="${statusClass}">${activity.status}</td>
            </tr>
        `;
    });
}
}

// === TECHNICIAN MANAGEMENT ===
async function loadTechnicians() {
if (!currentUser || !currentUser.email || !auth || !auth.currentUser) {
    console.log('User tidak terautentikasi dengan benar, melewati loadTechnicians');
    return;
}

try {
    if (!firestore) return;

    showLoading('Memuat data teknisi...');

    let techniciansSnapshot;
    if (currentUser.role === 'admin') {
        // Admin: Bisa lihat semua
        techniciansSnapshot = await firestore.collection('users').get();
    } else {
        // Teknisi: Hanya lihat data miliknya sendiri
        techniciansSnapshot = await firestore.collection('users')
            .where('role', 'in', ['teknisi', 'admin']) // Filter untuk teknisi dan admin
            .get();
    }

    const tbody = document.getElementById('technicianTable');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (techniciansSnapshot.empty) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; color: #666; padding: 30px;">
                    <i class="fas fa-users-slash"></i> Belum ada data teknisi
                </td>
            </tr>
        `;
        hideLoading();
        return;
    }

    let index = 0;
    techniciansSnapshot.forEach(doc => {
        const tech = doc.data();
        // Filter lagi di client untuk memastikan teknisi hanya melihat yang sesuai aturan
        if (currentUser.role !== 'admin' && tech.email !== currentUser.email) {
            return; // Lewati jika bukan admin dan bukan emailnya sendiri
        }

        index++;
        tbody.innerHTML += `
            <tr>
                <td>${tech.name || 'Tidak ada nama'}</td>
                <td>${tech.email || 'Tidak ada email'}</td>
                <td>${tech.nik || '-'}</td>
                <td>
                    ${currentUser.role === 'admin' ? `
                        <select class="jabatan-select" data-id="${doc.id}" onchange="updateJabatan('${doc.id}', this.value)">
                            <option value="Teknisi" ${tech.jabatan === 'Teknisi' ? 'selected' : ''}>Teknisi</option>
                            <option value="Admin" ${tech.jabatan === 'Admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    ` : `
                        <span>${tech.jabatan || 'Teknisi'}</span>
                    `}
                </td>
                <td>
                    ${currentUser.role === 'admin' ? `
                        <input type="text" class="mitra-input" data-id="${doc.id}" value="${tech.mitra || ''}"
                               style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"
                               onchange="updateMitra('${doc.id}', this.value)">
                    ` : `
                        <span>${tech.mitra || '-'}</span>
                    `}
                </td>
                <td class="${tech.status === 'active' ? 'status-active' : 'status-inactive'}">${tech.status === 'active' ? 'Aktif' : 'Nonaktif'}</td>
                <td>
                    ${currentUser.role === 'admin' ? `
                        <button class="btn-action btn-toggle" onclick="toggleTechnician('${doc.id}')" title="Ubah Status">
                            ${tech.status === 'active' ? 'Nonaktifkan' : 'Aktifkan'}
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteTechnician('${doc.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
    });

    hideLoading();

} catch (error) {
    console.error('Error loading technicians:', error);
    const tbody = document.getElementById('technicianTable');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; color: #ff4757; padding: 30px;">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data
                </td>
            </tr>
        `;
    }
    hideLoading();
}
}

// === FUNGSI UPDATE JABATAN ===
async function updateJabatan(userId, newJabatan) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat mengubah jabatan');
    loadTechnicians();
    return;
}

if (confirm(`Ubah jabatan menjadi ${newJabatan}?`)) {
    try {
        await firestore.collection('users').doc(userId).update({
            jabatan: newJabatan,
            role: newJabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi'
        });

        showNotification('Jabatan berhasil diubah', 'success');
        loadTechnicians();

    } catch (error) {
        console.error('Error updating jabatan:', error);
        showNotification('Gagal mengubah jabatan', 'error');
    }
}
}

async function updateMitra(userId, newMitra) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat mengubah data mitra');
    return;
}

try {
    await firestore.collection('users').doc(userId).update({
        mitra: newMitra
    });

    if (userId === currentUser.id) {
        currentUser.mitra = newMitra;

        if (document.getElementById('baFormPage').style.display === 'block') {
            document.querySelector('input[name="nama_mitra"]').value = newMitra;
        }
    }

    console.log('Mitra berhasil diubah');

} catch (error) {
    console.error('Error updating mitra:', error);
    showNotification('Gagal mengubah mitra', 'error');
}
}

async function toggleTechnician(userId) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat mengubah status teknisi');
    return;
}

try {
    const userDoc = await firestore.collection('users').doc(userId).get();
    if (!userDoc.exists) return;

    const currentStatus = userDoc.data().status;
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';

    await firestore.collection('users').doc(userId).update({
        status: newStatus
    });

    showNotification(`Status berhasil diubah menjadi ${newStatus === 'active' ? 'Aktif' : 'Nonaktif'}`, 'success');
    loadTechnicians();

} catch (error) {
    console.error('Error toggling technician:', error);
    showNotification('Gagal mengubah status', 'error');
}
}

async function deleteTechnician(userId) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat menghapus teknisi');
    return;
}

if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
    try {
        await firestore.collection('users').doc(userId).delete();
        showNotification('User berhasil dihapus', 'success');
        loadTechnicians();
    } catch (error) {
        console.error('Error deleting user:', error);
        showNotification('Gagal menghapus user', 'error');
    }
}
}

function showAddUserModal() {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat menambahkan user');
    return;
}

document.getElementById('addUserModal').style.display = 'block';
document.getElementById('newUserError').style.display = 'none';
document.getElementById('newUserName').value = '';
document.getElementById('newUserNIK').value = '';
document.getElementById('newUserEmail').value = '';
document.getElementById('newUserPassword').value = '';
document.getElementById('newUserJabatan').value = 'Teknisi';
document.getElementById('newUserMitra').value = '';
}

function closeAddUserModal() {
document.getElementById('addUserModal').style.display = 'none';
}

async function submitNewUser() {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat menambahkan user');
    return;
}

const name = document.getElementById('newUserName').value.trim();
const nik = document.getElementById('newUserNIK').value.trim();
const email = document.getElementById('newUserEmail').value.trim();
const password = document.getElementById('newUserPassword').value;
const jabatan = document.getElementById('newUserJabatan').value;
const mitra = document.getElementById('newUserMitra').value.trim();

if (!name || !nik || !email || !password || password.length < 6) {
    document.getElementById('newUserError').textContent = 'Harap isi semua field dengan benar (password minimal 6 karakter)';
    document.getElementById('newUserError').style.display = 'block';
    return;
}

if (!/^\d+$/.test(nik)) {
    document.getElementById('newUserError').textContent = 'NIK hanya boleh berisi angka';
    document.getElementById('newUserError').style.display = 'block';
    return;
}

if (nik.length < 6) {
    document.getElementById('newUserError').textContent = 'NIK minimal 6 digit';
    document.getElementById('newUserError').style.display = 'block';
    return;
}

try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;

    await firestore.collection('users').doc(user.uid).set({
        name: name,
        nik: nik,
        email: email,
        jabatan: jabatan,
        role: jabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi',
        mitra: mitra,
        status: 'active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser.id
    });

    showNotification('Teknisi berhasil ditambahkan', 'success');
    closeAddUserModal();
    loadTechnicians();

} catch (error) {
    console.error('Error adding user:', error);
    let errorMessage = 'Gagal menambahkan user: ';

    switch (error.code) {
        case 'auth/email-already-in-use':
            errorMessage = 'Email sudah terdaftar';
            break;
        case 'auth/invalid-email':
            errorMessage = 'Format email tidak valid';
            break;
        case 'auth/weak-password':
            errorMessage = 'Password terlalu lemah';
            break;
        default:
            errorMessage += error.message;
    }

    document.getElementById('newUserError').textContent = errorMessage;
    document.getElementById('newUserError').style.display = 'block';
}
}

function searchTechnicians() {
const searchTerm = document.getElementById('searchTech').value.toLowerCase();
const rows = document.querySelectorAll('#technicianTable tr');

rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
});
}

function exportTechnicians() {
showNotification('Data teknisi berhasil diexport ke Excel', 'success');
}

function importTechData() {
showNotification('Fitur Import Data - Buka file Excel untuk import data teknisi', 'info');
}

function logoutApp() {
    // Tampilkan konfirmasi sebelum keluar
    if (confirm("Apakah Anda yakin ingin keluar dari aplikasi?")) {
        // Panggil fungsi exitApp() yang ada di MainActivity.java
        if (window.Android && typeof window.Android.exitApp === 'function') {
            window.Android.exitApp();
        } else {
            // Pesan ini akan muncul jika fungsi tidak ditemukan (berguna untuk debugging)
            alert("Fungsi logout tidak tersedia.");
        }
    }
}

// Di dalam file index.html, di dalam tag <script>



function initializeUI() {
    // Letakkan semua kode yang perlu dijalankan untuk menyiapkan UI di sini.
    // Contoh: kode yang menampilkan tombol hamburger.
    // Asumsi tombol hamburger Anda memiliki id="hamburger-icon"
    var hamburgerIcon = document.getElementById("hamburger-icon");
    if (hamburgerIcon) {
        hamburgerIcon.style.display = 'block'; // atau 'inline-block', 'flex', dll.
    }

    console.log("UI Initialized!"); // Pesan ini untuk debugging di konsol WebView
}

// Panggil fungsi ini saat halaman pertama kali dimuat
window.onload = function() {
    initializeUI();
    // Panggil fungsi lain yang perlu dijalankan saat load, jika ada
    showHomePage();
};

// ... fungsi lainnya seperti openNav, closeNav, handleAndroidBack, dll. ...


function handleAndroidBack() {
    // Contoh: Cek apakah sidebar sedang terbuka.
    // Asumsi lebar sidebar lebih dari 0 jika terbuka.
    var sidebar = document.getElementById("mySidebar");
    if (sidebar.style.width !== "0px" && sidebar.style.width !== "") {
        // Jika sidebar terbuka, tutup sidebar.
        closeNav();
        return true; // Beri tahu Java bahwa kita sudah menanganinya.
    }
    // Jika tidak ada yang perlu ditangani di JS, biarkan Java yang bekerja.
    return false;
}

// === MASTER DATA FUNCTIONS ===
async function loadMasterData() {
console.log('Memulai loadMasterData. currentUser:', currentUser);
try {
    if (!firestore) {
        console.error('Firestore tidak diinisialisasi.');
        return;
    }

    showLoading('Memuat data master...');

    console.log('Mencoba mengambil data dari koleksi users...');
    const usersSnapshot = await firestore.collection('users').get();

    const tbody = document.getElementById('masterTable');
    if (!tbody) {
        console.error('Elemen #masterTable tidak ditemukan.');
        return;
    }

    tbody.innerHTML = '';

    if (usersSnapshot.empty) {
        console.log('Snapshot users kosong.');
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; color: #666; padding: 30px;">
                    <i class="fas fa-database"></i> Belum ada data master
                </td>
            </tr>
        `;
        hideLoading();
        return;
    }

    let index = 0;
    usersSnapshot.forEach(doc => {
        const tech = doc.data();
        if (tech.role === 'teknisi' || tech.role === 'admin' ||
            tech.jabatan === 'Teknisi' || tech.jabatan === 'Admin') {
            index++;
            tbody.innerHTML += `
                <tr>
                    <td>${index}</td>
                    <td>${tech.name || 'Tidak ada nama'}</td>
                    <td>${tech.email || 'Tidak ada email'}</td>
                    <td>${tech.nik || '-'}</td>
                    <td>${tech.jabatan || 'Teknisi'}</td>
                    <td>${tech.mitra || '-'}</td>
                    <td>${tech.createdAt ? new Date(tech.createdAt.toDate()).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}</td>
                    <td style="display: flex; align-items: center; gap: 5px;">
                        <button class="btn-action btn-edit" onclick="editMaster('${doc.id}')" style="padding: 6px 8px;"><i class="fas fa-edit"></i></button>
                        <button class="btn-action btn-delete" onclick="deleteMaster('${doc.id}')" style="padding: 6px 8px;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }
    });

    hideLoading();

} catch (error) {
    console.error('Error spesifik dari Firestore:', error.code);
    console.error('Pesan error lengkap:', error.message);
    const tbody = document.getElementById('masterTable');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; color: #ff4757; padding: 30px;">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data. Cek console.
                </td>
            </tr>
        `;
    }
    hideLoading();
}
}

function renderMasterTable(data) {
const tbody = document.getElementById('masterTable');
if (!tbody) return;

tbody.innerHTML = '';

if (data.length === 0) {
    tbody.innerHTML = `
        <tr>
            <td colspan="7" style="text-align: center; color: #666; padding: 20px;">
                <i class="fas fa-database"></i> Belum ada data master
            </td>
        </tr>
    `;
    return;
}

data.forEach(item => {
    tbody.innerHTML += `
        <tr>
            <td>${item.no}</td>
            <td>${item.name}</td>
            <td>${item.email}</td>
            <td>${item.nik}</td>
            <td>${item.jabatan}</td>
            <td>${item.mitra}</td>
            <td>${item.importDate}</td>
        </tr>
    `;
});
}

function getSampleMasterData() {
return [
    { no: 1, name: 'Ahmad Rizki', email: 'ahmad@example.com', nik: 'TK001', jabatan: 'Teknisi', mitra: 'PT Mitra Abadi', importDate: '2024-01-10' },
    { no: 2, name: 'Muhammad Ali', email: 'ali@example.com', nik: 'TK002', jabatan: 'Teknisi', mitra: 'CV Teknik Sejahtera', importDate: '2024-01-10' },
    { no: 3, name: 'Budi Hartono', email: 'budi@example.com', nik: 'TK003', jabatan: 'Admin', mitra: 'PT Sistem Informasi', importDate: '2024-01-09' },
    { no: 4, name: 'Siti Aisyah', email: 'siti@example.com', nik: 'TK004', jabatan: 'Teknisi', mitra: 'PT Jaya Makmur', importDate: '2024-01-09' },
    { no: 5, name: 'Joko Susanto', email: 'joko@example.com', nik: 'TK005', jabatan: 'Teknisi', mitra: 'CV Mandiri Teknik', importDate: '2024-01-08' }
];
}

function searchMasterData() {
const searchTerm = document.getElementById('searchMaster').value.toLowerCase();
const rows = document.querySelectorAll('#masterTable tr');

rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
});
}

function importExcel() {
if (!currentUser || currentUser.role !== 'admin') {
    showNotification('Hanya Admin yang dapat import data', 'error');
    return;
}

document.getElementById('excelFile').click();
}

function showAddMasterModal() {
document.getElementById('addMasterModal').style.display = 'block';
document.getElementById('newMasterError').style.display = 'none';
// Kosongkan form
document.getElementById('newMasterName').value = '';
document.getElementById('newMasterNIK').value = '';
document.getElementById('newMasterEmail').value = '';
document.getElementById('newMasterJabatan').value = 'Teknisi';
document.getElementById('newMasterMitra').value = '';
}

function closeAddMasterModal() {
document.getElementById('addMasterModal').style.display = 'none';
}

async function submitNewMaster() {
const name = document.getElementById('newMasterName').value.trim();
const nik = document.getElementById('newMasterNIK').value.trim();
const email = document.getElementById('newMasterEmail').value.trim();
const jabatan = document.getElementById('newMasterJabatan').value;
const mitra = document.getElementById('newMasterMitra').value.trim();

if (!name || !nik || !email) {
    document.getElementById('newMasterError').textContent = 'Harap isi Nama, NIK, dan Email.';
    document.getElementById('newMasterError').style.display = 'block';
    return;
}

try {
    showLoading('Memeriksa data...');

    // --- CEK EMAIL SUDAH ADA ---
    const emailQuery = await firestore.collection('users').where('email', '==', email).get();
    if (!emailQuery.empty) {
        document.getElementById('newMasterError').textContent = 'Email sudah terdaftar.';
        document.getElementById('newMasterError').style.display = 'block';
        hideLoading();
        return;
    }

    // --- CEK NIK SUDAH ADA ---
    const nikQuery = await firestore.collection('users').where('nik', '==', nik).get();
    if (!nikQuery.empty) {
        document.getElementById('newMasterError').textContent = 'NIK sudah terdaftar.';
        document.getElementById('newMasterError').style.display = 'block';
        hideLoading();
        return;
    }

    // --- JIKA TIDAK ADA, BUAT USER BARU ---
    const tempPassword = 'Password123';
    const userCredential = await auth.createUserWithEmailAndPassword(email, tempPassword);
    const user = userCredential.user;

    await firestore.collection('users').doc(user.uid).set({
        name: name,
        nik: nik,
        email: email,
        jabatan: jabatan,
        role: jabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi',
        mitra: mitra,
        status: 'active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showNotification('Data master berhasil ditambahkan', 'success');
    closeAddMasterModal();
    refreshMaster(); // Refresh tabel

} catch (error) {
    console.error('Error adding master data:', error);
    let errorMessage = 'Gagal menambah data: ';
    if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'Email sudah terdaftar.';
    } else {
        errorMessage += error.message;
    }
    document.getElementById('newMasterError').textContent = errorMessage;
    document.getElementById('newMasterError').style.display = 'block';
    hideLoading();
}
}

function handleExcelUpload(input) {
const file = input.files[0];
if (file) {
    showNotification(`File ${file.name} berhasil diupload. Data sedang diproses...`, 'info');

    setTimeout(() => {
        const sampleData = getSampleMasterData();

        localStorage.setItem('masterData', JSON.stringify(sampleData));

        if (firestore) {
            sampleData.forEach(async (item, index) => {
                try {
                    const existingUser = await firestore.collection('users')
                        .where('email', '==', item.email)
                        .get();

                    if (existingUser.empty) {
                        const tempPassword = 'Password123';
                        const userCredential = await auth.createUserWithEmailAndPassword(item.email, tempPassword);
                        const user = userCredential.user;

                        await firestore.collection('users').doc(user.uid).set({
                            name: item.name,
                            email: item.email,
                            nik: item.nik,
                            jabatan: item.jabatan,
                            role: item.jabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi',
                            mitra: item.mitra,
                            status: 'active',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            importedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            importedBy: currentUser.id
                        });
                    }
                } catch (error) {
                    console.error('Error importing user:', item.email, error);
                }
            });
        }

        showNotification('Data berhasil diimport dari Excel', 'success');
        loadMasterData();
        loadTechnicians();
    }, 1500);
}
}

function refreshMaster() {
localStorage.removeItem('masterData');

if (firestore) {
    firestore.collection('users').get().then(snapshot => {
        const data = [];
        snapshot.forEach(doc => {
            const tech = doc.data();
            if (tech.role === 'teknisi' || tech.role === 'admin' ||
                tech.jabatan === 'Teknisi' || tech.jabatan === 'Admin') {
                data.push({
                    no: data.length + 1,
                    name: tech.name || 'Tidak ada nama',
                    email: tech.email || 'Tidak ada email',
                    nik: tech.nik || doc.id.substring(0, 8),
                    jabatan: tech.jabatan || 'Teknisi',
                    mitra: tech.mitra || '',
                    importDate: tech.createdAt ? new Date(tech.createdAt.toDate()).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
                });
            }
        });

        localStorage.setItem('masterData', JSON.stringify(data));
        renderMasterTable(data);

        showNotification('Data master diperbarui', 'success');
    }).catch(error => {
        console.error('Error refreshing master data:', error);
        showNotification('Gagal memperbarui data master', 'error');
    });
} else {
    renderMasterTable(getSampleMasterData());
    showNotification('Data master diperbarui', 'success');
}
}

// === BA FORM FUNCTIONS ===
function openBAForm() {
document.getElementById('dashboardPage').style.display = 'none';
document.getElementById('baFormPage').style.display = 'block';

if (window.innerWidth <= 768) {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.remove('open');
    }
}

// Generate nomor BA
const { counter } = getBACounter();
const now = new Date();
const tahun = now.getFullYear();
const bulan = String(now.getMonth() + 1).padStart(2, '0');
const nextNumber = counter + 1;
const nomorUrut = String(nextNumber).padStart(3, '0');
const noBA = `BA/${tahun}/${bulan}/${nomorUrut}`;

const noBADisplay = document.getElementById('noBADisplay');
if (noBADisplay) {
    noBADisplay.textContent = noBA;
}

// Isi data user jika login
if (currentUser) {
    const namaTeknisiDisplay = document.getElementById('namaTeknisiDisplay');
    if (namaTeknisiDisplay) {
        namaTeknisiDisplay.textContent = currentUser.name;
    }

    const namaTeknisiTTD = document.getElementById('namaTeknisiTTD');
    if (namaTeknisiTTD) {
        namaTeknisiTTD.textContent = currentUser.name;
    }

    // --- PERBAIKAN: AMBIL ULANG DATA MITRA DARI DATABASE ---
    const mitraSpan = document.getElementById('nama_mitra');
    if (mitraSpan) {
        if (currentUser.mitra) {
            mitraSpan.textContent = currentUser.mitra;
        } else {
            // Jika kosong, coba ambil lagi dari Firestore
            firestore.collection('users').doc(currentUser.id).get().then(doc => {
                if (doc.exists && doc.data().mitra) {
                    mitraSpan.textContent = doc.data().mitra;
                    currentUser.mitra = doc.data().mitra; // Update juga di variabel
                }
            });
        }
    }
}

// Set tanggal hari ini
const today = new Date().toISOString().split('T')[0];
const tanggalInput = document.querySelector('input[name="tanggal_lumajang"]');
if (tanggalInput) {
    tanggalInput.value = today;
}

// Setup canvas tanda tangan
setupSignatureCanvas();

// Setup validasi form
setupValidation();

// Reset status tanda tangan
pelangganSigned = false;
petugasSigned = false;

// Reset error styling
const signaturePelangganBox = document.getElementById('signaturePelangganBox');
if (signaturePelangganBox) {
    signaturePelangganBox.classList.remove('error');
}

const signaturePetugasBox = document.getElementById('signaturePetugasBox');
if (signaturePetugasBox) {
    signaturePetugasBox.classList.remove('error');
}

// Reset draft ID untuk form baru
resetDraftId();

// Coba load draft terakhir jika ada
const draftKeys = Object.keys(localStorage).filter(key => key.startsWith('ba_draft_'));
if (draftKeys.length > 0) {
    // Ambil draft terbaru user ini
    const latestDraftKey = draftKeys.reduce((latest, key) => {
        try {
            const draftData = JSON.parse(localStorage.getItem(key));
            if (draftData.userEmail === currentUser.email) {
                if (!latest || new Date(draftData.updatedAt) > new Date(latest.updatedAt)) {
                    return { key, data: draftData };
                }
            }
        } catch (e) {
            console.log('Error parsing draft:', e);
        }
        return latest;
    }, null);

    if (latestDraftKey) {
        if (confirm('Ada draft yang belum diselesaikan dari ' +
                   new Date(latestDraftKey.data.updatedAt).toLocaleString('id-ID') +
                   '. Apakah Anda ingin melanjutkan?')) {
            setTimeout(() => {
                loadDraft(latestDraftKey.data.id);
            }, 500);
        }
    }
}
}

// === VALIDATION FUNCTIONS ===
function setupValidation() {
const stoInput = document.querySelector('input[name="sto"]');
stoInput.addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});

const woInput = document.querySelector('input[name="no_permintaan"]');
woInput.addEventListener('input', function() {
    this.value = this.value.replace(/[^A-Za-z0-9]/g, '');
});

const inetInput = document.querySelector('input[name="no_inet"]');
inetInput.addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
});

const kontakInput = document.querySelector('input[name="no_kontak"]');
kontakInput.addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9+ -]/g, '');
});

document.querySelectorAll('.test-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const group = this.getAttribute('data-group');
        if (this.checked) {
            document.querySelectorAll(`.test-checkbox[data-group="${group}"]`).forEach(cb => {
                if (cb !== this) cb.checked = false;
            });
        }
    });
});
}

// Fungsi untuk mendapatkan/membuat draft ID
function getCurrentDraftId() {
let draftId = localStorage.getItem('currentDraftId');
if (!draftId) {
    draftId = 'draft_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('currentDraftId', draftId);
}
return draftId;
}

// Fungsi untuk reset draft ID
function resetDraftId() {
localStorage.removeItem('currentDraftId');
}

// Fungsi untuk menyimpan draft
async function saveDraft() {
if (!currentUser) return;

try {
    const draftId = getCurrentDraftId();
    const formData = {};

    // Kumpulkan semua data dari form
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio') {
            formData[input.name] = input.checked;
        } else {
            formData[input.name] = input.value;
        }
    });

    // Simpan data draft ke localStorage
    const draftData = {
        id: draftId,
        formData: formData,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        userEmail: currentUser.email,
        userName: currentUser.name,
        status: 'Draft'
    };

    localStorage.setItem(`ba_draft_${draftId}`, JSON.stringify(draftData));

    // Simpan juga ke Firestore untuk backup
    await saveDraftToFirestore(draftData);

    showNotification('Draft berhasil disimpan!', 'success');

    // Refresh list BA Saya
    loadBASaya();

} catch (error) {
    console.error('Error saving draft:', error);
    showNotification('Gagal menyimpan draft', 'error');
}
}

// Fungsi untuk menyimpan draft ke Firestore
async function saveDraftToFirestore(draftData) {
if (!firestore) return;

try {
    await firestore.collection('ba_drafts').doc(draftData.id).set({
        ...draftData,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
} catch (error) {
    console.error('Error saving draft to Firestore:', error);
}
}

// Fungsi untuk load draft dari localStorage atau Firestore
async function loadDraft(draftId) {
try {
    // Cek di localStorage dulu
    const localDraft = localStorage.getItem(`ba_draft_${draftId}`);

    if (localDraft) {
        const draftData = JSON.parse(localDraft);
        populateFormFromDraft(draftData);
        showNotification('Draft dimuat dari penyimpanan lokal', 'info');
        return;
    }

    // Jika tidak ada di localStorage, cek di Firestore
    if (firestore) {
        const draftDoc = await firestore.collection('ba_drafts').doc(draftId).get();

        if (draftDoc.exists) {
            const draftData = draftDoc.data();
            populateFormFromDraft(draftData);
            showNotification('Draft dimuat dari database', 'info');
        }
    }

} catch (error) {
    console.error('Error loading draft:', error);
    showNotification('Gagal memuat draft', 'error');
}
}

// Fungsi untuk mengisi form dari data draft
function populateFormFromDraft(draftData) {
if (!draftData.formData) return;

const formData = draftData.formData;

// Isi semua field
Object.keys(formData).forEach(key => {
    const input = document.querySelector(`[name="${key}"]`);
    if (input) {
        if (input.type === 'checkbox') {
            input.checked = formData[key];
        } else {
            input.value = formData[key] || '';
        }
    }
});

// Update nomor BA jika ada
if (draftData.noBA) {
    document.getElementById('noBADisplay').textContent = draftData.noBA;
}

// Load tanda tangan jika ada
loadSignatureFromDraft(draftData.id, 'pelanggan');
loadSignatureFromDraft(draftData.id, 'petugas');

// Set current draft ID
localStorage.setItem('currentDraftId', draftData.id);
}

// Fungsi untuk menghapus draft
async function deleteDraft(draftId) {
if (confirm('Apakah Anda yakin ingin menghapus draft ini?')) {
    try {
        // Hapus dari localStorage
        localStorage.removeItem(`ba_draft_${draftId}`);

        // Hapus tanda tangan dari localStorage
        localStorage.removeItem(`signature_pelanggan_${draftId}`);
        localStorage.removeItem(`signature_petugas_${draftId}`);

        // Hapus dari Firestore
        if (firestore) {
            await firestore.collection('ba_drafts').doc(draftId).delete();
        }

        showNotification('Draft berhasil dihapus', 'success');
        loadBASaya();

    } catch (error) {
        console.error('Error deleting draft:', error);
        showNotification('Gagal menghapus draft', 'error');
    }
}
}

// Fungsi untuk setup tanda tangan canvas
function setupSignatureCanvas() {
const canvases = {
    'pelanggan': document.getElementById('signature-pelanggan'),
    'petugas': document.getElementById('signature-petugas')
};

Object.keys(canvases).forEach(key => {
    const canvas = canvases[key];
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Clear canvas terlebih dahulu
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';

    function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        let x, y;

        if (e.type.includes('touch')) {
            x = e.touches[0].clientX - rect.left;
            y = e.touches[0].clientY - rect.top;
        } else {
            x = e.clientX - rect.left;
            y = e.clientY - rect.top;
        }
        return { x, y };
    }

    function startDrawing(e) {
        // --- PERBAIKAN: CEK STATUS TTD SEBELUM MENGGAMBAR ---
        if ((key === 'pelanggan' && pelangganSigned) || (key === 'petugas' && petugasSigned)) {
            return; // Cegah menggambar jika sudah disimpan
        }
        // --- AKHIR PERBAIKAN ---

        isDrawing = true;
        const pos = getPosition(e);
        [lastX, lastY] = [pos.x, pos.y];

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
    }

    function draw(e) {
        if (!isDrawing) return;

        const pos = getPosition(e);

        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();

        [lastX, lastY] = [pos.x, pos.y];
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath();
    }

    // Event listeners untuk touch
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        startDrawing(e);
    }, { passive: false });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        draw(e);
    }, { passive: false });

    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        stopDrawing();
    }, { passive: false });

    // Event listeners untuk mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
});
}

function clearSignature(type) {
const canvas = document.getElementById(`signature-${type}`);
const ctx = canvas.getContext('2d');
ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.fillStyle = 'white';
ctx.fillRect(0, 0, canvas.width, canvas.height);

// --- PERBAIKAN: RESET STATUS TTD DAN HAPUS DARI LOCALSTORAGE ---
if (type === 'pelanggan') {
    pelangganSigned = false;
    const draftId = getCurrentDraftId();
    localStorage.removeItem(`signature_pelanggan_${draftId}`);
} else if (type === 'petugas') {
    petugasSigned = false;
    const draftId = getCurrentDraftId();
    localStorage.removeItem(`signature_petugas_${draftId}`);
}
// --- AKHIR PERBAIKAN ---
}

// Fungsi untuk clear tanda tangan
function clearSignature(type) {
const canvas = document.getElementById(`signature-${type}`);
const ctx = canvas.getContext('2d');

// Clear canvas
ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.fillStyle = 'white';
ctx.fillRect(0, 0, canvas.width, canvas.height);

// Reset status tanda tangan
if (type === 'pelanggan') {
    pelangganSigned = false;
    document.getElementById('signaturePelangganBox').classList.add('error');
} else if (type === 'petugas') {
    petugasSigned = false;
    document.getElementById('signaturePetugasBox').classList.add('error');
}

// Hapus tanda tangan dari localStorage
const draftId = getCurrentDraftId();
localStorage.removeItem(`signature_${type}_${draftId}`);

showNotification(`Tanda tangan ${type} dihapus`, 'info');
}

// Fungsi untuk save tanda tangan
function saveSignature(type) {
const canvas = document.getElementById(`signature-${type}`);

// Cek apakah canvas memiliki tanda tangan
const ctx = canvas.getContext('2d');
const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
const isEmpty = !imageData.data.some(channel => channel !== 0);

if (isEmpty) {
    showNotification(`Tanda tangan ${type} masih kosong`, 'warning');
    return;
}

if (type === 'pelanggan') {
    pelangganSigned = true;
    showNotification('Tanda tangan pelanggan berhasil disimpan!', 'success');
} else if (type === 'petugas') {
    petugasSigned = true;
    showNotification('Tanda tangan petugas berhasil disimpan!', 'success');
}

// Simpan ke localStorage untuk draft
const signatureData = canvas.toDataURL('image/png');
const draftId = getCurrentDraftId();
localStorage.setItem(`signature_${type}_${draftId}`, signatureData);

// Hapus error styling
const signatureBox = document.getElementById(`signature${type.charAt(0).toUpperCase() + type.slice(1)}Box`);
if (signatureBox) {
    signatureBox.classList.remove('error');
    signatureBox.style.border = '';
    signatureBox.style.backgroundColor = '';
}
}

// Fungsi untuk load tanda tangan dari draft
function loadSignatureFromDraft(draftId, type) {
if (!draftId) return;

const signatureData = localStorage.getItem(`signature_${type}_${draftId}`);
if (signatureData) {
    const canvas = document.getElementById(`signature-${type}`);
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Update status tanda tangan
        if (type === 'pelanggan') {
            pelangganSigned = true;
            document.getElementById('signaturePelangganBox').classList.remove('error');
        } else if (type === 'petugas') {
            petugasSigned = true;
            document.getElementById('signaturePetugasBox').classList.remove('error');
        }
    };
    img.src = signatureData;
}
}

// Fungsi untuk setup validation form
function setupValidation() {
// Validasi STO harus uppercase
const stoInput = document.querySelector('input[name="sto"]');
if (stoInput) {
    stoInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });

    stoInput.addEventListener('blur', function() {
        if (this.value && this.value !== this.value.toUpperCase()) {
            this.classList.add('error-field');
            showNotification('STO harus dalam huruf kapital', 'warning');
        }
    });
}

// Validasi No Permintaan hanya huruf dan angka
const woInput = document.querySelector('input[name="no_permintaan"]');
if (woInput) {
    woInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^A-Za-z0-9]/g, '');
    });
}

// Validasi No Inet hanya angka
const inetInput = document.querySelector('input[name="no_inet"]');
if (inetInput) {
    inetInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
}

// Validasi No Kontak
const kontakInput = document.querySelector('input[name="no_kontak"]');
if (kontakInput) {
    kontakInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9+ -]/g, '');
    });
}

// Validasi checkbox test usage (hanya satu yang boleh dicentang per group)
document.querySelectorAll('.test-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const group = this.getAttribute('data-group');
        if (this.checked) {
            // Uncheck yang lain dalam group yang sama
            document.querySelectorAll(`.test-checkbox[data-group="${group}"]`).forEach(cb => {
                if (cb !== this) {
                    cb.checked = false;
                    cb.classList.remove('error-field');
                }
            });
            this.classList.remove('error-field');
        }
    });
});
}

// Fungsi untuk mendapatkan/membuat draft ID
function getCurrentDraftId() {
let draftId = localStorage.getItem('currentDraftId');
if (!draftId && currentUser) {
    draftId = 'draft_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('currentDraftId', draftId);
}
return draftId;
}

// Fungsi untuk reset draft ID
function resetDraftId() {
localStorage.removeItem('currentDraftId');
}

// Fungsi untuk load draft
async function loadDraft(draftId) {
try {
    // Set current draft ID
    localStorage.setItem('currentDraftId', draftId);

    // Cek di localStorage dulu
    const localDraft = localStorage.getItem(`ba_draft_${draftId}`);

    if (localDraft) {
        const draftData = JSON.parse(localDraft);
        populateFormFromDraft(draftData);
        return;
    }

    // Jika tidak ada di localStorage, cek di Firestore
    if (firestore) {
        const draftDoc = await firestore.collection('ba_drafts').doc(draftId).get();

        if (draftDoc.exists) {
            const draftData = draftDoc.data();
            populateFormFromDraft(draftData);
        }
    }

} catch (error) {
    console.error('Error loading draft:', error);
}
}

// Fungsi untuk mengisi form dari data draft
function populateFormFromDraft(draftData) {
if (!draftData || !draftData.formData) return;

const formData = draftData.formData;

// Isi semua field
Object.keys(formData).forEach(key => {
    const input = document.querySelector(`[name="${key}"]`);
    if (input) {
        if (input.type === 'checkbox') {
            input.checked = Boolean(formData[key]);
        } else {
            input.value = formData[key] || '';
        }
    }
});

// Update nomor BA jika ada
if (draftData.noBA) {
    document.getElementById('noBADisplay').textContent = draftData.noBA;
}

// Update status tanda tangan
if (draftData.pelangganSigned) {
    pelangganSigned = draftData.pelangganSigned;
    document.getElementById('signaturePelangganBox').classList.remove('error');
}

if (draftData.petugasSigned) {
    petugasSigned = draftData.petugasSigned;
    document.getElementById('signaturePetugasBox').classList.remove('error');
}

showNotification('Draft berhasil dimuat', 'success');
}

// Fungsi untuk save draft
async function saveDraft() {
if (!currentUser) {
    showNotification('Anda harus login untuk menyimpan draft', 'error');
    return;
}

try {
    const draftId = getCurrentDraftId();
    const formData = {};

    // Kumpulkan semua data dari form
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio') {
            formData[input.name] = input.checked;
        } else {
            formData[input.name] = input.value;
        }
    });

    // Data draft
    const draftData = {
        id: draftId,
        userId: currentUser.id, // TAMBAHKAN BARIS INI
        formData: formData,
        noBA: document.getElementById('noBADisplay').textContent,
        pelangganSigned: pelangganSigned,
        petugasSigned: petugasSigned,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        userEmail: currentUser.email,
        userName: currentUser.name,
        status: 'Draft'
    };

    // Simpan ke localStorage
    localStorage.setItem(`ba_draft_${draftId}`, JSON.stringify(draftData));

    // Simpan tanda tangan ke localStorage
    if (pelangganSigned) {
        const canvasPelanggan = document.getElementById('signature-pelanggan');
        const signaturePelanggan = canvasPelanggan.toDataURL('image/png');
        localStorage.setItem(`signature_pelanggan_${draftId}`, signaturePelanggan);
    }

    if (petugasSigned) {
        const canvasPetugas = document.getElementById('signature-petugas');
        const signaturePetugas = canvasPetugas.toDataURL('image/png');
        localStorage.setItem(`signature_petugas_${draftId}`, signaturePetugas);
    }

    // Simpan ke Firestore jika online
    if (firestore) {
        try {
            await firestore.collection('ba_drafts').doc(draftId).set({
                ...draftData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (firestoreError) {
            console.log('Gagal menyimpan draft ke Firestore, hanya disimpan lokal:', firestoreError);
        }
    }

    showNotification('Draft berhasil disimpan!', 'success');

    // Refresh list BA Saya
    loadBASaya();

} catch (error) {
    console.error('Error saving draft:', error);
    showNotification('Gagal menyimpan draft', 'error');
}
}

function validateRequiredFields() {
// Daftar field yang wajib diisi
const requiredFields = [
    'sto',
    'no_permintaan',
    'no_inet',
    'tanggal_wo',
    'nama_pelanggan',
    'no_kontak',
    'alamat_pelanggan',
    'ONT_yang_DIPASANG_/_DITARIK',
    'sn_ont',
    'stb_id'
];

let isValid = true;
let firstErrorField = null;

// Validasi field required
requiredFields.forEach(fieldName => {
    const field = document.querySelector(`input[name="${fieldName}"]`);
    if (field) {
        if (!field.value.trim()) {
            field.classList.add('error-field');
            isValid = false;
            if (!firstErrorField) firstErrorField = field;
        } else {
            field.classList.remove('error-field');
        }
    }
});

// Validasi STO harus uppercase
const stoField = document.querySelector('input[name="sto"]');
if (stoField && stoField.value.trim() !== stoField.value.trim().toUpperCase()) {
    stoField.classList.add('error-field');
    isValid = false;
    if (!firstErrorField) firstErrorField = stoField;
    showNotification('STO harus dalam huruf kapital', 'warning');
}

// Validasi checkbox test usage (hanya satu yang boleh dicentang per group)
const checkboxGroups = ['voice', 'inet', 'usetv'];
checkboxGroups.forEach(group => {
    const checkboxes = document.querySelectorAll(`.test-checkbox[data-group="${group}"]`);
    const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);

    if (checkedBoxes.length > 1) {
        checkboxes.forEach(cb => cb.classList.add('error-field'));
        isValid = false;
        if (!firstErrorField) firstErrorField = checkboxes[0];
        showNotification(`Pilih hanya satu opsi untuk tes ${group}`, 'warning');
    } else {
        checkboxes.forEach(cb => cb.classList.remove('error-field'));
    }
});

// Tambahkan ini di dalam fungsi updateUserUI()
function updateUserUI() {
if (!currentUser) return;

const userNameEl = document.getElementById('userName');
const userRoleEl = document.getElementById('userRole');
const userAvatarEl = document.getElementById('userAvatar');

if (userNameEl) userNameEl.textContent = currentUser.name;
if (userRoleEl) userRoleEl.textContent = currentUser.jabatan || currentUser.role || 'User';
if (userAvatarEl) userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();

// --- PERBAIKAN: SEMBUNYIKAN MENU DATA MASTER UNTUK TEKNISI ---
const masterTechMenu = document.querySelector('.sidebar-item[onclick*="masterTech"]');
if (masterTechMenu) {
    if (currentUser.role !== 'admin') {
        masterTechMenu.style.display = 'none';
    } else {
        masterTechMenu.style.display = 'flex'; // Kembalikan ke tampilan semula
    }
}
// --- AKHIR PERBAIKAN ---
}

// VALIDASI TANDA TANGAN WAJIB
// --- PERBAIKAN: CARI SIGNATURE BOX DENGAN BENAR ---
const canvasPelanggan = document.getElementById('signature-pelanggan');
const signaturePelangganBox = canvasPelanggan ? canvasPelanggan.closest('.signature-box') : null;

const canvasPetugas = document.getElementById('signature-petugas');
const signaturePetugasBox = canvasPetugas ? canvasPetugas.closest('.signature-box') : null;
// --- AKHIR PERBAIKAN ---

// Validasi TTD Petugas (WAJIB)
if (!petugasSigned) {
    if (signaturePetugasBox) {
        signaturePetugasBox.classList.add('error');
        signaturePetugasBox.style.border = '1px solid red';
        signaturePetugasBox.style.backgroundColor = 'rgba(255, 0, 0, 0.05)';

        // Tambahkan label error
        let errorLabel = signaturePetugasBox.querySelector('.signature-error');
        if (!errorLabel) {
            errorLabel = document.createElement('div');
            errorLabel.className = 'signature-error';
            errorLabel.innerHTML = '<i class="fas fa-exclamation-circle"></i> TTD wajib diisi';
            errorLabel.style.color = 'red';
            errorLabel.style.fontSize = '10px';
            errorLabel.style.marginTop = '5px';
            signaturePetugasBox.appendChild(errorLabel);
        }
    }

    isValid = false;
    if (!firstErrorField) {
        firstErrorField = canvasPetugas;
    }
} else {
    if (signaturePetugasBox) {
        signaturePetugasBox.classList.remove('error');
        signaturePetugasBox.style.border = '';
        signaturePetugasBox.style.backgroundColor = '';

        // Hapus label error jika ada
        const errorLabel = signaturePetugasBox.querySelector('.signature-error');
        if (errorLabel) {
            errorLabel.remove();
        }
    }
}

// Validasi TTD Pelanggan (WAJIB)
if (!pelangganSigned) {
    if (signaturePelangganBox) {
        signaturePelangganBox.classList.add('error');
        signaturePelangganBox.style.border = '1px solid red';
        signaturePelangganBox.style.backgroundColor = 'rgba(255, 0, 0, 0.05)';

        // Tambahkan label error
        let errorLabel = signaturePelangganBox.querySelector('.signature-error');
        if (!errorLabel) {
            errorLabel = document.createElement('div');
            errorLabel.className = 'signature-error';
            errorLabel.innerHTML = '<i class="fas fa-exclamation-circle"></i> TTD wajib diisi';
            errorLabel.style.color = 'red';
            errorLabel.style.fontSize = '10px';
            errorLabel.style.marginTop = '5px';
            signaturePelangganBox.appendChild(errorLabel);
        }
    }

    isValid = false;
    if (!firstErrorField) {
        firstErrorField = canvasPelanggan;
    }
} else {
    if (signaturePelangganBox) {
        signaturePelangganBox.classList.remove('error');
        signaturePelangganBox.style.border = '';
        signaturePelangganBox.style.backgroundColor = '';

        // Hapus label error jika ada
        const errorLabel = signaturePelangganBox.querySelector('.signature-error');
        if (errorLabel) {
            errorLabel.remove();
        }
    }
}

// Tampilkan notifikasi jika ada error
if (!isValid) {
    if (!petugasSigned && !pelangganSigned) {
        showNotification('Tanda tangan Petugas dan Pelanggan WAJIB diisi!', 'error');
    } else if (!petugasSigned) {
        showNotification('Tanda tangan Petugas WAJIB diisi!', 'error');
    } else if (!pelangganSigned) {
        showNotification('Tanda tangan Pelanggan WAJIB diisi!', 'error');
    } else {
        showNotification('Harap lengkapi semua field yang wajib diisi', 'error');
    }

    // Scroll ke field pertama yang error
    if (firstErrorField) {
        setTimeout(() => {
            firstErrorField.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // Jika field adalah input, focus ke field tersebut
            if (firstErrorField.tagName === 'INPUT' || firstErrorField.tagName === 'SELECT' || firstErrorField.tagName === 'TEXTAREA') {
                firstErrorField.focus();
            }
        }, 300);
    }
}

return isValid;
}

async function saveBA() {
if (!currentUser) {
    showNotification('Anda harus login terlebih dahulu', 'error');
    return;
}

if (!validateRequiredFields()) {
    showNotification('Harap lengkapi semua field yang wajib diisi', 'error');
    return;
}

try {
    const newCounter = incrementBACounter();

    const now = new Date();
    const tahun = now.getFullYear();
    const bulan = String(now.getMonth() + 1).padStart(2, '0');
    const nomorUrut = String(newCounter).padStart(3, '0');
    const noBA = `BA/${tahun}/${bulan}/${nomorUrut}`;

    // --- AMBIL DATA DARI FORM ---
    const tanggalField = document.querySelector('input[name="tanggal_lumajang"]');
    const noInetField = document.querySelector('input[name="no_inet"]');
    const namaPelangganField = document.querySelector('input[name="nama_pelanggan"]');
    const stoField = document.querySelector('input[name="sto"]');
    const noPermintaanField = document.querySelector('input[name="no_permintaan"]');
    const noTeleponField = document.querySelector('input[name="no_telepon"]');
    const tanggalWoField = document.querySelector('input[name="tanggal_wo"]');
    const tanggalTransaksiField = document.querySelector('input[name="tanggal_transaksi"]');
    const noKontakField = document.querySelector('input[name="no_kontak"]');
    const alamatPelangganField = document.querySelector('input[name="alamat_pelanggan"]');
    const ontDitarikField = document.querySelector('input[name="ONT_yang_DIPASANG_/_DITARIK"]');
    const snOntField = document.querySelector('input[name="sn_ont"]');
    const stbIdField = document.querySelector('input[name="stb_id"]');

    // --- AMBIL DATA TANDA TANGAN ---
    const canvasPelanggan = document.getElementById('signature-pelanggan');
    const canvasPetugas = document.getElementById('signature-petugas');

    const signaturePelanggan = canvasPelanggan ? canvasPelanggan.toDataURL('image/png') : null;
    const signaturePetugas = canvasPetugas ? canvasPetugas.toDataURL('image/png') : null;

    const baData = {
        id: 'BA-' + Date.now() + '-' + currentUser.id.substring(0, 4),
        noBA: noBA,
        tanggal: tanggalField ? tanggalField.value : '',
        noInet: noInetField ? noInetField.value : '',
        namaPelanggan: namaPelangganField ? namaPelangganField.value : '',
        namaTeknisi: currentUser.name,
        teknisiId: currentUser.id,
        userEmail: currentUser.email,
        createdBy: currentUser.id,
        status: 'Selesai',
        tanggalDibuat: new Date().toISOString(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        sto: stoField ? stoField.value : '',
        noPermintaan: noPermintaanField ? noPermintaanField.value : '',
        noTelepon: noTeleponField ? noTeleponField.value : '',
        tanggalWO: tanggalWoField ? tanggalWoField.value : '',
        tanggalTransaksi: tanggalTransaksiField ? tanggalTransaksiField.value : '',
        noKontak: noKontakField ? noKontakField.value : '',
        alamatPelanggan: alamatPelangganField ? alamatPelangganField.value : '',
        ontDitarik: ontDitarikField ? ontDitarikField.value : '',
        snOnt: snOntField ? snOntField.value : '',
        stbId: stbIdField ? stbIdField.value : '',
        testVoice: document.querySelector('input[name="voice_baik"]').checked ? 'baik' :
                 document.querySelector('input[name="voice_tidak"]').checked ? 'tidak' : '',
        testInet: document.querySelector('input[name="inet_baik"]').checked ? 'baik' :
                document.querySelector('input[name="inet_tidak"]').checked ? 'tidak' : '',
        testUseeTv: document.querySelector('input[name="usetv_baik"]').checked ? 'baik' :
                  document.querySelector('input[name="usetv_tidak"]').checked ? 'tidak' : '',
        // --- TAMBAHKAN TANDA TANGAN KE DATA ---
        mitra: currentUser.mitra,
        signaturePelanggan: signaturePelanggan,
        signaturePetugas: signaturePetugas
    };

    await firestore.collection('ba_documents').doc(baData.id).set(baData);

    showNotification(`BA berhasil disimpan!\nNo BA: ${noBA}`, 'success');

    resetBAForm();

    // --- PERBAIKAN: LANGSUNG REFRESH DAFTAR BA DAN LAPORAN ---
    setTimeout(() => {
        // Sembunyikan form BA
        document.getElementById('baFormPage').style.display = 'none';
        document.getElementById('dashboardPage').style.display = 'block';

        // Tampilkan konten "Buat BA" (tempat list BA)
        document.querySelectorAll('.content-area').forEach(el => {
            el.classList.remove('active');
        });
        document.getElementById('createBAContent').classList.add('active');

        // Refresh list BA
        loadBASaya();

        // Refresh laporan
        loadReports();
    }, 1500); // Dikurangi delay untuk memastikan data sudah tersimpan
    // --- AKHIR PERBAIKAN ---

} catch (error) {
    decrementBACounter();
    showNotification('Gagal menyimpan BA: ' + error.message, 'error');
}
}

async function initializeFirestoreCollections() {
if (!firestore) return;

try {
    // Coba ambil satu dokumen dari koleksi ba_documents
    const docRef = firestore.collection('ba_documents').doc('init_check');
    const doc = await docRef.get();

    // Jika dokumen tidak ada, buat koleksi dengan membuat dummy doc
    if (!doc.exists) {
        await docRef.set({
            initialized: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('â Koleksi ba_documents berhasil dibuat otomatis.');
    }
} catch (error) {
    console.error('â ï¸ Gagal menginisialisasi koleksi:', error);
}
}

// Update resetBAForm() untuk reset draft ID
function resetBAForm() {
document.querySelectorAll('#baFormPage input[type="text"], #baFormPage input[type="date"]').forEach(input => {
    input.value = '';
    input.classList.remove('error-field');
});

document.querySelectorAll('#baFormPage input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
});

clearSignature('pelanggan');
clearSignature('petugas');
pelangganSigned = false;
petugasSigned = false;

// Reset draft ID untuk form baru
resetDraftId();
}

async function loadUserMitraFromFirebase() {
if (!currentUser || !firestore) return;

try {
    const userDoc = await firestore.collection('users').doc(currentUser.id).get();

    if (userDoc.exists) {
        const userData = userDoc.data();
        currentUser.mitra = userData.mitra || '';

        if (currentUser.mitra) {
            document.querySelector('input[name="nama_mitra"]').value = currentUser.mitra;
        }
    }
} catch (error) {
    console.error('Error loading user mitra:', error);
}
}

// === BA LIST FUNCTIONS ===
// Update loadBASaya() untuk include draft:
async function loadBASaya() {
if (!currentUser) return;

try {
    showLoading('Memuat data BA...');

    // Array untuk menyimpan semua BA dan Draft
    let allItems = [];

    // 1. Load BA dari Firestore
    let baSnapshot;
    try {
        baSnapshot = await firestore.collection('ba_documents')
            .where('userEmail', '==', currentUser.email)
            .orderBy('tanggalDibuat', 'desc')
            .limit(20)
            .get();
    } catch (indexError) {
        baSnapshot = await firestore.collection('ba_documents')
            .where('userEmail', '==', currentUser.email)
            .limit(20)
            .get();
    }

    baSnapshot.forEach(doc => {
        const ba = doc.data();
        allItems.push({
            id: doc.id,
            type: 'BA',
            noBA: ba.noBA || 'Draft',
            tanggal: ba.tanggal || '-',
            namaPelanggan: ba.namaPelanggan || '-',
            noInet: ba.noInet || '-',
            sto: ba.sto || '-',
            status: ba.status || 'Selesai',
            createdAt: ba.tanggalDibuat || ba.createdAt
        });
    });

    // 2. Load Draft dari Firestore
    if (firestore) {
        try {
            const draftSnapshot = await firestore.collection('ba_drafts')
                .where('userEmail', '==', currentUser.email)
                .orderBy('updatedAt', 'desc')
                .limit(10)
                .get();

            draftSnapshot.forEach(doc => {
                const draft = doc.data();
                allItems.push({
                    id: doc.id,
                    type: 'DRAFT',
                    noBA: 'DRAFT',
                    tanggal: new Date(draft.updatedAt?.toDate() || draft.updatedAt).toLocaleDateString('id-ID'),
                    namaPelanggan: draft.formData?.nama_pelanggan || '-',
                    noInet: draft.formData?.no_inet || '-',
                    sto: draft.formData?.sto || '-',
                    status: 'Draft',
                    createdAt: draft.updatedAt?.toDate() || draft.updatedAt
                });
            });
        } catch (draftError) {
            console.log('Error loading drafts:', draftError);
        }
    }

    // 3. Load Draft dari localStorage
    const draftKeys = Object.keys(localStorage).filter(key => key.startsWith('ba_draft_'));
    draftKeys.forEach(key => {
        try {
            const draftData = JSON.parse(localStorage.getItem(key));
            if (draftData.userEmail === currentUser.email) {
                allItems.push({
                    id: draftData.id,
                    type: 'DRAFT_LOCAL',
                    noBA: 'DRAFT (Lokal)',
                    tanggal: new Date(draftData.updatedAt).toLocaleDateString('id-ID'),
                    namaPelanggan: draftData.formData?.nama_pelanggan || '-',
                    noInet: draftData.formData?.no_inet || '-',
                    sto: draftData.formData?.sto || '-',
                    status: 'Draft',
                    createdAt: draftData.updatedAt
                });
            }
        } catch (e) {
            console.log('Error parsing local draft:', e);
        }
    });

    // Sort semua item berdasarkan tanggal dibuat
    allItems.sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return dateB - dateA;
    });

    // Render ke table
    const tbody = document.getElementById('myBATable');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (allItems.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                    <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                    Belum ada BA atau draft
                </td>
            </tr>
        `;
        hideLoading();
        return;
    }

    allItems.forEach((item, index) => {
        const statusClass = item.status === 'Selesai' ? 'status-active' :
                         item.status === 'Draft' ? 'status-inactive' : '';
        const statusText = item.type === 'DRAFT' || item.type === 'DRAFT_LOCAL' ? 'Draft' : item.status;

        let actionButtons = '';

        if (item.type === 'BA') {
            actionButtons = `
                <button class="btn-action btn-edit" onclick="viewBASaya('${item.id}')" title="Lihat">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn-action btn-toggle" onclick="downloadBAPDF('${item.id}')" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn-action btn-delete" onclick="deleteBASaya('${item.id}')" title="Hapus">
                    <i class="fas fa-trash"></i>
                </button>
            `;
        } else {
            // Untuk draft
            actionButtons = `
                <button class="btn-action btn-edit" onclick="loadDraft('${item.id}'); openBAForm();" title="Edit Draft">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-action btn-delete" onclick="deleteDraft('${item.id}')" title="Hapus Draft">
                    <i class="fas fa-trash"></i>
                </button>
            `;
        }

        tbody.innerHTML += `
            <tr>
                <td>${item.noBA}</td>
                <td>${item.tanggal}</td>
                <td>${item.namaPelanggan}</td>
                <td>${item.noInet}</td>
                <td>${item.sto}</td>
                <td class="${statusClass}">${statusText}</td>
                <td>${actionButtons}</td>
            </tr>
        `;
    });

    hideLoading();

} catch (error) {
    console.error('Error loading BA:', error);
    const tbody = document.getElementById('myBATable');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #ff4757; padding: 30px;">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data
                </td>
            </tr>
        `;
    }
    hideLoading();
}
}

function refreshBASaya() {
console.log('Merefresh list BA...');
loadBASaya();
}

function filterBASaya() {
const searchTerm = document.getElementById('searchNoInetSaya').value.toLowerCase();
const rows = document.querySelectorAll('#myBATable tr');

rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
});
}

function exportBASaya() {
showNotification('Data BA berhasil diexport ke Excel!', 'success');
}

async function viewBASaya(id) {
try {
    showLoading('Memuat data BA...');

    const baDoc = await firestore.collection('ba_documents').doc(id).get();
    if (!baDoc.exists) {
        showNotification('Data BA tidak ditemukan', 'error');
        hideLoading();
        return;
    }
    const baData = baDoc.data();

    // Buka form BA
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('baFormPage').style.display = 'block';

    // --- 1. SEMBUNYIKAN SEMUA KONTROL YANG TIDAK PERLU ---
    // Sembunyikan kontrol ukuran kertas
    document.querySelector('.page-size-controls').style.display = 'none';

    // Sembunyikan tombol "Kembali ke Dashboard"
    const allButtonsInForm = document.querySelectorAll('#baFormPage button');
    allButtonsInForm.forEach(button => {
        if (button.innerHTML.includes('Kembali ke Dashboard')) {
            button.style.display = 'none';
        }
    });

    // --- PERBAIKAN KHUSUS UNTUK TOMBOL SIMPAN & BATAL ---
    // Sembunyikan seluruh container yang berisi tombol "Simpan BA" dan "Batal"
    const bottomActionButtons = document.querySelector('#baFormPage div[style*="text-align: center"][style*="margin-top: 20px;"]');
    if (bottomActionButtons) {
        bottomActionButtons.style.display = 'none';
    }

    // --- PERBAIKAN: SEMBUNYIKAN KONTAINER TOMBOL DI LUAR FORM ---
    const outerActionButtons = document.getElementById('baFormActions');
    if (outerActionButtons) {
        outerActionButtons.style.display = 'none';
    }

    // Sembunyikan tombol di dalam signature box
    const signatureButtons = document.querySelectorAll('#baFormPage button[onclick*="clearSignature"], #baFormPage button[onclick*="saveSignature"]');
    signatureButtons.forEach(button => button.style.display = 'none');

    // Sembunyikan tombol scan barcode
    const scanButtons = document.querySelectorAll('.scan-btn');
    scanButtons.forEach(button => button.style.display = 'none');

    // --- 2. TAMBAHKAN TOMBOL TUTUP ("X") ---
    let closeBtn = document.getElementById('viewModeCloseBtn');
    if (!closeBtn) {
        closeBtn = document.createElement('button');
        closeBtn.id = 'viewModeCloseBtn';
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = `
            position: fixed; top: 15px; right: 15px; z-index: 10000;
            background: #e74c3c; color: white; border: none; border-radius: 50%;
            width: 40px; height: 40px; font-size: 24px; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); transition: background-color 0.2s;
        `;
        closeBtn.onmouseover = () => closeBtn.style.backgroundColor = '#c0392b';
        closeBtn.onmouseout = () => closeBtn.style.backgroundColor = '#e74c3c';
        closeBtn.onclick = closeViewMode;
        document.body.appendChild(closeBtn);
    }

    // --- 3. ISI SEMUA DATA FIELD ---
    const fieldMap = {
        'sto': 'sto', 'noPermintaan': 'no_permintaan', 'noTelepon': 'no_telepon', 'noInet': 'no_inet',
        'tanggalWO': 'tanggal_wo', 'tanggalTransaksi': 'tanggal_transaksi', 'namaPelanggan': 'nama_pelanggan',
        'noKontak': 'no_kontak', 'alamatPelanggan': 'alamat_pelanggan', 'ontDitarik': 'ONT_yang_DIPASANG_/_DITARIK',
        'snOnt': 'sn_ont', 'stbId': 'stb_id'
    };
    for (const dbKey in fieldMap) {
        const htmlName = fieldMap[dbKey];
        const input = document.querySelector(`[name="${htmlName}"]`);
        if (input && baData[dbKey]) {
            input.value = baData[dbKey];
        }
    }

    if (baData.noBA) document.getElementById('noBADisplay').textContent = baData.noBA;
    if (baData.namaTeknisi) {
        document.getElementById('namaTeknisiDisplay').textContent = baData.namaTeknisi;
        document.getElementById('namaTeknisiTTD').textContent = baData.namaTeknisi;
    }
    if (baData.namaPelanggan) document.getElementById('namaPelangganTTD').textContent = baData.namaPelanggan;
    if (baData.tanggal) document.querySelector('input[name="tanggal_lumajang"]').value = baData.tanggal;

    if (baData.testVoice) document.querySelector(`input[name="voice_${baData.testVoice}"]`).checked = true;
    if (baData.testInet) document.querySelector(`input[name="inet_${baData.testInet}"]`).checked = true;
    if (baData.testUseeTv) document.querySelector(`input[name="usetv_${baData.testUseeTv}"]`).checked = true;

    // --- 4. NONAKTIFKAN SEMUA INPUT, KEUALI CANVAS ---
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(el => {
        if (el.id !== 'signature-pelanggan' && el.id !== 'signature-petugas') {
            el.disabled = true;
            el.style.cursor = 'not-allowed';
        }
    });

    // --- 5. LOAD TANDA TANGAN KE CANVAS ---
    function loadSignatureToCanvas(canvasId, signatureData) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (!signatureData) {
            canvas.disabled = true;
            canvas.style.cursor = 'not-allowed';
            return;
        }

        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.disabled = true;
            canvas.style.cursor = 'not-allowed';
        };
        img.onerror = function() {
            console.error("Gagal memuat gambar tanda tangan untuk:", canvasId);
            canvas.disabled = true;
            canvas.style.cursor = 'not-allowed';
        };
        img.src = signatureData;
    }

    // --- PERBAIKAN: PASTIKAN TANDA TANGAN DIMUAT DARI DATABASE ---
    loadSignatureToCanvas('signature-pelanggan', baData.signaturePelanggan);
    loadSignatureToCanvas('signature-petugas', baData.signaturePetugas);

    hideLoading();


} catch (error) {
    console.error('Error viewing BA:', error);
    hideLoading();
    showNotification('Gagal memuat data BA', 'error');
}
}

function closeViewMode() {
// Kembalikan tampilan ke dashboard
document.getElementById('baFormPage').style.display = 'none';
document.getElementById('dashboardPage').style.display = 'block';

// Hapus tombol "X"
const closeBtn = document.getElementById('viewModeCloseBtn');
if (closeBtn) closeBtn.remove();

// Tampilkan kembali semua kontrol yang disembunyikan
document.querySelector('.page-size-controls').style.display = 'block';

const allButtonsInForm = document.querySelectorAll('#baFormPage button');
allButtonsInForm.forEach(button => {
    if (button.innerHTML.includes('Kembali ke Dashboard')) {
        button.style.display = 'inline-block';
    }
});

const bottomActionButtons = document.querySelector('#baFormPage div[style*="text-align: center"][style*="margin-top: 20px;"]');
if (bottomActionButtons) {
    bottomActionButtons.style.display = 'block';
}

// --- PERBAIKAN: TAMPILKAN KEMBALI KONTAINER TOMBOL DI LUAR FORM ---
const outerActionButtons = document.getElementById('baFormActions');
if (outerActionButtons) {
outerActionButtons.style.display = 'block';
}

const signatureButtons = document.querySelectorAll('#baFormPage button[onclick*="clearSignature"], #baFormPage button[onclick*="saveSignature"]');
signatureButtons.forEach(button => button.style.display = 'inline-block');

const scanButtons = document.querySelectorAll('.scan-btn');
scanButtons.forEach(button => button.style.display = 'inline-flex');

// Aktifkan kembali semua input
document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(el => {
    el.disabled = false;
    el.style.cursor = 'default';
});

// Reset form agar bersih saat dibuka kembali
resetBAForm();
}

// Di dalam tag <script> di index.html

async function downloadBAPDF(id) {
    try {
        showLoading('Sedang menyiapkan PDF...');

        const baDoc = await firestore.collection('ba_documents').doc(id).get();
        if (!baDoc.exists) {
            showNotification('Data BA tidak ditemukan', 'error');
            hideLoading();
            return;
        }
        const baData = baDoc.data();

        // --- Sisipkan data ke form (kode ini tidak perlu diubah) ---
        const baFormPage = document.getElementById('baFormPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const element = document.getElementById('page-container');

        dashboardPage.style.display = 'none';
        baFormPage.style.display = 'block';
        baFormPage.style.visibility = 'hidden';
        baFormPage.style.position = 'absolute';
        baFormPage.style.left = '-9999px';

        // ... (kode untuk mengisi form tetap sama) ...
        const fieldMap = {
            'sto': 'sto', 'noPermintaan': 'no_permintaan', 'noTelepon': 'no_telepon', 'noInet': 'no_inet',
            'tanggalWO': 'tanggal_wo', 'tanggalTransaksi': 'tanggal_transaksi', 'namaPelanggan': 'nama_pelanggan',
            'noKontak': 'no_kontak', 'alamatPelanggan': 'alamat_pelanggan', 'ontDitarik': 'ONT_yang_DIPASANG_/_DITARIK',
            'snOnt': 'sn_ont', 'stbId': 'stb_id'
        };
        for (const dbKey in fieldMap) {
            const htmlName = fieldMap[dbKey];
            const input = document.querySelector(`[name="${htmlName}"]`);
            if (input && baData[dbKey]) {
                input.value = baData[dbKey];
            }
        }
        if (baData.noBA) document.getElementById('noBADisplay').textContent = baData.noBA;
        if (baData.namaTeknisi) {
            document.getElementById('namaTeknisiDisplay').textContent = baData.namaTeknisi;
            document.getElementById('namaTeknisiTTD').textContent = baData.namaTeknisi;
        }
        if (baData.namaPelanggan) document.getElementById('namaPelangganTTD').textContent = baData.namaPelanggan;
        if (baData.mitra) document.getElementById('nama_mitra').textContent = baData.mitra;
        if (baData.tanggal) document.querySelector('input[name="tanggal_lumajang"]').value = baData.tanggal;

        if (baData.testVoice) document.querySelector(`input[name="voice_${baData.testVoice}"]`).checked = true;
        if (baData.testInet) document.querySelector(`input[name="inet_${baData.testInet}"]`).checked = true;
        if (baData.testUseeTv) document.querySelector(`input[name="usetv_${baData.testUseeTv}"]`).checked = true;

        function loadSignatureToCanvas(canvasId, signatureData) {
            if (!signatureData) return;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = signatureData;
        }
        loadSignatureToCanvas('signature-pelanggan', baData.signaturePelanggan);
        loadSignatureToCanvas('signature-petugas', baData.signaturePetugas);

        setTimeout(() => {
            const elementsToHide = document.querySelectorAll('#baFormActions, .scan-btn, button[onclick*="clearSignature"], button[onclick*="saveSignature"]');
            elementsToHide.forEach(el => el.style.display = 'none');

            const opt = {
                margin: 5,
                filename: `${baData.noBA || 'BA'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1.5, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // --- PERUBAHAN KRUSIAL DI SINI ---
            // Output sebagai 'blob' lalu konversi ke Base64
            html2pdf().set(opt).from(element).outputPdf('blob').then(function(blob) {
                const reader = new FileReader();
                reader.onloadend = function() {
                    const base64data = reader.result.split(',')[1]; // Ambil bagian Base64 saja
                    const filename = `${baData.noBA || 'BA'}.pdf`;

                    // Panggil fungsi dari Android untuk menyimpan
                    if (typeof Android !== 'undefined' && Android.savePDF) {
                        Android.savePDF(base64data, filename);
                    } else {
                        showNotification("Error: Tidak dapat terhubung ke fungsi penyimpanan Android.", "error");
                    }

                    // Kembalikan tampilan
                    baFormPage.style.display = 'none';
                    baFormPage.style.visibility = 'visible';
                    baFormPage.style.position = 'fixed';
                    baFormPage.style.left = '0';
                    baFormPage.style.top = '0';
                    dashboardPage.style.display = 'block';
                    hideLoading();
                    resetBAForm();
                };
                reader.readAsDataURL(blob);
            }).catch((error) => {
                console.error('Error generating PDF:', error);
                showNotification('Gagal menghasilkan PDF', 'error');
                hideLoading();
            });

        }, 1500);

    } catch (error) {
        console.error('Error preparing PDF:', error);
        hideLoading();
        showNotification('Gagal menyiapkan PDF', 'error');
    }
}
async function deleteBASaya(id) {
if (confirm('Apakah Anda yakin ingin menghapus BA ini?')) {
    try {
        await firestore.collection('ba_documents').doc(id).delete();
        showNotification('BA berhasil dihapus!', 'success');
        loadBASaya();
    } catch (error) {
        console.error('Error deleting BA:', error);
        showNotification('Gagal menghapus BA', 'error');
    }
}
}

// === COUNTER FUNCTIONS ===
function getBACounter() {
const now = new Date();
const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

const counterKey = `baCounter_${yearMonth}`;
let counter = localStorage.getItem(counterKey) || 0;
counter = parseInt(counter);

return { counter, counterKey };
}

function incrementBACounter() {
const { counter, counterKey } = getBACounter();
const newCounter = counter + 1;
localStorage.setItem(counterKey, newCounter);
return newCounter;
}

function decrementBACounter() {
const { counter, counterKey } = getBACounter();
const newCounter = Math.max(0, counter - 1);
localStorage.setItem(counterKey, newCounter);
return newCounter;
}

// === SIGNATURE FUNCTIONS ===
function setupSignatureCanvas() {
const canvases = {
    'pelanggan': document.getElementById('signature-pelanggan'),
    'petugas': document.getElementById('signature-petugas')
};

Object.keys(canvases).forEach(key => {
    const canvas = canvases[key];
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Reset canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';

    function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        let x, y;

        if (e.type.includes('touch')) {
            x = e.touches[0].clientX - rect.left;
            y = e.touches[0].clientY - rect.top;
        } else {
            x = e.clientX - rect.left;
            y = e.clientY - rect.top;
        }
        return { x, y };
    }

    function startDrawing(e) {
        // Cek apakah sudah disimpan. Jika ya, cegah menggambar.
        if ((key === 'pelanggan' && pelangganSigned) || (key === 'petugas' && petugasSigned)) {
            return;
        }

        isDrawing = true;
        const pos = getPosition(e);
        [lastX, lastY] = [pos.x, pos.y];
    }

    function draw(e) {
        if (!isDrawing) return;

        const pos = getPosition(e);

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();

        [lastX, lastY] = [pos.x, pos.y];
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath();
    }

    // Event listeners untuk touch
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        startDrawing(e);
    }, { passive: false });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        draw(e);
    }, { passive: false });

    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        stopDrawing();
    }, { passive: false });

    // Event listeners untuk mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
});
}

function saveSignature(type) {
const canvas = document.getElementById(`signature-${type}`);
const ctx = canvas.getContext('2d');

// Cek apakah canvas kosong
const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
const isEmpty = !imageData.data.some(channel => channel !== 0 && channel !== 255); // Cek apakah ada selain putih (255) atau transparan (0)

if (isEmpty) {
    showNotification(`Tanda tangan ${type} masih kosong`, 'warning');
    return;
}

if (type === 'pelanggan') {
    pelangganSigned = true;
    showNotification('Tanda tangan pelanggan berhasil disimpan!', 'success');
} else if (type === 'petugas') {
    petugasSigned = true;
    showNotification('Tanda tangan petugas berhasil disimpan!', 'success');
}

// Simpan ke localStorage untuk draft
const signatureData = canvas.toDataURL();
const draftId = getCurrentDraftId();
localStorage.setItem(`signature_${type}_${draftId}`, signatureData);

// --- PERBAIKAN: TANDAI CANVAS SEBAGAI SUDAH DISIMPAN ---
canvas.dataset.saved = 'true';
}

function clearSignature(type) {
const canvas = document.getElementById(`signature-${type}`);
const ctx = canvas.getContext('2d');
ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.fillStyle = 'white';
ctx.fillRect(0, 0, canvas.width, canvas.height);

if (type === 'pelanggan') {
    pelangganSigned = false;
} else if (type === 'petugas') {
    petugasSigned = false;
}

// Hapus tanda tangan dari localStorage
const draftId = getCurrentDraftId();
localStorage.removeItem(`signature_${type}_${draftId}`);


}

// Tambahkan fungsi baru ini:
function loadSignatureFromDraft(draftId, type) {
const signatureData = localStorage.getItem(`signature_${type}_${draftId}`);
if (signatureData) {
    const canvas = document.getElementById(`signature-${type}`);
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        if (type === 'pelanggan') {
            pelangganSigned = true;
        } else if (type === 'petugas') {
            petugasSigned = true;
        }
    };
    img.src = signatureData;
}
}

// === SCANNER FUNCTIONS ===
function openScanner(fieldId) {
    currentScannerField = fieldId;
    document.getElementById('scannerModal').style.display = 'block';
    document.getElementById('manualInput').value = '';
}

function closeScanner() {
document.getElementById('scannerModal').style.display = 'none';
if (window.Quagga) {
    Quagga.stop();
}
currentScannerField = null;
}

function startScanning() {
    if (!currentScannerField) {
        showNotification("Terjadi kesalahan internal. Silakan coba lagi.", "error");
        return;
    }

    // Tutup modal dulu
    document.getElementById('scannerModal').style.display = 'none';

    // Buat instance dari html5-qrcode
    const html5QrCode = new Html5Qrcode("reader"); // 'reader' adalah ID div yang akan kita buat

    // Konfigurasi untuk kamera belakang
    const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.777778 // 16:9
    };

    // Fungsi saat barcode berhasil dipindai
    const onScanSuccess = (decodedText, decodedResult) => {
        // Isi field dengan hasil scan
        document.getElementById(currentScannerField).value = decodedText;
        showNotification('Barcode berhasil dipindai!', 'success');
        
        // HENTIKAN SCANNER dan tutup modal
        html5QrCode.stop().then((ignore) => {
            // Scanner berhenti
        }).catch((err) => {
            console.log(`Gagal menghentikan scanner: ${err}`);
        });
        
        // Hapus elemen reader dari modal
        const readerElement = document.getElementById('reader');
        if (readerElement) {
            readerElement.remove();
        }
    };
    
    // Fungsi jika gagal memulai scanner
    const onScanFailure = (errorMessage) => {
        // Biasanya error ini muncul di awal, bisa diabaikan
        // console.warn(`Kode scan gagal: ${errorMessage}`);
    };

    // Buat elemen div baru untuk menampung scanner
    const scannerContent = document.querySelector('.scanner-content');
    const existingReader = document.getElementById('reader');
    if (existingReader) {
        existingReader.remove();
    }
    const readerDiv = document.createElement('div');
    readerDiv.id = 'reader';
    readerDiv.style.width = '100%';
    readerDiv.style.height = '300px';
    scannerContent.insertBefore(readerDiv, scannerContent.firstChild);

    // Tampilkan modal lagi
    document.getElementById('scannerModal').style.display = 'block';

    // Mulai scanner dengan kamera belakang
    html5QrCode.start(
        { facingMode: "environment" }, 
        config,
        onScanSuccess,
        onScanFailure
    ).catch((err) => {
        console.error(`Gagal memulai scanner: ${err}`);
        showNotification('Gagal memulai kamera. Pastikan izin kamera sudah diberikan.', 'error');
        document.getElementById('scannerModal').style.display = 'none';
    });
}

// Modifikasi fungsi closeScanner untuk membersihkan
function closeScanner() {
    document.getElementById('scannerModal').style.display = 'none';
    // Coba hentikan scanner jika masih berjalan
    if (window.html5QrCode) {
        window.html5QrCode.stop().then(() => {
            console.log("Scanner berhasil dihentikan.");
        }).catch((err) => {
            console.log("Gagal menghentikan scanner.");
        });
    }
}

function useManualInput() {
const manualValue = document.getElementById('manualInput').value.trim();
if (manualValue && currentScannerField) {
    document.getElementById(currentScannerField).value = manualValue;
    showNotification('Kode manual berhasil dimasukkan!', 'success');
    closeScanner();
} else {
    showNotification('Masukkan kode barcode terlebih dahulu!', 'warning');
}
}

// === UTILITY FUNCTIONS ===
function showNotification(message, type = 'info') {
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    ${message}
`;

document.body.appendChild(notification);

setTimeout(() => {
    notification.classList.add('show');
}, 100);

setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 300);
}, 3000);
}

function showLoading(message = 'Memuat...') {
const overlay = document.getElementById('loadingOverlay');
const loadingText = overlay.querySelector('.loading-text');
loadingText.textContent = message;
overlay.style.display = 'flex';
}

function hideLoading() {
const overlay = document.getElementById('loadingOverlay');
overlay.style.display = 'none';
}

function changePageSize(size) {
const container = document.getElementById('page-container');
const sizeClass = size === 'A4 landscape' ? 'landscape' : size.toLowerCase().replace(' ', '-');

container.className = 'container-' + sizeClass;

document.querySelectorAll('.page-size-btn').forEach(btn => {
    btn.classList.remove('active');
});
event.target.classList.add('active');
}

function uploadImage(posisi, input) {
const file = input.files[0];
if (file) {
    const reader = new FileReader();

    reader.onload = function(e) {
        const imgId = posisi === 'kiri' ? 'logoKiri' : 'logoKanan';
        const placeholderId = posisi === 'kiri' ? 'placeholderKiri' : 'placeholderKanan';
        const img = document.getElementById(imgId);
        const placeholder = document.getElementById(placeholderId);

        img.src = e.target.result;
        img.style.display = 'block';
        placeholder.style.display = 'none';

        localStorage.setItem('logo_' + posisi, e.target.result);
    };

    reader.readAsDataURL(file);
}
}

function loadSavedImages() {
const logoKiri = localStorage.getItem('logo_kiri');
const logoKanan = localStorage.getItem('logo_kanan');

if (logoKiri) {
    const imgKiri = document.getElementById('logoKiri');
    const placeholderKiri = document.getElementById('placeholderKiri');
    imgKiri.src = logoKiri;
    imgKiri.style.display = 'block';
    placeholderKiri.style.display = 'none';
}

if (logoKanan) {
    const imgKanan = document.getElementById('logoKanan');
    const placeholderKanan = document.getElementById('placeholderKanan');
    imgKanan.src = logoKanan;
    imgKanan.style.display = 'block';
    placeholderKanan.style.display = 'none';
}
}

function resetImages() {
if (confirm('Reset semua logo ke default?')) {
    localStorage.removeItem('logo_kiri');
    localStorage.removeItem('logo_kanan');

    const imgKiri = document.getElementById('logoKiri');
    const placeholderKiri = document.getElementById('placeholderKiri');
    imgKiri.style.display = 'none';
    imgKiri.src = '';
    placeholderKiri.style.display = 'block';

    const imgKanan = document.getElementById('logoKanan');
    const placeholderKanan = document.getElementById('placeholderKanan');
    imgKanan.style.display = 'none';
    imgKanan.src = '';
    placeholderKanan.style.display = 'block';
}
}

function addResetButton() {
const controls = document.querySelector('.page-size-controls');
if (controls && !document.getElementById('resetImagesBtn')) {
    const resetBtn = document.createElement('button');
    resetBtn.id = 'resetImagesBtn';
    resetBtn.className = 'page-size-btn';
    resetBtn.innerHTML = '<i class="fas fa-redo"></i> Reset Logo';
    resetBtn.onclick = resetImages;
    resetBtn.style.marginTop = '10px';
    controls.appendChild(resetBtn);
}
}

function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
        // Mobile: toggle open/close
        sidebar.classList.toggle('open');
    } else {
        // Desktop: toggle collapsed/expanded
        const isCollapsed = sidebar.style.width === '80px' || sidebar.classList.contains('collapsed');

        if (isCollapsed) {
            sidebar.style.width = '260px';
            sidebar.classList.remove('collapsed');
            document.querySelector('.main-content').style.marginLeft = '260px';
        } else {
            sidebar.style.width = '80px';
            sidebar.classList.add('collapsed');
            document.querySelector('.main-content').style.marginLeft = '80px';
        }
    }

    // Ubah ikon hamburger
    const icon = document.querySelector('.hamburger-btn i');
    const isOpen = sidebar.classList.contains('open') || sidebar.classList.contains('collapsed');

    if (isOpen) {
        icon.classList.remove('fa-bars');
        icon.classList.add('fa-times');
    } else {
        icon.classList.remove('fa-times');
        icon.classList.add('fa-bars');
    }
}

function closeBAForm() {
// Cek apakah form dalam mode read-only (semua input disabled)
const isReadOnly = document.querySelector('#baFormPage input:disabled') !== null;

if (isReadOnly) {
    // Jika mode view, cukup tutup form tanpa reset atau konfirmasi
    document.getElementById('baFormPage').style.display = 'none';
    document.getElementById('dashboardPage').style.display = 'block';
    // Kembalikan judul header ke semula
    document.querySelector('.header-left h1').textContent = 'Buat Berita Acara';
    document.querySelector('.header-left p').textContent = 'Form pengisian BA';
    return;
}

// Logika lama untuk mode edit/buat baru
const draftId = getCurrentDraftId();
const hasDraft = localStorage.getItem(`ba_draft_${draftId}`);

if (hasDraft) {
    if (confirm('Apakah Anda ingin menyimpan draft sebelum keluar?')) {
        saveDraft();
    }
}

document.getElementById('baFormPage').style.display = 'none';
document.getElementById('dashboardPage').style.display = 'block';

// Reset form
resetBAForm();
}

function filterReports() {
const startDate = document.getElementById('startDate').value;
const endDate = document.getElementById('endDate').value;
const month = document.getElementById('monthFilter').value;
const inetSearch = document.getElementById('searchInet').value.toLowerCase();

showNotification(`Filter diterapkan:\nTanggal: ${startDate} - ${endDate}\nBulan: ${month}\nNo Internet: ${inetSearch}`, 'info');

loadReports();
}

function exportReports() {
showNotification('Laporan berhasil diexport ke Excel', 'success');
}

async function loadReports() {
if (!currentUser || !currentUser.email || !auth || !auth.currentUser) {
    console.log('User tidak terautentikasi dengan benar, melewati loadReports');
    return;
}

try {
    if (!firestore) return;

    showLoading('Memuat laporan...');

    let reportsSnapshot;
    if (currentUser.role === 'admin') {
        reportsSnapshot = await firestore.collection('ba_documents')
            .where('status', '==', 'Selesai')
            .orderBy('tanggalDibuat', 'desc')
            .limit(50)
            .get();
    } else {
        reportsSnapshot = await firestore.collection('ba_documents')
            .where('userEmail', '==', currentUser.email)
            .where('status', '==', 'Selesai')
            .orderBy('tanggalDibuat', 'desc')
            .limit(50)
            .get();
    }

    const tbody = document.getElementById('reportsTable');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (reportsSnapshot.empty) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                    <i class="fas fa-chart-bar"></i> Belum ada laporan
                </td>
            </tr>
        `;
        hideLoading();
        return;
    }

    let reportDocs = [];
    reportsSnapshot.forEach(doc => {
        reportDocs.push({ id: doc.id, data: doc.data() });
    });

    reportDocs.sort((a, b) => {
        const dateA = new Date(a.data.tanggalDibuat || 0);
        const dateB = new Date(b.data.tanggalDibuat || 0);
        return dateB - dateA;
    });

    reportDocs.forEach((doc) => {
        const report = doc.data;
        const statusClass = report.status === 'Selesai' ? 'status-active' : 'status-inactive';

        tbody.innerHTML += `
            <tr>
                <td>${report.noBA || doc.id}</td>
                <td>${report.tanggal || '-'}</td>
                <td>${report.namaPelanggan || '-'}</td>
                <td>${report.noInet || '-'}</td>
                <td>${report.namaTeknisi || '-'}</td>
                <td>${report.testVoice || report.testInet || report.testUseeTv || '-'}</td>
                <td class="${statusClass}">${report.status || 'Draft'}</td>
            </tr>
        `;
    });

    hideLoading();

} catch (error) {
    console.error('Error loading reports:', error);
    const tbody = document.getElementById('reportsTable');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #ff4757; padding: 30px;">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data
                </td>
            </tr>
        `;
    }
    hideLoading();
}
}

async function loadDrafts() {
console.log('ð§ ===== MULAI: loadDrafts() =====');
console.log('ð§ DEBUG: currentUser:', currentUser);
console.log('ð§ DEBUG: currentUser.role:', currentUser?.role);

if (!currentUser || !currentUser.email || !auth || !auth.currentUser) {
    console.log('â DEBUG: User tidak valid, keluar dari fungsi.');
    return;
}

try {
    if (!firestore) {
        console.log('â DEBUG: Firestore tidak ada, keluar dari fungsi.');
        return;
    }

    showLoading('Memuat drafts...');
    console.log('ð§ DEBUG: Loading ditampilkan.');

    let draftsSnapshot;
    if (currentUser.role === 'admin') {
        console.log('ð§ DEBUG: User adalah ADMIN. Mengeksekusi query untuk admin.');
        draftsSnapshot = await firestore.collection('ba_drafts').orderBy('updatedAt', 'desc').limit(10).get();
    } else {
        console.log('ð§ DEBUG: User adalah TEKNISI. Mengeksekusi query untuk teknisi.');
        draftsSnapshot = await firestore.collection('ba_drafts').where('userEmail', '==', currentUser.email).orderBy('updatedAt', 'desc').limit(10).get();
    }

    console.log('ð§ DEBUG: Query selesai dieksekusi. Menunggu hasil...');
    const snapshotResult = await draftsSnapshot;
    console.log('ð§ DEBUG: Hasil query diterima. Jumlah dokumen:', snapshotResult.size);
    console.log('ð§ DEBUG: Metadata query:', snapshotResult.metadata);
    console.log('ð§ DEBUG: Data snapshot:', snapshotResult);

    const tbody = document.getElementById('myBATable');
    if (!tbody) {
        console.log('â DEBUG: Elemen #myBATable tidak ditemukan di HTML.');
        return;
    }

    tbody.innerHTML = '';

    if (snapshotResult.empty) {
        console.log('ð§ DEBUG: Snapshot kosong, tampilkan pesan kosong.');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                    <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                    Belum ada draft
                </td>
            </tr>
        `;
        hideLoading();
        return;
    }

    let draftDocs = [];
    console.log('ð§ DEBUG: Memproses dokumen dari snapshot...');
    snapshotResult.forEach(doc => {
        console.log('ð§ DEBUG: Memproses dokumen:', doc.id, doc.data());
        draftDocs.push({ id: doc.id, data: doc.data() });
    });

    console.log('ð§ DEBUG: Data sebelum di-sort:', draftDocs);

    draftDocs.sort((a, b) => {
        const dateA = new Date(a.data.updatedAt || 0);
        const dateB = new Date(b.data.updatedAt || 0);
        return dateB - dateA;
    });

    console.log('ð§ DEBUG: Data setelah di-sort:', draftDocs);

    console.log('ð§ DEBUG: Mulai rendering ke HTML...');
    draftDocs.forEach((doc, index) => {
        const draft = doc.data;
        const statusClass = 'status-draft'; // Status khusus untuk draft

        const newRow = `
            <tr>
                <td>${draft.noBA || 'DRAFT'}</td>
                <td>${new Date(draft.updatedAt?.toDate() || draft.updatedAt).toLocaleDateString('id-ID')}</td>
                <td>${draft.formData?.nama_pelanggan || '-'}</td>
                <td>${draft.formData?.no_inet || '-'}</td>
                <td>-</td>
                <td>${draft.userEmail || '-'}</td>
                <td class="${statusClass}">Draft</td>
                <td>
                    <button class="btn-action btn-edit" onclick="loadDraft('${doc.id}'); openBAForm();" title="Edit Draft">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-action btn-delete" onclick="deleteDraft('${doc.id}')" title="Hapus Draft">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        console.log(`ð§ DEBUG: Menambah baris ke-${index + 1}:`, newRow);
        tbody.innerHTML += newRow;
    });

    console.log('ð§ DEBUG: Selesai rendering. Sembunyikan loading.');
    hideLoading();
    console.log('ð§ ===== SELESAI: loadDrafts() =====');

} catch (error) {
    console.error('â ===== ERROR: loadDrafts() =====');
    console.error('â ERROR: Pesan Error:', error.message);
    console.error('â ERROR: Kode Error:', error.code);
    console.error('â ERROR: Stack Trace:', error.stack);
    console.error('â ERROR: Objek Error Lengkap:', error);
    console.error('â ===== AKHIR ERROR =====');

    const tbody = document.getElementById('myBATable');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #ff4757; padding: 30px;">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data
                </td>
            </tr>
        `;
    }
    hideLoading();
}
}

// === SCROLL FUNCTIONALITY ===
function initScrollIndicator() {
const scrollIndicator = document.getElementById('scrollIndicator');
const scrollProgress = document.getElementById('scrollProgress');

if (!scrollIndicator || !scrollProgress) return;

function updateScrollProgress() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrollPercent = (scrollTop / scrollHeight) * 100;

    scrollProgress.style.width = scrollPercent + '%';

    if (scrollTop > 300) {
        scrollIndicator.classList.add('show');
    } else {
        scrollIndicator.classList.remove('show');
    }
}

window.scrollToTop = function() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
};

window.addEventListener('scroll', updateScrollProgress);

updateScrollProgress();
}

function enhanceBAFormScroll() {
const baFormPage = document.getElementById('baFormPage');
if (!baFormPage) return;

baFormPage.style.scrollBehavior = 'smooth';

const formInputs = baFormPage.querySelectorAll('input, textarea, select');
formInputs.forEach(input => {
    input.addEventListener('focus', function() {
        setTimeout(() => {
            const rect = this.getBoundingClientRect();
            const isInViewport = rect.top >= 0 && rect.bottom <= window.innerHeight;

            if (!isInViewport) {
                this.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }, 300);
    });
});
}

// === FUNGSI UNTUK MODAL PREVIEW PDF ===

// === FUNGSI UNTUK MODAL PREVIEW PDF ===

function showPDFPreview(pdfUrl, filename) {
const modal = document.getElementById('pdfPreviewModal');

// --- PERBAIKAN: CEK APAKAH MODAL ADA ---
if (!modal) {
    console.error('Error: Modal dengan ID "pdfPreviewModal" tidak ditemukan di HTML.');
    alert('Error: Elemen preview tidak ditemukan. Pastikan HTML untuk modal preview sudah ditambahkan dengan benar. Lihat console untuk detail.');
    return;
}

const iframe = document.getElementById('pdfPreviewFrame');
const downloadBtn = document.getElementById('downloadPdfFromPreviewBtn');

// --- PERBAIKAN: CEK APAKAH IFRAME ADA ---
if (!iframe) {
    console.error('Error: Iframe dengan ID "pdfPreviewFrame" tidak ditemukan di HTML.');
    alert('Error: Elemen preview tidak ditemukan. Pastikan HTML untuk modal preview sudah ditambahkan dengan benar. Lihat console untuk detail.');
    return;
}

// Set URL PDF ke iframe
iframe.src = pdfUrl;

// Set event listener untuk tombol download
// Hapus listener lama jika ada untuk mencegah duplikasi
const newDownloadBtn = downloadBtn.cloneNode(true);
downloadBtn.parentNode.replaceChild(newDownloadBtn, downloadBtn);

newDownloadBtn.addEventListener('click', () => {
    // Buat link sementara untuk mendownload
    const a = document.createElement('a');
    a.href = pdfUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Opsional: Tutup modal setelah download
    // closePDFPreview();
});

// Tampilkan modal
modal.style.display = 'block';
}

function closePDFPreview() {
const modal = document.getElementById('pdfPreviewModal');
const iframe = document.getElementById('pdfPreviewFrame');

if (!modal || !iframe) {
    // Jika elemen tidak ada, tidak perlu melakukan apa-apa
    return;
}

// Sembunyikan modal
modal.style.display = 'none';

// Kosongkan src iframe untuk menghentikan pemuatan
const currentSrc = iframe.src;
iframe.src = 'about:blank'; // Reset src ke halaman kosong

// Revoke URL untuk membebaskan memori
if (currentSrc && currentSrc.startsWith('blob:')) {
    URL.revokeObjectURL(currentSrc);
}
}

// === INITIALIZE ===
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Memulai inisialisasi...');

    showLoading('Menginisialisasi sistem...');

    const firebaseInitialized = await initializeFirebase();

    if (firebaseInitialized) {
        const today = new Date().toISOString().split('T')[0];
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');

        if (startDate) startDate.value = today;
        if (endDate) endDate.value = today;

        loadDashboardData();
        loadMasterData();
        loadReports();
    }

    loadSavedImages();
    addResetButton();

    setupInactivityDetection();

    // --- TOMBOL LOGIN ---
    const loginButton = document.getElementById('loginBtn');
    if (loginButton) {
        loginButton.addEventListener('click', login);
    }

    // --- SIDEBAR UNTUK MOBILE ---
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('open');
            }
        });
    });

    // --- TUTUP FORM BA DENGAN ESCAPE ---
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('baFormPage').style.display === 'block') {
            closeBAForm();
        }
    });

    // --- TUTUP SIDEBAR DI LUAR AREA KLIK ---
    document.addEventListener('click', function(event) {
        const sidebar = document.querySelector('.sidebar');
        const hamburger = document.querySelector('.hamburger-btn');
        const hamburgerIcon = document.querySelector('.hamburger-btn i');

        if (window.innerWidth <= 768 &&
            sidebar.classList.contains('open') &&
            !sidebar.contains(event.target) &&
            !hamburger.contains(event.target) &&
            event.target !== hamburger) {

            sidebar.classList.remove('open');
            hamburgerIcon.classList.remove('fa-times');
            hamburgerIcon.classList.add('fa-bars');
        }
    });

    // --- INISIALISASI SCROLL ---
    initScrollIndicator();
    enhanceBAFormScroll();

    setTimeout(() => {
        hideLoading();
    }, 1000);
});


</script>
</body>
</html>
