<!DOCTYPE html>
<html lang="id">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Sistem Berita Acara</title>

    <style type="text/css">
        /* ==========================================================================
           GLOBAL & UTILITY STYLES
           ========================================================================== */
        html, body {
    margin: 0;
    padding: 0;
    background-color: #f0f0f0;
    overscroll-behavior-y: contain;
    overflow-x: hidden; /* ← TAMBAH INI */
    width: 100%;
    max-width: 100%;
}

        /* Field validation styles */
        .required-field {
            position: relative;
        }
        .required-field::after {
            content: " *";
            color: red;
            position: absolute;
            right: -10px;
            top: 0;
        }
        .error-field {
            border-bottom: 2px solid red !important;
            background-color: rgba(255, 0, 0, 0.05) !important;
        }

        /* General input & table styles */
        input[type="text"], input[type="date"], input[type="email"], input[type="password"], input[type="file"], select, textarea {
            border: none;
            border-bottom: 1px solid #000;
            background: transparent;
            font-family: Arial;
            font-size: 9pt;
            width: 100%;
            padding: 2px;
            box-sizing: border-box;
            color: #000;
        }
        input[type="checkbox"] {
            margin-right: 3px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        td {
            padding: 3px;
            vertical-align: top;
        }
        .main-table {
            width: 100%;
            border: 1px solid #000;
        }
        .main-table td {
            border: 1px solid #000;
            padding: 5px;
        }
        .data-table {
            width: 100%;
            border: none;
        }
        .data-table td {
            border: none;
            padding: 2px;
        }

        /* Buttons */
        .scan-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 8pt;
            cursor: pointer;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .scan-btn i { font-size: 10px; }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }

        /* ==========================================================================
       LOGIN PAGE STYLES (REDESIGNED)
       ========================================================================== */
    #loginPage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    #loginPage::before {
        content: '';
        position: absolute;
        width: 150%;
        height: 150%;
        background-color: #e74c3c;
        top: 25%;
        right: -75%;
        border-radius: 50%;
        z-index: -1;

    }
    .login-container {
        background: #ffffff; /* Solid white background */
        border-radius: 8px;
        padding: 48px;
        width: 90%;
        max-width: 250px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.08); /* Subtle, soft shadow */
        border: 3px solid #e1e4e8; /* Light border for definition */
        text-align: center;
    }
    .login-header {
        margin-bottom: 32px;
    }
    .login-header h2 {
        color: #24292e; /* Dark, professional text color */
        font-size: 15px;
        font-weight: 600;
        margin: 0 0 8px;
    }
    .login-header p {
        color: #000000; /* Muted gray for subtext */
        font-size: 16px;
        font-weight: 500;
        margin: 0;
    }
    /* Removed the tech animation for a cleaner look */
    .login-form {
        margin-top: 0;
    }
    .form-group {
        margin-bottom: 20px;
        text-align: left;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #24292e;
        font-weight: 500;
        font-size: 14px;
    }
    .form-group input {
        width: 50%;
        padding: 12px 16px;
        border: 1px solid #d1d5da;
        border-radius: 6px;
        font-size: 15px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background-color: #ffffff;
        box-sizing: border-box;
    }
    .form-group input:focus {
        outline: none;
        border-color: #e74c3c; /* Red accent on focus */
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.15); /* Subtle red glow */
    }
    .login-btn {
        width: 50%;
        padding: 5px;
        background-color: #e74c3c; /* Solid red, no gradient for a cleaner look */
        color: #ffffff;
        border: 1px solid transparent;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        margin-top: 8px;
    }
    .login-btn:hover {
        background-color: #c0392b; /* Darker red on hover */
    }
    .login-btn:active {
        background-color: #a93226; /* Even darker on active */
    }
    .error-message {
        color: #e74c3c;
        font-size: 13px;
        margin-top: 6px;
        display: none;
        font-weight: 500;
    }

        /* ==========================================================================
           DASHBOARD & MAIN LAYOUT STYLES
           ========================================================================== */
        #dashboardPage {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            z-index: 9998;
            overflow-y: auto;
        }
        .main-content {
    margin-left: 260px;
    padding: 25px;
    transition: margin-left 0.3s ease;
    min-height: 100vh;
    overflow-y: auto;
    overflow-x: hidden; /* ← PASTIKAN ADA */
    margin-top: 70px;
    height: calc(100vh - 70px);
    width: calc(100% - 260px); /* ← TAMBAH INI */
    max-width: calc(100% - 260px); /* ← TAMBAH INI */
    box-sizing: border-box; /* ← TAMBAH INI */
}

                /* --- MODERN & CLEAN HEADER --- */
        .header {
            background: #ffffff;
            padding: 0 25px;
            border-radius: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0; /* ← UBAH: 30px → 0 */
            height: 70px;
            position: fixed; /* ← UBAH: sticky → fixed */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .header-left h1 {
            color: #2c3e50;
            font-size: 24px;
            margin: 0;
            font-weight: 700;
        }
        .header-left p {
            display: none; /* Sembunyikan subjudul */
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* --- CLEAN USER INFO --- */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-right: 20px;
            border-right: 1px solid #eaeaea; /* Pemisah visual */
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e74c3c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }
        .user-details {
            text-align: right;
        }
        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            line-height: 1.2;
        }
        .user-role {
            font-size: 12px;
            color: #7f8c8d;
        }
        .logout-btn {
            background-color: transparent;
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 4px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 10px;
            font-weight: 500;
        }
        .logout-btn:hover {
            background-color: #e74c3c;
            color: white;
        }

        /* --- NEW & IMPROVED SIDEBAR --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: #ffffff;
            transition: left 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 20px rgba(0,0,0,0.06);
            overflow-y: auto;
            border-right: 1px solid #e8e8e8;
        }
        .sidebar-header {
            padding: 28px 24px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
            position: relative;
        }
        .sidebar-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 24px;
            right: 24px;
            height: 2px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        .sidebar-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .sidebar-header h3 i { color: #e74c3c; font-size: 20px; }
        .sidebar-menu { padding: 20px 0; }
        .sidebar-item {
            padding: 16px 24px;
            color: #64748b;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 2px 16px;
            border-radius: 0 8px 8px 0;
            position: relative;
        }
        .sidebar-item:hover {
            color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.08) 0%, rgba(231, 76, 60, 0.02) 100%);
            border-left-color: #e74c3c;
            transform: translateX(2px);
        }
        .sidebar-item.active {
            color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.12) 0%, rgba(231, 76, 60, 0.04) 100%);
            border-left-color: #e74c3c;
            font-weight: 600;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.1);
        }
        .sidebar-item i {
            font-size: 18px;
            width: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .sidebar-item:hover i,
        .sidebar-item.active i { transform: scale(1.1); }

       /* --- NEW & IMPROVED HAMBURGER BUTTON --- */
/* Tampilkan hamburger hanya di mobile */


@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}


        /* === HORIZONTAL SCROLL CARD CONTAINER === */
.horizontal-scroll-container {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    gap: 15px;
    padding: 15px 5px;
    margin: 15px 0;
    scrollbar-width: thin;
    scrollbar-color: #e74c3c #f0f0f0;
    -webkit-overflow-scrolling: touch;
}

/* Hide scrollbar tapi tetap bisa scroll */
.horizontal-scroll-container::-webkit-scrollbar {
    height: 6px;
}

.horizontal-scroll-container::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 3px;
}

.horizontal-scroll-container::-webkit-scrollbar-thumb {
    background: #e74c3c;
    border-radius: 3px;
}

/* Card di dalam horizontal container */
.horizontal-card {
    flex: 0 0 auto;
    width: 300px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #eee;
    transition: all 0.3s ease;
}

.horizontal-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* Ukuran untuk mobile */
@media screen and (max-width: 768px) {
    .horizontal-card {
        width: 280px;
        padding: 15px;
    }
    
    .horizontal-scroll-container {
        padding: 10px 5px;
        margin: 10px -15px 10px -15px;
    }
}
        
        /* --- NEW & IMPROVED CARDS & CONTENT AREA --- */
        .content-area {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
    overflow-x: hidden; /* ← TAMBAH INI */
    width: 100%; /* ← TAMBAH INI */
    max-width: 100%; /* ← TAMBAH INI */
}
        .content-area.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
       .cards-container {
    grid-template-columns: repeat(2, 1fr) !important; /* 2 KOLOM */
    gap: 12px;
    padding: 10px;
    overflow-x: hidden; /* ← TAMBAH INI */
    width: 100%; /* ← TAMBAH INI */
    max-width: 100%; /* ← TAMBAH INI */
    box-sizing: border-box; /* ← TAMBAH INI */
}
        .card {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
    max-width: 100%; /* ← TAMBAH INI */
    box-sizing: border-box; /* ← TAMBAH INI */
}
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.05) 0%, rgba(231, 76, 60, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        .card:hover::after { opacity: 1; }
        .card-icon {
            width: 70px;
            height: 70px;
            border-radius: 16px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            color: white;
            font-size: 30px;
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3);
            position: relative;
            overflow: hidden;
        }
        .card-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
            animation: shine 3s infinite;
        }
        .card h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 20px;
            font-weight: 600;
            position: relative;
        }
        .card p {
            color: #7f8c8d;
            font-size: 15px;
            line-height: 1.6;
            font-weight: 400;
        }

        /* --- TABLES, FORMS, BUTTONS STYLES (Mostly unchanged but cleaned up) --- */
        .table-container {
                background: white;
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 6px 25px rgba(0,0,0,0.08);
                overflow-x: auto; /* ← BIARKAN INI */
                overflow-y: hidden;
                border: 1px solid rgba(0,0,0,0.05);
                max-width: 100%;
            }

            /* Scrollbar styling */
            .table-container::-webkit-scrollbar {
                height: 8px;
            }

            .table-container::-webkit-scrollbar-thumb {
                background: #e74c3c;
                border-radius: 4px;
            }
        .table-title {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .table-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .table-controls input, .table-controls select, .table-controls button {
            padding: 10px 18px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .table-controls input:focus, .table-controls select:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .table-controls button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        .table-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        .data-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px 18px;
            text-align: left;
            color: #2c3e50;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        .data-table td {
            padding: 15px 18px;
            border-bottom: 1px solid #ecf0f1;
            color: #495057;
            font-size: 14px;
        }
        .data-table tr:hover { background: #f8f9fa; }
        .status-active {
            color: #27ae60;
            font-weight: 600;
            background: rgba(39, 174, 96, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .status-inactive {
            color: #e74c3c;
            font-weight: 600;
            background: rgba(231, 76, 60, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .btn-action {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            margin: 2px;
        }
        .btn-edit { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .btn-delete { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .btn-toggle { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .form-container {
            background: white;
            border-radius: 16px;
            padding: 35px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .form-group { margin-bottom: 25px; }
        .form-row { display: flex; gap: 25px; margin-bottom: 25px; }
        .form-row .form-group { flex: 1; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .btn-submit {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 14px 35px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }
        .jabatan-select {
            padding: 6px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-width: 110px;
            transition: all 0.3s ease;
        }
        .jabatan-select:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .jabatan-select:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ==========================================================================
           MODALS, NOTIFICATIONS, OVERLAYS
           ========================================================================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 35px;
            width: 90%;
            max-width: 520px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .scanner-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        .scanner-content {
            position: relative;
            margin: 5% auto;
            width: 90%;
            max-width: 500px;
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .scanner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .scanner-title { font-size: 18px; font-weight: 600; color: #2c3e50; }
        .close-scanner { background: none; border: none; font-size: 24px; color: #7f8c8d; cursor: pointer; }
        .scanner-video {
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .scanner-controls { display: flex; justify-content: center; gap: 15px; }
        .scanner-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .capture-btn { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
        .cancel-btn { background: #ecf0f1; color: #2c3e50; }
        .scanner-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .scanner-input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .manual-entry { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ecf0f1; }
        .manual-title { font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 10px; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        .notification.error { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .notification.warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .notification.info { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #e74c3c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text { color: white; margin-left: 15px; font-size: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ==========================================================================
           BA FORM PAGE STYLES
           ========================================================================== */
        #baFormPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
            z-index: 9999;
            overflow-y: auto;
            display: none;
        }
        #baFormPage .page-container {
            margin: 60px auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .page-size-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .page-size-btn {
            margin: 2px;
            padding: 5px 10px;
            font-size: 10px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #f5f5f5;
            border-radius: 3px;
        }
        .page-size-btn.active {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        .container-a4 { width: 200mm; min-height: 297mm; background: white; margin: 20px auto; padding: 10mm; box-sizing: border-box; font-family: Arial; font-size: 9pt; }
        .container-a5 { width: 148mm; min-height: 210mm; background: white; margin: 20px auto; padding: 8mm; box-sizing: border-box; font-family: Arial; font-size: 8pt; }
        .container-letter { width: 216mm; min-height: 279mm; background: white; margin: 20px auto; padding: 10mm; box-sizing: border-box; font-family: Arial; font-size: 9pt; }
        .container-landscape { width: 297mm; min-height: 210mm; background: white; margin: 20px auto; padding: 10mm; box-sizing: border-box; font-family: Arial; font-size: 9pt; }
        .test-table { width: 100%; border: 1px solid #000; }
        .test-table th, .test-table td { border: 1px solid #000; padding: 5px; text-align: center; font-size: 8pt; }
        .signature-box { border: 1px dashed #000; height: 80px; position: relative; }
        canvas {
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        .zoom-on-focus { transition: transform 0.3s ease; }
        .zoom-on-focus:focus {
            transform: scale(1.2);
            position: relative;
            z-index: 100;
        }

        /* ==========================================================================
           SCROLL & UTILITY STYLES
           ========================================================================== */
        .scroll-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .scroll-indicator.show { opacity: 1; }
        .scroll-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .scroll-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            z-index: 10000;
            transition: width 0.1s ease;
        }
        .file-upload {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 45px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .file-upload:hover {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }
        .file-upload i { font-size: 52px; color: #e74c3c; margin-bottom: 18px; }
        .file-upload p { color: #6c757d; margin-bottom: 12px; font-size: 15px; }
        .file-upload span { color: #e74c3c; font-weight: 600; }

        /* ==========================================================================
           PRINT STYLES
           ========================================================================== */
        @media print {
            .page-size-controls, .hamburger-btn, .scan-btn, .loading-overlay {
                display: none !important;
            }
            .container-a4, .container-a5, .container-letter, .container-landscape {
                margin: 0;
                box-shadow: none;
            }
        }

        /* ==========================================================================
           RESPONSIVE STYLES
           ========================================================================== */
       

    /* Sidebar */
    .sidebar {
        left: -260px;
        transition: left 0.3s ease;
        box-shadow: 2px 0 15px rgba(0,0,0,0.3);
        z-index: 1000; /* Di bawah hamburger */
    }

    .sidebar.open {
        left: 0;
    }

    /* Main Content */
    .main-content {
        margin-left: 0 !important;
        padding: 15px;
        position: relative;
    }

            /* Sidebar */
            .sidebar {
                left: -260px;
                transition: left 0.3s ease;
                box-shadow: 2px 0 15px rgba(0,0,0,0.3);
            }
            .sidebar.open { left: 0; }
            .sidebar-item span { display: none; }
            .sidebar.open .sidebar-item span { display: inline-block; margin-left: 10px; }

            /* Main Content */
            .main-content { margin-left: 0 !important; padding: 15px; }

            /* Cards */
            .cards-container { grid-template-columns: 1fr; gap: 15px; }
            .card { padding: 20px; }
            .card-icon { width: 60px; height: 60px; font-size: 24px; }

            /* Tables */
            .table-container { padding: 15px; overflow-x: auto; }
            .data-table { min-width: 600px; font-size: 12px; }
        

        @media screen and (max-width: 480px) {
            .header-left h1 { font-size: 18px; margin-left: 40px; }
            .user-info { font-size: 12px; }
            .user-avatar { width: 40px; height: 40px; font-size: 16px; }
            .user-name { font-size: 14px; }
            .user-role { font-size: 11px; }
            .scroll-indicator {
                bottom: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
            }
        }


  

        /* === SIDEBAR RESPONSIVE === */
@media screen and (max-width: 768px) {
    /* Sidebar hidden di mobile kecuali saat open */
    .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    
    .sidebar.open {
        transform: translateX(0);
    }
    
    /* Main content full width di mobile */
    .main-content {
        margin-left: 0 !important;
        padding: 15px;
    }
}

@media screen and (min-width: 769px) {
    /* Sidebar selalu visible di desktop */
    .sidebar {
        transform: translateX(0);
        width: 260px;
    }
    
    /* Beri margin untuk konten */
    .main-content {
        margin-left: 260px;
        transition: margin-left 0.3s ease;
    }
    
    /* Sidebar collapsed state */
    .sidebar.collapsed {
        width: 80px;
    }
    
    .sidebar.collapsed ~ .main-content {
        margin-left: 80px;
    }
}

        /* Tambahkan di bagian CSS */
    .signature-required {
        position: relative;
        color: red;
        font-weight: bold;
    }

    .signature-required::after {
        content: " *";
        color: red;
        position: absolute;
        right: -10px;
        top: 0;
    }

    .signature-box.error {
        border-color: red !important;
        background-color: rgba(255, 0, 0, 0.05) !important;
    }

    /* Styling untuk tanda tangan required */
    .signature-required {
        position: relative;
        color: #2c3e50;
        font-weight: bold;
        margin-bottom: 8px;
        display: inline-block;
    }

    .signature-required::after {
        content: " *";
        color: red;
        font-size: 14px;
        position: absolute;
        right: -12px;
        top: 0;
    }

    .signature-box {
        border: 1px dashed #000;
        height: 80px;
        position: relative;
        margin-bottom: 5px;
        transition: all 0.3s ease;
    }

    .signature-box.error {
        border: 2px solid red !important;
        background-color: rgba(255, 0, 0, 0.05) !important;
        animation: pulseError 0.5s ease-in-out;
    }

    @keyframes pulseError {
        0% { border-color: red; }
        50% { border-color: #ff6666; }
        100% { border-color: red; }
    }

    .signature-error {
        color: red;
        font-size: 10px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .signature-error i {
        font-size: 12px;
    }

    /* Tombol untuk draft */
    .btn-draft {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
        color: white;
    }

    .btn-draft:hover {
        background: linear-gradient(135deg, #2980b9 0%, #1c6ea4 100%) !important;
        transform: translateY(-2px);
    }

    .status-draft {
        color: #f39c12;
        font-weight: 600;
        background: rgba(243, 156, 18, 0.1);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
    }

    .sidebar-brand {
        position: absolute;
        bottom: 15px;
        left: 0;
        width: 100%;
        text-align: center;
        color: #504f4f; /* Warna abu-abu seperti copyright */
        font-size: 11px; /* Ukuran font kecil */
        font-weight: 400; /* Tidak tebal */
        padding: 10px 0;
        border-top: 1px solid #f0f0f0;
    }

    /* ==========================================================================
       PERBAIKAN KHUSUS UNTUK PRINT/PDF AGAR TIDAK TERPOTONG
       ========================================================================== */
    @media print {
        #page-container {
            width: 100% !important; /* Pastikan container tidak melebihi lebar halaman */
            overflow: visible !important;
        }
        #page-container .main-table {
            width: 100% !important;
            table-layout: fixed !important; /* Paksa tabel untuk menggunakan lebar yang ditentukan */
        }
        #page-container .main-table tr td {
            /* PERBAIKAN UTAMA: GANTI LEBAR KOLOM YANG BERMASALAH */
            width: 48% !important; /* Ganti 55% dan 50% menjadi 48% agar muat di A4 */
            box-sizing: border-box !important;
            word-wrap: break-word !important;
        }
        /* Sembunyikan elemen yang tidak perlu di PDF */
        .page-size-controls, #baFormActions, .scan-btn, .loading-overlay {
            display: none !important;
        }
    }

    /* ==========================================================================
       BA FORM INPUT & BUTTON ALIGNMENT FIX
       ========================================================================== */

    /* Target khusus input di dalam form BA */
    #baFormPage input[type="text"],
    #baFormPage input[type="date"],
    #baFormPage input[type="email"],
    #baFormPage input[type="password"],
    #baFormPage input[type="file"],
    #baFormPage select,
    #baFormPage textarea {
        /* Ini menimpa style global agar bisa sejajar dengan tombol */
        display: inline-block;
        width: calc(100% - 50px); /* Kurangi lebar untuk tombol */
        vertical-align: middle;
    }

    #baFormPage .scan-btn {
        /* Pastikan tombol juga sejajar */
        display: inline-block;
        vertical-align: middle;
        margin-left: 5px;
        margin-bottom: 2px; /* Sesuaikan agar rapi */
    }

    /* Perbaikan khusus untuk tabel di form BA */
    #baFormPage .main-table td {
        /* Cegah konten di dalam td pindah baris */
        white-space: nowrap;
    }

    /* ==========================================================================
       PDF LAYOUT FIX
       ========================================================================== */

    /* Class ini akan menata ulang layout menjadi 1 kolom saat PDF dibuat */
    .pdf-layout .main-table tr {
        display: flex;
        flex-direction: column;
    }

    .pdf-layout .main-table td {
        width: 100% !important;
        display: block;
        border: 1px solid #000; /* Kembalikan border */
        padding: 5px;
        box-sizing: border-box;
        margin-bottom: 10px; /* Beri jarak antar kolom yang sekarang bertumpuk */
    }
/* Sidebar Collapsed untuk Desktop */
@media screen and (min-width: 769px) {
    .sidebar.collapsed {
        width: 80px !important;
    }

    .sidebar.collapsed .sidebar-header h3 {
        font-size: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .sidebar.collapsed .sidebar-header h3 i {
        font-size: 24px;
        margin-right: 0;
    }

    .sidebar.collapsed .sidebar-item span {
        display: none;
    }

    .sidebar.collapsed .sidebar-item {
        justify-content: center;
        padding: 16px 0;
        margin: 2px 8px;
    }

    .sidebar.collapsed .sidebar-item i {
        font-size: 20px;
        width: 30px;
        margin: 0;
    }

    .sidebar.collapsed .sidebar-brand {
        font-size: 0;
        line-height: 0;
        padding: 5px 0;
        overflow: hidden;
    }

    .sidebar.collapsed .sidebar-brand br {
        display: none;
    }

    .sidebar.collapsed ~ .main-content {
        margin-left: 80px !important;
    }
}


/* === BOTTOM NAVIGATION === */
.bottom-nav {
    display: none; /* Sembunyi di desktop */
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: white;
    border-top: 1px solid #e0e0e0;
    padding: 8px 0;
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 8px 5px;
    cursor: pointer;
    transition: all 0.2s;
    color: #666;
}

.nav-item.active {
    color: #e74c3c;
}

.nav-item i {
    display: block;
    font-size: 20px;
    margin-bottom: 4px;
}

.nav-item span {
    font-size: 11px;
    font-weight: 500;
}

.nav-item:hover {
    color: #e74c3c;
    transform: translateY(-2px);
}

/* Tampilkan hanya di mobile */
@media screen and (max-width: 768px) {
    .bottom-nav {
        display: flex;
        justify-content: space-around;
        align-items: center;
    }
    
    /* Sembunyikan hamburger di mobile */
    .hamburger-btn {
        display: none !important;
    }
}

/* Untuk desktop, tetap pakai sidebar */
@media screen and (min-width: 769px) {
    .bottom-nav {
        display: none;
    }
    
    .sidebar {
        display: block;
    }
    
    .hamburger-btn {
        display: flex !important;
    }
}

/* Di bagian responsive CSS (sekitar line 1100) */
@media screen and (max-width: 768px) {
    /* SEMBUNYIKAN SIDEBAR */
    .sidebar {
        display: none !important;
    }
    
    /* SEMBUNYIKAN HAMBURGER */
    .hamburger-btn {
        display: none !important;
    }
    
    /* MAIN CONTENT FULL WIDTH */
    .main-content {
        margin-left: 0 !important;
        width: 100% !important;
        padding: 15px !important;
        padding-bottom: 80px !important; /* Ruang untuk bottom nav */
    }
    
    /* HEADER RAPIKAN */
    .header {
        padding: 10px 15px !important;
        height: 60px !important;
    }
    
    .header-left h1 {
        font-size: 18px !important;
        margin-left: 0 !important;
    }
}

/* ==========================================================================
   HORIZONTAL SCROLL CARD SYSTEM
   ========================================================================== */
.horizontal-scroll-container {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    gap: 15px;
    padding: 15px 5px;
    margin: 15px 0 25px 0;
    scrollbar-width: thin;
    scrollbar-color: #e74c3c #f0f0f0;
    -webkit-overflow-scrolling: touch;
    min-height: 220px;
}

.horizontal-scroll-container::-webkit-scrollbar {
    height: 6px;
}

.horizontal-scroll-container::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 3px;
}

.horizontal-scroll-container::-webkit-scrollbar-thumb {
    background: #e74c3c;
    border-radius: 3px;
}

.horizontal-card {
    flex: 0 0 auto;
    width: 300px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid #eee;
    transition: all 0.3s ease;
    position: relative;
}

.horizontal-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* Card Header */
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

.card-badge {
    background: #e74c3c15;
    color: #e74c3c;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

/* Card Content */
.card-content {
    margin-bottom: 15px;
}

.card-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
}

.card-row i {
    width: 20px;
    color: #7f8c8d;
    margin-right: 8px;
}

/* Card Actions */
.card-actions {
    display: flex;
    gap: 8px;
    border-top: 1px solid #eee;
    padding-top: 15px;
}

.card-btn {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.card-btn-view {
    background: #3498db;
    color: white;
}

.card-btn-edit {
    background: #f39c12;
    color: white;
}

.card-btn-delete {
    background: #e74c3c;
    color: white;
}

.card-btn-download {
    background: #27ae60;
    color: white;
}

.card-btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}

/* Responsive */
@media screen and (max-width: 768px) {
    .horizontal-card {
        width: 280px;
        padding: 15px;
    }
    
    .horizontal-scroll-container {
        padding: 10px 5px;
        margin: 10px -10px;
    }
}


/* ==========================================================================
   BEAUTIFUL MODAL POPUP
   ========================================================================== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-popup {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px;
    padding: 40px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(231, 76, 60, 0.25),
                0 8px 30px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
    animation: slideUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-popup::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, #e74c3c, #c0392b, #ff6b6b);
    border-radius: 20px 20px 0 0;
}

.modal-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 25px;
    background: linear-gradient(135deg, #ff6b6b, #e74c3c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
    position: relative;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.modal-icon::after {
    content: '';
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    background: linear-gradient(135deg, #ff6b6b, #e74c3c);
    border-radius: 50%;
    z-index: -1;
    opacity: 0.2;
    animation: pulse 2s infinite 0.2s;
}

.modal-icon i {
    font-size: 35px;
    color: white;
}

.modal-title {
    text-align: center;
    color: #2c3e50;
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
    letter-spacing: -0.3px;
}

.modal-message {
    text-align: center;
    color: #7f8c8d;
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 30px;
    padding: 0 10px;
}

.modal-buttons {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}

.modal-btn {
    flex: 1;
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    letter-spacing: 0.3px;
}

.modal-btn-cancel {
    background: linear-gradient(145deg, #f8f9fa, #e9ecef);
    color: #495057;
    border: 2px solid #dee2e6;
}

.modal-btn-cancel:hover {
    background: linear-gradient(145deg, #e9ecef, #dee2e6);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.modal-btn-logout {
    background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 50%, #c0392b 100%);
    color: white;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

.modal-btn-logout::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s ease;
}

.modal-btn-logout:hover::before {
    left: 100%;
}

.modal-btn-logout:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 50%, #a93226 100%);
}

.modal-btn i {
    font-size: 18px;
}

.modal-user-info {
    background: rgba(231, 76, 60, 0.08);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 25px;
    border-left: 4px solid #e74c3c;
}

.user-info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 14px;
}

.user-info-item i {
    color: #e74c3c;
    width: 20px;
    text-align: center;
}

.user-info-item:last-child {
    margin-bottom: 0;
}

.logout-success-popup {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    padding: 20px 25px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3);
    z-index: 100001;
    animation: slideInRight 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    border-left: 5px solid #2ecc71;
    max-width: 350px;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.logout-success-popup i {
    font-size: 24px;
    margin-right: 15px;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* MODAL LOGOUT STYLE */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100000;
}

.modal-popup {
    background: white;
    border-radius: 15px;
    padding: 30px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    animation: modalSlideUp 0.3s ease;
    border-top: 5px solid #e74c3c;
}

@keyframes modalSlideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

.modal-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.modal-icon i {
    font-size: 25px;
    color: white;
}

.modal-title {
    text-align: center;
    color: #2c3e50;
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 20px;
}

.user-info-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #3498db;
}

.user-info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 14px;
    color: #495057;
}

.user-info-item i {
    color: #e74c3c;
    width: 16px;
}

.modal-message {
    text-align: center;
    color: #6c757d;
    font-size: 15px;
    line-height: 1.5;
    margin-bottom: 25px;
}

.modal-buttons {
    display: flex;
    gap: 15px;
}

.modal-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.modal-btn-cancel {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
}

.modal-btn-cancel:hover {
    background: #e9ecef;
}

.modal-btn-logout {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.modal-btn-logout:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
}


/* ==========================================================================
   HIDE BOTTOM NAV ON LOGIN PAGE
   ========================================================================== */
#loginPage ~ .bottom-nav,
#baFormPage ~ .bottom-nav,
.bottom-nav[style*="display: none"] {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}



    </style>

   <!-- SUPABASE SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

   
<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- html2pdf.js for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- QuaggaJS for barcode scanning -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.2/dist/quagga.min.js"></script>
</head>
<body>
<!-- === LOGIN PAGE === -->
<div id="loginPage">
    <div class="login-container">
        <div class="login-header">
            <h2>Berita Acara Digital</h2>
            <p>by X-SOFTWARE</p>
        </div>

        <div class="tech-animation">
            <div class="circuit-line">
                <div class="node"></div>
                <div class="node"></div>
                <div class="node"></div>
            </div>
        </div>

        <div class="login-form">
            <div class="form-group">
                <label for="email"><i class="fas fa-envelope"></i> Email</label>
                <input type="email" id="email" placeholder="Masukkan email terdaftar">
                <div class="error-message" id="emailError">Email tidak valid</div>
            </div>

            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" placeholder="Masukkan password">
                <div class="error-message" id="passwordError">Password minimal 6 karakter</div>
            </div>

            <button class="login-btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        </div>
    </div>
</div>

<!-- === BEAUTIFUL LOGOUT MODAL === -->
<div id="logoutModal" class="modal-overlay">
    <div class="modal-popup">
        <div class="modal-icon">
            <i class="fas fa-sign-out-alt"></i>
        </div>
        
        <h2 class="modal-title">Logout dari Sistem</h2>
        
        <!-- TAMBAH INI: USER INFO CARD -->
        <div class="user-info-card">
            <div class="user-info-item">
                <i class="fas fa-user"></i>
                <span>Nama: <strong id="logoutUserName">-</strong></span>
            </div>
            <div class="user-info-item">
                <i class="fas fa-envelope"></i>
                <span>Email: <strong id="logoutUserEmail">-</strong></span>
            </div>
            <div class="user-info-item">
                <i class="fas fa-user-tag"></i>
                <span>Role: <strong id="logoutUserRole">-</strong></span>
            </div>
        </div>
        
        <p class="modal-message">
            Apakah Anda yakin ingin keluar?
        </p>
        
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="cancelLogout()">
                <i class="fas fa-times"></i> Batal
            </button>
            <button class="modal-btn modal-btn-logout" onclick="confirmLogout()">
                <i class="fas fa-sign-out-alt"></i> Ya, Logout
            </button>
        </div>
    </div>
</div>



<!-- === DASHBOARD === -->
<div id="dashboardPage">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-file-contract"></i> Berita Acara Digital</h3>
        </div>

        <div class="sidebar-menu">
            <!-- Cari bagian ini dan tambahkan data-role="admin" -->
            <div class="sidebar-item" data-role="admin" onclick="showContent('technician')">
                <i class="fas fa-users-cog"></i> Teknisi
            </div>

            <div class="sidebar-item" data-role="Teknisi" onclick="showContent('createBA')">
                <i class="fas fa-file-medical"></i> Buat BA
            </div>

            <div class="sidebar-item" data-role="admin" onclick="showContent('masterTech')">
                <i class="fas fa-database"></i> Data Master
            </div>

            <div class="sidebar-item" data-role="admin" onclick="showContent('reports')">
                <i class="fas fa-chart-bar"></i> Laporan
            </div>

            <div class="sidebar-brand">
                © 2025 Powered by<br>
                X-SOFTWARE | Your Business Solution
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <!-- Header perbaikan -->
<div class="header">
    <!-- Hamburger untuk mobile -->
    <div class="hamburger-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Title section -->
    <div class="header-left">
        <h1 id="headerTitle">Dashboard</h1>
        <p id="headerSubtitle" class="header-subtitle">Sistem Manajemen Berita Acara</p>
    </div>

    <!-- User section -->
    <div class="header-right">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">A</div>
            <div class="user-details">
                <div class="user-name" id="userName">User</div>
                <div class="user-role" id="userRole">ROLE</div>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Logout</span>
        </button>
    </div>
</div>

        <!-- Content Area -->
        <div id="contentArea">
            <!-- Dashboard Content -->
            <div class="content-area active" id="dashboardContent">
                <div class="cards-container">
                    <div class="card" onclick="showContent('createBA')">
                        <div class="card-icon">
                            <i class="fas fa-file-medical"></i>
                        </div>
                        <h3>Buat BA</h3>
                        <p>Buat Berita Acara baru untuk pekerjaan yang telah diselesaikan</p>
                    </div>

                    <div class="card" onclick="showContent('technician')">
                        <div class="card-icon">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <h3>Teknisi</h3>
                        <p>Kelola data teknisi, status aktif/nonaktif, dan informasi lainnya</p>
                    </div>

                    <div class="card" onclick="showContent('masterTech')">
                        <div class="card-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <h3>Data Master</h3>
                        <p>Import data teknisi dari Excel dan kelola data master</p>
                    </div>

                    <div class="card" onclick="showContent('reports')">
                        <div class="card-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3>Laporan</h3>
                        <p>Lihat laporan data BA berdasarkan filter tertentu</p>
                    </div>
                </div>

                    
<!-- GANTI TABEL DENGAN HORIZONTAL SCROLL -->
<div class="horizontal-scroll-container" id="reportsContainer">
    <!-- Card laporan akan di-generate oleh JavaScript -->
</div>

<div id="reportsEmpty" style="display: none; text-align: center; padding: 40px; color: #666;">
    <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 15px;"></i>
    <p>Belum ada laporan</p>
</div>
                </div>
            </div>



            <!-- Menu Teknisi Content -->
            <div class="content-area" id="technicianContent">
                <div class="table-container">
                    <h3 class="table-title">Daftar Teknisi</h3>

                    

                    <div class="table-controls">
    <input type="text" id="searchTech" placeholder="Cari teknisi...">
    <button onclick="exportTechnicians()"><i class="fas fa-download"></i> Export</button>
    <button onclick="showAddUserModal()"><i class="fas fa-plus"></i> Tambah</button>
    <button onclick="importTechData()"><i class="fas fa-file-import"></i> Import</button>
</div>

<!-- GANTI TABEL DENGAN HORIZONTAL SCROLL -->
<div class="horizontal-scroll-container" id="technicianContainer">
    <!-- Card teknisi akan di-generate oleh JavaScript -->
</div>

<div id="technicianEmpty" style="display: none; text-align: center; padding: 40px; color: #666;">
    <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 15px;"></i>
    <p>Belum ada data teknisi</p>
</div>
                </div>
            </div>

            <!-- Buat BA Content -->
            <div class="content-area" id="createBAContent">
                <div class="table-container">
                    <!-- TOMBOL BUAT BA -->
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="color: #333; margin-bottom: 15px;">Buat Berita Acara Baru</h3>
                        <button class="btn-submit" onclick="openBAForm()" style="padding: 15px 50px; font-size: 16px;">
                            <i class="fas fa-file-medical"></i> Buka Form BA
                        </button>
                        <p style="color: #666; margin-top: 15px; font-size: 14px;">
                            Klik tombol di atas untuk membuka form pengisian Berita Acara
                        </p>
                    </div>

                    <!-- LIST BA SAYA -->
                    <div>
                        <h3 style="color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e74c3c;">
                            <i class="fas fa-list"></i> Daftar BA Saya
                        </h3>

                        

                        <div class="table-controls">
    <input type="date" id="filterTanggalSaya">
    <input type="text" id="searchNoInetSaya" placeholder="Cari No Internet">
    <button onclick="exportBASaya()"><i class="fas fa-download"></i> Export</button>
    <button onclick="refreshBASaya()"><i class="fas fa-sync"></i> Refresh</button>
</div>

<!-- GANTI TABEL DENGAN HORIZONTAL SCROLL -->
<div class="horizontal-scroll-container" id="baListContainer">
    <!-- Card BA akan di-generate oleh JavaScript -->
</div>

<div id="baListEmpty" style="display: none; text-align: center; padding: 40px; color: #666;">
    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
    <p>Belum ada BA</p>
</div>
                    </div>
                </div>
            </div>


            <!-- Master Teknisi Content -->
            <div class="content-area" id="masterTechContent">
                <div class="table-container">
                    <h3 class="table-title">Master Data</h3>

                    <div class="table-controls">
                        <input type="text" id="searchMaster" placeholder="Cari data master..." onkeyup="searchMasterData()">
                        <button onclick="showAddMasterModal()"><i class="fas fa-plus"></i> Tambah Data</button>
                        <button onclick="importExcel()"><i class="fas fa-file-import"></i> Import Excel</button>
                        <button onclick="refreshMaster()"><i class="fas fa-sync"></i> Refresh</button>
                    </div>

                    <div class="file-upload" onclick="document.getElementById('excelFile').click()" id="dropZone">
                        <i class="fas fa-file-excel"></i>
                        <p>Drag & drop file Excel di sini atau klik untuk memilih</p>
                        <span>Format: .xlsx, .xls</span>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" hidden onchange="handleExcelUpload(this)">
                    </div>

                    <div class="file-upload" onclick="document.getElementById('excelFile').click()" id="dropZone">
    <i class="fas fa-file-excel"></i>
    <p>Drag & drop file Excel di sini atau klik untuk memilih</p>
    <span>Format: .xlsx, .xls</span>
    <input type="file" id="excelFile" accept=".xlsx,.xls" hidden onchange="handleExcelUpload(this)">
</div>

<!-- GANTI TABEL DENGAN HORIZONTAL SCROLL -->
<div class="horizontal-scroll-container" id="masterContainer">
    <!-- Card master data akan di-generate oleh JavaScript -->
</div>

<div id="masterEmpty" style="display: none; text-align: center; padding: 40px; color: #666;">
    <i class="fas fa-database" style="font-size: 48px; margin-bottom: 15px;"></i>
    <p>Belum ada data master</p>
</div>
                </div>
            </div>

            <!-- === MODAL TAMBAH DATA MASTER === -->
            <div id="addMasterModal" class="modal">
                <div class="modal-content">
                    <h3 style="color: #333; margin-bottom: 20px;">
                        <i class="fas fa-user-plus"></i> Tambah Data Master
                    </h3>

                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" id="newMasterName" placeholder="Masukkan nama lengkap" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>NIK</label>
                        <input type="text" id="newMasterNIK" placeholder="Masukkan NIK" class="form-control" maxlength="20">
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="newMasterEmail" placeholder="Masukkan email" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Jabatan</label>
                        <select id="newMasterJabatan" class="form-control">
                            <option value="Teknisi">Teknisi</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Mitra</label>
                        <input type="text" id="newMasterMitra" placeholder="Nama mitra" class="form-control">
                    </div>

                    <div id="newMasterError" style="color: #ff4757; margin: 10px 0; display: none;"></div>

                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button onclick="closeAddMasterModal()" style="flex: 1; padding: 12px; background: #ddd; border: none; border-radius: 8px; cursor: pointer;">
                            Batal
                        </button>
                        <button onclick="submitNewMaster()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Laporan Content -->
            <div class="content-area" id="reportsContent">
                <div class="table-container">
                    <h3 class="table-title">Laporan BA</h3>

                    <div class="table-controls">
                        <input type="date" id="startDate">
                        <input type="date" id="endDate">
                        <select id="monthFilter">
                            <option value="">Pilih Bulan</option>
                            <option value="01">Januari</option>
                            <option value="02">Februari</option>
                            <option value="03">Maret</option>
                            <option value="04">April</option>
                            <option value="05">Mei</option>
                            <option value="06">Juni</option>
                            <option value="07">Juli</option>
                            <option value="08">Agustus</option>
                            <option value="09">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                        <input type="text" id="searchInetReports" placeholder="No Internet Pelanggan">
                        <button onclick="filterReports()"><i class="fas fa-filter"></i> Filter</button>
                        <button onclick="exportReports()"><i class="fas fa-file-export"></i> Export</button>
                    </div>

                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>No BA</th>
                            <th>Tanggal</th>
                            <th>Pelanggan</th>
                            <th>No Internet</th>
                            <th>Teknisi</th>
                            <th>Layanan</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody id="reportsTable">
                        <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- === MODAL TAMBAH USER === -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <h3 style="color: #333; margin-bottom: 20px;">
            <i class="fas fa-user-plus"></i> Tambah User Baru
        </h3>

        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="newUserName" placeholder="Masukkan nama lengkap" class="form-control">
        </div>

        <div class="form-group">
            <label>NIK</label>
            <input type="text" id="newUserNIK" placeholder="Masukkan NIK" class="form-control" maxlength="20">
        </div>

        <div class="form-group">
            <label>Email</label>
            <input type="email" id="newUserEmail" placeholder="Masukkan email" class="form-control">
        </div>

        <div class="form-group">
            <label>Password</label>
            <input type="password" id="newUserPassword" placeholder="Minimal 6 karakter" class="form-control">
        </div>

        <div class="form-group">
            <label>Jabatan</label>
            <select id="newUserJabatan" class="form-control">
                <option value="Teknisi">Teknisi</option>
                <option value="Admin">Admin</option>
            </select>
        </div>

        <div class="form-group">
            <label>Mitra</label>
            <input type="text" id="newUserMitra" placeholder="Nama mitra" class="form-control">
        </div>

        <div id="newUserError" style="color: #ff4757; margin: 10px 0; display: none;"></div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button onclick="closeAddUserModal()" style="flex: 1; padding: 12px; background: #ddd; border: none; border-radius: 8px; cursor: pointer;">
                Batal
            </button>
            <button onclick="submitNewUser()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-save"></i> Simpan
            </button>
        </div>
    </div>
</div>

<!-- === SCANNER MODAL === -->
<div id="scannerModal" class="scanner-modal">
    <div class="scanner-content">
        <div class="scanner-header">
            <h3 class="scanner-title">Scan Barcode</h3>
            <button class="close-scanner" onclick="closeScanner()">&times;</button>
        </div>

        <div id="scanner-video" class="scanner-video">
            <!-- Camera feed will be displayed here -->
        </div>

        <div class="scanner-controls">
            <button class="scanner-btn capture-btn" onclick="startScanning()">
                <i class="fas fa-camera"></i> Mulai Scan
            </button>
            <button class="scanner-btn cancel-btn" onclick="closeScanner()">
                <i class="fas fa-times"></i> Batal
            </button>
        </div>

        <div class="manual-entry">
            <h4 class="manual-title">Atau masukkan secara manual:</h4>
            <input type="text" id="manualInput" class="scanner-input" placeholder="Masukkan kode barcode">
            <button class="scanner-btn capture-btn" onclick="useManualInput()">
                <i class="fas fa-keyboard"></i> Gunakan Input Manual
            </button>
        </div>
    </div>
</div>

<!-- === LOADING OVERLAY === -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Sedang mengkonfigurasi sistem...</div>
</div>

<!-- BOTTOM NAVIGATION - MOBILE (PERBAIKAN) -->
<div id="bottomNav" class="bottom-nav" style="display: none;">
    <div class="nav-item" onclick="showContent('dashboard')" data-target="dashboard">
        <i class="fas fa-home"></i>
        <span>Dashboard</span>
    </div>
    
    <div class="nav-item" onclick="showContent('createBA')" data-target="createBA">
        <i class="fas fa-file-medical"></i>
        <span>Buat BA</span>
    </div>
    
    <div class="nav-item" onclick="showContent('technician')" data-target="technician">
        <i class="fas fa-users-cog"></i>
        <span>Teknisi</span>
    </div>
    
    <div class="nav-item" onclick="showContent('reports')" data-target="reports">
        <i class="fas fa-chart-bar"></i>
        <span>Laporan</span>
    </div>
    
    <div class="nav-item" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
    </div>
</div>


<!-- === BA FORM === -->
<div id="baFormPage" style="display: none;">
    

    <div id="page-container" class="container-a4">
        <!-- === MODAL PREVIEW PDF === -->
        <div id="pdfPreviewModal" class="modal">
            <div class="modal-content" style="width: 90%; max-width: 900px; height: 100%; padding: 0; display: flex; flex-direction: column;">
                <div class="scanner-header" style="padding: 15px 20px; border-bottom: 1px solid #eaeaea;">
                    <h3 class="scanner-title">Preview Berita Acara</h3>
                    <button class="close-scanner" onclick="closePDFPreview()">&times;</button>
                </div>
                <div style="flex-grow: 1; padding: 10px; background-color: #f0f0f0; overflow: hidden;">
                    <iframe id="pdfPreviewFrame" style="width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 4px;"></iframe>
                </div>
                <div style="padding: 15px 20px; text-align: right; border-top: 1px solid #eaeaea; background-color: #fff;">
                    <button class="scanner-btn cancel-btn" onclick="closePDFPreview()">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                    <button class="scanner-btn capture-btn" id="downloadPdfFromPreviewBtn" style="margin-left: 10px;">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>

        <table style="width: 100%; border: none; margin-bottom: 10px;">
            <tr>
                <td style="width: 15%; text-align: left; border: none; vertical-align: middle;">
                    <div style="border: 0px dashed #000; width: 100px; height: 50px; position: relative; overflow: hidden; cursor: pointer;"
                         onclick="document.getElementById('uploadKiri').click()"
                         onmouseover="this.style.borderColor='#e74c3c'; this.style.boxShadow='0 0 10px rgba(231, 76, 60, 0.3)'"
                         onmouseout="this.style.borderColor='#000'; this.style.boxShadow='none'">
                        <img id="logoKiri" src="" style="width: 100%; height: 100%; object-fit: contain; display: none; cursor: pointer;">
                        <div id="placeholderKiri" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <button type="button"
                                    style="background: rgba(231, 76, 60, 0.9); color: white; border: none;
                                   padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;"
                                    onmouseover="this.style.background='#c0392b'"
                                    onmouseout="this.style.background='rgba(231, 76, 60, 0.9)'">
                                <i class="fas fa-upload"></i> Logo
                            </button>
                            <div style="font-size: 8px; color: #666; margin-top: 2px;">Klik untuk upload</div>
                        </div>
                        <input type="file" id="uploadKiri" accept="image/*" onchange="uploadImage('kiri', this)" style="display: none;">
                    </div>
                </td>

                <td style="width: 80%; text-align: center; border: none; vertical-align: middle;">
                    <h1 style="font-size: 12pt; margin: 0; font-weight: bold;">LAPORAN PENYELESAIAN PEKERJAAN</h1>
                </td>

                <td style="width:70%; text-align: right; border: none; vertical-align: middle;">
                    <div style="border: 0px dashed #000; width: 100px; height: 50px; position: relative; overflow: hidden; cursor: pointer;"
                         onclick="document.getElementById('uploadKanan').click()"
                         onmouseover="this.style.borderColor='#e74c3c'; this.style.boxShadow='0 0 10px rgba(231, 76, 60, 0.3)'"
                         onmouseout="this.style.borderColor='#000'; this.style.boxShadow='none'">
                        <img id="logoKanan" src="" style="width: 100%; height: 100%; object-fit: contain; display: none; cursor: pointer;">
                        <div id="placeholderKanan" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <button type="button"
                                    style="background: rgba(231, 76, 60, 0.9); color: white; border: none;
                                   padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;"
                                    onmouseover="this.style.background='#c0392b'"
                                    onmouseout="this.style.background='rgba(231, 76, 60, 0.9)'">
                                <i class="fas fa-upload"></i> Logo
                            </button>
                            <div style="font-size: 8px; color: #666; margin-top: 2px;">Klik untuk upload</div>
                        </div>
                        <input type="file" id="uploadKanan" accept="image/*" onchange="uploadImage('kanan', this)" style="display: none;">
                    </div>
                </td>
            </tr>
        </table>

        <table style="width: 100%; margin-bottom: 5px; border: none;">
            <tr>
                <td style="border: none;">
                    <strong>Nama Mitra :</strong> <span id="nama_mitra" style="width: 150px;font-weight: bold; margin-left: 5px;"></span>
                </td>
                <td style="border: none; text-align: right;">
                    <strong>No BA :</strong> <span id="noBADisplay" style="font-weight: bold; margin-left: 5px;">BA-001</span>
                </td>
            </tr>
            <tr>
                <td style="border: none;">
                    <strong>Nama Teknisi :</strong> <span id="namaTeknisiDisplay" style="font-weight: bold; margin-left: 5px;"></span>
                </td>
                <td style="border: none; text-align: right;"></td>
            </tr>
        </table>

        <table class="main-table">
            <tr>
                <td style="width: 55%; vertical-align: top;">
                    <table style="width: 100%; border: none;">
                        <tr><td style="width: 35%; border: none; white-space: nowrap;" class="required-field">1. STO</td><td style="width: 1%; border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="width: 100%; border: none;"><input type="text" name="sto" class="required-field zoom-on-focus" style="text-transform: uppercase;"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">2. No Permintaan/WO</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_permintaan" class="required-field zoom-on-focus" pattern="[A-Za-z0-9]+" title="Hanya huruf dan angka"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;">3. No Telepon</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_telepon" pattern="[0-9]+" title="Hanya angka"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">4. No Inet</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_inet" class="required-field zoom-on-focus" pattern="[0-9]+" title="Hanya angka"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">5. Tanggal WO</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="date" name="tanggal_wo" class="required-field zoom-on-focus"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;">6. Tanggal Transaksi</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="date" name="tanggal_transaksi"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">7. Nama Pelanggan</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="nama_pelanggan" class="required-field zoom-on-focus"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">8. No Kontak</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_kontak" class="required-field zoom-on-focus" pattern="[0-9]+" title="Hanya angka"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">9. Alamat Pelanggan</td><td style="border: none; padding-left: 1x; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="alamat_pelanggan" class="required-field zoom-on-focus"></td></tr>
                    </table>

                    <table style="margin-top: 5px; width: 100%; border: none;">
                        <tr style="border: none;"><td colspan="3" style="border: none;"><strong>DATEK</strong></td></tr>
                        <tr style="border: none;"><td style="width: 1%; border: none; white-space: nowrap;">1. RK/MSAN/ODC</td><td style="width: 3%; border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="width: 100%; border: none;"><input type="text" name="rk_msan_odc"></td></tr>
                        <tr style="border: none;"><td style="border: none; white-space: nowrap;">2. DP/ODP</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="dp_odp"></td></tr>
                        <tr style="border: none;"><td style="border: none; white-space: nowrap;">3. Klem Primer/Feeder</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="klem_primer_feeder"></td></tr>
                        <tr style="border: none;"><td style="border: none; white-space: nowrap;">4. Kec sec/Distribusi</td><td style="border: none; padding-left: 5px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="kec_sec_distribusi"></td></tr>
                    </table>

                    <table style="margin-top: 5px; width: 100%; border: none;">
                        <tr style="border: none;"><td colspan="3" style="border: none;"><strong>Material</strong></td></tr>
                        <tr style="border: none;">
                            <td style="width: 2%; border: none; white-space: nowrap;">1.</td>
                            <td style="width: 1%; border: none;"></td>
                            <td style="width: 100%; border: none;">
                                <input type="text" name="material1_kiri" style="width: 45%;"> : <input type="text" name="material1_kanan" style="width: 45%;">
                            </td>
                        </tr>
                        <tr style="border: none;">
                            <td style="border: none; white-space: nowrap;">2.</td>
                            <td style="border: none;"></td>
                            <td style="border: none;">
                                <input type="text" name="material2_kiri" style="width: 45%;"> : <input type="text" name="material2_kanan" style="width: 45%;">
                            </td>
                        </tr>
                        <tr style="border: none;">
                            <td style="border: none; white-space: nowrap;">3.</td>
                            <td style="border: none;"></td>
                            <td style="border: none;">
                                <input type="text" name="material3_kiri" style="width: 45%;"> : <input type="text" name="material3_kanan" style="width: 45%;">
                            </td>
                        </tr>
                        <tr style="border: none;">
                            <td style="border: none; white-space: nowrap;">4.</td>
                            <td style="border: none;"></td>
                            <td style="border: none;">
                                <input type="text" name="material4_kiri" style="width: 45%;"> : <input type="text" name="material4_kanan" style="width: 45%;">
                            </td>
                        </tr>
                        <tr style="border: none;">
                            <td style="border: none; white-space: nowrap;">5.</td>
                            <td style="border: none;"></td>
                            <td style="border: none;">
                                <input type="text" name="material5_kiri" style="width: 45%;"> : <input type="text" name="material5_kanan" style="width: 45%;">
                            </td>
                        </tr>
                    </table>
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <table border="1" cellpadding="1" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td colspan="5" style="text-align: center; font-weight: bold; font-size: 10pt;">TEST USAGE</td>
                        </tr>
                        <tr>
                            <td rowspan="2" style="text-align: center; font-weight: bold; width: 25%;">Tes Layanan</td>
                            <td rowspan="2" style="text-align: center; font-weight: bold; width: 25%;">Contoh</td>
                            <td colspan="2" style="text-align: center; font-weight: bold; width: 50%;">Kualitas</td>
                        </tr>
                        <tr>
                            <td style="text-align: center;">Baik</td>
                            <td style="text-align: center;">Tidak</td>
                        </tr>
                        <tr>
                            <td style="text-align: center;">Test Voice</td>
                            <td style="text-align: center;"></td>
                            <td style="text-align: center;"><input type="checkbox" name="voice_baik" class="test-checkbox" data-group="voice"></td>
                            <td style="text-align: center;"><input type="checkbox" name="voice_tidak" class="test-checkbox" data-group="voice"></td>
                        </tr>
                        <tr>
                            <td style="text-align: center;">Test Internet</td>
                            <td style="text-align: center;"></td>
                            <td style="text-align: center;"><input type="checkbox" name="inet_baik" class="test-checkbox" data-group="inet"></td>
                            <td style="text-align: center;"><input type="checkbox" name="inet_tidak" class="test-checkbox" data-group="inet"></td>
                        </tr>
                        <tr>
                            <td style="text-align: center;">Test UseeTv</td>
                            <td style="text-align: center;"></td>
                            <td style="text-align: center;"><input type="checkbox" name="usetv_baik" class="test-checkbox" data-group="usetv"></td>
                            <td style="text-align: center;"><input type="checkbox" name="usetv_tidak" class="test-checkbox" data-group="usetv"></td>
                        </tr>
                    </table>

                    <div style="border: 1px solid #000; padding: 5px; margin-top: 10px;">
                        <strong>Tes Internet :</strong><br>
                        1. Tes Ping&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_ping" style="width: 80px;"> ms<br>                            2. Tes Upload&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_upload" style="width: 80px;"> Mbps<br>
                        3. Tes Download &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_download" style="width: 80px;"> Mbps<br>
                        4. Hasil Ukur Redaman&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="hasil_ukur_redaman" style="width: 90px;">
                    </div>

                    <div style="border: 1px solid #000; padding: 100px; margin-top: 10px;"></div>
                </td>
            </tr>
        </table>

        <table class="main-table" style="margin-top: 10px;">
            <tr>
                <td style="width: 60%; vertical-align: top;">
                    <table style="width: 90%; border: none;">
                        <tr><td style="width: 20%; border: none; white-space: nowrap;" class="required-field">ONT yang DITARIK / ONT BEKAS</td><td style="width: 5%; border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="width: 50%; border: none;">
                            <input type="text" name="ONT_yang_DIPASANG_/_DITARIK" class="required-field zoom-on-focus" id="ont_ditarik">
                            <button class="scan-btn" onclick="openScanner('ont_ditarik')"><i class="fas fa-camera"></i></button>

                        </td></tr>
                        <tr><td style="border: none; white-space: nowrap;">lampu Indikator ONT Nyala</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="checkbox" name="power"> Power <input type="checkbox" name="dsl"> DSL <input type="checkbox" name="internet"> Internet</td></tr>
                        <tr><td style="border: none; white-space: nowrap;">Nama / Notel Teknisi</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="nama_teknisi"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;" class="required-field">STB ID</td><td style="width: 5%; border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="width: 55%; border: none;">
                            <input type="text" name="stb_id" class="required-field zoom-on-focus" id="stb_id">
                            <button class="scan-btn" onclick="openScanner('stb_id')"><i class="fas fa-camera"></i></button>

                        </td></tr>
                    </table>
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <table style="width: 100%; border: none;">
                        <tr><td style="width: 30%; border: none; white-space: nowrap;" class="required-field">SN ONT BARU</td><td style="width: 5%; border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="width: 65%; border: none;">
                            <input type="text" name="sn_ont" class="required-field zoom-on-focus" id="sn_ont">
                            <button class="scan-btn" onclick="openScanner('sn_ont')"><i class="fas fa-camera"></i></button>
                        </td></tr>
                        <tr><td style="border: none; white-space: nowrap;">SN PLC</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="sn_plc"></td></tr>
                        <tr><td style="border: none; white-space: nowrap;">SN WIFI EXT</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="sn_wifi_ext"></td></tr>
                    </table>
                </td>
            </tr>
        </table>

        <table class="main-table" style="margin-top: 10px;">
            <tr>
                <td style="width: 50%; vertical-align: top;">
                    <strong>PSB</strong><br>
                    <input type="checkbox" name="psb_1p_voice"> 1P [Voice]/1P [Internet] &nbsp;
                    <input type="checkbox" name="psb_3p"> 3P<br>
                    <input type="checkbox" name="psb_2p"> 2P [Voice + Internet] / 2P [Internet + UseeTv]
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <strong>Tambahan</strong><br>
                    <input type="checkbox" name="ganti_stb"> Ganti STB / ONT &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="checkbox" name="plc"> PLC &nbsp;
                    <input type="checkbox" name="indibox"> IndiBox<br>
                    <input type="checkbox" name="stb_belum_terpasang"> STB Belum Terpasang &nbsp;
                    <input type="checkbox" name="wifi_extender"> Wifi Extender
                </td>
            </tr>
        </table>

        <table class="main-table" style="margin-top: 10px;">
            <tr>
                <td>
                    <strong>Migrasi</strong><br>
                    <strong>Infrastruktur:</strong><br>
                    <input type="checkbox" name="infra_1p1p_voice"> 1P-1P [Voice]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="checkbox" name="infra_1p2p_voice"> 1P-2P [Voice+Internet]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="checkbox" name="infra_2p2p_voice"> 2P-2P [Internet+Voice]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <input type="checkbox" name="infra_1p3p"> 1P-3P&nbsp;
                    <input type="checkbox" name="infra_3p3p"> 3P-3P<br>
                    <input type="checkbox" name="infra_1p1p_internet"> 1P-1P [Internet] &nbsp;
                    <input type="checkbox" name="infra_1p2p_usetv"> 1P-2P [Internet+UseeTv] &nbsp;
                    <input type="checkbox" name="infra_2p2p_usetv"> 2P-2P [Internet+UseeTv] &nbsp;
                    <input type="checkbox" name="infra_2p3p"> 2P-3P<br>

                    <strong>Layanan:</strong><br>
                    <input type="checkbox" name="layanan_1p2p_voice"> 1P-2P [Internet+Voice] &nbsp;
                    <input type="checkbox" name="layanan_1p2p_usetv"> 1P-2P [Internet+UseeTv] &nbsp;
                    <input type="checkbox" name="layanan_1p3p"> 1P-3P &nbsp;
                    <input type="checkbox" name="layanan_2p3p"> 2P-3P
                </td>
            </tr>
        </table>

        <table style="width: 100%; margin: 10px 0; border: none;">
            <tr>
                <td style="border: none;">
                    <strong>Speed :</strong> 10MB 20MB 30MB 40MB 50MB 100MB 200MB 300MB 1 GB other
                </td>
            </tr>
        </table>

        <table class="main-table">
            <tr>
                <td style="font-size: 9pt; white-space: normal; word-wrap: break-word; overflow-wrap: break-word;">
                    1. Perangkat (ONT/Modem/STB) yang dipasang di rumah pelanggan adalah MILIK TELKOM yang dipinjamkan selama menjadi pelanggan TELKOM. Modem yang tidak dipakai karena Migrasi ke Fiber akan ditarik Kembali.<br>
                    2. Telkom dapat mengambil Perangkat bila tidak ada penggunaan selama 3 bulan berturut-turut.<br>
                    3. Untuk progress pemilihan dan monitoring diharapkan power perangkat selalu dalam kondisi hidup (ON)<br>
                    4. Disarankan untuk segera merubah password yang ada untuk menjaga agar tidak dipergunakan oleh pihak-pihak yang tidak dikehendaki<br>
                    5. Pelanggan sudah mendapatkan penjelasan dari sales/seller atau menerima buku petunjuk menggunakan modem internet yang telah dipasang.
                </td>
            </tr>
        </table>

        <div style="text-align: right; margin-top: 10px; margin-right: 25%;">
            Lumajang, <input type="date" name="tanggal_lumajang" style="border: none; border-bottom: 1px solid #000; text-align: center; width: 120px;">
        </div>

        <table class="main-table" style="margin-top: 10px;">
            <tr>
                <td style="width: 50%; text-align: center;">
                    <div>Pelanggan</div>
                    <div id="namaPelangganTTD" style="margin-bottom: 5px; font-weight: bold;"></div>
                    <div class="signature-box">
                        <canvas id="signature-pelanggan" width="200" height="70"></canvas>
                        <button type="button" onclick="clearSignature('pelanggan')" style="position: absolute; bottom: 5px; right: 5px; font-size: 8px;">Hapus</button>
                    </div>
                    <button type="button" onclick="saveSignature('pelanggan')" style="margin-top: 5px; font-size: 8px; padding: 3px 8px;">Save TTD</button>
                </td>
                <td style="width: 50%; text-align: center;">
                    <div>Petugas Lapangan</div>
                    <div id="namaTeknisiTTD" style="margin-bottom: 5px; font-weight: bold;"></div>
                    <div class="signature-box">
                        <canvas id="signature-petugas" width="200" height="70"></canvas>
                        <button type="button" onclick="clearSignature('petugas')" style="position: absolute; bottom: 5px; right: 5px; font-size: 8px;">Hapus</button>
                    </div>
                    <button type="button" onclick="saveSignature('petugas')" style="margin-top: 5px; font-size: 8px; padding: 3px 8px;">Save TTD</button>
                </td>
            </tr>
        </table>

        <!-- Tambahkan tombol ini di bagian bawah form BA (setelah tombol Simpan BA) -->
        <div id="baFormActions" style="text-align: center; margin-top: 20px;">
            <button type="button" onclick="saveDraft()"
                    style="padding: 10px 30px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt; margin-right: 10px;">
                <i class="fas fa-save"></i> Save Draft
            </button>
            <button type="button" onclick="saveBA()"
                    style="padding: 10px 30px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt; margin-right: 10px;">
                <i class="fas fa-save"></i> Simpan BA ke Database
            </button>
            <button type="button" onclick="closeBAForm()"
                    style="padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt;">
                <i class="fas fa-times"></i> Batal
            </button>
        </div>
    </div>
</div>




<!-- Scroll Progress Bar -->
<div class="scroll-progress" id="scrollProgress"></div>

<!-- Scroll to Top Button -->
<div id="scrollIndicator" class="scroll-indicator" onclick="scrollToTop()">
    <i class="fas fa-arrow-up"></i>
</div>

<!-- Tambahkan ini di dalam <body>, di atas modal scanner yang sudah ada -->
<!-- Modal Kamera -->
<div id="cameraModal" class="scanner-modal" style="display: none;">
    <div class="scanner-content">
        <div class="scanner-header">
            <h3 class="scanner-title">Ambil Foto</h3>
            <button class="close-scanner" onclick="closeCameraModal()">&times;</button>
        </div>

        <!-- Video untuk menampilkan preview kamera -->
        <video id="camera-video" class="scanner-video" autoplay playsinline></video>

        <div class="scanner-controls">
            <button class="scanner-btn capture-btn" onclick="capturePhoto()">
                <i class="fas fa-camera"></i> Ambil Foto
            </button>
            <button class="scanner-btn cancel-btn" onclick="closeCameraModal()">
                <i class="fas fa-times"></i> Batal
            </button>
        </div>
    </div>
</div>

<script>


                                // === SUPABASE CONFIGURATION ===

const SUPABASE_URL = 'https://bhrahyvqtkdiyftckdie.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJocmFoeXZxdGtkaXlmdGNrZGllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxODUwMjksImV4cCI6MjA4MTc2MTAyOX0.dam0XlS7HtO7ya8nhGxtUqN23UDakUe24NUd4eR8He4';

// === GLOBAL VARIABLES ===
let supabase = null;        // <-- HANYA SATU DEKLARASI INI
let currentUser = null;
let pelangganSigned = false;
let petugasSigned = false;
let currentScannerField = null;
let inactivityTimer;
const INACTIVITY_LIMIT = 10 * 60 * 1000;

// === FIREBASE INDEX MANAGEMENT ===
class FirebaseIndexManager {
constructor(firestore) {
    this.firestore = firestore;
    this.indexes = [
        {
            collection: 'ba_documents',
            fields: [
                { fieldPath: 'userEmail', order: 'ASCENDING' },
                { fieldPath: 'tanggalDibuat', order: 'DESCENDING' }
            ]
        },
        {
            collection: 'ba_documents',
            fields: [
                { fieldPath: 'tanggalDibuat', order: 'DESCENDING' }
            ]
        }
    ];
}

async createIndexes() {
    try {
        const projectId = firebaseConfig.projectId;
        const baseUrl = `https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/indexes`;

        for (const index of this.indexes) {
            try {
                const indexDefinition = {
                    name: `${baseUrl}?indexId=${this.generateIndexId(index)}`,
                    queryScope: 'COLLECTION',
                    fields: index.fields
                };

                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await this.getAuthToken()}`
                    },
                    body: JSON.stringify(indexDefinition)
                });

                if (response.ok) {
                    console.log('✅ Index created successfully:', index.collection);
                } else if (response.status === 409) {
                    console.log('ℹ️ Index already exists:', index.collection);
                } else {
                    console.warn('⚠️ Failed to create index:', index.collection);
                }
            } catch (error) {
                console.warn('⚠️ Error creating index:', error);
            }
        }
    } catch (error) {
        console.warn('⚠️ Index creation failed:', error);
    }
}

generateIndexId(index) {
    const fields = index.fields.map(f => `${f.fieldPath}_${f.order}`).join('_');
    return `${index.collection}_${fields}`;
}

async getAuthToken() {
    try {
        const user = auth.currentUser;
        if (user) {
            return await user.getIdToken();
        }
    } catch (error) {
        console.warn('⚠️ Could not get auth token:', error);
    }
    return null;
}

async waitForIndexes(maxWaitTime = 60000) {
    const startTime = Date.now();

    while (Date.now() - startTime < maxWaitTime) {
        try {
            await this.firestore.collection('ba_documents')
                .where('userEmail', '==', 'test@test.com')
                .orderBy('tanggalDibuat', 'desc')
                .limit(1)
                .get();

            console.log('✅ Indexes are ready');
            return true;
        } catch (error) {
            if (error.message.includes('requires an index')) {
                console.log('⏳ Waiting for indexes to be ready...');
                await new Promise(resolve => setTimeout(resolve, 2000));
            } else {
                break;
            }
        }
    }

    return false;
}
}

// === INITIALIZE SUPABASE ===
async function initializeSupabase() {
  try {
    if (typeof supabase !== 'undefined' && window.supabase) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
      // Fallback jika supabase tidak ada di window
      supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    console.log('✅ Supabase initialized successfully');

    // Cek session yang sudah ada
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    
    if (sessionError) {
      console.error('❌ Session error:', sessionError);
      return false;
    }

    if (session && session.user) {
      console.log('👤 Existing session found:', session.user.email);
      await handleLoggedInUser(session.user, session);
    }

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        console.log('🔐 Auth event:', event);
        
        if (event === 'SIGNED_IN' && session?.user) {
          console.log('👤 User signed in:', session.user.email);
          await handleLoggedInUser(session.user, session);
        } 
        else if (event === 'SIGNED_OUT') {
          console.log('👤 User signed out');
          currentUser = null;
          document.getElementById('dashboardPage').style.display = 'none';
          document.getElementById('loginPage').style.display = 'flex';
        }
        else if (event === 'USER_UPDATED' && session?.user) {
          console.log('👤 User updated:', session.user.email);
          await handleLoggedInUser(session.user, session);
        }
      }
    );

    return true;

  } catch (error) {
    console.error('❌ Supabase initialization error:', error);
    showNotification('Supabase gagal diinisialisasi. Periksa koneksi internet.', 'error');
    return false;
  }
}

// ==========================================================================
// FIX: PREVENT HORIZONTAL SCROLL (KECUALI CARD LIST)
// ==========================================================================

function fixHorizontalScroll() {
    console.log('🔧 Fixing horizontal scroll...');
    
    // 1. Reset scroll horizontal ke 0
    window.scrollTo(0, window.scrollY);
    
    // 2. Prevent horizontal scroll dengan wheel
    window.addEventListener('wheel', function(e) {
        // Jika mencoba scroll horizontal, prevent
        if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // 3. Prevent horizontal scroll dengan touch di mobile
    window.addEventListener('touchmove', function(e) {
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            // Jika swipe horizontal lebih dari 10px, prevent
            if (Math.abs(e.touches[0].pageX - touch.clientX) > 10) {
                e.preventDefault();
            }
        }
    }, { passive: false });
    
    // 4. Fix untuk semua elemen kecuali yang boleh scroll horizontal
    const noScrollElements = document.querySelectorAll(
        'body, html, #dashboardPage, #loginPage,  .main-content, .content-area, .cards-container, .card, .form-container'
    );
    
    noScrollElements.forEach(el => {
        
        el.style.maxWidth = '100%';
    });
    
    // 5. Biarkan ini yang boleh scroll horizontal
    const allowScrollElements = document.querySelectorAll(
        '.horizontal-scroll-container, .table-container'
    );
    
    allowScrollElements.forEach(el => {
        el.style.overflowX = 'auto';
    });
    
    console.log('✅ Horizontal scroll fixed');
}

// Jalankan saat load
window.addEventListener('load', fixHorizontalScroll);
document.addEventListener('DOMContentLoaded', fixHorizontalScroll);

// Jalankan lagi saat resize
window.addEventListener('resize', fixHorizontalScroll);

// Emergency check setiap 2 detik
setInterval(() => {
    if (window.scrollX !== 0) {
       
    }
}, 2000);

// === UPDATE USER UI FUNCTION ===
function updateUserUI() {
if (!currentUser) return;

const userNameEl = document.getElementById('userName');
const userRoleEl = document.getElementById('userRole');
const userAvatarEl = document.getElementById('userAvatar');

if (userNameEl) userNameEl.textContent = currentUser.name;
if (userRoleEl) userRoleEl.textContent = currentUser.jabatan || currentUser.role || 'User';
if (userAvatarEl) userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();

// --- PERBAIKAN: SEMBUNYIKAN MENU UNTUK TEKNISI ---
if (currentUser.role === 'teknisi') {
    // Sembunyikan menu Dashboard
    const dashboardMenu = document.querySelector('.sidebar-item[onclick*="dashboard"]');
    if (dashboardMenu) dashboardMenu.style.display = 'none';

    // Sembunyikan menu Manajemen Teknisi
    const technicianMenu = document.querySelector('.sidebar-item[onclick*="technician"]');
    if (technicianMenu) technicianMenu.style.display = 'none';

    // Sembunyikan menu Data Master
    const masterTechMenu = document.querySelector('.sidebar-item[onclick*="masterTech"]');
    if (masterTechMenu) masterTechMenu.style.display = 'none';
}
// --- AKHIR PERBAIKAN ---

console.log('User UI Updated:', {
    name: currentUser.name,
    role: currentUser.jabatan || currentUser.role,
    email: currentUser.email
});
}

// Fungsi ini akan dipanggil oleh tombol HTML
function requestCameraPermissionFromJS(fieldId) {
    // Simpan dulu field ID ke variabel global
    currentScannerField = fieldId; 
    
    // Kirim sinyal ke Kodular untuk meminta izin
    if (typeof window.AppInventor !== 'undefined') {
        window.AppInventor.setWebViewString('REQUEST_CAMERA_PERMISSION');
    } else {
        // Fallback jika tidak di webview (untuk testing di browser)
        console.log('Meminta izin kamera untuk field:', fieldId);
        // Di browser, kita coba langsung jalankan scanner
        startScanning(); 
    }
}

// Tambahkan variabel global untuk stream kamera
let cameraStream = null;
let currentPhotoField = null; // Untuk menyimpan field tempat foto akan disimpan

// Fungsi untuk membuka modal kamera
function openCameraModal(fieldId) {
    currentPhotoField = fieldId; // Simpan ID field tujuan
    const modal = document.getElementById('cameraModal');
    const video = document.getElementById('camera-video');

    modal.style.display = 'block';

    // Mintak akses kamera dan tampilkan preview di video
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(function(stream) {
                cameraStream = stream;
                video.srcObject = stream;
            })
            .catch(function(error) {
                console.error("Tidak dapat mengakses kamera:", error);
                showToast("Tidak dapat mengakses kamera. Pastikan izin kamera sudah diberikan.");
                closeCameraModal();
            });
    } else {
        showToast("Browser Anda tidak mendukung fitur kamera.");
        closeCameraModal();
    }
}

// Fungsi untuk menutup modal kamera
function closeCameraModal() {
    const modal = document.getElementById('cameraModal');
    const video = document.getElementById('camera-video');

    // Hentikan stream kamera untuk membebaskan sumber daya
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }

    video.srcObject = null;
    modal.style.display = 'none';
}

// Fungsi untuk mengambil foto dari video
function capturePhoto() {
    const video = document.getElementById('camera-video');

    // Buat elemen canvas sementara untuk menangkap frame
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');

    // Gambar frame video ke canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Ubah canvas menjadi data URL (format gambar)
    const dataUrl = canvas.toDataURL('image/jpeg');

    // Simpan data URL ke field yang dituju
    if (currentPhotoField) {
        // Di sini Anda bisa menampilkan foto yang diambil
        // Misalnya, dengan membuat elemen <img> baru
        const imgContainer = document.getElementById(currentPhotoField + '_preview');
        if (imgContainer) {
            imgContainer.src = dataUrl;
            imgContainer.style.display = 'block';
        }

        // Simpan data URL ke input hidden untuk disimpan ke database
        const hiddenInput = document.getElementById(currentPhotoField + '_data');
        if (hiddenInput) {
            hiddenInput.value = dataUrl;
        }
    }

    // Tutup modal kamera
    closeCameraModal();
    showToast("Foto berhasil diambil!");
}

// === HANDLE LOGGED IN USER FUNCTION (Supabase) ===
async function handleLoggedInUser(supabaseUser, session) {
  try {
    // Get user data from our users table (bukan dari auth.users)
    const { data: userData, error: userError } = await supabase
      .from('users')
      .select('*')
      .eq('email', supabaseUser.email)
      .single();

    if (userError || !userData) {
      console.log('❌ User tidak terdaftar di tabel users:', supabaseUser.email);
      
      // Auto logout karena tidak terdaftar
      await supabase.auth.signOut();
      showNotification('Akun Anda tidak terdaftar dalam sistem', 'error');
      return;
    }

    currentUser = {
      id: userData.id, // UUID dari tabel users
      name: userData.name || supabaseUser.email.split('@')[0],
      email: supabaseUser.email,
      jabatan: userData.jabatan || 'Teknisi',
      role: userData.role || 'teknisi',
      avatar: supabaseUser.email.charAt(0).toUpperCase(),
      mitra: userData.mitra || ''
    };

    // TAMPILKAN DASHBOARD JIKA MASIH DI LOGIN PAGE
    if (document.getElementById('loginPage').style.display !== 'none') {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboardPage').style.display = 'block';

      updateUserUI();

      if (currentUser.role === 'teknisi') {
        document.getElementById('namaTeknisiDisplay').textContent = currentUser.name;
        document.getElementById('namaTeknisiTTD').textContent = currentUser.name;

        // PERBAIKAN: Hanya isi span, jangan input (untuk hindari error)
        if (currentUser.mitra) {
          document.getElementById('nama_mitra').textContent = currentUser.mitra;
        } else {
          loadUserMitraFromSupabase(); // Fungsi ini nanti kita buat
        }
      }
// loadDashboardData();    // TODO: masih Firebase
loadTechnicians();         // ← UNCOMMENT! Sudah kita perbaiki ✅
// loadBASaya();          // TODO: masih Firebase
loadReports();             // Sudah di-update ke Supabase ✅
         loadReports();             // Sudah di-update ke Supabase ✅
    }

  } catch (error) {
    console.error('Error handling logged in user:', error);
  }
}

/// ==========================================================================
// REPLACE ONLY THE LOGIN FUNCTION - FIX AUTH CONFLICT
// ==========================================================================

// === PERBAIKAN LOGIN - HAPUS FIREBASE, GANTI SUPABASE ===
async function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    // Reset error display
    document.getElementById('emailError').style.display = 'none';
    document.getElementById('passwordError').style.display = 'none';

    // Basic validation
    if (!email) {
        document.getElementById('emailError').textContent = 'Email wajib diisi';
        document.getElementById('emailError').style.display = 'block';
        return;
    }

    if (!password || password.length < 6) {
        document.getElementById('passwordError').textContent = 'Password minimal 6 karakter';
        document.getElementById('passwordError').style.display = 'block';
        return;
    }

    // Show loading
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
    loginBtn.disabled = true;

    try {
        console.log('🔑 Attempting login with Supabase...');
        
        // GUNAKAN SUPABASE, BUKAN FIREBASE!
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) {
            console.error('❌ Supabase login error:', error);
            throw error;
        }

        console.log('✅ Supabase login success:', data.user?.email);
        
        // Tunggu onAuthStateChange untuk handle sisanya
        showNotification('Login berhasil!');

    } catch (error) {
        console.error('❌ Login error:', error);
        
        let errorMessage = 'Login gagal! ';
        
        if (error.message?.includes('Invalid login credentials')) {
            errorMessage += 'Email atau password salah.';
        } else if (error.message?.includes('Email not confirmed')) {
            errorMessage += 'Email belum dikonfirmasi.';
        } else {
            errorMessage += error.message || 'Terjadi kesalahan';
        }
        
        showNotification(errorMessage, 'error');
        
    } finally {
        // Reset button
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        loginBtn.disabled = false;
    }
}

// === PERBAIKAN EVENT LISTENER ===
document.addEventListener('DOMContentLoaded', function() {
    // Hapus yang lama
    const oldLoginBtn = document.getElementById('loginBtn');
    if (oldLoginBtn) {
        // Clone untuk remove event listeners
        const newBtn = oldLoginBtn.cloneNode(true);
        oldBtn.parentNode.replaceChild(newBtn, oldLoginBtn);
        
        // Tambah event listener baru
        newBtn.addEventListener('click', login);
    }
    
    // Juga support Enter key
    const passwordField = document.getElementById('password');
    if (passwordField) {
        passwordField.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    }
});

// Update the login button event listener
document.getElementById('loginBtn').onclick = login;

// Also allow Enter key to trigger login
document.getElementById('password').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    login();
  }
});


function setupLogoutModalButtons() {
    // FUNGSI KOSONG AJA
    console.log('Tombol modal sudah pakai onclick di HTML');
}

// === BEAUTIFUL LOGOUT FUNCTION ===
function showLogoutPopup() {
    console.log('🎯 TAMPILKAN MODAL LOGOUT');
    
    // CEK DULU ELEMENTNYA ADA ATAU ENGGAK
    const nameElement = document.getElementById('logoutUserName');
    const emailElement = document.getElementById('logoutUserEmail');
    const roleElement = document.getElementById('logoutUserRole');
    
    // Isi info user JIKA ELEMENT ADA
    if (currentUser) {
        if (nameElement) nameElement.textContent = currentUser.name || 'User';
        if (emailElement) emailElement.textContent = currentUser.email || '-';
        if (roleElement) roleElement.textContent = currentUser.jabatan || currentUser.role || 'User';
    }
    
    // Tampilkan modal
    const modal = document.getElementById('logoutModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    // Setup tombol di modal
    setupLogoutModalButtons();
}

function closeLogoutModal() {
    const modal = document.getElementById('logoutModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

async function performLogout() {
    console.log('🔴 LOGOUT SIMPLE');
    
    // 1. Tutup modal logout
    document.getElementById('logoutModal').style.display = 'none';
    
    // 2. Logout dari Supabase
    if (window.supabase) {
        await supabase.auth.signOut();
    }
    
    // 3. Reset user
    currentUser = null;
    
    // 4. Tampilkan login page, sembunyikan dashboard
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('baFormPage').style.display = 'none';
    
    // 5. Reset form login
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    
    // 6. Kasih alert
    alert('✅ Logout berhasil!');
}

function showLogoutSuccessPopup() {
    const successPopup = document.getElementById('logoutSuccessPopup');
    if (successPopup) {
        successPopup.style.display = 'block';
        
        // Sembunyikan otomatis setelah 3 detik
        setTimeout(() => {
            successPopup.style.display = 'none';
        }, 3000);
    }
}

function updateUIAfterLogout() {
    console.log('🔄 Update UI setelah logout...');
    
    // 1. Tampilkan halaman login
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('baFormPage').style.display = 'none';
    
    // 2. Reset form login dengan animasi
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    
    if (emailInput) {
        emailInput.style.transition = 'all 0.5s ease';
        emailInput.style.opacity = '0.5';
        setTimeout(() => {
            emailInput.value = '';
            emailInput.style.opacity = '1';
        }, 300);
    }
    
    if (passwordInput) {
        passwordInput.style.transition = 'all 0.5s ease';
        passwordInput.style.opacity = '0.5';
        setTimeout(() => {
            passwordInput.value = '';
            passwordInput.style.opacity = '1';
        }, 300);
    }
    
    // 3. Reset semua content area
    document.querySelectorAll('.content-area').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
    });
    
    // 4. Reset sidebar
    document.querySelectorAll('.sidebar-item').forEach(el => {
        el.classList.remove('active');
    });
    
    // 5. Reset header
    const header = document.querySelector('.header-left');
    if (header) {
        header.innerHTML = '<h1>Dashboard</h1><p>Sistem Manajemen Berita Acara</p>';
    }
    
    // 6. Focus ke email input
    setTimeout(() => {
        if (emailInput) {
            emailInput.focus();
            emailInput.style.transform = 'scale(1.02)';
            setTimeout(() => {
                emailInput.style.transform = 'scale(1)';
            }, 300);
        }
    }, 500);
    
    console.log('✅ UI berhasil diupdate');
}

// === UPDATE TOMBOL LOGOUT UNTUK PAKAI POPUP ===
function setupLogoutButtons() {
    console.log('🔧 Setup tombol logout dengan popup...');
    
    // Tombol logout di header
    const headerLogoutBtns = document.querySelectorAll('.logout-btn');
    headerLogoutBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            showLogoutPopup();
        });
    });
    
    // Tombol logout di bottom nav
    const bottomNavLogout = document.querySelector('.nav-item[onclick*="logout"], .nav-btn[onclick*="logout"]');
    if (bottomNavLogout) {
        bottomNavLogout.addEventListener('click', function(e) {
            e.preventDefault();
            showLogoutPopup();
        });
    }
    
    // Juga handle onclick inline
    document.querySelectorAll('[onclick*="logout()"]').forEach(el => {
        el.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            showLogoutPopup();
            return false;
        };
    });
    
    console.log(`✅ Setup selesai: ${headerLogoutBtns.length} tombol logout ditemukan`);
}

// === GANTI FUNGSI LOGOUT LAMA ===
window.logout = showLogoutPopup;

// === PASTIKAN FUNGSI DI SCOPE GLOBAL ===
window.logout = logout;

// === NEW FUNCTION TO SHOW DASHBOARD ===
function showDashboardContent() {
document.querySelectorAll('.content-area').forEach(el => {
    el.classList.remove('active');
});

document.getElementById('dashboardContent').classList.add('active');

document.querySelectorAll('.sidebar-item').forEach(el => {
    el.classList.remove('active');
});
document.querySelector('.sidebar-item').classList.add('active');

const header = document.querySelector('.header-left');
header.innerHTML = '<h1>Dashboard</h1><p>Sistem Manajemen Berita Acara</p>';
}

function showContent(contentId) {
    // --- CEK ROLE UNTUK MENU MASTER ---
    if (contentId === 'masterTech' && currentUser.role !== 'admin') {
        showNotification('Anda tidak memiliki akses ke halaman ini', 'error');
        return;
    }

    // --- UPDATE USER UI ---
    updateUserUI();

    // --- HIDE SEMUA CONTENT ---
    document.querySelectorAll('.content-area').forEach(el => {
        el.classList.remove('active');
    });

    // --- MOBILE: CLOSE SIDEBAR ---
    if (contentId === 'createBA' && window.innerWidth <= 768) {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.classList.remove('open');
    }

    // --- HIGHLIGHT SIDEBAR ITEM ---
    document.querySelectorAll('.sidebar-item').forEach(el => {
        el.classList.remove('active');
    });
    
    // Highlight sidebar item yang sesuai
    const sidebarItem = document.querySelector(`.sidebar-item[onclick*="${contentId}"]`);
    if (sidebarItem) {
        sidebarItem.classList.add('active');
    }

    // --- SHOW TARGET CONTENT ---
    const targetContent = document.getElementById(contentId + 'Content');
    if (targetContent) {
        targetContent.classList.add('active');
    } else {
        console.error('Content not found:', contentId + 'Content');
        return;
    }

    // --- BOTTOM NAV HIGHLIGHT ---
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const bottomNavItem = document.querySelector(`.nav-item[data-target="${contentId}"]`);
    if (bottomNavItem) {
        bottomNavItem.classList.add('active');
    }

    // --- LOAD DATA JIKA PERLU ---
    if (contentId === 'createBA') {
        setTimeout(() => {
            // loadBASaya(); // Masih dikomentari sampai kita perbaiki
        }, 100);
    }

    // --- UPDATE HEADER TITLE ---
    const header = document.querySelector('.header-left');
    const titleMap = {
        'technician': ['Manajemen Teknisi', 'Kelola data teknisi'],
        'createBA': ['Buat Berita Acara', 'Form pengisian BA'],
        'masterTech': ['Data Master', 'Import dan kelola data master'],
        'reports': ['Laporan', 'Analisis data BA'],
        'dashboard': ['Dashboard', 'Sistem Manajemen Berita Acara']
    };

    if (titleMap[contentId]) {
        header.innerHTML = `<h1>${titleMap[contentId][0]}</h1><p>${titleMap[contentId][1]}</p>`;
    }

    // --- EVENT FOR BOTTOM NAV (jika dipanggil dari bottom nav) ---
    if (window.innerWidth <= 768) {
        // Scroll ke atas saat ganti halaman di mobile
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// === DASHBOARD FUNCTIONS ===
function loadDashboardData() {
const activities = [
    { no: 'BA-001', customer: 'Budi Santoso', technician: 'Ahmad Rizki', date: '2024-01-15', status: 'Selesai' },
    { no: 'BA-002', customer: 'Siti Aisyah', technician: 'Muhammad Ali', date: '2024-01-14', status: 'Pending' },
    { no: 'BA-003', customer: 'Joko Widodo', technician: 'Ahmad Rizki', date: '2024-01-13', status: 'Selesai' },
    { no: 'BA-004', customer: 'Ani Wijaya', technician: 'Budi Hartono', date: '2024-01-12', status: 'Selesai' },
    { no: 'BA-005', customer: 'Rina Melati', technician: 'Muhammad Ali', date: '2024-01-11', status: 'Pending' }
];

const tbody = document.getElementById('recentActivity');
if (tbody) {
    tbody.innerHTML = '';

    activities.forEach(activity => {
        const statusClass = activity.status === 'Selesai' ? 'status-active' : 'status-inactive';
        tbody.innerHTML += `
            <tr>
                <td>${activity.no}</td>
                <td>${activity.customer}</td>
                <td>${activity.technician}</td>
                <td>${activity.date}</td>
                <td class="${statusClass}">${activity.status}</td>
            </tr>
        `;
    });
}
}

// === TECHNICIAN MANAGEMENT ===
async function loadTechnicians() {
    if (!currentUser || !supabase) return;

    try {
        showLoading('Memuat data teknisi...');

        let query = supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });

        if (currentUser.role !== 'admin') {
            query = query.eq('email', currentUser.email);
        }

        const { data: technicians, error } = await query;

        if (error) throw error;

        const container = document.getElementById('technicianContainer');
        const emptyMsg = document.getElementById('technicianEmpty');
        
        if (!container) return;

        container.innerHTML = '';

        if (!technicians || technicians.length === 0) {
            if (emptyMsg) emptyMsg.style.display = 'block';
            hideLoading();
            return;
        }

        if (emptyMsg) emptyMsg.style.display = 'none';

        technicians.forEach((tech) => {
            const card = document.createElement('div');
            card.className = 'horizontal-card';
            
            const statusColor = tech.status === 'active' ? '#27ae60' : '#e74c3c';
            const jabatanColor = tech.jabatan === 'Admin' ? '#9b59b6' : '#3498db';
            
            card.innerHTML = `
                <div class="card-header">
                    <h4 class="card-title">${tech.name || 'Tidak ada nama'}</h4>
                    <span class="card-badge" style="background: ${statusColor}15; color: ${statusColor}">
                        ${tech.status === 'active' ? 'Aktif' : 'Nonaktif'}
                    </span>
                </div>
                
                <div class="card-content">
                    <div class="card-row">
                        <i class="fas fa-envelope"></i>
                        <span style="font-size: 12px;">${tech.email || 'Email: -'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-id-card"></i>
                        <span>${tech.nik || 'NIK: -'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-user-tag"></i>
                        <span style="color: ${jabatanColor}">${tech.jabatan || 'Teknisi'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-handshake"></i>
                        <span>${tech.mitra || 'Mitra: -'}</span>
                    </div>
                </div>
                
                <div class="card-actions">
                    ${currentUser.role === 'admin' ? `
                        <button class="card-btn card-btn-edit" onclick="showEditTechModal('${tech.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="card-btn card-btn-delete" onclick="deleteTechnician('${tech.id}')">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                        <button class="card-btn ${tech.status === 'active' ? 'card-btn-delete' : 'card-btn-download'}" 
                                onclick="toggleTechnician('${tech.id}')">
                            <i class="fas fa-power-off"></i> ${tech.status === 'active' ? 'Nonaktif' : 'Aktif'}
                        </button>
                    ` : `
                        <button class="card-btn card-btn-view" onclick="viewTechDetail('${tech.id}')">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    `}
                </div>
            `;
            
            container.appendChild(card);
        });

        hideLoading();

    } catch (error) {
        console.error('Error loading technicians:', error);
        const container = document.getElementById('technicianContainer');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; color: #ff4757; padding: 40px; width: 100%;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                    <p>Error loading data</p>
                </div>
            `;
        }
        hideLoading();
    }
}

// === FUNGSI UPDATE JABATAN ===
async function updateJabatan(userId, newJabatan) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat mengubah jabatan');
    loadTechnicians();
    return;
}

if (confirm(`Ubah jabatan menjadi ${newJabatan}?`)) {
    try {
        await firestore.collection('users').doc(userId).update({
            jabatan: newJabatan,
            role: newJabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi'
        });

        showNotification('Jabatan berhasil diubah', 'success');
        loadTechnicians();

    } catch (error) {
        console.error('Error updating jabatan:', error);
        showNotification('Gagal mengubah jabatan', 'error');
    }
}
}

async function updateMitra(userId, newMitra) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat mengubah data mitra');
    return;
}

try {
    await firestore.collection('users').doc(userId).update({
        mitra: newMitra
    });

    if (userId === currentUser.id) {
        currentUser.mitra = newMitra;

        if (document.getElementById('baFormPage').style.display === 'block') {
            document.querySelector('input[name="nama_mitra"]').value = newMitra;
        }
    }

    console.log('Mitra berhasil diubah');

} catch (error) {
    console.error('Error updating mitra:', error);
    showNotification('Gagal mengubah mitra', 'error');
}
}

async function toggleTechnician(userId) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat mengubah status teknisi');
    return;
}

try {
    const userDoc = await firestore.collection('users').doc(userId).get();
    if (!userDoc.exists) return;

    const currentStatus = userDoc.data().status;
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';

    await firestore.collection('users').doc(userId).update({
        status: newStatus
    });

    showNotification(`Status berhasil diubah menjadi ${newStatus === 'active' ? 'Aktif' : 'Nonaktif'}`, 'success');
    loadTechnicians();

} catch (error) {
    console.error('Error toggling technician:', error);
    showNotification('Gagal mengubah status', 'error');
}
}

async function deleteTechnician(userId) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat menghapus teknisi');
    return;
}

if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
    try {
        await firestore.collection('users').doc(userId).delete();
        showNotification('User berhasil dihapus', 'success');
        loadTechnicians();
    } catch (error) {
        console.error('Error deleting user:', error);
        showNotification('Gagal menghapus user', 'error');
    }
}
}

function showAddUserModal() {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat menambahkan user');
    return;
}

document.getElementById('addUserModal').style.display = 'block';
document.getElementById('newUserError').style.display = 'none';
document.getElementById('newUserName').value = '';
document.getElementById('newUserNIK').value = '';
document.getElementById('newUserEmail').value = '';
document.getElementById('newUserPassword').value = '';
document.getElementById('newUserJabatan').value = 'Teknisi';
document.getElementById('newUserMitra').value = '';
}

function closeAddUserModal() {
document.getElementById('addUserModal').style.display = 'none';
}

async function submitNewUser() {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Hanya Admin yang dapat menambahkan user');
    return;
}

const name = document.getElementById('newUserName').value.trim();
const nik = document.getElementById('newUserNIK').value.trim();
const email = document.getElementById('newUserEmail').value.trim();
const password = document.getElementById('newUserPassword').value;
const jabatan = document.getElementById('newUserJabatan').value;
const mitra = document.getElementById('newUserMitra').value.trim();

if (!name || !nik || !email || !password || password.length < 6) {
    document.getElementById('newUserError').textContent = 'Harap isi semua field dengan benar (password minimal 6 karakter)';
    document.getElementById('newUserError').style.display = 'block';
    return;
}

if (!/^\d+$/.test(nik)) {
    document.getElementById('newUserError').textContent = 'NIK hanya boleh berisi angka';
    document.getElementById('newUserError').style.display = 'block';
    return;
}

if (nik.length < 6) {
    document.getElementById('newUserError').textContent = 'NIK minimal 6 digit';
    document.getElementById('newUserError').style.display = 'block';
    return;
}

try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;

    await firestore.collection('users').doc(user.uid).set({
        name: name,
        nik: nik,
        email: email,
        jabatan: jabatan,
        role: jabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi',
        mitra: mitra,
        status: 'active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser.id
    });

    showNotification('Teknisi berhasil ditambahkan', 'success');
    closeAddUserModal();
    loadTechnicians();

} catch (error) {
    console.error('Error adding user:', error);
    let errorMessage = 'Gagal menambahkan user: ';

    switch (error.code) {
        case 'auth/email-already-in-use':
            errorMessage = 'Email sudah terdaftar';
            break;
        case 'auth/invalid-email':
            errorMessage = 'Format email tidak valid';
            break;
        case 'auth/weak-password':
            errorMessage = 'Password terlalu lemah';
            break;
        default:
            errorMessage += error.message;
    }

    document.getElementById('newUserError').textContent = errorMessage;
    document.getElementById('newUserError').style.display = 'block';
}
}

function searchTechnicians() {
const searchTerm = document.getElementById('searchTech').value.toLowerCase();
const rows = document.querySelectorAll('#technicianTable tr');

rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
});
}

function exportTechnicians() {
showNotification('Data teknisi berhasil diexport ke Excel', 'success');
}

function importTechData() {
showNotification('Fitur Import Data - Buka file Excel untuk import data teknisi', 'info');
}

// === LOGOUT FUNCTION ===
function logout() {
    // Tampilkan modal
    document.getElementById('logoutModal').style.display = 'flex';
}

// === FUNGSI DI MODAL ===
function confirmLogout() {
    console.log('🔴 LOGOUT PROSES');
    
    // 1. Tutup modal logout
    document.getElementById('logoutModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // 2. Tampilkan notifikasi logout
    showNotification('Logout berhasil!', 'success');
    
    // 3. Logout dari Supabase
    if (window.supabase) {
        supabase.auth.signOut();
    }
    
    // 4. Reset user
    window.currentUser = null;
    
    // 5. Tampilkan login, sembunyikan dashboard
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('baFormPage').style.display = 'none';
    
    // 6. Reset form
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
}

// Di dalam file index.html, di dalam tag <script>



function initializeUI() {
    // Letakkan semua kode yang perlu dijalankan untuk menyiapkan UI di sini.
    // Contoh: kode yang menampilkan tombol hamburger.
    // Asumsi tombol hamburger Anda memiliki id="hamburger-icon"
    var hamburgerIcon = document.getElementById("hamburger-icon");
    if (hamburgerIcon) {
        hamburgerIcon.style.display = 'block'; // atau 'inline-block', 'flex', dll.
    }

    console.log("UI Initialized!"); // Pesan ini untuk debugging di konsol WebView
}



// ... fungsi lainnya seperti openNav, closeNav, handleAndroidBack, dll. ...


function handleAndroidBack() {
    // Contoh: Cek apakah sidebar sedang terbuka.
    // Asumsi lebar sidebar lebih dari 0 jika terbuka.
    var sidebar = document.getElementById("mySidebar");
    if (sidebar.style.width !== "0px" && sidebar.style.width !== "") {
        // Jika sidebar terbuka, tutup sidebar.
        closeNav();
        return true; // Beri tahu Java bahwa kita sudah menanganinya.
    }
    // Jika tidak ada yang perlu ditangani di JS, biarkan Java yang bekerja.
    return false;
}

// === MASTER DATA FUNCTIONS ===
async function loadMasterData() {
    if (!supabase) return;

    try {
        showLoading('Memuat data master...');

        const { data: masterData, error } = await supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        const container = document.getElementById('masterContainer');
        const emptyMsg = document.getElementById('masterEmpty');
        
        if (!container) return;

        container.innerHTML = '';

        if (!masterData || masterData.length === 0) {
            if (emptyMsg) emptyMsg.style.display = 'block';
            hideLoading();
            return;
        }

        if (emptyMsg) emptyMsg.style.display = 'none';

        masterData.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'horizontal-card';
            
            const jabatanColor = item.jabatan === 'Admin' ? '#9b59b6' : '#3498db';
            
            card.innerHTML = `
                <div class="card-header">
                    <h4 class="card-title">${item.name || 'Tidak ada nama'}</h4>
                    <span class="card-badge" style="background: ${jabatanColor}15; color: ${jabatanColor}">
                        ${item.jabatan || 'Teknisi'}
                    </span>
                </div>
                
                <div class="card-content">
                    <div class="card-row">
                        <i class="fas fa-envelope"></i>
                        <span style="font-size: 12px;">${item.email || 'Email: -'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-id-card"></i>
                        <span>${item.nik || 'NIK: -'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-handshake"></i>
                        <span>${item.mitra || 'Mitra: -'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-calendar"></i>
                        <span>${item.created_at ? new Date(item.created_at).toLocaleDateString('id-ID') : '-'}</span>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button class="card-btn card-btn-edit" onclick="editMaster('${item.id}')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="card-btn card-btn-delete" onclick="deleteMaster('${item.id}')">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        });

        hideLoading();

    } catch (error) {
        console.error('Error loading master data:', error);
        const container = document.getElementById('masterContainer');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; color: #ff4757; padding: 40px; width: 100%;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                    <p>Error loading data</p>
                </div>
            `;
        }
        hideLoading();
    }
}

function renderMasterTable(data) {
const tbody = document.getElementById('masterTable');
if (!tbody) return;

tbody.innerHTML = '';

if (data.length === 0) {
    tbody.innerHTML = `
        <tr>
            <td colspan="7" style="text-align: center; color: #666; padding: 20px;">
                <i class="fas fa-database"></i> Belum ada data master
            </td>
        </tr>
    `;
    return;
}

data.forEach(item => {
    tbody.innerHTML += `
        <tr>
            <td>${item.no}</td>
            <td>${item.name}</td>
            <td>${item.email}</td>
            <td>${item.nik}</td>
            <td>${item.jabatan}</td>
            <td>${item.mitra}</td>
            <td>${item.importDate}</td>
        </tr>
    `;
});
}

function getSampleMasterData() {
return [
    { no: 1, name: 'Ahmad Rizki', email: 'ahmad@example.com', nik: 'TK001', jabatan: 'Teknisi', mitra: 'PT Mitra Abadi', importDate: '2024-01-10' },
    { no: 2, name: 'Muhammad Ali', email: 'ali@example.com', nik: 'TK002', jabatan: 'Teknisi', mitra: 'CV Teknik Sejahtera', importDate: '2024-01-10' },
    { no: 3, name: 'Budi Hartono', email: 'budi@example.com', nik: 'TK003', jabatan: 'Admin', mitra: 'PT Sistem Informasi', importDate: '2024-01-09' },
    { no: 4, name: 'Siti Aisyah', email: 'siti@example.com', nik: 'TK004', jabatan: 'Teknisi', mitra: 'PT Jaya Makmur', importDate: '2024-01-09' },
    { no: 5, name: 'Joko Susanto', email: 'joko@example.com', nik: 'TK005', jabatan: 'Teknisi', mitra: 'CV Mandiri Teknik', importDate: '2024-01-08' }
];
}

function searchMasterData() {
const searchTerm = document.getElementById('searchMaster').value.toLowerCase();
const rows = document.querySelectorAll('#masterTable tr');

rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
});
}

function importExcel() {
if (!currentUser || currentUser.role !== 'admin') {
    showNotification('Hanya Admin yang dapat import data', 'error');
    return;
}

document.getElementById('excelFile').click();
}

function showAddMasterModal() {
document.getElementById('addMasterModal').style.display = 'block';
document.getElementById('newMasterError').style.display = 'none';
// Kosongkan form
document.getElementById('newMasterName').value = '';
document.getElementById('newMasterNIK').value = '';
document.getElementById('newMasterEmail').value = '';
document.getElementById('newMasterJabatan').value = 'Teknisi';
document.getElementById('newMasterMitra').value = '';
}

function closeAddMasterModal() {
document.getElementById('addMasterModal').style.display = 'none';
}

async function submitNewMaster() {
const name = document.getElementById('newMasterName').value.trim();
const nik = document.getElementById('newMasterNIK').value.trim();
const email = document.getElementById('newMasterEmail').value.trim();
const jabatan = document.getElementById('newMasterJabatan').value;
const mitra = document.getElementById('newMasterMitra').value.trim();

if (!name || !nik || !email) {
    document.getElementById('newMasterError').textContent = 'Harap isi Nama, NIK, dan Email.';
    document.getElementById('newMasterError').style.display = 'block';
    return;
}

try {
    showLoading('Memeriksa data...');

    // --- CEK EMAIL SUDAH ADA ---
    const emailQuery = await firestore.collection('users').where('email', '==', email).get();
    if (!emailQuery.empty) {
        document.getElementById('newMasterError').textContent = 'Email sudah terdaftar.';
        document.getElementById('newMasterError').style.display = 'block';
        hideLoading();
        return;
    }

    // --- CEK NIK SUDAH ADA ---
    const nikQuery = await firestore.collection('users').where('nik', '==', nik).get();
    if (!nikQuery.empty) {
        document.getElementById('newMasterError').textContent = 'NIK sudah terdaftar.';
        document.getElementById('newMasterError').style.display = 'block';
        hideLoading();
        return;
    }

    // --- JIKA TIDAK ADA, BUAT USER BARU ---
    const tempPassword = 'Password123';
    const userCredential = await auth.createUserWithEmailAndPassword(email, tempPassword);
    const user = userCredential.user;

    await firestore.collection('users').doc(user.uid).set({
        name: name,
        nik: nik,
        email: email,
        jabatan: jabatan,
        role: jabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi',
        mitra: mitra,
        status: 'active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showNotification('Data master berhasil ditambahkan', 'success');
    closeAddMasterModal();
    refreshMaster(); // Refresh tabel

} catch (error) {
    console.error('Error adding master data:', error);
    let errorMessage = 'Gagal menambah data: ';
    if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'Email sudah terdaftar.';
    } else {
        errorMessage += error.message;
    }
    document.getElementById('newMasterError').textContent = errorMessage;
    document.getElementById('newMasterError').style.display = 'block';
    hideLoading();
}
}

function handleExcelUpload(input) {
const file = input.files[0];
if (file) {
    showNotification(`File ${file.name} berhasil diupload. Data sedang diproses...`, 'info');

    setTimeout(() => {
        const sampleData = getSampleMasterData();

        localStorage.setItem('masterData', JSON.stringify(sampleData));

        if (firestore) {
            sampleData.forEach(async (item, index) => {
                try {
                    const existingUser = await firestore.collection('users')
                        .where('email', '==', item.email)
                        .get();

                    if (existingUser.empty) {
                        const tempPassword = 'Password123';
                        const userCredential = await auth.createUserWithEmailAndPassword(item.email, tempPassword);
                        const user = userCredential.user;

                        await firestore.collection('users').doc(user.uid).set({
                            name: item.name,
                            email: item.email,
                            nik: item.nik,
                            jabatan: item.jabatan,
                            role: item.jabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi',
                            mitra: item.mitra,
                            status: 'active',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            importedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            importedBy: currentUser.id
                        });
                    }
                } catch (error) {
                    console.error('Error importing user:', item.email, error);
                }
            });
        }

        showNotification('Data berhasil diimport dari Excel', 'success');
        loadMasterData();
        loadTechnicians();
    }, 1500);
}
}

function refreshMaster() {
localStorage.removeItem('masterData');

if (firestore) {
    firestore.collection('users').get().then(snapshot => {
        const data = [];
        snapshot.forEach(doc => {
            const tech = doc.data();
            if (tech.role === 'teknisi' || tech.role === 'admin' ||
                tech.jabatan === 'Teknisi' || tech.jabatan === 'Admin') {
                data.push({
                    no: data.length + 1,
                    name: tech.name || 'Tidak ada nama',
                    email: tech.email || 'Tidak ada email',
                    nik: tech.nik || doc.id.substring(0, 8),
                    jabatan: tech.jabatan || 'Teknisi',
                    mitra: tech.mitra || '',
                    importDate: tech.createdAt ? new Date(tech.createdAt.toDate()).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
                });
            }
        });

        localStorage.setItem('masterData', JSON.stringify(data));
        renderMasterTable(data);

        showNotification('Data master diperbarui', 'success');
    }).catch(error => {
        console.error('Error refreshing master data:', error);
        showNotification('Gagal memperbarui data master', 'error');
    });
} else {
    renderMasterTable(getSampleMasterData());
    showNotification('Data master diperbarui', 'success');
}
}

function openBAForm() {
  document.getElementById('dashboardPage').style.display = 'none';
  document.getElementById('baFormPage').style.display = 'block';

  if (window.innerWidth <= 768) {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sidebar.classList.remove('open');
    }
  }

  // Generate nomor BA
  const { counter } = getBACounter();
  const now = new Date();
  const tahun = now.getFullYear();
  const bulan = String(now.getMonth() + 1).padStart(2, '0');
  const nextNumber = counter + 1;
  const nomorUrut = String(nextNumber).padStart(3, '0');
  const noBA = `BA/${tahun}/${bulan}/${nomorUrut}`;

  const noBADisplay = document.getElementById('noBADisplay');
  if (noBADisplay) {
    noBADisplay.textContent = noBA;
  }

  // Isi data user jika login
  if (currentUser) {
    const namaTeknisiDisplay = document.getElementById('namaTeknisiDisplay');
    if (namaTeknisiDisplay) {
      namaTeknisiDisplay.textContent = currentUser.name;
    }

    const namaTeknisiTTD = document.getElementById('namaTeknisiTTD');
    if (namaTeknisiTTD) {
      namaTeknisiTTD.textContent = currentUser.name;
    }

    // --- PERBAIKAN: AMBIL DATA MITRA DARI SUPABASE ---
    const mitraSpan = document.getElementById('nama_mitra');
    if (mitraSpan) {
      if (currentUser.mitra) {
        mitraSpan.textContent = currentUser.mitra;
      } else {
        // Jika kosong, coba ambil lagi dari Supabase
        if (supabase) {
          supabase
            .from('users')
            .select('mitra')
            .eq('id', currentUser.id)
            .single()
            .then(({ data, error }) => {
              if (!error && data && data.mitra) {
                mitraSpan.textContent = data.mitra;
                currentUser.mitra = data.mitra; // Update juga di variabel
              }
            });
        }
      }
    }
  }

  // Set tanggal hari ini
  const today = new Date().toISOString().split('T')[0];
  const tanggalInput = document.querySelector('input[name="tanggal_lumajang"]');
  if (tanggalInput) {
    tanggalInput.value = today;
  }

  // Setup canvas tanda tangan
  setupSignatureCanvas();

  // Setup validasi form
  setupValidation();

  // Reset status tanda tangan
  pelangganSigned = false;
  petugasSigned = false;

  // Reset error styling
  const signaturePelangganBox = document.getElementById('signaturePelangganBox');
  if (signaturePelangganBox) {
    signaturePelangganBox.classList.remove('error');
  }

  const signaturePetugasBox = document.getElementById('signaturePetugasBox');
  if (signaturePetugasBox) {
    signaturePetugasBox.classList.remove('error');
  }

  // Reset draft ID untuk form baru
  resetDraftId();

  // Coba load draft terakhir jika ada
  const draftKeys = Object.keys(localStorage).filter(key => key.startsWith('ba_draft_'));
  if (draftKeys.length > 0) {
    // Ambil draft terbaru user ini
    const latestDraftKey = draftKeys.reduce((latest, key) => {
      try {
        const draftData = JSON.parse(localStorage.getItem(key));
        if (draftData.userEmail === currentUser.email) {
          if (!latest || new Date(draftData.updatedAt) > new Date(latest.updatedAt)) {
            return { key, data: draftData };
          }
        }
      } catch (e) {
        console.log('Error parsing draft:', e);
      }
      return latest;
    }, null);

    if (latestDraftKey) {
      if (confirm('Ada draft yang belum diselesaikan dari ' +
                 new Date(latestDraftKey.data.updatedAt).toLocaleString('id-ID') +
                 '. Apakah Anda ingin melanjutkan?')) {
        setTimeout(() => {
          loadDraft(latestDraftKey.data.id);
        }, 500);
      }
    }
  }
}

// === VALIDATION FUNCTIONS ===
function setupValidation() {
const stoInput = document.querySelector('input[name="sto"]');
stoInput.addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});

const woInput = document.querySelector('input[name="no_permintaan"]');
woInput.addEventListener('input', function() {
    this.value = this.value.replace(/[^A-Za-z0-9]/g, '');
});

const inetInput = document.querySelector('input[name="no_inet"]');
inetInput.addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
});

const kontakInput = document.querySelector('input[name="no_kontak"]');
kontakInput.addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9+ -]/g, '');
});

document.querySelectorAll('.test-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const group = this.getAttribute('data-group');
        if (this.checked) {
            document.querySelectorAll(`.test-checkbox[data-group="${group}"]`).forEach(cb => {
                if (cb !== this) cb.checked = false;
            });
        }
    });
});
}


// === FALLBACK LOGOUT UNTUK DEBUG ===
function forceLogout() {
    console.log('🆘 Force logout dijalankan');
    
    // Reset semua
    currentUser = null;
    
    // Reset UI
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('baFormPage').style.display = 'none';
    
    // Reset form
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    
    // Hapus localStorage
    localStorage.clear();
    
    alert('Logout paksa berhasil!');
    
    // Reload page untuk reset state
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Tambahkan tombol debug logout (opsional, untuk testing)
function addDebugLogoutButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = 'DEBUG: Force Logout';
    debugBtn.style.cssText = `
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: red;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        z-index: 99999;
        font-size: 10px;
    `;
    debugBtn.onclick = forceLogout;
    document.body.appendChild(debugBtn);
    
    console.log('🐛 Tombol debug logout ditambahkan');
}

// Di bagian setupBottomNav atau init function
function setupBottomNavListeners() {
  // Logout dari bottom nav
  const bottomNavLogout = document.querySelector('.nav-item[onclick*="logout"]');
  if (bottomNavLogout) {
    bottomNavLogout.removeAttribute('onclick'); // Hapus onclick inline
    bottomNavLogout.addEventListener('click', logout);
  }
}

// Panggil di DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
  setupBottomNavListeners();
});

// FUNGSI UNTUK TOGGLE BOTTOM NAV
// === PERBAIKAN BOTTOM NAVIGATION ===
function setupBottomNav() {
    const bottomNav = document.getElementById('bottomNav');
    
    if (!bottomNav) return;
    
    // FUNGSI UNTUK MENENTUKAN KAPAN BOTTOM NAV DITAMPILKAN
    function updateBottomNavVisibility() {
        const isLoginPage = document.getElementById('loginPage').style.display !== 'none';
        const isBAFormPage = document.getElementById('baFormPage').style.display !== 'none';
        const isPDFModal = document.getElementById('pdfPreviewModal')?.style.display === 'block';
        const isScannerModal = document.getElementById('scannerModal')?.style.display === 'block';
        const isCameraModal = document.getElementById('cameraModal')?.style.display === 'block';
        
        // Tampilkan bottom nav jika:
        // - Bukan login page
        // - Bukan BA form page  
        // - Tidak ada modal yang aktif
        const shouldShow = !isLoginPage && !isBAFormPage && !isPDFModal && !isScannerModal && !isCameraModal;
        
        // Hanya tampil di mobile
        if (window.innerWidth <= 768) {
            bottomNav.style.display = shouldShow ? 'flex' : 'none';
        } else {
            bottomNav.style.display = 'none';
        }
    }
    
    // Update visibility saat ini
    updateBottomNavVisibility();
    
    // Listen untuk perubahan display
    const observer = new MutationObserver(updateBottomNavVisibility);
    
    // Observe elemen yang bisa berubah display
    const elementsToObserve = [
        document.getElementById('loginPage'),
        document.getElementById('dashboardPage'), 
        document.getElementById('baFormPage'),
        document.getElementById('pdfPreviewModal'),
        document.getElementById('scannerModal'),
        document.getElementById('cameraModal')
    ];
    
    elementsToObserve.forEach(el => {
        if (el) {
            observer.observe(el, { 
                attributes: true, 
                attributeFilter: ['style'] 
            });
        }
    });
    
    // Update saat resize
    window.addEventListener('resize', updateBottomNavVisibility);
    
    // Update saat modal dibuka/tutup
    document.addEventListener('click', function(e) {
        setTimeout(updateBottomNavVisibility, 100);
    });
}

// === PERBAIKAN FUNGSI showContent ===
function showContent(contentId) {
    console.log('🚀 MENU DITEKAN:', contentId);
    
    // --- CEK ROLE UNTUK MENU MASTER ---
    if (contentId === 'masterTech' && currentUser.role !== 'admin') {
        showNotification('Anda tidak memiliki akses ke halaman ini', 'error');
        return;
    }

    // --- UPDATE USER UI ---
    updateUserUI();

    // --- HIDE SEMUA CONTENT ---
    document.querySelectorAll('.content-area').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
    });
    
    // --- SHOW TARGET CONTENT ---
    const target = document.getElementById(contentId + 'Content');
    if (target) {
        target.classList.add('active');
        target.style.display = 'block';
    } else {
        console.error('Content not found:', contentId + 'Content');
        return;
    }

    // --- HIGHLIGHT SIDEBAR ITEM ---
    document.querySelectorAll('.sidebar-item').forEach(el => {
        el.classList.remove('active');
    });
    
    const sidebarItem = document.querySelector(`.sidebar-item[onclick*="${contentId}"]`);
    if (sidebarItem) {
        sidebarItem.classList.add('active');
    }

    // --- UPDATE BOTTOM NAV ACTIVE ---
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const bottomNavItem = document.querySelector(`.nav-item[data-target="${contentId}"]`);
    if (bottomNavItem) {
        bottomNavItem.classList.add('active');
    }

    // --- LOAD DATA JIKA PERLU ---
    if (contentId === 'createBA') {
        setTimeout(() => {
            loadBASaya();
        }, 100);
    }

    // --- UPDATE HEADER TITLE ---
    const header = document.querySelector('.header-left');
    const titleMap = {
        'technician': 'Manajemen Teknisi',
        'createBA': 'Buat Berita Acara', 
        'masterTech': 'Data Master',
        'reports': 'Laporan',
        'dashboard': 'Dashboard'
    };

    if (titleMap[contentId]) {
        header.innerHTML = `<h1>${titleMap[contentId]}</h1><p>Sistem Manajemen Berita Acara</p>`;
    }

    // --- UPDATE BOTTOM NAV VISIBILITY ---
    setupBottomNav();
    
    // --- SCROLL KE ATAS ---
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    console.log('✅ Content ditampilkan:', contentId);
}

// === INIT SAAT PAGE LOAD ===
document.addEventListener('DOMContentLoaded', function() {
    // Setup bottom navigation
    setTimeout(() => {
        setupBottomNav();
    }, 500);
});

// Fungsi untuk mendapatkan/membuat draft ID
function getCurrentDraftId() {
let draftId = localStorage.getItem('currentDraftId');
if (!draftId) {
    draftId = 'draft_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('currentDraftId', draftId);
}
return draftId;
}

// Fungsi untuk reset draft ID
function resetDraftId() {
localStorage.removeItem('currentDraftId');
}

// Fungsi untuk menyimpan draft
async function saveDraft() {
if (!currentUser) return;

try {
    const draftId = getCurrentDraftId();
    const formData = {};

    // Kumpulkan semua data dari form
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio') {
            formData[input.name] = input.checked;
        } else {
            formData[input.name] = input.value;
        }
    });

    // Simpan data draft ke localStorage
    const draftData = {
        id: draftId,
        formData: formData,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        userEmail: currentUser.email,
        userName: currentUser.name,
        status: 'Draft'
    };

    localStorage.setItem(`ba_draft_${draftId}`, JSON.stringify(draftData));

    // Simpan juga ke Firestore untuk backup
    await saveDraftToFirestore(draftData);

    showNotification('Draft berhasil disimpan!', 'success');

    // Refresh list BA Saya
    loadBASaya();

} catch (error) {
    console.error('Error saving draft:', error);
    showNotification('Gagal menyimpan draft', 'error');
}
}

// Fungsi untuk menyimpan draft ke Firestore
async function saveDraftToFirestore(draftData) {
if (!firestore) return;

try {
    await firestore.collection('ba_drafts').doc(draftData.id).set({
        ...draftData,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
} catch (error) {
    console.error('Error saving draft to Firestore:', error);
}
}

// Fungsi untuk load draft dari localStorage atau Firestore
async function loadDraft(draftId) {
try {
    // Cek di localStorage dulu
    const localDraft = localStorage.getItem(`ba_draft_${draftId}`);

    if (localDraft) {
        const draftData = JSON.parse(localDraft);
        populateFormFromDraft(draftData);
        showNotification('Draft dimuat dari penyimpanan lokal', 'info');
        return;
    }

    // Jika tidak ada di localStorage, cek di Firestore
    if (firestore) {
        const draftDoc = await firestore.collection('ba_drafts').doc(draftId).get();

        if (draftDoc.exists) {
            const draftData = draftDoc.data();
            populateFormFromDraft(draftData);
            showNotification('Draft dimuat dari database', 'info');
        }
    }

} catch (error) {
    console.error('Error loading draft:', error);
    showNotification('Gagal memuat draft', 'error');
}
}

// Fungsi untuk mengisi form dari data draft
function populateFormFromDraft(draftData) {
if (!draftData.formData) return;

const formData = draftData.formData;

// Isi semua field
Object.keys(formData).forEach(key => {
    const input = document.querySelector(`[name="${key}"]`);
    if (input) {
        if (input.type === 'checkbox') {
            input.checked = formData[key];
        } else {
            input.value = formData[key] || '';
        }
    }
});

// Update nomor BA jika ada
if (draftData.noBA) {
    document.getElementById('noBADisplay').textContent = draftData.noBA;
}

// Load tanda tangan jika ada
loadSignatureFromDraft(draftData.id, 'pelanggan');
loadSignatureFromDraft(draftData.id, 'petugas');

// Set current draft ID
localStorage.setItem('currentDraftId', draftData.id);
}

// Fungsi untuk menghapus draft
async function deleteDraft(draftId) {
if (confirm('Apakah Anda yakin ingin menghapus draft ini?')) {
    try {
        // Hapus dari localStorage
        localStorage.removeItem(`ba_draft_${draftId}`);

        // Hapus tanda tangan dari localStorage
        localStorage.removeItem(`signature_pelanggan_${draftId}`);
        localStorage.removeItem(`signature_petugas_${draftId}`);

        // Hapus dari Firestore
        if (firestore) {
            await firestore.collection('ba_drafts').doc(draftId).delete();
        }

        showNotification('Draft berhasil dihapus', 'success');
        loadBASaya();

    } catch (error) {
        console.error('Error deleting draft:', error);
        showNotification('Gagal menghapus draft', 'error');
    }
}
}

// Fungsi untuk setup tanda tangan canvas
function setupSignatureCanvas() {
const canvases = {
    'pelanggan': document.getElementById('signature-pelanggan'),
    'petugas': document.getElementById('signature-petugas')
};

Object.keys(canvases).forEach(key => {
    const canvas = canvases[key];
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Clear canvas terlebih dahulu
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';

    function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        let x, y;

        if (e.type.includes('touch')) {
            x = e.touches[0].clientX - rect.left;
            y = e.touches[0].clientY - rect.top;
        } else {
            x = e.clientX - rect.left;
            y = e.clientY - rect.top;
        }
        return { x, y };
    }

    function startDrawing(e) {
        // --- PERBAIKAN: CEK STATUS TTD SEBELUM MENGGAMBAR ---
        if ((key === 'pelanggan' && pelangganSigned) || (key === 'petugas' && petugasSigned)) {
            return; // Cegah menggambar jika sudah disimpan
        }
        // --- AKHIR PERBAIKAN ---

        isDrawing = true;
        const pos = getPosition(e);
        [lastX, lastY] = [pos.x, pos.y];

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
    }

    function draw(e) {
        if (!isDrawing) return;

        const pos = getPosition(e);

        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();

        [lastX, lastY] = [pos.x, pos.y];
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath();
    }

    // Event listeners untuk touch
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        startDrawing(e);
    }, { passive: false });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        draw(e);
    }, { passive: false });

    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        stopDrawing();
    }, { passive: false });

    // Event listeners untuk mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
});
}

function clearSignature(type) {
const canvas = document.getElementById(`signature-${type}`);
const ctx = canvas.getContext('2d');
ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.fillStyle = 'white';
ctx.fillRect(0, 0, canvas.width, canvas.height);

// --- PERBAIKAN: RESET STATUS TTD DAN HAPUS DARI LOCALSTORAGE ---
if (type === 'pelanggan') {
    pelangganSigned = false;
    const draftId = getCurrentDraftId();
    localStorage.removeItem(`signature_pelanggan_${draftId}`);
} else if (type === 'petugas') {
    petugasSigned = false;
    const draftId = getCurrentDraftId();
    localStorage.removeItem(`signature_petugas_${draftId}`);
}
// --- AKHIR PERBAIKAN ---
}



// Fungsi untuk save tanda tangan
function saveSignature(type) {
const canvas = document.getElementById(`signature-${type}`);

// Cek apakah canvas memiliki tanda tangan
const ctx = canvas.getContext('2d');
const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
const isEmpty = !imageData.data.some(channel => channel !== 0);

if (isEmpty) {
    showNotification(`Tanda tangan ${type} masih kosong`, 'warning');
    return;
}

if (type === 'pelanggan') {
    pelangganSigned = true;
    showNotification('Tanda tangan pelanggan berhasil disimpan!', 'success');
} else if (type === 'petugas') {
    petugasSigned = true;
    showNotification('Tanda tangan petugas berhasil disimpan!', 'success');
}

// Simpan ke localStorage untuk draft
const signatureData = canvas.toDataURL('image/png');
const draftId = getCurrentDraftId();
localStorage.setItem(`signature_${type}_${draftId}`, signatureData);

// Hapus error styling
const signatureBox = document.getElementById(`signature${type.charAt(0).toUpperCase() + type.slice(1)}Box`);
if (signatureBox) {
    signatureBox.classList.remove('error');
    signatureBox.style.border = '';
    signatureBox.style.backgroundColor = '';
}
}

// Fungsi untuk load tanda tangan dari draft
function loadSignatureFromDraft(draftId, type) {
if (!draftId) return;

const signatureData = localStorage.getItem(`signature_${type}_${draftId}`);
if (signatureData) {
    const canvas = document.getElementById(`signature-${type}`);
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Update status tanda tangan
        if (type === 'pelanggan') {
            pelangganSigned = true;
            document.getElementById('signaturePelangganBox').classList.remove('error');
        } else if (type === 'petugas') {
            petugasSigned = true;
            document.getElementById('signaturePetugasBox').classList.remove('error');
        }
    };
    img.src = signatureData;
}
}

// Fungsi untuk setup validation form
function setupValidation() {
// Validasi STO harus uppercase
const stoInput = document.querySelector('input[name="sto"]');
if (stoInput) {
    stoInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });

    stoInput.addEventListener('blur', function() {
        if (this.value && this.value !== this.value.toUpperCase()) {
            this.classList.add('error-field');
            showNotification('STO harus dalam huruf kapital', 'warning');
        }
    });
}

// Validasi No Permintaan hanya huruf dan angka
const woInput = document.querySelector('input[name="no_permintaan"]');
if (woInput) {
    woInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^A-Za-z0-9]/g, '');
    });
}

// Validasi No Inet hanya angka
const inetInput = document.querySelector('input[name="no_inet"]');
if (inetInput) {
    inetInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
}

// Validasi No Kontak
const kontakInput = document.querySelector('input[name="no_kontak"]');
if (kontakInput) {
    kontakInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9+ -]/g, '');
    });
}

// Validasi checkbox test usage (hanya satu yang boleh dicentang per group)
document.querySelectorAll('.test-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const group = this.getAttribute('data-group');
        if (this.checked) {
            // Uncheck yang lain dalam group yang sama
            document.querySelectorAll(`.test-checkbox[data-group="${group}"]`).forEach(cb => {
                if (cb !== this) {
                    cb.checked = false;
                    cb.classList.remove('error-field');
                }
            });
            this.classList.remove('error-field');
        }
    });
});
}

// Fungsi untuk mendapatkan/membuat draft ID
function getCurrentDraftId() {
let draftId = localStorage.getItem('currentDraftId');
if (!draftId && currentUser) {
    draftId = 'draft_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('currentDraftId', draftId);
}
return draftId;
}

// Fungsi untuk reset draft ID
function resetDraftId() {
localStorage.removeItem('currentDraftId');
}

// Fungsi untuk load draft
async function loadDraft(draftId) {
try {
    // Set current draft ID
    localStorage.setItem('currentDraftId', draftId);

    // Cek di localStorage dulu
    const localDraft = localStorage.getItem(`ba_draft_${draftId}`);

    if (localDraft) {
        const draftData = JSON.parse(localDraft);
        populateFormFromDraft(draftData);
        return;
    }

    // Jika tidak ada di localStorage, cek di Firestore
    if (firestore) {
        const draftDoc = await firestore.collection('ba_drafts').doc(draftId).get();

        if (draftDoc.exists) {
            const draftData = draftDoc.data();
            populateFormFromDraft(draftData);
        }
    }

} catch (error) {
    console.error('Error loading draft:', error);
}
}

// Fungsi untuk mengisi form dari data draft
function populateFormFromDraft(draftData) {
if (!draftData || !draftData.formData) return;

const formData = draftData.formData;

// Isi semua field
Object.keys(formData).forEach(key => {
    const input = document.querySelector(`[name="${key}"]`);
    if (input) {
        if (input.type === 'checkbox') {
            input.checked = Boolean(formData[key]);
        } else {
            input.value = formData[key] || '';
        }
    }
});

// Update nomor BA jika ada
if (draftData.noBA) {
    document.getElementById('noBADisplay').textContent = draftData.noBA;
}

// Update status tanda tangan
if (draftData.pelangganSigned) {
    pelangganSigned = draftData.pelangganSigned;
    document.getElementById('signaturePelangganBox').classList.remove('error');
}

if (draftData.petugasSigned) {
    petugasSigned = draftData.petugasSigned;
    document.getElementById('signaturePetugasBox').classList.remove('error');
}

showNotification('Draft berhasil dimuat', 'success');
}

// Fungsi untuk save draft
async function saveDraft() {
if (!currentUser) {
    showNotification('Anda harus login untuk menyimpan draft', 'error');
    return;
}

try {
    const draftId = getCurrentDraftId();
    const formData = {};

    // Kumpulkan semua data dari form
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio') {
            formData[input.name] = input.checked;
        } else {
            formData[input.name] = input.value;
        }
    });

    // Data draft
    const draftData = {
        id: draftId,
        userId: currentUser.id, // TAMBAHKAN BARIS INI
        formData: formData,
        noBA: document.getElementById('noBADisplay').textContent,
        pelangganSigned: pelangganSigned,
        petugasSigned: petugasSigned,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        userEmail: currentUser.email,
        userName: currentUser.name,
        status: 'Draft'
    };

    // Simpan ke localStorage
    localStorage.setItem(`ba_draft_${draftId}`, JSON.stringify(draftData));

    // Simpan tanda tangan ke localStorage
    if (pelangganSigned) {
        const canvasPelanggan = document.getElementById('signature-pelanggan');
        const signaturePelanggan = canvasPelanggan.toDataURL('image/png');
        localStorage.setItem(`signature_pelanggan_${draftId}`, signaturePelanggan);
    }

    if (petugasSigned) {
        const canvasPetugas = document.getElementById('signature-petugas');
        const signaturePetugas = canvasPetugas.toDataURL('image/png');
        localStorage.setItem(`signature_petugas_${draftId}`, signaturePetugas);
    }

    // Simpan ke Firestore jika online
    if (firestore) {
        try {
            await firestore.collection('ba_drafts').doc(draftId).set({
                ...draftData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (firestoreError) {
            console.log('Gagal menyimpan draft ke Firestore, hanya disimpan lokal:', firestoreError);
        }
    }

    showNotification('Draft berhasil disimpan!', 'success');

    // Refresh list BA Saya
    loadBASaya();

} catch (error) {
    console.error('Error saving draft:', error);
    showNotification('Gagal menyimpan draft', 'error');
}
}

function validateRequiredFields() {
// Daftar field yang wajib diisi
const requiredFields = [
    'sto',
    'no_permintaan',
    'no_inet',
    'tanggal_wo',
    'nama_pelanggan',
    'no_kontak',
    'alamat_pelanggan',
    'ONT_yang_DIPASANG_/_DITARIK',
    'sn_ont',
    'stb_id'
];

let isValid = true;
let firstErrorField = null;

// Validasi field required
requiredFields.forEach(fieldName => {
    const field = document.querySelector(`input[name="${fieldName}"]`);
    if (field) {
        if (!field.value.trim()) {
            field.classList.add('error-field');
            isValid = false;
            if (!firstErrorField) firstErrorField = field;
        } else {
            field.classList.remove('error-field');
        }
    }
});

// Validasi STO harus uppercase
const stoField = document.querySelector('input[name="sto"]');
if (stoField && stoField.value.trim() !== stoField.value.trim().toUpperCase()) {
    stoField.classList.add('error-field');
    isValid = false;
    if (!firstErrorField) firstErrorField = stoField;
    showNotification('STO harus dalam huruf kapital', 'warning');
}

// Validasi checkbox test usage (hanya satu yang boleh dicentang per group)
const checkboxGroups = ['voice', 'inet', 'usetv'];
checkboxGroups.forEach(group => {
    const checkboxes = document.querySelectorAll(`.test-checkbox[data-group="${group}"]`);
    const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);

    if (checkedBoxes.length > 1) {
        checkboxes.forEach(cb => cb.classList.add('error-field'));
        isValid = false;
        if (!firstErrorField) firstErrorField = checkboxes[0];
        showNotification(`Pilih hanya satu opsi untuk tes ${group}`, 'warning');
    } else {
        checkboxes.forEach(cb => cb.classList.remove('error-field'));
    }
});

// Tambahkan ini di dalam fungsi updateUserUI()
function updateUserUI() {
if (!currentUser) return;

const userNameEl = document.getElementById('userName');
const userRoleEl = document.getElementById('userRole');
const userAvatarEl = document.getElementById('userAvatar');

if (userNameEl) userNameEl.textContent = currentUser.name;
if (userRoleEl) userRoleEl.textContent = currentUser.jabatan || currentUser.role || 'User';
if (userAvatarEl) userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();

// --- PERBAIKAN: SEMBUNYIKAN MENU DATA MASTER UNTUK TEKNISI ---
const masterTechMenu = document.querySelector('.sidebar-item[onclick*="masterTech"]');
if (masterTechMenu) {
    if (currentUser.role !== 'admin') {
        masterTechMenu.style.display = 'none';
    } else {
        masterTechMenu.style.display = 'flex'; // Kembalikan ke tampilan semula
    }
}
// --- AKHIR PERBAIKAN ---
}

// VALIDASI TANDA TANGAN WAJIB
// --- PERBAIKAN: CARI SIGNATURE BOX DENGAN BENAR ---
const canvasPelanggan = document.getElementById('signature-pelanggan');
const signaturePelangganBox = canvasPelanggan ? canvasPelanggan.closest('.signature-box') : null;

const canvasPetugas = document.getElementById('signature-petugas');
const signaturePetugasBox = canvasPetugas ? canvasPetugas.closest('.signature-box') : null;
// --- AKHIR PERBAIKAN ---

// Validasi TTD Petugas (WAJIB)
if (!petugasSigned) {
    if (signaturePetugasBox) {
        signaturePetugasBox.classList.add('error');
        signaturePetugasBox.style.border = '1px solid red';
        signaturePetugasBox.style.backgroundColor = 'rgba(255, 0, 0, 0.05)';

        // Tambahkan label error
        let errorLabel = signaturePetugasBox.querySelector('.signature-error');
        if (!errorLabel) {
            errorLabel = document.createElement('div');
            errorLabel.className = 'signature-error';
            errorLabel.innerHTML = '<i class="fas fa-exclamation-circle"></i> TTD wajib diisi';
            errorLabel.style.color = 'red';
            errorLabel.style.fontSize = '10px';
            errorLabel.style.marginTop = '5px';
            signaturePetugasBox.appendChild(errorLabel);
        }
    }

    isValid = false;
    if (!firstErrorField) {
        firstErrorField = canvasPetugas;
    }
} else {
    if (signaturePetugasBox) {
        signaturePetugasBox.classList.remove('error');
        signaturePetugasBox.style.border = '';
        signaturePetugasBox.style.backgroundColor = '';

        // Hapus label error jika ada
        const errorLabel = signaturePetugasBox.querySelector('.signature-error');
        if (errorLabel) {
            errorLabel.remove();
        }
    }
}

// Validasi TTD Pelanggan (WAJIB)
if (!pelangganSigned) {
    if (signaturePelangganBox) {
        signaturePelangganBox.classList.add('error');
        signaturePelangganBox.style.border = '1px solid red';
        signaturePelangganBox.style.backgroundColor = 'rgba(255, 0, 0, 0.05)';

        // Tambahkan label error
        let errorLabel = signaturePelangganBox.querySelector('.signature-error');
        if (!errorLabel) {
            errorLabel = document.createElement('div');
            errorLabel.className = 'signature-error';
            errorLabel.innerHTML = '<i class="fas fa-exclamation-circle"></i> TTD wajib diisi';
            errorLabel.style.color = 'red';
            errorLabel.style.fontSize = '10px';
            errorLabel.style.marginTop = '5px';
            signaturePelangganBox.appendChild(errorLabel);
        }
    }

    isValid = false;
    if (!firstErrorField) {
        firstErrorField = canvasPelanggan;
    }
} else {
    if (signaturePelangganBox) {
        signaturePelangganBox.classList.remove('error');
        signaturePelangganBox.style.border = '';
        signaturePelangganBox.style.backgroundColor = '';

        // Hapus label error jika ada
        const errorLabel = signaturePelangganBox.querySelector('.signature-error');
        if (errorLabel) {
            errorLabel.remove();
        }
    }
}

// Tampilkan notifikasi jika ada error
if (!isValid) {
    if (!petugasSigned && !pelangganSigned) {
        showNotification('Tanda tangan Petugas dan Pelanggan WAJIB diisi!', 'error');
    } else if (!petugasSigned) {
        showNotification('Tanda tangan Petugas WAJIB diisi!', 'error');
    } else if (!pelangganSigned) {
        showNotification('Tanda tangan Pelanggan WAJIB diisi!', 'error');
    } else {
        showNotification('Harap lengkapi semua field yang wajib diisi', 'error');
    }

    // Scroll ke field pertama yang error
    if (firstErrorField) {
        setTimeout(() => {
            firstErrorField.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // Jika field adalah input, focus ke field tersebut
            if (firstErrorField.tagName === 'INPUT' || firstErrorField.tagName === 'SELECT' || firstErrorField.tagName === 'TEXTAREA') {
                firstErrorField.focus();
            }
        }, 300);
    }
}

return isValid;
}






// ==================== FUNGSI BARU: saveBAToForm() YANG LOAD SEMUA DATA ====================
function saveBAToForm(baData) {
    console.log('💾 Loading SEMUA data ke form dari:', baData);
    
    // ===== 1. ISI SEMUA FIELD TEXT/DATE/TEXTAREA =====
    const allTextFields = document.querySelectorAll(`
        #baFormPage input[type="text"],
        #baFormPage input[type="date"], 
        #baFormPage input[type="number"],
        #baFormPage textarea
    `);
    
    allTextFields.forEach(input => {
        const fieldName = input.name;
        
        // Coba cari data dengan nama field yang sama
        if (baData[fieldName] !== undefined && baData[fieldName] !== null) {
            input.value = baData[fieldName];
            
            // HIGHLIGHT jika ada isinya
            if (baData[fieldName].toString().trim()) {
                input.style.backgroundColor = '#e8f5e9';
                input.style.borderLeft = '3px solid #27ae60';
            }
        }
        
        // Coba cari dengan nama field alternatif
        const altNames = {
            'sto': ['STO', 'sto'],
            'no_permintaan': ['no_wo', 'wo_number', 'no_permintaan'],
            'no_inet': ['no_internet', 'internet_number', 'no_inet'],
            'nama_pelanggan': ['pelanggan', 'customer_name', 'nama_pelanggan'],
            'alamat_pelanggan': ['alamat', 'address', 'alamat_pelanggan'],
            'tanggal_wo': ['tanggal_pekerjaan', 'work_date', 'tanggal_wo'],
            'no_kontak': ['kontak', 'contact', 'no_kontak'],
            'ONT_yang_DIPASANG_/_DITARIK': ['ont_ditarik', 'ont_old', 'ONT_ditarik'],
            'sn_ont': ['serial_ont', 'ont_sn', 'sn_ont'],
            'stb_id': ['stb_sn', 'serial_stb', 'stb_id']
        };
        
        if (altNames[fieldName]) {
            for (const altName of altNames[fieldName]) {
                if (baData[altName] !== undefined && baData[altName] !== null) {
                    input.value = baData[altName];
                    if (baData[altName].toString().trim()) {
                        input.style.backgroundColor = '#e8f5e9';
                        input.style.borderLeft = '3px solid #27ae60';
                    }
                    break;
                }
            }
        }
    });
    
    // ===== 2. ISI SEMUA CHECKBOX =====
    const allCheckboxes = document.querySelectorAll('#baFormPage input[type="checkbox"]');
    
    allCheckboxes.forEach(checkbox => {
        const fieldName = checkbox.name;
        
        // Cek data langsung
        if (baData[fieldName] !== undefined) {
            checkbox.checked = Boolean(baData[fieldName]);
            
            // HIGHLIGHT jika tercentang
            if (baData[fieldName]) {
                const parentTd = checkbox.closest('td');
                if (parentTd) {
                    parentTd.style.backgroundColor = '#e8f5e9';
                }
            }
        }
        
        // Mapping untuk checkbox grup test
        const testMapping = {
            'voice_baik': baData.test_voice === 'baik',
            'voice_tidak': baData.test_voice === 'tidak',
            'inet_baik': baData.test_inet === 'baik',
            'inet_tidak': baData.test_inet === 'tidak',
            'usetv_baik': baData.test_usee_tv === 'baik',
            'usetv_tidak': baData.test_usee_tv === 'tidak'
        };
        
        if (testMapping[fieldName] !== undefined) {
            checkbox.checked = testMapping[fieldName];
            if (testMapping[fieldName]) {
                const parentTd = checkbox.closest('td');
                if (parentTd) {
                    parentTd.style.backgroundColor = '#e8f5e9';
                }
            }
        }
    });
    
    // ===== 3. ISI FIELD KHUSUS =====
    // No BA
    if (baData.no_ba) {
        document.getElementById('noBADisplay').textContent = baData.no_ba;
    }
    
    // Nama Teknisi
    const teknisiName = baData.nama_teknisi || baData.teknisi_name || currentUser?.name || '';
    if (teknisiName) {
        document.getElementById('namaTeknisiDisplay').textContent = teknisiName;
        document.getElementById('namaTeknisiTTD').textContent = teknisiName;
    }
    
    // Nama Pelanggan TTD
    if (baData.nama_pelanggan) {
        document.getElementById('namaPelangganTTD').textContent = baData.nama_pelanggan;
    }
    
    // Mitra
    const mitra = baData.mitra || baData.partner || currentUser?.mitra || '';
    if (mitra) {
        document.getElementById('nama_mitra').textContent = mitra;
    }
    
    // Tanggal
    if (baData.tanggal || baData.tanggal_laporan || baData.created_at) {
        const tanggalInput = document.querySelector('input[name="tanggal_lumajang"]');
        if (tanggalInput) {
            const dateStr = baData.tanggal || baData.tanggal_laporan || baData.created_at.split('T')[0];
            tanggalInput.value = dateStr;
        }
    }
    
    // ===== 4. LOAD TANDA TANGAN =====
    // Signature pelanggan
    const sigPelanggan = baData.signature_pelanggan || baData.ttd_pelanggan || baData.customer_signature;
    if (sigPelanggan) {
        loadImageToCanvas('signature-pelanggan', sigPelanggan);
    }
    
    // Signature petugas
    const sigPetugas = baData.signature_petugas || baData.ttd_petugas || baData.technician_signature;
    if (sigPetugas) {
        loadImageToCanvas('signature-petugas', sigPetugas);
    }
    
    // ===== 5. TAMPILKAN INFO =====
    console.log('✅ SEMUA data dimuat ke form');
    showLoadedDataSummary(baData);
}

// ==================== FUNGSI BANTUAN BARU ====================
function loadImageToCanvas(canvasId, imageData) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || !imageData) return;
    
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Fill white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw image
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        // Add highlight
        canvas.style.border = '2px solid #27ae60';
        canvas.style.boxShadow = '0 0 10px rgba(39, 174, 96, 0.3)';
    };
    
    img.onerror = function() {
        console.warn('Gagal load gambar untuk canvas:', canvasId);
    };
    
    img.src = imageData;
}

function showLoadedDataSummary(baData) {
    // Hitung field yang berhasil di-load
    let loadedFields = 0;
    
    // Cek text fields
    const textFields = document.querySelectorAll('#baFormPage input[type="text"], #baFormPage input[type="date"], #baFormPage textarea');
    textFields.forEach(input => {
        if (input.value.trim()) {
            loadedFields++;
        }
    });
    
    // Cek checkbox yang tercentang
    const checkboxes = document.querySelectorAll('#baFormPage input[type="checkbox"]:checked');
    loadedFields += checkboxes.length;
    
    // Buat notifikasi kecil
    const summaryDiv = document.createElement('div');
    summaryDiv.id = 'dataLoadSummary';
    summaryDiv.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #2c3e50;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 9999;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        max-width: 300px;
    `;
    
    summaryDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px; color: #3498db;">
            <i class="fas fa-database"></i> Data Loaded
        </div>
        <div>✅ ${loadedFields} field terisi</div>
        <div>📄 No BA: ${baData.no_ba || 'Tidak ada'}</div>
        <div>👤 Pelanggan: ${baData.nama_pelanggan || 'Tidak ada'}</div>
        <div style="margin-top: 8px; font-size: 10px; color: #bdc3c7;">
            <i class="fas fa-info-circle"></i> Mode View Only
        </div>
    `;
    
    // Hapus yang lama
    const oldSummary = document.getElementById('dataLoadSummary');
    if (oldSummary) oldSummary.remove();
    
    document.body.appendChild(summaryDiv);
    
    // Auto hide setelah 8 detik
    setTimeout(() => {
        if (summaryDiv.parentNode) {
            summaryDiv.style.opacity = '0.7';
            setTimeout(() => {
                if (summaryDiv.parentNode) {
                    summaryDiv.remove();
                }
            }, 2000);
        }
    }, 8000);
}

// ==================== TAMBAH KE TABLE LAPORAN ====================
function addToReportsTable(baData) {
    console.log('📋 Menambah ke table laporan');
    
    // Cari table di reportsContent
    const reportsContent = document.getElementById('reportsContent');
    if (!reportsContent) {
        console.error('reportsContent tidak ada');
        return;
    }
    
    // Cari table body
    let tbody = reportsContent.querySelector('#reportsTable tbody');
    if (!tbody) {
        // Buat table jika belum ada
        const tableHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>No BA</th>
                        <th>Tanggal</th>
                        <th>Pelanggan</th>
                        <th>No Internet</th>
                        <th>Teknisi</th>
                        <th>STO</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody"></tbody>
            </table>
        `;
        reportsContent.querySelector('.table-container').innerHTML += tableHTML;
        tbody = document.getElementById('reportsTableBody');
    }
    
    // Di bagian tombol aksi, ganti jadi:
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${baData.no_ba}</td>
        <td>${baData.tanggal}</td>
        <td>${baData.nama_pelanggan}</td>
        <td>${baData.no_inet}</td>
        <td>${baData.nama_teknisi}</td>
        <td>${baData.sto}</td>
        <td><span class="status-active">${baData.status}</span></td>
        <td>
            <button class="btn-action btn-edit" onclick="viewFullBA('${baData.id}')" title="Lihat Halaman BA Lengkap">
                <i class="fas fa-eye"></i> View Full
            </button>
            <button class="btn-action btn-delete" onclick="deleteBATable('${baData.id}')" title="Hapus">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    // Tambah ke awal table
    tbody.insertBefore(row, tbody.firstChild);
    
    console.log('✅ Ditambahkan ke table');
}

// ==================== VIEW FULL BA PAGE ====================
function viewFullBA(baId) {
    console.log('👁️ VIEW FULL BA PAGE:', baId);
    
    // Ambil data dari localStorage
    const reports = JSON.parse(localStorage.getItem('table_reports') || '[]');
    const baData = reports.find(r => r.id === baId);
    
    if (!baData) {
        alert('Data BA tidak ditemukan');
        return;
    }
    
    // 1. SIMPAN DATA KE FORM BA
    saveBAToForm(baData);
    
    // 2. BUKA HALAMAN BA FORM
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('baFormPage').style.display = 'block';
    
    // 3. NONAKTIFKAN SEMUA INPUT (READ-ONLY)
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(el => {
        el.disabled = true;
        el.style.background = '#f5f5f5';
        el.style.cursor = 'not-allowed';
    });
    
    // 4. SEMBUNYIKAN TOMBOL SIMPAN, TAMPILKAN TOMBOL TUTUP
    const formActions = document.getElementById('baFormActions');
    if (formActions) {
        formActions.innerHTML = `
            <button onclick="closeViewBA()" style="padding: 10px 30px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt; margin-right: 10px;">
                <i class="fas fa-times"></i> Tutup View
            </button>
            <button onclick="downloadBAPDF('${baId}')" style="padding: 10px 30px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt;">
                <i class="fas fa-download"></i> Download PDF
            </button>
        `;
    }
    
    // 5. SEMBUNYIKAN TOMBOL SCAN & UPLOAD LOGO
    document.querySelectorAll('.scan-btn, button[onclick*="upload"], [onclick*="clearSignature"], [onclick*="saveSignature"]').forEach(btn => {
        btn.style.display = 'none';
    });
    
    // 6. TAMBAH TOMBOL CLOSE DI POJOK KANAN
    addCloseButton();
    
    console.log('✅ BA Form dibuka dalam mode VIEW');
}

// ==================== UPDATE FUNGSI saveBA() ====================
// ==================== FUNGSI saveBA() YANG BENAR ====================
async function saveBA() {
    console.log('💾 MULAI SAVE BA');
    
    // ========== 1. VALIDASI TANDA TANGAN HARUS ADA ==========
    const canvasPelanggan = document.getElementById('signature-pelanggan');
    const canvasPetugas = document.getElementById('signature-petugas');
    
    // Fungsi cek tanda tangan benar-benar ada
    function cekTandaTangan(canvas) {
        if (!canvas) return false;
        try {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Cek apakah ada pixel yang bukan putih
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 10) { // Ada alpha (tidak transparan)
                    return true;
                }
            }
            return false;
        } catch (e) {
            return false;
        }
    }
    
    const pelangganAda = cekTandaTangan(canvasPelanggan);
    const petugasAda = cekTandaTangan(canvasPetugas);
    
    // JIKA TANDA TANGAN TIDAK ADA, BERHENTI
    if (!pelangganAda || !petugasAda) {
        showNotification('❌ ERROR: Tanda tangan WAJIB diisi!', 'error', 5000);
        
        // Kasih efek merah
        if (!pelangganAda) {
            const box = canvasPelanggan.closest('.signature-box');
            if (box) {
                box.style.border = '3px solid red';
                box.style.background = '#ffcccc';
            }
        }
        
        if (!petugasAda) {
            const box = canvasPetugas.closest('.signature-box');
            if (box) {
                box.style.border = '3px solid red';
                box.style.background = '#ffcccc';
            }
        }
        
        // Scroll ke tanda tangan
        setTimeout(() => {
            document.querySelector('.signature-box').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }, 300);
        
        return; // BERHENTI TOTAL, TIDAK SIMPAN
    }
    
    // ========== 2. VALIDASI DATA WAJIB ==========
    const required = [
        'sto', 'no_permintaan', 'no_inet', 'tanggal_wo',
        'nama_pelanggan', 'no_kontak', 'alamat_pelanggan',
        'ONT_yang_DIPASANG_/_DITARIK', 'sn_ont', 'stb_id'
    ];
    
    let adaYangKosong = false;
    let fieldPertama = null;
    
    required.forEach(field => {
        const input = document.querySelector(`[name="${field}"]`);
        if (input && !input.value.trim()) {
            adaYangKosong = true;
            if (!fieldPertama) fieldPertama = input;
            input.style.borderBottom = '3px solid red';
        }
    });
    
    if (adaYangKosong) {
        showNotification('❌ ERROR: Ada data wajib yang belum diisi!', 'error');
        if (fieldPertama) {
            setTimeout(() => {
                fieldPertama.scrollIntoView({ behavior: 'smooth', block: 'center' });
                fieldPertama.focus();
            }, 300);
        }
        return; // BERHENTI
    }
    
    // ========== 3. JIKA SEMUA OKE, LANJUT SIMPAN ==========
    const dataBA = {};
    
    // Kumpulkan semua data form
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(el => {
        if (el.type === 'checkbox') {
            dataBA[el.name] = el.checked;
        } else {
            dataBA[el.name] = el.value;
        }
    });
    
    // Tambah tanda tangan
    dataBA.signature_pelanggan = canvasPelanggan.toDataURL();
    dataBA.signature_petugas = canvasPetugas.toDataURL();
    
    // Tambah metadata
    dataBA.id = 'ba_' + Date.now();
    dataBA.no_ba = document.getElementById('noBADisplay').textContent;
    dataBA.nama_teknisi = currentUser?.name || '';
    dataBA.user_email = currentUser?.email || '';
    dataBA.status = 'Selesai';
    dataBA.created_at = new Date().toISOString();
    dataBA.mitra = document.getElementById('nama_mitra').textContent || currentUser?.mitra || '';
    
    // ========== 4. SIMPAN KE LOCALSTORAGE ==========
    try {
        let reports = JSON.parse(localStorage.getItem('table_reports') || '[]');
        reports.unshift(dataBA);
        localStorage.setItem('table_reports', JSON.stringify(reports));
        
        showNotification('✅ SUCCESS: BA berhasil disimpan!', 'success');
        
        // Tambah ke tabel
        addToReportsTable(dataBA);
        
    } catch (e) {
        showNotification('❌ ERROR: Gagal menyimpan data', 'error');
        return;
    }
    
    // ========== 5. RESET DAN KEMBALI ==========
    setTimeout(() => {
        document.getElementById('baFormPage').style.display = 'none';
        document.getElementById('dashboardPage').style.display = 'block';
        resetBAForm();
        showContent('reports');
    }, 1500);
}

// Fungsi reset form tetap sama
function resetBAForm() {
    document.querySelectorAll('#baFormPage input[type="text"], #baFormPage input[type="date"]').forEach(input => {
        input.value = '';
        input.style.borderBottom = '';
    });
    
    document.querySelectorAll('#baFormPage input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset tanda tangan
    const canvas1 = document.getElementById('signature-pelanggan');
    const canvas2 = document.getElementById('signature-petugas');
    const ctx1 = canvas1.getContext('2d');
    const ctx2 = canvas2.getContext('2d');
    ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
    ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
    ctx1.fillStyle = 'white';
    ctx2.fillStyle = 'white';
    ctx1.fillRect(0, 0, canvas1.width, canvas1.height);
    ctx2.fillRect(0, 0, canvas2.width, canvas2.height);
    
    // Reset styling
    document.querySelectorAll('.signature-box').forEach(box => {
        box.style.border = '';
        box.style.background = '';
    });
}

// ==================== TAMBAH TOMBOL CLOSE ====================
function addCloseButton() {
    // Hapus tombol close lama jika ada
    const oldBtn = document.getElementById('viewBACloseBtn');
    if (oldBtn) oldBtn.remove();
    
    // Buat tombol close baru
    const closeBtn = document.createElement('button');
    closeBtn.id = 'viewBACloseBtn';
    closeBtn.innerHTML = '&times;';
    closeBtn.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        transition: all 0.3s;
    `;
    
    closeBtn.onmouseover = () => {
        closeBtn.style.background = '#c0392b';
        closeBtn.style.transform = 'scale(1.1)';
    };
    
    closeBtn.onmouseout = () => {
        closeBtn.style.background = '#e74c3c';
        closeBtn.style.transform = 'scale(1)';
    };
    
    closeBtn.onclick = closeViewBA;
    
    document.body.appendChild(closeBtn);
}

// ==================== TUTUP VIEW BA ====================
function closeViewBA() {
    console.log('❌ Menutup view BA');
    
    // 1. Hapus tombol close
    const closeBtn = document.getElementById('viewBACloseBtn');
    if (closeBtn) closeBtn.remove();
    
    // 2. Kembalikan form ke mode edit
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(el => {
        el.disabled = false;
        el.style.background = '';
        el.style.cursor = '';
    });
    
    // 3. Tampilkan tombol asli
    const formActions = document.getElementById('baFormActions');
    if (formActions) {
        formActions.innerHTML = `
            <button type="button" onclick="saveDraft()" style="padding: 10px 30px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt; margin-right: 10px;">
                <i class="fas fa-save"></i> Save Draft
            </button>
            <button type="button" onclick="saveBA()" style="padding: 10px 30px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt; margin-right: 10px;">
                <i class="fas fa-save"></i> Simpan BA ke Database
            </button>
            <button type="button" onclick="closeBAForm()" style="padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt;">
                <i class="fas fa-times"></i> Batal
            </button>
        `;
    }
    
    // 4. Tampilkan tombol scan & signature
    document.querySelectorAll('.scan-btn, button[onclick*="upload"], [onclick*="clearSignature"], [onclick*="saveSignature"]').forEach(btn => {
        btn.style.display = '';
    });
    
    // 5. Kembali ke dashboard
    document.getElementById('baFormPage').style.display = 'none';
    document.getElementById('dashboardPage').style.display = 'block';
    
    // 6. Reset form
    resetBAForm();
    
    console.log('✅ Kembali ke dashboard');
}



// ==================== TAMPILKAN DATA DI LAPORAN ====================
function showBAInReports(baData) {
    console.log('🎯 Menampilkan BA di MENU LAPORAN');
    
    // 1. Cari container di MENU LAPORAN (reportsContent)
    const reportsContent = document.getElementById('reportsContent');
    if (!reportsContent) {
        console.error('❌ reportsContent tidak ditemukan');
        return;
    }
    
    // 2. Cari container di dalam reportsContent
    let container = reportsContent.querySelector('#reportsContainer');
    if (!container) {
        console.log('⚠️ reportsContainer tidak ditemukan, buat baru');
        container = document.createElement('div');
        container.id = 'reportsContainer';
        container.className = 'horizontal-scroll-container';
        reportsContent.appendChild(container);
    }
    
    // 3. Cari empty message
    let emptyMsg = reportsContent.querySelector('#reportsEmpty');
    if (!emptyMsg) {
        emptyMsg = document.createElement('div');
        emptyMsg.id = 'reportsEmpty';
        emptyMsg.style.display = 'none';
        reportsContent.appendChild(emptyMsg);
    }
    
    // 4. Buat card BA
    const card = document.createElement('div');
    card.className = 'horizontal-card';
    card.style.border = '2px solid #27ae60';
    card.style.boxShadow = '0 0 10px rgba(39, 174, 96, 0.3)';
    
    card.innerHTML = `
        <div style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0; color: #2c3e50; font-size: 16px;">
                    <i class="fas fa-user"></i> ${baData.nama_pelanggan}
                </h4>
                <span style="background: #27ae60; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                    <i class="fas fa-check"></i> BARU
                </span>
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="margin-bottom: 5px;">
                    <i class="fas fa-hashtag" style="color: #e74c3c; width: 20px;"></i>
                    <strong>No BA:</strong> <span style="color: #2c3e50;">${baData.no_ba}</span>
                </div>
                <div style="margin-bottom: 5px;">
                    <i class="fas fa-wifi" style="color: #3498db; width: 20px;"></i>
                    <strong>No Internet:</strong> <span style="color: #2c3e50;">${baData.no_inet}</span>
                </div>
                <div style="margin-bottom: 5px;">
                    <i class="fas fa-map-marker-alt" style="color: #9b59b6; width: 20px;"></i>
                    <strong>STO:</strong> <span style="color: #2c3e50;">${baData.sto}</span>
                </div>
                <div style="margin-bottom: 5px;">
                    <i class="fas fa-calendar" style="color: #2ecc71; width: 20px;"></i>
                    <strong>Tanggal:</strong> <span style="color: #2c3e50;">${baData.tanggal}</span>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 8px; border-radius: 8px; font-size: 12px; color: #27ae60;">
                <i class="fas fa-save"></i> Tersimpan di sistem - ${new Date().toLocaleTimeString('id-ID')}
            </div>
        </div>
    `;
    
    // 5. Tambah ke AWAL container
    container.insertBefore(card, container.firstChild);
    
    // 6. Sembunyikan pesan kosong
    emptyMsg.style.display = 'none';
    
    console.log('✅ BA ditampilkan di MENU LAPORAN');
    
    // 7. Auto scroll ke laporan setelah 1 detik
    setTimeout(() => {
        showContent('reports'); // Buka menu laporan
    }, 1000);
}


// ==================== LOAD LAPORAN DARI localStorage ====================
function loadReportsFromStorage() {
    console.log('📂 Loading reports from localStorage');
    
    const container = document.getElementById('reportsContainer');
    const emptyMsg = document.getElementById('reportsEmpty');
    
    if (!container) {
        console.error('❌ Container tidak ditemukan');
        return;
    }
    
    const reports = JSON.parse(localStorage.getItem('ba_reports') || '[]');
    
    if (reports.length === 0) {
        if (emptyMsg) {
            emptyMsg.style.display = 'block';
            emptyMsg.innerHTML = `
                <i class="fas fa-chart-bar" style="font-size: 48px; color: #e74c3c;"></i>
                <p>Belum ada laporan</p>
                <p style="font-size: 12px; color: #666;">Buat BA baru di menu "Buat BA"</p>
            `;
        }
        container.innerHTML = '';
        return;
    }
    
    if (emptyMsg) emptyMsg.style.display = 'none';
    
    // Clear container
    container.innerHTML = '';
    
    
    
    console.log(`✅ ${reports.length} laporan ditampilkan`);
}

// ==================== INITIALIZE ====================
// Panggil ini saat halaman load
document.addEventListener('DOMContentLoaded', function() {
    // Load reports saat pertama kali
    setTimeout(() => {
        loadReportsFromStorage();
    }, 500);
});

// Override loadReports() agar pakai localStorage
window.loadReports = loadReportsFromStorage;
// PASTIKAN FUNGSI hideLoading() ADA
function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
        console.log('⏹️ Loading stopped');
    }
}
    async function initializeFirestoreCollections() {
    if (!firestore) return;

    try {
        // Coba ambil satu dokumen dari koleksi ba_documents
        const docRef = firestore.collection('ba_documents').doc('init_check');
        const doc = await docRef.get();

        // Jika dokumen tidak ada, buat koleksi dengan membuat dummy doc
        if (!doc.exists) {
            await docRef.set({
                initialized: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log('✅ Koleksi ba_documents berhasil dibuat otomatis.');
        }
    } catch (error) {
        console.error('⚠️ Gagal menginisialisasi koleksi:', error);
    }
    }

// Update resetBAForm() untuk reset draft ID
function resetBAForm() {
document.querySelectorAll('#baFormPage input[type="text"], #baFormPage input[type="date"]').forEach(input => {
    input.value = '';
    input.classList.remove('error-field');
});

document.querySelectorAll('#baFormPage input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
});

clearSignature('pelanggan');
clearSignature('petugas');
pelangganSigned = false;
petugasSigned = false;

// Reset draft ID untuk form baru
resetDraftId();
}

// === LOAD USER MITRA FROM SUPABASE ===
async function loadUserMitraFromSupabase() {
  if (!currentUser || !supabase) return;

  try {
    const { data: userData, error } = await supabase
      .from('users')
      .select('mitra')
      .eq('id', currentUser.id)
      .single();

    if (!error && userData && userData.mitra) {
      currentUser.mitra = userData.mitra;
      document.getElementById('nama_mitra').textContent = userData.mitra;
    }
  } catch (error) {
    console.error('Error loading user mitra:', error);
  }
}

async function loadBASaya() {
    console.log('📋 [loadBASaya] Fungsi dipanggil');
    
    if (!currentUser) {
        console.error('❌ [loadBASaya] User tidak login');
        showNotification('Anda harus login untuk melihat BA', 'error');
        return;
    }
    
    if (!supabase) {
        console.error('❌ [loadBASaya] Supabase tidak ada');
        showNotification('Koneksi database error', 'error');
        return;
    }

    try {
        showLoading('Memuat data BA...');
        
        console.log('👤 [loadBASaya] User:', currentUser.email);
        
        // 1. QUERY DATA BA MILIK USER INI
        const { data: baList, error } = await supabase
            .from('ba_documents')
            .select('*')
            .eq('user_email', currentUser.email) // ← PASTI FILTER BY EMAIL
            .order('created_at', { ascending: false })
            .limit(50);
        
        console.log('📥 [loadBASaya] Response dari Supabase:');
        console.log('- Error:', error);
        console.log('- Jumlah data:', baList?.length || 0);
        
        if (error) {
            console.error('❌ [loadBASaya] Supabase error detail:', {
                message: error.message,
                code: error.code,
                details: error.details
            });
            throw error;
        }

        // 2. TAMPILKAN DATA
        const container = document.getElementById('baListContainer');
        const emptyMsg = document.getElementById('baListEmpty');
        
        if (!container) {
            console.error('❌ [loadBASaya] Container tidak ditemukan');
            hideLoading();
            return;
        }

        container.innerHTML = '';

        if (!baList || baList.length === 0) {
            console.log('📭 [loadBASaya] Tidak ada data BA untuk user ini');
            
            if (emptyMsg) {
                emptyMsg.style.display = 'block';
                emptyMsg.innerHTML = `
                    <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 15px; color: #e74c3c;"></i>
                    <p>Belum ada Berita Acara</p>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Buat BA baru dengan klik "Buka Form BA"
                    </p>
                    <p style="font-size: 11px; color: #999; margin-top: 10px;">
                        User: ${currentUser.email}
                    </p>
                `;
            }
            
            hideLoading();
            return;
        }

        if (emptyMsg) emptyMsg.style.display = 'none';

        // 3. RENDER SETIAP BA
        console.log('🎨 [loadBASaya] Merender', baList.length, 'BA...');
        
        baList.forEach((ba, index) => {
            // DEBUG LOG 3 DATA PERTAMA
            if (index < 3) {
                console.log(`📄 BA ${index + 1}:`, {
                    id: ba.id,
                    no_ba: ba.no_ba,
                    status: ba.status,
                    nama_pelanggan: ba.nama_pelanggan
                });
            }
            
            // TENTUKAN WARNA STATUS
            let statusColor, statusText;
            
            if (ba.status === 'Selesai') {
                statusColor = '#27ae60';
                statusText = 'Selesai';
            } else if (ba.status === 'Draft') {
                statusColor = '#f39c12';
                statusText = 'Draft';
            } else {
                statusColor = '#e74c3c';
                statusText = ba.status || 'Unknown';
            }
            
            // FORMAT TANGGAL
            let tanggalDisplay = ba.tanggal || '-';
            if (!ba.tanggal && ba.created_at) {
                try {
                    tanggalDisplay = new Date(ba.created_at).toLocaleDateString('id-ID');
                } catch (e) {
                    tanggalDisplay = '-';
                }
            }
            
            const card = document.createElement('div');
            card.className = 'horizontal-card';
            card.style.borderLeft = `4px solid ${statusColor}`;
            
            card.innerHTML = `
                <div class="card-header">
                    <h4 class="card-title" style="color: #2c3e50; font-size: 16px;">
                        ${ba.nama_pelanggan || 'Tidak ada nama'}
                    </h4>
                    <span class="card-badge" style="background: ${statusColor}15; color: ${statusColor}; font-size: 11px;">
                        <i class="fas fa-${ba.status === 'Selesai' ? 'check-circle' : ba.status === 'Draft' ? 'save' : 'exclamation-circle'}"></i>
                        ${statusText}
                    </span>
                </div>
                
                <div class="card-content">
                    <div class="card-row">
                        <i class="fas fa-hashtag" style="color: #e74c3c;"></i>
                        <span style="font-weight: 600;">${ba.no_ba || 'No BA: -'}</span>
                    </div>
                    
                    <div class="card-row">
                        <i class="fas fa-wifi" style="color: #3498db;"></i>
                        <span>${ba.no_inet || 'No Internet: -'}</span>
                    </div>
                    
                    <div class="card-row">
                        <i class="fas fa-map-marker-alt" style="color: #9b59b6;"></i>
                        <span>${ba.sto || 'STO: -'}</span>
                    </div>
                    
                    <div class="card-row">
                        <i class="fas fa-calendar-alt" style="color: #2ecc71;"></i>
                        <span>${tanggalDisplay}</span>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button class="card-btn card-btn-view" onclick="viewBASaya('${ba.id}')" title="Lihat Detail">
                        <i class="fas fa-eye"></i> Lihat
                    </button>
                    
                    <button class="card-btn card-btn-download" onclick="downloadBAPDF('${ba.id}')" title="Download PDF">
                        <i class="fas fa-download"></i> PDF
                    </button>
                    
                    <button class="card-btn card-btn-delete" onclick="deleteBASaya('${ba.id}')" title="Hapus BA">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        });

        console.log('✅ [loadBASaya] Rendering selesai');
        hideLoading();
        
        // AUTO REFRESH SETELAH 2 DETIK
        setTimeout(() => {
            console.log('🔄 [loadBASaya] Auto-check data baru...');
        }, 2000);

    } catch (error) {
        console.error('❌ [loadBASaya] Error fatal:', error);
        
        const container = document.getElementById('baListContainer');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; color: #ff4757; padding: 40px; width: 100%;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                    <p><strong>Error memuat data BA</strong></p>
                    <p style="font-size: 12px; margin-top: 10px; color: #666;">
                        ${error.message || 'Gagal terhubung ke database'}
                    </p>
                    <button onclick="loadBASaya()" style="margin-top: 15px; padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </div>
            `;
        }
        hideLoading();
    }
}

// FUNGSI DELETE BA (UPDATE)
async function deleteBASaya(id) {
    if (!confirm('Apakah Anda yakin ingin menghapus BA ini?')) {
        return;
    }
    
    try {
        showLoading('Menghapus BA...');
        
        const { error } = await supabase
            .from('ba_documents')
            .delete()
            .eq('id', id);
            
        if (error) throw error;
        
        showNotification('✅ BA berhasil dihapus!', 'success');
        
        // REFRESH DATA SETELAH 1 DETIK
        setTimeout(() => {
            loadBASaya();
            loadReports(); // Juga refresh laporan
        }, 1000);
        
    } catch (error) {
        console.error('Error deleting BA:', error);
        showNotification('❌ Gagal menghapus BA: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function refreshBASaya() {
console.log('Merefresh list BA...');
loadBASaya();
}

function filterBASaya() {
const searchTerm = document.getElementById('searchNoInetSaya').value.toLowerCase();
const rows = document.querySelectorAll('#myBATable tr');

rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
});
}

function exportBASaya() {
showNotification('Data BA berhasil diexport ke Excel!', 'success');
}

async function viewBAReport(id) {
    try {
        showLoading('Memuat data...');
        
        const { data: report, error } = await supabase
            .from('ba_documents')
            .select('*')
            .eq('id', id)
            .single();
            
        if (error) throw error;
        
        // Tampilkan modal detail
        showReportDetailModal(report);
        
    } catch (error) {
        console.error('Error loading report:', error);
        showNotification('Gagal memuat data laporan', 'error');
    } finally {
        hideLoading();
    }
}

function showReportDetailModal(report) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-popup" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin: 0;">Detail Berita Acara</h3>
                <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div><strong>No BA:</strong> ${report.no_ba || '-'}</div>
                    <div><strong>Tanggal:</strong> ${report.tanggal || '-'}</div>
                    <div><strong>Nama Pelanggan:</strong> ${report.nama_pelanggan || '-'}</div>
                    <div><strong>No Internet:</strong> ${report.no_inet || '-'}</div>
                    <div><strong>STO:</strong> ${report.sto || '-'}</div>
                    <div><strong>Teknisi:</strong> ${report.nama_teknisi || '-'}</div>
                    <div><strong>Status:</strong> ${report.status || '-'}</div>
                    <div><strong>Dibuat oleh:</strong> ${report.user_email || '-'}</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="downloadBAPDF('${report.id}')" style="flex: 1; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button onclick="this.closest('.modal-overlay').remove()" style="flex: 1; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

async function checkSupabaseData() {
    console.log('🔍 CHECKING SUPABASE DATA...');
    
    if (!supabase) {
        console.error('❌ Supabase tidak ada');
        return;
    }
    
    try {
        // Cek total data
        const { count, error: countError } = await supabase
            .from('ba_documents')
            .select('*', { count: 'exact', head: true });
            
        console.log(`📊 Total data BA: ${count}`);
        
        // Cek data per user
        const { data: userData, error: userError } = await supabase
            .from('ba_documents')
            .select('user_email, status, count')
            .group('user_email, status');
            
        console.log('👥 Data per user:', userData);
        
        // Ambil 5 data terbaru
        const { data: recentData, error: recentError } = await supabase
            .from('ba_documents')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(5);
            
        console.log('🆕 5 Data terbaru:', recentData);
        
    } catch (error) {
        console.error('❌ Error checking data:', error);
    }
}

// Panggil di console untuk test
window.checkData = checkSupabaseData;

async function viewBASaya(id) {
try {
    showLoading('Memuat data BA...');

    const baDoc = await firestore.collection('ba_documents').doc(id).get();
    if (!baDoc.exists) {
        showNotification('Data BA tidak ditemukan', 'error');
        hideLoading();
        return;
    }
    const baData = baDoc.data();

    // Buka form BA
    document.getElementById('dashboardPage').style.display = 'none';
    document.getElementById('baFormPage').style.display = 'block';

    // --- 1. SEMBUNYIKAN SEMUA KONTROL YANG TIDAK PERLU ---
    // Sembunyikan kontrol ukuran kertas
    document.querySelector('.page-size-controls').style.display = 'none';

    // Sembunyikan tombol "Kembali ke Dashboard"
    const allButtonsInForm = document.querySelectorAll('#baFormPage button');
    allButtonsInForm.forEach(button => {
        if (button.innerHTML.includes('Kembali ke Dashboard')) {
            button.style.display = 'none';
        }
    });

    // --- PERBAIKAN KHUSUS UNTUK TOMBOL SIMPAN & BATAL ---
    // Sembunyikan seluruh container yang berisi tombol "Simpan BA" dan "Batal"
    const bottomActionButtons = document.querySelector('#baFormPage div[style*="text-align: center"][style*="margin-top: 20px;"]');
    if (bottomActionButtons) {
        bottomActionButtons.style.display = 'none';
    }

    // --- PERBAIKAN: SEMBUNYIKAN KONTAINER TOMBOL DI LUAR FORM ---
    const outerActionButtons = document.getElementById('baFormActions');
    if (outerActionButtons) {
        outerActionButtons.style.display = 'none';
    }

    // Sembunyikan tombol di dalam signature box
    const signatureButtons = document.querySelectorAll('#baFormPage button[onclick*="clearSignature"], #baFormPage button[onclick*="saveSignature"]');
    signatureButtons.forEach(button => button.style.display = 'none');

    // Sembunyikan tombol scan barcode
    const scanButtons = document.querySelectorAll('.scan-btn');
    scanButtons.forEach(button => button.style.display = 'none');

    // --- 2. TAMBAHKAN TOMBOL TUTUP ("X") ---
    let closeBtn = document.getElementById('viewModeCloseBtn');
    if (!closeBtn) {
        closeBtn = document.createElement('button');
        closeBtn.id = 'viewModeCloseBtn';
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = `
            position: fixed; top: 15px; right: 15px; z-index: 10000;
            background: #e74c3c; color: white; border: none; border-radius: 50%;
            width: 40px; height: 40px; font-size: 24px; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); transition: background-color 0.2s;
        `;
        closeBtn.onmouseover = () => closeBtn.style.backgroundColor = '#c0392b';
        closeBtn.onmouseout = () => closeBtn.style.backgroundColor = '#e74c3c';
        closeBtn.onclick = closeViewMode;
        document.body.appendChild(closeBtn);
    }

    // --- 3. ISI SEMUA DATA FIELD ---
    const fieldMap = {
        'sto': 'sto', 'noPermintaan': 'no_permintaan', 'noTelepon': 'no_telepon', 'noInet': 'no_inet',
        'tanggalWO': 'tanggal_wo', 'tanggalTransaksi': 'tanggal_transaksi', 'namaPelanggan': 'nama_pelanggan',
        'noKontak': 'no_kontak', 'alamatPelanggan': 'alamat_pelanggan', 'ontDitarik': 'ONT_yang_DIPASANG_/_DITARIK',
        'snOnt': 'sn_ont', 'stbId': 'stb_id'
    };
    for (const dbKey in fieldMap) {
        const htmlName = fieldMap[dbKey];
        const input = document.querySelector(`[name="${htmlName}"]`);
        if (input && baData[dbKey]) {
            input.value = baData[dbKey];
        }
    }

    if (baData.noBA) document.getElementById('noBADisplay').textContent = baData.noBA;
    if (baData.namaTeknisi) {
        document.getElementById('namaTeknisiDisplay').textContent = baData.namaTeknisi;
        document.getElementById('namaTeknisiTTD').textContent = baData.namaTeknisi;
    }
    if (baData.namaPelanggan) document.getElementById('namaPelangganTTD').textContent = baData.namaPelanggan;
    if (baData.tanggal) document.querySelector('input[name="tanggal_lumajang"]').value = baData.tanggal;

    if (baData.testVoice) document.querySelector(`input[name="voice_${baData.testVoice}"]`).checked = true;
    if (baData.testInet) document.querySelector(`input[name="inet_${baData.testInet}"]`).checked = true;
    if (baData.testUseeTv) document.querySelector(`input[name="usetv_${baData.testUseeTv}"]`).checked = true;

    // --- 4. NONAKTIFKAN SEMUA INPUT, KEUALI CANVAS ---
    document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(el => {
        if (el.id !== 'signature-pelanggan' && el.id !== 'signature-petugas') {
            el.disabled = true;
            el.style.cursor = 'not-allowed';
        }
    });

    // --- 5. LOAD TANDA TANGAN KE CANVAS ---
    function loadSignatureToCanvas(canvasId, signatureData) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (!signatureData) {
            canvas.disabled = true;
            canvas.style.cursor = 'not-allowed';
            return;
        }

        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.disabled = true;
            canvas.style.cursor = 'not-allowed';
        };
        img.onerror = function() {
            console.error("Gagal memuat gambar tanda tangan untuk:", canvasId);
            canvas.disabled = true;
            canvas.style.cursor = 'not-allowed';
        };
        img.src = signatureData;
    }

    // --- PERBAIKAN: PASTIKAN TANDA TANGAN DIMUAT DARI DATABASE ---
    loadSignatureToCanvas('signature-pelanggan', baData.signaturePelanggan);
    loadSignatureToCanvas('signature-petugas', baData.signaturePetugas);

    hideLoading();


} catch (error) {
    console.error('Error viewing BA:', error);
    hideLoading();
    showNotification('Gagal memuat data BA', 'error');
}
}

function closeViewMode() {
// Kembalikan tampilan ke dashboard
document.getElementById('baFormPage').style.display = 'none';
document.getElementById('dashboardPage').style.display = 'block';

// Hapus tombol "X"
const closeBtn = document.getElementById('viewModeCloseBtn');
if (closeBtn) closeBtn.remove();

// Tampilkan kembali semua kontrol yang disembunyikan
document.querySelector('.page-size-controls').style.display = 'block';

const allButtonsInForm = document.querySelectorAll('#baFormPage button');
allButtonsInForm.forEach(button => {
    if (button.innerHTML.includes('Kembali ke Dashboard')) {
        button.style.display = 'inline-block';
    }
});

const bottomActionButtons = document.querySelector('#baFormPage div[style*="text-align: center"][style*="margin-top: 20px;"]');
if (bottomActionButtons) {
    bottomActionButtons.style.display = 'block';
}

// --- PERBAIKAN: TAMPILKAN KEMBALI KONTAINER TOMBOL DI LUAR FORM ---
const outerActionButtons = document.getElementById('baFormActions');
if (outerActionButtons) {
outerActionButtons.style.display = 'block';
}

const signatureButtons = document.querySelectorAll('#baFormPage button[onclick*="clearSignature"], #baFormPage button[onclick*="saveSignature"]');
signatureButtons.forEach(button => button.style.display = 'inline-block');

const scanButtons = document.querySelectorAll('.scan-btn');
scanButtons.forEach(button => button.style.display = 'inline-flex');

// Aktifkan kembali semua input
document.querySelectorAll('#baFormPage input, #baFormPage select, #baFormPage textarea').forEach(el => {
    el.disabled = false;
    el.style.cursor = 'default';
});

// Reset form agar bersih saat dibuka kembali
resetBAForm();
}

// Di dalam tag <script> di index.html

// === PERBAIKAN FUNGSI downloadBAPDF YANG ERROR ===
// === PERBAIKAN downloadBAPDF() YANG FIX ===
async function downloadBAPDF(baId) {
    console.log('📥 DOWNLOAD HALAMAN BA PERSIS');
    
    try {
        // 1. TAMPILKAN LOADING
        const loadingEl = document.getElementById('loadingOverlay');
        if (loadingEl) loadingEl.style.display = 'flex';
        
        // 2. AMBIL ELEMENT HALAMAN BA YANG SEDANG DITAMPILKAN
        const baFormPage = document.getElementById('baFormPage');
        if (!baFormPage || baFormPage.style.display === 'none') {
            // JIKA HALAMAN BA TIDAK DITAMPILKAN, BUKA DULU
            await viewFullBA(baId);
        }
        
        // 3. AMBIL CONTAINER UTAMA HALAMAN BA
        const pageContainer = document.getElementById('page-container');
        if (!pageContainer) {
            throw new Error('Container halaman BA tidak ditemukan');
        }
        
        // 4. PAKAI html2pdf UNTUK CAPTURE HALAMAN
        const options = {
            margin:       0,
            filename:     `BERITA_ACARA_${baId}.pdf`,
            image:        { type: 'jpeg', quality: 1 },
            html2canvas:  { 
                scale: 2,
                useCORS: true,
                scrollX: 0,
                scrollY: -window.scrollY,
                windowWidth: pageContainer.scrollWidth,
                windowHeight: pageContainer.scrollHeight
            },
            jsPDF:        { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait' 
            }
        };
        
        // 5. DOWNLOAD PERSIS SEPERTI TAMPILAN DI BROWSER
        await html2pdf().set(options).from(pageContainer).save();
        
        // 6. SEMBUNYIKAN LOADING
        if (loadingEl) loadingEl.style.display = 'none';
        
        alert('✅ Halaman BA berhasil didownload!');
        
    } catch (error) {
        console.error('❌ Error:', error);
        const loadingEl = document.getElementById('loadingOverlay');
        if (loadingEl) loadingEl.style.display = 'none';
        alert('❌ Gagal download: ' + error.message);
    }
}

// === PERBAIKAN FUNGSI hideLoading ===
function hideLoading() {
    console.log('🛑 hideLoading() dipanggil');
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
        console.log('✅ Loading disembunyikan');
    }
}
async function deleteBASaya(id) {
if (confirm('Apakah Anda yakin ingin menghapus BA ini?')) {
    try {
        await firestore.collection('ba_documents').doc(id).delete();
        showNotification('BA berhasil dihapus!', 'success');
        loadBASaya();
    } catch (error) {
        console.error('Error deleting BA:', error);
        showNotification('Gagal menghapus BA', 'error');
    }
}
}

// === COUNTER FUNCTIONS ===
function getBACounter() {
const now = new Date();
const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

const counterKey = `baCounter_${yearMonth}`;
let counter = localStorage.getItem(counterKey) || 0;
counter = parseInt(counter);

return { counter, counterKey };
}

function incrementBACounter() {
const { counter, counterKey } = getBACounter();
const newCounter = counter + 1;
localStorage.setItem(counterKey, newCounter);
return newCounter;
}

function decrementBACounter() {
const { counter, counterKey } = getBACounter();
const newCounter = Math.max(0, counter - 1);
localStorage.setItem(counterKey, newCounter);
return newCounter;
}

// === SIGNATURE FUNCTIONS ===
function setupSignatureCanvas() {
const canvases = {
    'pelanggan': document.getElementById('signature-pelanggan'),
    'petugas': document.getElementById('signature-petugas')
};

Object.keys(canvases).forEach(key => {
    const canvas = canvases[key];
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Reset canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';

    function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        let x, y;

        if (e.type.includes('touch')) {
            x = e.touches[0].clientX - rect.left;
            y = e.touches[0].clientY - rect.top;
        } else {
            x = e.clientX - rect.left;
            y = e.clientY - rect.top;
        }
        return { x, y };
    }

    function startDrawing(e) {
        // Cek apakah sudah disimpan. Jika ya, cegah menggambar.
        if ((key === 'pelanggan' && pelangganSigned) || (key === 'petugas' && petugasSigned)) {
            return;
        }

        isDrawing = true;
        const pos = getPosition(e);
        [lastX, lastY] = [pos.x, pos.y];
    }

    function draw(e) {
        if (!isDrawing) return;

        const pos = getPosition(e);

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();

        [lastX, lastY] = [pos.x, pos.y];
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath();
    }

    // Event listeners untuk touch
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        startDrawing(e);
    }, { passive: false });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        draw(e);
    }, { passive: false });

    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        stopDrawing();
    }, { passive: false });

    // Event listeners untuk mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
});
}

function saveSignature(type) {
    const canvas = document.getElementById(`signature-${type}`);
    
    if (!canvas) {
        showNotification(`❌ Canvas tanda tangan ${type} tidak ditemukan`, 'error');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const isEmpty = !imageData.data.some(channel => channel !== 0);
    
    if (isEmpty) {
        showNotification(`❌ Tanda tangan ${type} masih kosong! Gambar tanda tangan dulu.`, 'error');
        
        const box = canvas.closest('.signature-box');
        if (box) {
            box.classList.add('error');
            box.style.border = '2px solid red';
            box.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
        }
        
        return;
    }
    
    // Simpan status tanda tangan
    if (type === 'pelanggan') {
        pelangganSigned = true;
        showNotification('✅ Tanda tangan pelanggan berhasil disimpan!', 'success');
    } else if (type === 'petugas') {
        petugasSigned = true;
        showNotification('✅ Tanda tangan petugas berhasil disimpan!', 'success');
    }
    
    // Hapus error styling
    const box = canvas.closest('.signature-box');
    if (box) {
        box.classList.remove('error');
        box.style.border = '';
        box.style.backgroundColor = '';
    }
    
    // Simpan ke localStorage untuk draft
    const signatureData = canvas.toDataURL('image/png');
    const draftId = getCurrentDraftId();
    localStorage.setItem(`signature_${type}_${draftId}`, signatureData);
}

// Tambahkan fungsi baru ini:
function loadSignatureFromDraft(draftId, type) {
const signatureData = localStorage.getItem(`signature_${type}_${draftId}`);
if (signatureData) {
    const canvas = document.getElementById(`signature-${type}`);
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        if (type === 'pelanggan') {
            pelangganSigned = true;
        } else if (type === 'petugas') {
            petugasSigned = true;
        }
    };
    img.src = signatureData;
}
}

// === SCANNER FUNCTIONS ===
function openScanner(fieldId) {
    currentScannerField = fieldId;
    document.getElementById('scannerModal').style.display = 'block';
    document.getElementById('manualInput').value = '';
}

function closeScanner() {
document.getElementById('scannerModal').style.display = 'none';
if (window.Quagga) {
    Quagga.stop();
}
currentScannerField = null;
}

function startScanning() {
    if (!currentScannerField) {
        console.error("Error: Tidak ada field yang dituju untuk scan.");
        showNotification("Terjadi kesalahan internal. Silakan coba lagi.", "error");
        return;
    }

    // Cek apakah browser mendukung getUserMedia
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.error("Browser tidak mendukung akses kamera.");
        showNotification("Browser Anda tidak mendukung fitur kamera. Gunakan browser modern.", "error");
        return;
    }

    const scannerVideo = document.getElementById('scanner-video');
    scannerVideo.innerHTML = '<div style="color: white; text-align: center; padding-top: 100px;">Mengakses kamera...</div>';

     Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: scannerVideo,
            constraints: {
                width: { min: 640, ideal: 1280, max: 1920 },
                height: { min: 480, ideal: 720, max: 1080 },
                facingMode: "environment" // Coba kamera belakang
            }
        },
        decoder: {
            readers: ["code_128_reader", "ean_reader", "code_39_reader"]
        },
        locate: true,
        frequency: 5
    }, function(err) {
        if (err) {
            console.error("QuaggaJS Init Error:", err);
            let errorMessage = 'Gagal menginisialisasi kamera.';

            // PERBAIKAN 2: Penanganan error spesifik untuk pengalaman pengguna yang lebih baik
            if (err.name === "NotFoundError" || err.message.includes("device not found")) {
                 errorMessage = 'Kamera tidak ditemukan. Pastikan kamera terhubung dan coba masukan manual.';
            } else if (err.name === "NotAllowedError" || err.message.includes("permission denied")) {
                errorMessage = 'Izin kamera ditolak. Berikan izin di pengaturan browser Anda.';
            } else if (err.name === "NotReadableError") {
                errorMessage = 'Kamera tidak dapat diakses. Coba muat ulang halaman atau pastikan Anda menggunakan HTTPS.';
            }
            
            showNotification(errorMessage, 'error');
            closeScanner();
            return;
        }
        console.log("QuaggaJS successfully initialized.");
        Quagga.start();
    });

    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        if (currentScannerField) {
            document.getElementById(currentScannerField).value = code;
            showNotification('Barcode berhasil dipindai!', 'success');
            closeScanner();
        }
    });
}

function useManualInput() {
const manualValue = document.getElementById('manualInput').value.trim();
if (manualValue && currentScannerField) {
    document.getElementById(currentScannerField).value = manualValue;
    showNotification('Kode manual berhasil dimasukkan!', 'success');
    closeScanner();
} else {
    showNotification('Masukkan kode barcode terlebih dahulu!', 'warning');
}
}

// === UTILITY FUNCTIONS ===
function showNotification(message, type = 'info') {
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    ${message}
`;

document.body.appendChild(notification);

setTimeout(() => {
    notification.classList.add('show');
}, 100);

setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 300);
}, 3000);
}

function showLoading(message = 'Memuat...') {
const overlay = document.getElementById('loadingOverlay');
const loadingText = overlay.querySelector('.loading-text');
loadingText.textContent = message;
overlay.style.display = 'flex';
}

function hideLoading() {
    console.log('🛑 hideLoading() dipanggil');
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
        console.log('✅ Loading disembunyikan');
    } else {
        console.error('❌ Loading overlay tidak ditemukan');
    }
}
function changePageSize(size) {
const container = document.getElementById('page-container');
const sizeClass = size === 'A4 landscape' ? 'landscape' : size.toLowerCase().replace(' ', '-');

container.className = 'container-' + sizeClass;

document.querySelectorAll('.page-size-btn').forEach(btn => {
    btn.classList.remove('active');
});
event.target.classList.add('active');
}

function uploadImage(posisi, input) {
const file = input.files[0];
if (file) {
    const reader = new FileReader();

    reader.onload = function(e) {
        const imgId = posisi === 'kiri' ? 'logoKiri' : 'logoKanan';
        const placeholderId = posisi === 'kiri' ? 'placeholderKiri' : 'placeholderKanan';
        const img = document.getElementById(imgId);
        const placeholder = document.getElementById(placeholderId);

        img.src = e.target.result;
        img.style.display = 'block';
        placeholder.style.display = 'none';

        localStorage.setItem('logo_' + posisi, e.target.result);
    };

    reader.readAsDataURL(file);
}
}

function loadSavedImages() {
const logoKiri = localStorage.getItem('logo_kiri');
const logoKanan = localStorage.getItem('logo_kanan');

if (logoKiri) {
    const imgKiri = document.getElementById('logoKiri');
    const placeholderKiri = document.getElementById('placeholderKiri');
    imgKiri.src = logoKiri;
    imgKiri.style.display = 'block';
    placeholderKiri.style.display = 'none';
}

if (logoKanan) {
    const imgKanan = document.getElementById('logoKanan');
    const placeholderKanan = document.getElementById('placeholderKanan');
    imgKanan.src = logoKanan;
    imgKanan.style.display = 'block';
    placeholderKanan.style.display = 'none';
}
}

function resetImages() {
if (confirm('Reset semua logo ke default?')) {
    localStorage.removeItem('logo_kiri');
    localStorage.removeItem('logo_kanan');

    const imgKiri = document.getElementById('logoKiri');
    const placeholderKiri = document.getElementById('placeholderKiri');
    imgKiri.style.display = 'none';
    imgKiri.src = '';
    placeholderKiri.style.display = 'block';

    const imgKanan = document.getElementById('logoKanan');
    const placeholderKanan = document.getElementById('placeholderKanan');
    imgKanan.style.display = 'none';
    imgKanan.src = '';
    placeholderKanan.style.display = 'block';
}
}

function addResetButton() {
const controls = document.querySelector('.page-size-controls');
if (controls && !document.getElementById('resetImagesBtn')) {
    const resetBtn = document.createElement('button');
    resetBtn.id = 'resetImagesBtn';
    resetBtn.className = 'page-size-btn';
    resetBtn.innerHTML = '<i class="fas fa-redo"></i> Reset Logo';
    resetBtn.onclick = resetImages;
    resetBtn.style.marginTop = '10px';
    controls.appendChild(resetBtn);
}
}

function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    
    // TOGGLE SAJA, biar CSS yang handle tampilan
    sidebar.classList.toggle('open');
    
    // Ubah ikon
    const icon = document.querySelector('.hamburger-btn i');
    const isOpen = sidebar.classList.contains('open');
    
    icon.className = isOpen ? 'fas fa-times' : 'fas fa-bars';
}

function closeBAForm() {
    // SELALU kembali ke dashboard
    document.getElementById('baFormPage').style.display = 'none';
    document.getElementById('dashboardPage').style.display = 'block';
    
    // Tampilkan konten "Buat BA" (tempat list BA)
    document.querySelectorAll('.content-area').forEach(el => {
        el.classList.remove('active');
    });
    document.getElementById('createBAContent').classList.add('active');
    
    // Update header
    document.querySelector('.header-left h1').textContent = 'Buat Berita Acara';
    document.querySelector('.header-left p').textContent = 'Form pengisian BA';
    
    // Reset form
    resetBAForm();
}

function filterReports() {
const startDate = document.getElementById('startDate').value;
const endDate = document.getElementById('endDate').value;
const month = document.getElementById('monthFilter').value;
const inetSearch = document.getElementById('searchInet').value.toLowerCase();

showNotification(`Filter diterapkan:\nTanggal: ${startDate} - ${endDate}\nBulan: ${month}\nNo Internet: ${inetSearch}`, 'info');

loadReports();
}

function exportReports() {
showNotification('Laporan berhasil diexport ke Excel', 'success');
}

// === AUTO LOGOUT FUNCTIONALITY (Supabase) ===
function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        if (currentUser) {
            showNotification('Sesi Anda telah berakhir karena tidak ada aktivitas selama 10 menit', 'warning');
            logout();
        }
    }, INACTIVITY_LIMIT);
}

function setupInactivityDetection() {
    const events = [
        'mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'
    ];

    events.forEach(event => {
        document.addEventListener(event, resetInactivityTimer, true);
    });

    resetInactivityTimer();
}

async function loadReports() {
    console.log('📊 [loadReports] Fungsi dipanggil');
    
    if (!currentUser) {
        console.error('❌ [loadReports] User tidak login');
        return;
    }
    
    if (!supabase) {
        console.error('❌ [loadReports] Supabase tidak ada');
        return;
    }

    try {
        showLoading('Memuat laporan...');
        
        // DEBUG: LOG USER INFO
        console.log('👤 [loadReports] Current user:', {
            email: currentUser.email,
            role: currentUser.role,
            id: currentUser.id
        });
        
        // 1. TEST QUERY DASAR DULU
        console.log('🔍 [loadReports] Testing query dasar...');
        const { data: testData, error: testError } = await supabase
            .from('ba_documents')
            .select('count')
            .single();
            
        console.log('📊 [loadReports] Total data di database:', testData?.count || 0);
        
        if (testError) {
            console.error('❌ [loadReports] Error count data:', testError);
        }
        
        // 2. QUERY DATA UTAMA
        let query = supabase
            .from('ba_documents')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);
        
        // HANYA FILTER JIKA BUKAN ADMIN
        console.log('🎭 [loadReports] User role:', currentUser.role);
        
        if (currentUser.role !== 'admin') {
            console.log('🔍 [loadReports] Filter untuk user:', currentUser.email);
            query = query.eq('user_email', currentUser.email);
        } else {
            console.log('🔍 [loadReports] Admin - ambil semua data');
        }
        
        // 3. EKSEKUSI QUERY
        console.log('⚡ [loadReports] Mengeksekusi query...');
        const { data: reports, error } = await query;

        if (error) {
            console.error('❌ [loadReports] Supabase query error:', {
                message: error.message,
                code: error.code,
                details: error.details
            });
            
            // TAMPILKAN ERROR KE USER
            showNotification('Error mengambil data: ' + error.message, 'error');
            hideLoading();
            return;
        }

        console.log('✅ [loadReports] Data diterima dari Supabase:');
        console.log('📦 Jumlah data:', reports?.length || 0);
        
        if (reports && reports.length > 0) {
            console.log('📄 Sample data pertama:', reports[0]);
            console.log('🏷️ Status data pertama:', reports[0].status);
            console.log('📧 Email data pertama:', reports[0].user_email);
        }

        // 4. TAMPILKAN DATA
        const container = document.getElementById('reportsContainer');
        const emptyMsg = document.getElementById('reportsEmpty');
        
        if (!container) {
            console.error('❌ [loadReports] Container tidak ditemukan');
            hideLoading();
            return;
        }

        container.innerHTML = '';

        if (!reports || reports.length === 0) {
            console.log('📭 [loadReports] Tidak ada data ditemukan');
            if (emptyMsg) {
                emptyMsg.style.display = 'block';
                emptyMsg.innerHTML = `
                    <i class="fas fa-database" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p>Belum ada data laporan</p>
                    <small style="color: #999;">User: ${currentUser.email}</small>
                `;
            }
            hideLoading();
            return;
        }

        if (emptyMsg) emptyMsg.style.display = 'none';

        // 5. RENDER SETIAP DATA
        console.log('🎨 [loadReports] Merender', reports.length, 'data...');
        
        reports.forEach((report, index) => {
            // LOG SETIAP DATA UNTUK DEBUG
            if (index < 3) { // Hanya log 3 data pertama
                console.log(`📊 Data ${index + 1}:`, {
                    id: report.id,
                    no_ba: report.no_ba,
                    status: report.status,
                    user_email: report.user_email,
                    nama_pelanggan: report.nama_pelanggan
                });
            }
            
            const statusColor = report.status === 'Selesai' ? '#27ae60' : 
                              report.status === 'Draft' ? '#f39c12' : '#e74c3c';
            
            const statusText = report.status === 'Selesai' ? 'Selesai' :
                             report.status === 'Draft' ? 'Draft' : 'Unknown';
            
            const card = document.createElement('div');
            card.className = 'horizontal-card';
            
            card.innerHTML = `
                <div class="card-header">
                    <h4 class="card-title">${report.nama_pelanggan || 'Tidak ada nama'}</h4>
                    <span class="card-badge" style="background: ${statusColor}15; color: ${statusColor}">
                        ${statusText}
                    </span>
                </div>
                
                <div class="card-content">
                    <div class="card-row">
                        <i class="fas fa-hashtag"></i>
                        <span style="font-weight: 600; color: #2c3e50;">${report.no_ba || 'No BA: -'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-wifi"></i>
                        <span>${report.no_inet || 'No Internet: -'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-user-cog"></i>
                        <span>${report.nama_teknisi || 'Teknisi: -'}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-calendar"></i>
                        <span>${report.tanggal || (report.created_at ? new Date(report.created_at).toLocaleDateString('id-ID') : '-')}</span>
                    </div>
                    <div class="card-row">
                        <i class="fas fa-envelope"></i>
                        <small style="color: #666;">${report.user_email || '-'}</small>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button class="card-btn card-btn-view" onclick="viewBAReport('${report.id}')">
                        <i class="fas fa-eye"></i> Detail
                    </button>
                    <button class="card-btn card-btn-download" onclick="downloadBAPDF('${report.id}')">
                        <i class="fas fa-download"></i> PDF
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        });

        console.log('✅ [loadReports] Rendering selesai');
        hideLoading();
        
        

    } catch (error) {
        console.error('❌ [loadReports] Error fatal:', error);
        console.error('Stack:', error.stack);
        
        const container = document.getElementById('reportsContainer');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; color: #ff4757; padding: 40px; width: 100%;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                    <p><strong>Error loading data</strong></p>
                    <p style="font-size: 12px; margin-top: 10px;">${error.message}</p>
                    <button onclick="loadReports()" style="margin-top: 15px; padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 5px;">
                        Coba Lagi
                    </button>
                </div>
            `;
        }
        hideLoading();
    }
}

// TAMBAH FUNGSI UNTUK MELIHAT DETAIL REPORT
async function viewBAReport(id) {
    try {
        showLoading('Memuat detail...');
        
        const { data: report, error } = await supabase
            .from('ba_documents')
            .select('*')
            .eq('id', id)
            .single();
            
        if (error) throw error;
        
        // Tampilkan dalam alert sederhana dulu
        alert(`Detail BA:\n
No BA: ${report.no_ba || '-'}\n
Pelanggan: ${report.nama_pelanggan || '-'}\n
Status: ${report.status || '-'}\n
Tanggal: ${report.tanggal || '-'}\n
Teknisi: ${report.nama_teknisi || '-'}`);
        
    } catch (error) {
        console.error('Error view report:', error);
        showNotification('Gagal memuat detail', 'error');
    } finally {
        hideLoading();
    }
}

async function loadDrafts() {
console.log('🔧 ===== MULAI: loadDrafts() =====');
console.log('🔧 DEBUG: currentUser:', currentUser);
console.log('🔧 DEBUG: currentUser.role:', currentUser?.role);

if (!currentUser || !currentUser.email || !auth || !auth.currentUser) {
    console.log('❌ DEBUG: User tidak valid, keluar dari fungsi.');
    return;
}

try {
    if (!firestore) {
        console.log('❌ DEBUG: Firestore tidak ada, keluar dari fungsi.');
        return;
    }

    showLoading('Memuat drafts...');
    console.log('🔧 DEBUG: Loading ditampilkan.');

    let draftsSnapshot;
    if (currentUser.role === 'admin') {
        console.log('🔧 DEBUG: User adalah ADMIN. Mengeksekusi query untuk admin.');
        draftsSnapshot = await firestore.collection('ba_drafts').orderBy('updatedAt', 'desc').limit(10).get();
    } else {
        console.log('🔧 DEBUG: User adalah TEKNISI. Mengeksekusi query untuk teknisi.');
        draftsSnapshot = await firestore.collection('ba_drafts').where('userEmail', '==', currentUser.email).orderBy('updatedAt', 'desc').limit(10).get();
    }

    console.log('🔧 DEBUG: Query selesai dieksekusi. Menunggu hasil...');
    const snapshotResult = await draftsSnapshot;
    console.log('🔧 DEBUG: Hasil query diterima. Jumlah dokumen:', snapshotResult.size);
    console.log('🔧 DEBUG: Metadata query:', snapshotResult.metadata);
    console.log('🔧 DEBUG: Data snapshot:', snapshotResult);

    const tbody = document.getElementById('myBATable');
    if (!tbody) {
        console.log('❌ DEBUG: Elemen #myBATable tidak ditemukan di HTML.');
        return;
    }

    tbody.innerHTML = '';

    if (snapshotResult.empty) {
        console.log('🔧 DEBUG: Snapshot kosong, tampilkan pesan kosong.');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                    <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                    Belum ada draft
                </td>
            </tr>
        `;
        hideLoading();
        return;
    }

    let draftDocs = [];
    console.log('🔧 DEBUG: Memproses dokumen dari snapshot...');
    snapshotResult.forEach(doc => {
        console.log('🔧 DEBUG: Memproses dokumen:', doc.id, doc.data());
        draftDocs.push({ id: doc.id, data: doc.data() });
    });

    console.log('🔧 DEBUG: Data sebelum di-sort:', draftDocs);

    draftDocs.sort((a, b) => {
        const dateA = new Date(a.data.updatedAt || 0);
        const dateB = new Date(b.data.updatedAt || 0);
        return dateB - dateA;
    });

    console.log('🔧 DEBUG: Data setelah di-sort:', draftDocs);

    console.log('🔧 DEBUG: Mulai rendering ke HTML...');
    draftDocs.forEach((doc, index) => {
        const draft = doc.data;
        const statusClass = 'status-draft'; // Status khusus untuk draft

        const newRow = `
            <tr>
                <td>${draft.noBA || 'DRAFT'}</td>
                <td>${new Date(draft.updatedAt?.toDate() || draft.updatedAt).toLocaleDateString('id-ID')}</td>
                <td>${draft.formData?.nama_pelanggan || '-'}</td>
                <td>${draft.formData?.no_inet || '-'}</td>
                <td>-</td>
                <td>${draft.userEmail || '-'}</td>
                <td class="${statusClass}">Draft</td>
                <td>
                    <button class="btn-action btn-edit" onclick="loadDraft('${doc.id}'); openBAForm();" title="Edit Draft">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-action btn-delete" onclick="deleteDraft('${doc.id}')" title="Hapus Draft">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        console.log(`🔧 DEBUG: Menambah baris ke-${index + 1}:`, newRow);
        tbody.innerHTML += newRow;
    });

    console.log('🔧 DEBUG: Selesai rendering. Sembunyikan loading.');
    hideLoading();
    console.log('🔧 ===== SELESAI: loadDrafts() =====');

} catch (error) {
    console.error('❌ ===== ERROR: loadDrafts() =====');
    console.error('❌ ERROR: Pesan Error:', error.message);
    console.error('❌ ERROR: Kode Error:', error.code);
    console.error('❌ ERROR: Stack Trace:', error.stack);
    console.error('❌ ERROR: Objek Error Lengkap:', error);
    console.error('❌ ===== AKHIR ERROR =====');

    const tbody = document.getElementById('myBATable');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #ff4757; padding: 30px;">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data
                </td>
            </tr>
        `;
    }
    hideLoading();
}
}

// === SCROLL FUNCTIONALITY ===
function initScrollIndicator() {
const scrollIndicator = document.getElementById('scrollIndicator');
const scrollProgress = document.getElementById('scrollProgress');

if (!scrollIndicator || !scrollProgress) return;

function updateScrollProgress() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrollPercent = (scrollTop / scrollHeight) * 100;

    scrollProgress.style.width = scrollPercent + '%';

    if (scrollTop > 300) {
        scrollIndicator.classList.add('show');
    } else {
        scrollIndicator.classList.remove('show');
    }
}

window.scrollToTop = function() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
};

window.addEventListener('scroll', updateScrollProgress);

updateScrollProgress();
}

function enhanceBAFormScroll() {
const baFormPage = document.getElementById('baFormPage');
if (!baFormPage) return;

baFormPage.style.scrollBehavior = 'smooth';

const formInputs = baFormPage.querySelectorAll('input, textarea, select');
formInputs.forEach(input => {
    input.addEventListener('focus', function() {
        setTimeout(() => {
            const rect = this.getBoundingClientRect();
            const isInViewport = rect.top >= 0 && rect.bottom <= window.innerHeight;

            if (!isInViewport) {
                this.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }, 300);
    });
});
}


// === FUNGSI UNTUK MODAL PREVIEW PDF ===

function showPDFPreview(pdfUrl, filename) {
const modal = document.getElementById('pdfPreviewModal');

// --- PERBAIKAN: CEK APAKAH MODAL ADA ---
if (!modal) {
    console.error('Error: Modal dengan ID "pdfPreviewModal" tidak ditemukan di HTML.');
    alert('Error: Elemen preview tidak ditemukan. Pastikan HTML untuk modal preview sudah ditambahkan dengan benar. Lihat console untuk detail.');
    return;
}

const iframe = document.getElementById('pdfPreviewFrame');
const downloadBtn = document.getElementById('downloadPdfFromPreviewBtn');

// --- PERBAIKAN: CEK APAKAH IFRAME ADA ---
if (!iframe) {
    console.error('Error: Iframe dengan ID "pdfPreviewFrame" tidak ditemukan di HTML.');
    alert('Error: Elemen preview tidak ditemukan. Pastikan HTML untuk modal preview sudah ditambahkan dengan benar. Lihat console untuk detail.');
    return;
}

// Set URL PDF ke iframe
iframe.src = pdfUrl;

// Set event listener untuk tombol download
// Hapus listener lama jika ada untuk mencegah duplikasi
const newDownloadBtn = downloadBtn.cloneNode(true);
downloadBtn.parentNode.replaceChild(newDownloadBtn, downloadBtn);

newDownloadBtn.addEventListener('click', () => {
    // Buat link sementara untuk mendownload
    const a = document.createElement('a');
    a.href = pdfUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Opsional: Tutup modal setelah download
    // closePDFPreview();
});

// Tampilkan modal
modal.style.display = 'block';
}

function closePDFPreview() {
const modal = document.getElementById('pdfPreviewModal');
const iframe = document.getElementById('pdfPreviewFrame');

if (!modal || !iframe) {
    // Jika elemen tidak ada, tidak perlu melakukan apa-apa
    return;
}

// Sembunyikan modal
modal.style.display = 'none';

// Kosongkan src iframe untuk menghentikan pemuatan
const currentSrc = iframe.src;
iframe.src = 'about:blank'; // Reset src ke halaman kosong

// Revoke URL untuk membebaskan memori
if (currentSrc && currentSrc.startsWith('blob:')) {
    URL.revokeObjectURL(currentSrc);
}
}

// === INITIALIZE APP ===
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🚀 Aplikasi mulai loading...');
    
    // 1. Setup tombol login
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) {
        loginBtn.addEventListener('click', function(e) {
            e.preventDefault();
            login();
        });
    }
    
    // 2. Setup tombol logout dengan popup
    setupLogoutButtons();
    
    // 3. Initialize Supabase
    console.log('🔄 Inisialisasi Supabase...');
    const supabaseReady = await initializeSupabase();
    
    if (supabaseReady) {
        console.log('✅ Supabase siap');
    }
    
    // 4. Setup lainnya
    loadSavedImages();
    initScrollIndicator();
    setupInactivityDetection();
    
    console.log('🏁 Aplikasi siap digunakan!');
});

// === FUNGSI SETUP TOMBOL LOGOUT ===
function setupLogoutButtons() {
    console.log('🔧 Setup tombol logout...');
    
    // Tombol logout di header (Desktop)
    const headerLogoutBtns = document.querySelectorAll('.logout-btn');
    headerLogoutBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('🖱️ Tombol logout header diklik');
            logout();
        });
    });
    
    // Tombol logout di bottom nav (Mobile)
    const bottomNavLogout = document.querySelector('.nav-item[onclick*="logout"], .nav-btn[onclick*="logout"]');
    if (bottomNavLogout) {
        bottomNavLogout.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('📱 Tombol logout bottom nav diklik');
            logout();
        });
    }
    
    console.log(`✅ Setup selesai: ${headerLogoutBtns.length} tombol logout ditemukan`);
}



// ==============================================
// FUNGSI TESTING & DEBUGGING
// ==============================================

// 1. FUNGSI UNTUK CEK DATA DI SUPABASE
window.testSupabaseData = async function() {
    console.log('🔍 ===== TEST SUPABASE DATA =====');
    
    if (!supabase) {
        console.error('❌ Supabase tidak ada');
        alert('Supabase tidak terhubung');
        return;
    }
    
    if (!currentUser) {
        console.error('❌ User tidak login');
        alert('Silakan login dulu');
        return;
    }
    
    try {
        // 1. CEK TOTAL DATA
        console.log('📊 1. Menghitung total data...');
        const { count, error: countError } = await supabase
            .from('ba_documents')
            .select('*', { count: 'exact', head: true });
        
        console.log('✅ Total data di database:', count || 0);
        
        // 2. CEK DATA PER USER
        console.log('👤 2. Cek data untuk user:', currentUser.email);
        const { data: userData, error: userError } = await supabase
            .from('ba_documents')
            .select('*')
            .eq('user_email', currentUser.email)
            .order('created_at', { ascending: false })
            .limit(5);
        
        if (userError) {
            console.error('❌ Error query user data:', userError);
        } else {
            console.log('✅ Data untuk user ini:', userData?.length || 0);
            if (userData && userData.length > 0) {
                console.log('📄 Sample data user:');
                userData.forEach((item, i) => {
                    console.log(`  ${i+1}. ${item.no_ba} - ${item.nama_pelanggan} - Status: ${item.status}`);
                });
            } else {
                console.log('📭 Tidak ada data untuk user ini');
            }
        }
        
        // 3. CEK SEMUA DATA (UNTUK ADMIN)
        console.log('👑 3. Cek semua data (admin view)...');
        const { data: allData, error: allError } = await supabase
            .from('ba_documents')
            .select('id, no_ba, user_email, status, created_at')
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (allError) {
            console.error('❌ Error query all data:', allError);
        } else {
            console.log('✅ 10 Data terbaru di sistem:');
            if (allData && allData.length > 0) {
                allData.forEach((item, i) => {
                    console.log(`  ${i+1}. ${item.no_ba} - ${item.user_email} - ${item.status} - ${item.created_at}`);
                });
            } else {
                console.log('📭 Tidak ada data sama sekali di sistem');
            }
        }
        
        // 4. CEK STRUKTUR TABLE
        console.log('🏗️ 4. Cek struktur table...');
        const { data: sample, error: sampleError } = await supabase
            .from('ba_documents')
            .select('*')
            .limit(1)
            .single();
        
        if (sampleError && sampleError.code !== 'PGRST116') { // PGRST116 = no rows
            console.error('❌ Error cek struktur:', sampleError);
        } else if (sample) {
            console.log('✅ Struktur data:');
            Object.keys(sample).forEach(key => {
                console.log(`  - ${key}: ${typeof sample[key]}`);
            });
        }
        
        // 5. TAMPILKAN HASIL DI ALERT
        let resultMessage = `📊 HASIL TEST:\n\n`;
        resultMessage += `Total data: ${count || 0}\n`;
        resultMessage += `Data untuk ${currentUser.email}: ${userData?.length || 0}\n\n`;
        
        if (userData && userData.length > 0) {
            resultMessage += `DATA ANDA:\n`;
            userData.slice(0, 3).forEach(item => {
                resultMessage += `• ${item.no_ba} - ${item.status}\n`;
            });
            if (userData.length > 3) resultMessage += `...dan ${userData.length - 3} data lainnya\n`;
        } else {
            resultMessage += `⚠️ Tidak ada data untuk Anda\n`;
        }
        
        resultMessage += `\nRole Anda: ${currentUser.role || 'User'}`;
        
        alert(resultMessage);
        
        console.log('✅ ===== TEST SELESAI =====');
        
    } catch (error) {
        console.error('💥 ERROR TESTING:', error);
        alert(`❌ ERROR TEST:\n${error.message}`);
    }
};

// 2. FUNGSI UNTUK BUAT DATA TEST (JIKA KOSONG)
window.createTestData = async function() {
    if (!confirm('Buat data test BA?')) return;
    
    try {
        showLoading('Membuat data test...');
        
        const testData = {
            no_ba: `BA/TEST/${Date.now().toString().slice(-6)}`,
            tanggal: new Date().toISOString().split('T')[0],
            no_inet: '123456789',
            nama_pelanggan: 'PELANGGAN TEST',
            nama_teknisi: currentUser.name,
            teknisi_id: currentUser.id,
            user_email: currentUser.email,
            created_by: currentUser.id,
            status: 'Selesai',
            sto: 'TEST',
            no_permintaan: 'WO-TEST-001',
            no_telepon: '08123456789',
            tanggal_wo: new Date().toISOString().split('T')[0],
            no_kontak: '08123456789',
            alamat_pelanggan: 'Alamat test',
            ont_ditarik: 'ONT-TEST-001',
            sn_ont: 'SN-TEST-001',
            stb_id: 'STB-TEST-001',
            test_voice: 'baik',
            test_inet: 'baik',
            test_usee_tv: 'baik',
            mitra: 'MITRA TEST',
            signature_pelanggan: null,
            signature_petugas: null
        };
        
        const { data, error } = await supabase
            .from('ba_documents')
            .insert([testData])
            .select();
            
        if (error) throw error;
        
        showNotification('✅ Data test berhasil dibuat!', 'success');
        
        // REFRESH DATA
        setTimeout(() => {
            loadBASaya();
            loadReports();
        }, 1500);
        
    } catch (error) {
        console.error('Error create test data:', error);
        showNotification('❌ Gagal buat data test: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
};

// 3. FUNGSI UNTUK RESET & CLEANUP
window.cleanupTestData = async function() {
    if (!confirm('Hapus SEMUA data BA milik Anda?')) return;
    
    try {
        showLoading('Menghapus data...');
        
        const { error } = await supabase
            .from('ba_documents')
            .delete()
            .eq('user_email', currentUser.email);
            
        if (error) throw error;
        
        showNotification('✅ Semua data BA Anda telah dihapus!', 'success');
        
        // REFRESH
        setTimeout(() => {
            loadBASaya();
            loadReports();
        }, 1000);
        
    } catch (error) {
        console.error('Error cleanup:', error);
        showNotification('❌ Gagal hapus data: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
};

// 4. TAMBAH TOMBOL DEBUG DI UI
function addDebugButtons() {
    // Hapus tombol debug lama jika ada
    const oldDebug = document.getElementById('debugButtons');
    if (oldDebug) oldDebug.remove();
    
    // Buat container tombol debug
    const debugDiv = document.createElement('div');
    debugDiv.id = 'debugButtons';
    debugDiv.style.cssText = `
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 9999;
        background: rgba(0,0,0,0.8);
        padding: 10px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        max-width: 200px;
    `;
    
    debugDiv.innerHTML = `
        <div style="color: white; font-size: 10px; margin-bottom: 5px; text-align: center;">
            🐛 DEBUG TOOLS
        </div>
        <button onclick="testSupabaseData()" style="padding: 6px 10px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">
            🔍 Test Data
        </button>
        <button onclick="createTestData()" style="padding: 6px 10px; background: #2ecc71; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">
            ➕ Buat Test Data
        </button>
        <button onclick="cleanupTestData()" style="padding: 6px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">
            🗑️ Hapus Data Saya
        </button>
        <button onclick="loadReports()" style="padding: 6px 10px; background: #9b59b6; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">
            📊 Refresh Laporan
        </button>
        <button onclick="loadBASaya()" style="padding: 6px 10px; background: #f39c12; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">
            📋 Refresh BA Saya
        </button>
        <hr style="border: none; border-top: 1px solid #555; margin: 5px 0;">
        <div style="color: #aaa; font-size: 9px; text-align: center;">
            User: ${currentUser?.email || 'Not logged in'}
        </div>
    `;
    
    document.body.appendChild(debugDiv);
    console.log('✅ Debug buttons added');
}

// 5. AUTO SETUP DEBUG SAAT LOGIN
// Tambah di fungsi handleLoggedInUser() atau setelah login sukses:
function setupDebugTools() {
    // Tambah tombol debug
    setTimeout(addDebugButtons, 2000);
    
    // Auto test saat pertama kali
    setTimeout(() => {
        console.log('🔧 Auto-testing data...');
        if (window.testSupabaseData) {
            window.testSupabaseData().catch(e => console.log('Auto-test skipped:', e));
        }
    }, 3000);
}

// 6. PASTIKAN FUNGSI INI DIPANGGIL SETELAH LOGIN
// Cari fungsi handleLoggedInUser() dan tambah:
// setupDebugTools();


    // --- SIDEBAR UNTUK MOBILE ---
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('open');
            }
        });
    });

    // --- TUTUP FORM BA DENGAN ESCAPE ---
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('baFormPage').style.display === 'block') {
            closeBAForm();
        }
    });

    // --- TUTUP SIDEBAR DI LUAR AREA KLIK ---
    document.addEventListener('click', function(event) {
        const sidebar = document.querySelector('.sidebar');
        const hamburger = document.querySelector('.hamburger-btn');
        const hamburgerIcon = document.querySelector('.hamburger-btn i');

        if (window.innerWidth <= 768 &&
            sidebar.classList.contains('open') &&
            !sidebar.contains(event.target) &&
            !hamburger.contains(event.target) &&
            event.target !== hamburger) {

            sidebar.classList.remove('open');
            hamburgerIcon.classList.remove('fa-times');
            hamburgerIcon.classList.add('fa-bars');
        }
    });

    // --- INISIALISASI SCROLL ---
    initScrollIndicator();
    enhanceBAFormScroll();

    setTimeout(() => {
        hideLoading();
    }, 1000);



</script>
</body>
</html>
