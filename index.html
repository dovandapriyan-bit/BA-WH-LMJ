<!DOCTYPE html>
<html lang="id">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Sistem Berita Acara</title>
    
    <style type="text/css">
        /* RESPONSIVE FIX - PASTI BERFUNGSI */
        @media screen and (max-width: 768px) {
            /* HEADER */
            .header {
                padding: 10px;
                flex-direction: column;
                gap: 10px;
            }
            
            .header-left {
                width: 100%;
                position: relative;
                text-align: center;
            }
            
            .hamburger-btn {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                background: #e74c3c;
                color: white;
                border: none;
                padding: 8px;
                border-radius: 5px;
                z-index: 1002;
            }
            
            /* SIDEBAR */
            .sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                height: 100vh;
                width: 200px !important;
                z-index: 1001;
                transition: left 0.3s ease;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            }
            
            .sidebar.open {
                left: 0;
                box-shadow: 2px 0 15px rgba(0,0,0,0.3);
            }
            
            .sidebar-item span {
                display: none;
            }
            
            .sidebar.open .sidebar-item span {
                display: inline-block;
                margin-left: 10px;
            }
            
            /* MAIN CONTENT */
            .main-content {
                margin-left: 0 !important;
                padding: 10px;
            }
            
            /* CARDS */
            .cards-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* TABLES */
            .table-container {
                padding: 15px;
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 600px;
                font-size: 12px;
            }
        }

        @media screen and (max-width: 480px) {
            .header-left h1 {
                font-size: 18px;
                margin-left: 40px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
                font-size: 12px;
            }
        }

        /* === STYLES YANG SUDAH ADA === */
        .page-size-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .page-size-btn {
            margin: 2px;
            padding: 5px 10px;
            font-size: 10px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #f5f5f5;
            border-radius: 3px;
        }

        .page-size-btn.active {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .container-a4 { 
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 20px auto;
            padding: 10mm;
            box-sizing: border-box;
            font-family: Arial;
            font-size: 9pt;
        }

        .container-a5 { 
            width: 148mm;
            min-height: 210mm;
            background: white;
            margin: 20px auto;
            padding: 8mm;
            box-sizing: border-box;
            font-family: Arial;
            font-size: 8pt;
        }

        .container-letter { 
            width: 216mm;
            min-height: 279mm;
            background: white;
            margin: 20px auto;
            padding: 10mm;
            box-sizing: border-box;
            font-family: Arial;
            font-size: 9pt;
        }

        .container-landscape { 
            width: 297mm;
            min-height: 210mm;
            background: white;
            margin: 20px auto;
            padding: 10mm;
            box-sizing: border-box;
            font-family: Arial;
            font-size: 9pt;
        }

        html, body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        input[type="text"] {
            border: none;
            border-bottom: 1px solid #000;
            background: transparent;
            font-family: Arial;
            font-size: 9pt;
            width: 100%;
            padding: 2px;
        }

        input[type="checkbox"] {
            margin-right: 3px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        td {
            padding: 3px;
            vertical-align: top;
        }

        .main-table {
            width: 100%;
            border: 1px solid #000;
        }

        .main-table td {
            border: 1px solid #000;
            padding: 5px;
        }

        .data-table {
            width: 100%;
            border: none;
        }

        .data-table td {
            border: none;
            padding: 2px;
        }

        .test-table {
            width: 100%;
            border: 1px solid #000;
        }

        .test-table th, .test-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            font-size: 8pt;
        }

        .signature-box {
            border: 1px dashed #000;
            height: 80px;
            position: relative;
        }

        .main-table td {
            padding: 3px;
        }

        canvas {
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            overscroll-behavior-y: contain;
        }

                
        /* === LOGIN PAGE STYLES === */
        #loginPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #e74c3c 50%, #c0392b 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 50px 40px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h2 {
            color: #2c3e50;
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .login-header p {
            color: #7f8c8d;
            font-size: 15px;
            font-weight: 400;
        }

        .tech-animation {
            text-align: center;
            margin-bottom: 35px;
        }

        .circuit-line {
            position: relative;
            height: 3px;
            background: linear-gradient(90deg, transparent, #e74c3c, transparent);
            margin: 25px 0;
            border-radius: 2px;
        }

        .circuit-line::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 15px;
            height: 15px;
            background: #e74c3c;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }

        .node {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            top: -2.5px;
        }

        .node:nth-child(1) { left: 25%; }
        .node:nth-child(2) { left: 50%; }
        .node:nth-child(3) { left: 75%; }

        .login-form {
            margin-top: 25px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #ffffff;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #e74c3c;
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 8px;
            display: none;
            font-weight: 500;
        }

        /* === DASHBOARD STYLES === */
        #dashboardPage {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            z-index: 9998;
        }

                /* SIDEBAR STYLES */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: #ffffff;
            transition: left 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 20px rgba(0,0,0,0.06);
            overflow-y: auto;
            border-right: 1px solid #e8e8e8;
        }

        .sidebar-header {
            padding: 28px 24px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
        }

        .sidebar-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sidebar-header h3 i {
            color: #e74c3c;
            font-size: 20px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-item {
            padding: 16px 24px;
            color: #64748b;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 2px 16px;
            border-radius: 0 8px 8px 0;
            position: relative;
        }

        .sidebar-item:hover {
            color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.08) 0%, rgba(231, 76, 60, 0.02) 100%);
            border-left-color: #e74c3c;
            transform: translateX(2px);
        }

        .sidebar-item.active {
            color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.12) 0%, rgba(231, 76, 60, 0.04) 100%);
            border-left-color: #e74c3c;
            font-weight: 600;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.1);
        }

        .sidebar-item i {
            font-size: 18px;
            width: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .sidebar-item:hover i,
        .sidebar-item.active i {
            transform: scale(1.1);
        }

        /* Add subtle separator between menu items */
        .sidebar-item:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 24px;
            right: 24px;
            height: 1px;
            background: linear-gradient(90deg, transparent, #f0f0f0, transparent);
            opacity: 0.5;
        }

        /* Add subtle background pattern */
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(231, 76, 60, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(231, 76, 60, 0.02) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(231, 76, 60, 0.01) 0%, transparent 50%);
            pointer-events: none;
        }

        /* Add subtle shadow for depth */
        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            right: -1px;
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(0,0,0,0.08), transparent);
        }

        /* Update hamburger button to match */
        .hamburger-btn {
            background: #ffffff;
            color: #e74c3c;
            border: 1px solid #e8e8e8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .hamburger-btn:hover {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 260px;
            padding: 25px;
            transition: margin-left 0.3s ease;
        }

        /* HEADER */
        .header {
            background: white;
            padding: 20px 35px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .header-left h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-left p {
            color: #7f8c8d;
            font-size: 15px;
            font-weight: 400;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 18px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 12px 25px;
            border-radius: 50px;
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(255,255,255,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 15px;
        }

        .user-role {
            font-size: 12px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            padding: 8px 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.05);
        }

        /* CONTENT AREA */
        .content-area {
            display: none;
        }

        .content-area.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CARDS */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .card-icon {
            width: 65px;
            height: 65px;
            border-radius: 16px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            color: white;
            font-size: 28px;
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 20px;
            font-weight: 600;
        }

        .card p {
            color: #7f8c8d;
            font-size: 15px;
            line-height: 1.6;
            font-weight: 400;
        }

        /* TABLES */
        .table-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            overflow-x: auto;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .table-title {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .table-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .table-controls input,
        .table-controls select,
        .table-controls button {
            padding: 10px 18px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .table-controls input:focus,
        .table-controls select:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .table-controls button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .table-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px 18px;
            text-align: left;
            color: #2c3e50;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .data-table td {
            padding: 15px 18px;
            border-bottom: 1px solid #ecf0f1;
            color: #495057;
            font-size: 14px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-active {
            color: #27ae60;
            font-weight: 600;
            background: rgba(39, 174, 96, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .status-inactive {
            color: #e74c3c;
            font-weight: 600;
            background: rgba(231, 76, 60, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .btn-action {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            margin: 2px;
        }

        .btn-edit {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-toggle {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* FORM STYLES */
        .form-container {
            background: white;
            border-radius: 16px;
            padding: 35px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn-submit {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 14px 35px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }

        /* FILE UPLOAD */
        .file-upload {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 45px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .file-upload:hover {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .file-upload i {
            font-size: 52px;
            color: #e74c3c;
            margin-bottom: 18px;
        }

        .file-upload p {
            color: #6c757d;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .file-upload span {
            color: #e74c3c;
            font-weight: 600;
        }

        /* UTILITIES */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }
        
        /* JABATAN SELECT */
        .jabatan-select {
            padding: 6px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-width: 110px;
            transition: all 0.3s ease;
        }

        .jabatan-select:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        
        .jabatan-select:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 35px;
            width: 90%;
            max-width: 520px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .hamburger-btn {
            display: none;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            position: absolute;
            left: 10px;
            top: 10px;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
        }

        .hamburger-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
        }

        @media (max-width: 768px) {
            .hamburger-btn {
                display: block;
            }
            
            .sidebar {
                left: -260px;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        /* RESPONSIVE FIX - PASTI BERFUNGSI */
        @media screen and (max-width: 768px) {
            /* HEADER */
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .header-left {
                width: 100%;
                position: relative;
                text-align: center;
            }
            
            .hamburger-btn {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: white;
                border: none;
                padding: 8px;
                border-radius: 8px;
                z-index: 1002;
                box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            }
            
            /* SIDEBAR */
            .sidebar {
                position: fixed;
                left: -260px;
                top: 0;
                height: 100vh;
                width: 240px !important;
                z-index: 1001;
                transition: left 0.3s ease;
                background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
                box-shadow: 4px 0 20px rgba(0,0,0,0.2);
            }
            
            .sidebar.open {
                left: 0;
                box-shadow: 4px 0 25px rgba(0,0,0,0.3);
            }
            
            .sidebar-item span {
                display: none;
            }
            
            .sidebar.open .sidebar-item span {
                display: inline-block;
                margin-left: 12px;
            }
            
            /* MAIN CONTENT */
            .main-content {
                margin-left: 0 !important;
                padding: 15px;
            }
            
            /* CARDS */
            .cards-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .card {
                padding: 25px;
            }
            
            /* TABLES */
            .table-container {
                padding: 20px;
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 600px;
                font-size: 12px;
            }

            .table-controls {
                flex-direction: column;
                gap: 10px;
            }

            .table-controls input,
            .table-controls select,
            .table-controls button {
                width: 100%;
            }
        }

        @media screen and (max-width: 480px) {
            .header-left h1 {
                font-size: 22px;
                margin-left: 50px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
                font-size: 13px;
                padding: 10px 20px;
            }

            .login-container {
                padding: 40px 30px;
                margin: 20px;
            }

            .card {
                padding: 20px;
            }

            .card-icon {
                width: 55px;
                height: 55px;
                font-size: 24px;
            }

            .table-container {
                padding: 15px;
            }
        }

        /* UNTUK HP KECIL */
        @media (max-width: 480px) {
            .sidebar {
                width: 70px;
            }
            
            .main-content {
                margin-left: 0;
                padding: 10px;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .table-controls {
                flex-wrap: wrap;
            }
            
            .table-controls input,
            .table-controls select,
            .table-controls button {
                flex: 1 1 100%;
                margin-bottom: 8px;
            }
            
            /* BA FORM UNTUK HP */
            .main-table td {
                padding: 2px;
                font-size: 8pt;
            }
            
            input[type="text"],
            input[type="date"] {
                font-size: 8pt;
                padding: 1px;
            }
            
            .signature-box canvas {
                width: 150px;
                height: 50px;
            }
        }
    

        /* RESPONSIVE SIDEBAR */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            
            .sidebar-header h3,
            .sidebar-item span,
            .submenu-header span,
            .sidebar-subitem span {
                display: none;
            }
            
            .sidebar-header {
                padding: 20px 10px;
                text-align: center;
            }
            
            .sidebar-item {
                padding: 15px 10px;
                text-align: center;
                justify-content: center;
            }
            
            .sidebar-item i {
                margin-right: 0;
                font-size: 20px;
            }
            
            .submenu-header {
                padding: 15px 10px;
                justify-content: center;
            }
            
            .sidebar-submenu {
                position: fixed;
                left: 70px;
                top: 0;
                width: 200px;
                height: 100vh;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                z-index: 1001;
                display: none;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            
            .sidebar-item.has-submenu.active .sidebar-submenu {
                display: block;
            }
            
            .sidebar-subitem {
                padding: 15px 20px;
                justify-content: flex-start;
            }
            
            .sidebar-subitem span {
                display: inline-block;
                margin-left: 10px;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            /* HEADER RESPONSIVE */
            .header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
            }
            
            /* TABLE RESPONSIVE */
            .table-container {
                padding: 15px;
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 600px;
            }
            
            /* BA FORM RESPONSIVE */
            .container-a4, 
            .container-a5, 
            .container-letter, 
            .container-landscape {
                width: 100%;
                padding: 5mm;
                margin: 10px auto;
            }
            
            .page-size-controls {
                top: 5px;
                right: 5px;
                padding: 5px;
                font-size: 10px;
            }
            
            .page-size-btn {
                padding: 3px 6px;
                font-size: 9px;
            }
        }

        /* UNTUK HP KECIL */
        @media (max-width: 480px) {
            .sidebar {
                width: 60px;
            }
            
            .main-content {
                margin-left: 60px;
                padding: 10px;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .table-controls {
                flex-wrap: wrap;
            }
            
            .table-controls input,
            .table-controls select,
            .table-controls button {
                flex: 1 1 100%;
                margin-bottom: 5px;
            }
            
            /* BA FORM UNTUK HP */
            .main-table td {
                padding: 2px;
                font-size: 8pt;
            }
            
            input[type="text"],
            input[type="date"] {
                font-size: 8pt;
                padding: 1px;
            }
            
            .signature-box canvas {
                width: 150px;
                height: 50px;
            }
        }

        /* UTILITIES */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }
        
        /* JABATAN SELECT */
        .jabatan-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            cursor: pointer;
            min-width: 100px;
        }
        
        .jabatan-select:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: #333;
            cursor: pointer;
            padding: 5px;
            position: absolute;
            right: 10px;
            top: 10px;
        }

        @media (max-width: 768px) {
            .hamburger-btn {
                display: block;
            }
            
            .sidebar {
                left: -250px;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
        }

       /* Image Upload Styles */
.image-upload-container {
    position: relative;
    border: 1px dashed #000;
    width: 90px;
    height: 50px;
    overflow: hidden;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.image-upload-container:hover {
    border-color: #e74c3c;
    box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
}

.image-upload-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    cursor: pointer;
}

.image-upload-placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.image-upload-btn {
    background: rgba(231, 76, 60, 0.9);
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    transition: all 0.3s ease;
}

.image-upload-btn:hover {
    background: #c0392b;
    transform: scale(1.05);
}

.image-upload-hint {
    font-size: 8px;
    color: #666;
    margin-top: 2px;
}

/* Overlay styles */
.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    cursor: pointer;
}

.image-overlay:hover {
    opacity: 1;
}

.overlay-content {
    color: white;
    text-align: center;
}

.overlay-icon {
    font-size: 16px;
    margin-bottom: 2px;
    display: block;
}

.overlay-text {
    font-size: 8px;
}

/* Reset button styling */
#resetImagesBtn {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    border: none;
    margin-top: 10px;
}

#resetImagesBtn:hover {
    background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
}
    </style>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- === LOGIN PAGE === -->
    <div id="loginPage">
        <div class="login-container">
            <div class="login-header">
                <h2>Berita Acara Elektronik</h2>
                <p>by X-SOFTWARE</p>
            </div>
            
            <div class="tech-animation">
                <div class="circuit-line">
                    <div class="node"></div>
                    <div class="node"></div>
                    <div class="node"></div>
                </div>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="email" placeholder="Masukkan email terdaftar">
                    <div class="error-message" id="emailError">Email tidak valid</div>
                </div>
                
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" placeholder="Masukkan password">
                    <div class="error-message" id="passwordError">Password minimal 6 karakter</div>
                </div>
                
                <button class="login-btn" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
        </div>
    </div>

    <!-- === DASHBOARD === -->
    <div id="dashboardPage">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-file-contract"></i> Berita Acara Digital</h3>
            </div>
            
            <div class="sidebar-menu">
                <div class="sidebar-item active" onclick="showContent('dashboard')">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                
                <div class="sidebar-item" onclick="showContent('technician')">
                    <i class="fas fa-users-cog"></i> Teknisi
                </div>
                
                <div class="sidebar-item" onclick="showContent('createBA')">
                    <i class="fas fa-file-medical"></i> Buat BA
                </div>
                
                <div class="sidebar-item" onclick="showContent('masterTech')">
                    <i class="fas fa-database"></i> Data Master
                </div>
                
                <div class="sidebar-item" onclick="showContent('reports')">
                    <i class="fas fa-chart-bar"></i> Laporan
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header-left">
                <button class="hamburger-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Dashboard</h1>
                <p>Sistem Manajemen Berita Acara</p>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin</div>
                    <div class="user-role" id="userRole">ADMIN</div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <!-- Content Area -->
            <div id="contentArea">
                <!-- Dashboard Content -->
                <div class="content-area active" id="dashboardContent">
                    <div class="cards-container">
                        <div class="card" onclick="showContent('createBA')">
                            <div class="card-icon">
                                <i class="fas fa-file-medical"></i>
                            </div>
                            <h3>Buat BA Baru</h3>
                            <p>Buat Berita Acara baru untuk pekerjaan yang telah diselesaikan</p>
                        </div>
                        
                        <div class="card" onclick="showContent('technician')">
                            <div class="card-icon">
                                <i class="fas fa-users-cog"></i>
                            </div>
                            <h3>Kelola Teknisi</h3>
                            <p>Kelola data teknisi, status aktif/nonaktif, dan informasi lainnya</p>
                        </div>
                        
                        <div class="card" onclick="showContent('masterTech')">
                            <div class="card-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <h3>Data Master</h3>
                            <p>Import data teknisi dari Excel dan kelola data master</p>
                        </div>
                        
                        <div class="card" onclick="showContent('reports')">
                            <div class="card-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h3>Laporan & Analisis</h3>
                            <p>Lihat laporan dan analisis data BA berdasarkan filter tertentu</p>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <h3 class="table-title">Aktivitas Terbaru</h3>
                        <table class="data-table">
    <thead>
        <tr>
            <th>Nama</th>
            <th>Email</th>
            <th>NIK</th>
            <th>Jabatan</th>
            <th>Mitra</th>
            <th>Status</th>
            <th>Aksi</th>
        </tr>
    </thead>
    <tbody id="technicianTable">
        <!-- Data akan diisi oleh JavaScript -->
    </tbody>
</table>
                    </div>
                </div>
                
                

                <!-- Menu Teknisi Content -->
                <div class="content-area" id="technicianContent">
                    <div class="table-container">
                        <h3 class="table-title">Daftar Teknisi</h3>
                        
                        <div class="table-controls">
                            <input type="text" id="searchTech" placeholder="Cari teknisi..." onkeyup="searchTechnicians()">
                            <button onclick="exportTechnicians()"><i class="fas fa-download"></i> Export</button>
                            <button onclick="showAddUserModal()"><i class="fas fa-plus"></i> Tambah Teknisi</button>
                            <button onclick="importTechData()"><i class="fas fa-file-import"></i> Import Data</button>
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>NIK</th>
                                    <th>Jabatan</th>
                                    <th>Mitra</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="technicianTable">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Buat BA Content -->
                <div class="content-area" id="createBAContent">
                    <div class="table-container">
                        <!-- TOMBOL BUAT BA -->
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 30px;">
                            <h3 style="color: #333; margin-bottom: 15px;">Buat Berita Acara Baru</h3>
                            <button class="btn-submit" onclick="openBAForm()" style="padding: 15px 50px; font-size: 16px;">
                                <i class="fas fa-file-medical"></i> Buka Form BA
                            </button>
                            <p style="color: #666; margin-top: 15px; font-size: 14px;">
                                Klik tombol di atas untuk membuka form pengisian Berita Acara
                            </p>
                        </div>
                        
                        <!-- LIST BA SAYA -->
                        <div>
                            <h3 style="color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e74c3c;">
                                <i class="fas fa-list"></i> Daftar BA Saya
                            </h3>
                            
                            <div class="table-controls">
                                <input type="date" id="filterTanggalSaya">
                                <input type="text" id="searchNoInetSaya" placeholder="Cari No Internet" onkeyup="filterBASaya()">
                                <button onclick="exportBASaya()"><i class="fas fa-download"></i> Export</button>
                                <button onclick="refreshBASaya()"><i class="fas fa-sync"></i> Refresh</button>
                            </div>
                            
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>No BA</th>
                                        <th>Tanggal</th>
                                        <th>Pelanggan</th>
                                        <th>No Internet</th>
                                        <th>STO</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="myBATable">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Master Teknisi Content -->
                <div class="content-area" id="masterTechContent">
                    <div class="table-container">
                        <h3 class="table-title">Master Data</h3>
                        
                        <div class="table-controls">
                            <input type="text" id="searchMaster" placeholder="Cari data master..." onkeyup="searchMasterData()">
                            <button onclick="importExcel()"><i class="fas fa-file-import"></i> Import Excel</button>
                            <button onclick="refreshMaster()"><i class="fas fa-sync"></i> Refresh</button>
                        </div>
                        
                        <div class="file-upload" onclick="document.getElementById('excelFile').click()" id="dropZone">
                            <i class="fas fa-file-excel"></i>
                            <p>Drag & drop file Excel di sini atau klik untuk memilih</p>
                            <span>Format: .xlsx, .xls</span>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" hidden onchange="handleExcelUpload(this)">
                        </div>
                        
                        <table class="data-table mt-20">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>NIK</th>
                                    <th>Jabatan</th>
                                    <th>Mitra</th>
                                    <th>Tanggal Import</th>
                                </tr>
                            </thead>
                            <tbody id="masterTable">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Laporan Content -->
                <div class="content-area" id="reportsContent">
                    <div class="table-container">
                        <h3 class="table-title">Laporan BA</h3>
                        
                        <div class="table-controls">
                            <input type="date" id="startDate">
                            <input type="date" id="endDate">
                            <select id="monthFilter">
                                <option value="">Pilih Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                            <input type="text" id="searchInet" placeholder="No Internet Pelanggan">
                            <button onclick="filterReports()"><i class="fas fa-filter"></i> Filter</button>
                            <button onclick="exportReports()"><i class="fas fa-file-export"></i> Export</button>
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>No BA</th>
                                    <th>Tanggal</th>
                                    <th>Pelanggan</th>
                                    <th>No Internet</th>
                                    <th>Teknisi</th>
                                    <th>Layanan</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === MODAL TAMBAH USER === -->
    <!-- === MODAL TAMBAH USER === -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <h3 style="color: #333; margin-bottom: 20px;">
            <i class="fas fa-user-plus"></i> Tambah User Baru
        </h3>
        
        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="newUserName" placeholder="Masukkan nama lengkap" class="form-control">
        </div>
        
        <div class="form-group">
            <label>NIK</label>
            <input type="text" id="newUserNIK" placeholder="Masukkan NIK" class="form-control" maxlength="20">
        </div>
        
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="newUserEmail" placeholder="Masukkan email" class="form-control">
        </div>
        
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="newUserPassword" placeholder="Minimal 6 karakter" class="form-control">
        </div>
        
        <div class="form-group">
            <label>Jabatan</label>
            <select id="newUserJabatan" class="form-control">
                <option value="Teknisi">Teknisi</option>
                <option value="Admin">Admin</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Mitra</label>
            <input type="text" id="newUserMitra" placeholder="Nama mitra" class="form-control">
        </div>
        
        <div id="newUserError" style="color: #ff4757; margin: 10px 0; display: none;"></div>
        
        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button onclick="closeAddUserModal()" style="flex: 1; padding: 12px; background: #ddd; border: none; border-radius: 8px; cursor: pointer;">
                Batal
            </button>
            <button onclick="submitNewUser()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-save"></i> Simpan
            </button>
        </div>
    </div>
</div>

    <!-- === BA FORM === -->
    <div id="baFormPage" style="display: none;">
        <div class="page-size-controls">
            <strong>Ukuran Kertas:</strong><br>
            <button class="page-size-btn active" onclick="changePageSize('A4')">A4</button>
            <button class="page-size-btn" onclick="changePageSize('A5')">A5</button>
            <button class="page-size-btn" onclick="changePageSize('Letter')">Letter</button>
            <button class="page-size-btn" onclick="changePageSize('A4 landscape')">Landscape</button>
        </div>

        <div id="page-container" class="container-a4">

            <table style="width: 100%; border: none; margin-bottom: 15px;">
    <tr>
        <td style="width: 20%; text-align: left; border: none; vertical-align: middle;">
            <div style="border: 1px dashed #000; width: 90px; height: 50px; position: relative; overflow: hidden; cursor: pointer;" 
                 onclick="document.getElementById('uploadKiri').click()"
                 onmouseover="this.style.borderColor='#e74c3c'; this.style.boxShadow='0 0 10px rgba(231, 76, 60, 0.3)'"
                 onmouseout="this.style.borderColor='#000'; this.style.boxShadow='none'">
                <img id="logoKiri" src="" style="width: 100%; height: 100%; object-fit: contain; display: none; cursor: pointer;">
                <div id="placeholderKiri" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <button type="button" 
                            style="background: rgba(231, 76, 60, 0.9); color: white; border: none; 
                                   padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;"
                            onmouseover="this.style.background='#c0392b'"
                            onmouseout="this.style.background='rgba(231, 76, 60, 0.9)'">
                        <i class="fas fa-upload"></i> Logo
                    </button>
                    <div style="font-size: 8px; color: #666; margin-top: 2px;">Klik untuk upload</div>
                </div>
                <input type="file" id="uploadKiri" accept="image/*" onchange="uploadImage('kiri', this)" style="display: none;">
            </div>
        </td>
        
        <td style="width: 80%; text-align: center; border: none; vertical-align: middle;">
            <h1 style="font-size: 12pt; margin: 0; font-weight: bold;">LAPORAN PENYELESAIAN PEKERJAAN</h1>
        </td>
        
        <td style="width: 40%; text-align: right; border: none; vertical-align: middle;">
            <div style="border: 1px dashed #000; width: 90px; height: 50px; position: relative; overflow: hidden; cursor: pointer;" 
                 onclick="document.getElementById('uploadKanan').click()"
                 onmouseover="this.style.borderColor='#e74c3c'; this.style.boxShadow='0 0 10px rgba(231, 76, 60, 0.3)'"
                 onmouseout="this.style.borderColor='#000'; this.style.boxShadow='none'">
                <img id="logoKanan" src="" style="width: 100%; height: 100%; object-fit: contain; display: none; cursor: pointer;">
                <div id="placeholderKanan" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <button type="button" 
                            style="background: rgba(231, 76, 60, 0.9); color: white; border: none; 
                                   padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;"
                            onmouseover="this.style.background='#c0392b'"
                            onmouseout="this.style.background='rgba(231, 76, 60, 0.9)'">
                        <i class="fas fa-upload"></i> Logo
                    </button>
                    <div style="font-size: 8px; color: #666; margin-top: 2px;">Klik untuk upload</div>
                </div>
                <input type="file" id="uploadKanan" accept="image/*" onchange="uploadImage('kanan', this)" style="display: none;">
            </div>
        </td>
    </tr>
</table>

            <table style="width: 100%; margin-bottom: 10px; border: none;">
                <tr>
                    <td style="border: none;">
                        <strong>Nama Mitra :</strong> <input type="text" name="nama_mitra" style="width: 100px;">
                    </td>
                    <td style="border: none; text-align: right;">
                        <strong>No BA :</strong> <span id="noBADisplay" style="font-weight: bold; margin-left: 5px;">BA-001</span>
                    </td>
                </tr>
                <tr>
                    <td style="border: none;">
                        <strong>Nama Teknisi :</strong> <span id="namaTeknisiDisplay" style="font-weight: bold; margin-left: 5px;"></span>
                    </td>
                    <td style="border: none; text-align: right;"></td>
                </tr>
            </table>

            <table class="main-table">
                <tr>
                    <td style="width: 55%; vertical-align: top;">
                        <table style="width: 100%; border: none;">
                            <tr><td style="width: 10%; border: none; white-space: nowrap;">1. STO</td><td style="width: 1%; border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="width: 100%; border: none;"><input type="text" name="sto"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">2. No Permintaan/WO</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_permintaan"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">3. No Telepon</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_telepon"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">4. No Inet</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_inet"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">5. Tanggal WO</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="tanggal_wo"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">6. Tanggal Transaksi</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="tanggal_transaksi"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">7. Nama Pelanggan</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="nama_pelanggan"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">8. No Kontak</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="no_kontak"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">9. Alamat Pelanggan</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="alamat_pelanggan"></td></tr>
                        </table>

                        <table style="margin-top: 10px; width: 100%; border: none;">
                            <tr style="border: none;"><td colspan="3" style="border: none;"><strong>DATEK</strong></td></tr>
                            <tr style="border: none;"><td style="width: 1%; border: none; white-space: nowrap;">1. RK/MSAN/ODC</td><td style="width: 3%; border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="width: 100%; border: none;"><input type="text" name="rk_msan_odc"></td></tr>
                            <tr style="border: none;"><td style="border: none; white-space: nowrap;">2. DP/ODP</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="dp_odp"></td></tr>
                            <tr style="border: none;"><td style="border: none; white-space: nowrap;">3. Klem Primer/Feeder</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="klem_primer_feeder"></td></tr>
                            <tr style="border: none;"><td style="border: none; white-space: nowrap;">4. Kec sec/Distribusi</td><td style="border: none; padding-left: 35px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="kec_sec_distribusi"></td></tr>
                        </table>

                        <table style="margin-top: 10px; width: 100%; border: none;">
                            <tr style="border: none;"><td colspan="3" style="border: none;"><strong>Material</strong></td></tr>
                            <tr style="border: none;">
                                <td style="width: 2%; border: none; white-space: nowrap;">1.</td>
                                <td style="width: 1%; border: none;"></td>
                                <td style="width: 100%; border: none;">
                                    <input type="text" name="material1_kiri" style="width: 45%;"> : <input type="text" name="material1_kanan" style="width: 45%;">
                                </td>
                            </tr>
                            <tr style="border: none;">
                                <td style="border: none; white-space: nowrap;">2.</td>
                                <td style="border: none;"></td>
                                <td style="border: none;">
                                    <input type="text" name="material2_kiri" style="width: 45%;"> : <input type="text" name="material2_kanan" style="width: 45%;">
                                </td>
                            </tr>
                            <tr style="border: none;">
                                <td style="border: none; white-space: nowrap;">3.</td>
                                <td style="border: none;"></td>
                                <td style="border: none;">
                                    <input type="text" name="material3_kiri" style="width: 45%;"> : <input type="text" name="material3_kanan" style="width: 45%;">
                                </td>
                            </tr>
                            <tr style="border: none;">
                                <td style="border: none; white-space: nowrap;">4.</td>
                                <td style="border: none;"></td>
                                <td style="border: none;">
                                    <input type="text" name="material4_kiri" style="width: 45%;"> : <input type="text" name="material4_kanan" style="width: 45%;">
                                </td>
                            </tr>
                            <tr style="border: none;">
                                <td style="border: none; white-space: nowrap;">5.</td>
                                <td style="border: none;"></td>
                                <td style="border: none;">
                                    <input type="text" name="material5_kiri" style="width: 45%;"> : <input type="text" name="material5_kanan" style="width: 45%;">
                                </td>
                            </tr>
                        </table>    
                    </td>
                    <td style="width: 50%; vertical-align: top;">
                        <table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td colspan="5" style="text-align: center; font-weight: bold; font-size: 10pt;">TEST USAGE</td>
                            </tr>
                            <tr>
                                <td rowspan="2" style="text-align: center; font-weight: bold; width: 25%;">Tes Layanan</td>
                                <td rowspan="2" style="text-align: center; font-weight: bold; width: 25%;">Contoh</td>
                                <td colspan="2" style="text-align: center; font-weight: bold; width: 50%;">Kualitas</td>
                            </tr>
                            <tr>
                                <td style="text-align: center;">Baik</td>
                                <td style="text-align: center;">Tidak</td>
                            </tr>
                            <tr>
                                <td style="text-align: center;">Test Voice</td>
                                <td style="text-align: center;"></td>
                                <td style="text-align: center;"><input type="checkbox" name="voice_baik"></td>
                                <td style="text-align: center;"><input type="checkbox" name="voice_tidak"></td>
                            </tr>
                            <tr>
                                <td style="text-align: center;">Test Internet</td>
                                <td style="text-align: center;"></td>
                                <td style="text-align: center;"><input type="checkbox" name="inet_baik"></td>
                                <td style="text-align: center;"><input type="checkbox" name="inet_tidak"></td>
                            </tr>
                            <tr>
                                <td style="text-align: center;">Test UseeTv</td>
                                <td style="text-align: center;"></td>
                                <td style="text-align: center;"><input type="checkbox" name="usetv_baik"></td>
                                <td style="text-align: center;"><input type="checkbox" name="usetv_tidak"></td>
                            </tr>
                        </table>

                        <div style="border: 2px solid #000; padding: 10px; margin-top: 10px;">
                            <strong>Tes Internet :</strong><br>
                            1. Tes Ping&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_ping" style="width: 80px;"> ms<br>
                            2. Tes Upload&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_upload" style="width: 80px;"> Mbps<br>
                            3. Tes Download &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="tes_download" style="width: 80px;"> Mbps<br>
                            4. Hasil Ukur Redaman&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <input type="text" name="hasil_ukur_redaman" style="width: 90px;">
                        </div>

                        <div style="border: 2px solid #000; padding: 100px; margin-top: 10px;"></div>
                    </td>
                </tr>
            </table>

            <table class="main-table" style="margin-top: 10px;">
                <tr>
                    <td style="width: 55%; vertical-align: top;">
                        <table style="width: 100%; border: none;">
                            <tr><td style="width: 40%; border: none; white-space: nowrap;">ONT yang DITARIK / ONT BEKAS</td><td style="width: 5%; border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="width: 55%; border: none;"><input type="text" name="ONT_yang_DIPASANG_/_DITARIK"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">lampu Indikator ONT Nyala</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="checkbox" name="power"> Power <input type="checkbox" name="dsl"> DSL <input type="checkbox" name="internet"> Internet</td></tr>
                            <tr><td style="border: none; white-space: nowrap;">Nama / Notel Teknisi</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="nama_teknisi"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">STB ID</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="stb_id"></td></tr>
                        </table>
                    </td>
                    <td style="width: 50%; vertical-align: top;">
                        <table style="width: 100%; border: none;">
                            <tr><td style="width: 30%; border: none; white-space: nowrap;">SN ONT BARU</td><td style="width: 5%; border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="width: 65%; border: none;"><input type="text" name="sn_ont"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">SN PLC</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="sn_plc"></td></tr>
                            <tr><td style="border: none; white-space: nowrap;">SN WIFI EXT</td><td style="border: none; padding-left: 10px; white-space: nowrap;">:</td><td style="border: none;"><input type="text" name="sn_wifi_ext"></td></tr>
                        </table>
                    </td>
                </tr>
            </table>

            <table class="main-table" style="margin-top: 10px;">
                <tr>
                    <td style="width: 50%; vertical-align: top;">
                        <strong>PSB</strong><br>
                        <input type="checkbox" name="psb_1p_voice"> 1P [Voice]/1P [Internet] &nbsp;
                        <input type="checkbox" name="psb_3p"> 3P<br>
                        <input type="checkbox" name="psb_2p"> 2P [Voice + Internet] / 2P [Internet + UseeTv]
                    </td>
                    <td style="width: 50%; vertical-align: top;">
                        <strong>Tambahan</strong><br>
                        <input type="checkbox" name="ganti_stb"> Ganti STB / ONT &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <input type="checkbox" name="plc"> PLC &nbsp;
                        <input type="checkbox" name="indibox"> IndiBox<br>
                        <input type="checkbox" name="stb_belum_terpasang"> STB Belum Terpasang &nbsp;
                        <input type="checkbox" name="wifi_extender"> Wifi Extender
                    </td>
                </tr>
            </table>

            <table class="main-table" style="margin-top: 10px;">
                <tr>
                    <td>
                        <strong>Migrasi</strong><br>
                        <strong>Infrastruktur:</strong><br>
                        <input type="checkbox" name="infra_1p1p_voice"> 1P-1P [Voice]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <input type="checkbox" name="infra_1p2p_voice"> 1P-2P [Voice+Internet]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <input type="checkbox" name="infra_2p2p_voice"> 2P-2P [Internet+Voice]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <input type="checkbox" name="infra_1p3p"> 1P-3P&nbsp;
                        <input type="checkbox" name="infra_3p3p"> 3P-3P<br>
                        <input type="checkbox" name="infra_1p1p_internet"> 1P-1P [Internet] &nbsp;
                        <input type="checkbox" name="infra_1p2p_usetv"> 1P-2P [Internet+UseeTv] &nbsp;
                        <input type="checkbox" name="infra_2p2p_usetv"> 2P-2P [Internet+UseeTv] &nbsp;
                        <input type="checkbox" name="infra_2p3p"> 2P-3P<br>
                        
                        <strong>Layanan:</strong><br>
                        <input type="checkbox" name="layanan_1p2p_voice"> 1P-2P [Internet+Voice] &nbsp;
                        <input type="checkbox" name="layanan_1p2p_usetv"> 1P-2P [Internet+UseeTv] &nbsp;
                        <input type="checkbox" name="layanan_1p3p"> 1P-3P &nbsp;
                        <input type="checkbox" name="layanan_2p3p"> 2P-3P
                    </td>
                </tr>
            </table>

            <table style="width: 100%; margin: 10px 0; border: none;">
                <tr>
                    <td style="border: none;">
                        <strong>Speed :</strong> 10MB 20MB 30MB 40MB 50MB 100MB 200MB 300MB 1 GB other
                    </td>
                </tr>
            </table>

            <table class="main-table">
                <tr>
                    <td style="font-size: 10pt;">
                        1. Perangkat (ONT/Modem/STB) yang dipasang di rumah pelanggan adalah MILIK TELKOM yang dipinjamkan selama menjadi pelanggan TELKOM. Modem yang tidak dipakai karena Migrasi ke Fiber akan ditarik Kembali.<br>
                        2. Telkom dapat mengambil Perangkat bila tidak ada penggunaan selama 3 bulan berturut-turut.<br>
                        3. Untuk progress pemilihan dan monitoring diharapkan power perangkat selalu dalam kondisi hidup (ON)<br>
                        4. Disarankan untuk segera merubah password yang ada untuk menjaga agar tidak dipergunakan oleh pihak-pihak yang tidak dikehendaki<br>
                        5. Pelanggan sudah mendapatkan penjelasan dari sales/seller atau menerima buku petunjuk menggunakan modem internet yang telah dipasang.
                    </td>
                </tr>
            </table>

            <div style="text-align: right; margin-top: 10px; margin-right: 25%;">
                Lumajang, <input type="date" name="tanggal_lumajang" style="border: none; border-bottom: 1px solid #000; text-align: center; width: 120px;">
            </div>

            <table class="main-table" style="margin-top: 10px;">
                <tr>
                    <td style="width: 50%; text-align: center;">
                        <div>Pelanggan</div>
                        <div id="namaPelangganTTD" style="margin-bottom: 5px; font-weight: bold;"></div>
                        <div class="signature-box">
                            <canvas id="signature-pelanggan" width="200" height="70"></canvas>
                            <button type="button" onclick="clearSignature('pelanggan')" style="position: absolute; bottom: 5px; right: 5px; font-size: 8px;">Hapus</button>
                        </div>
                        <button type="button" onclick="saveSignature('pelanggan')" style="margin-top: 5px; font-size: 8px; padding: 3px 8px;">Save TTD</button>
                    </td>
                    <td style="width: 50%; text-align: center;">
                        <div>Petugas Lapangan</div>
                        <div id="namaTeknisiTTD" style="margin-bottom: 5px; font-weight: bold;"></div>
                        <div class="signature-box">
                            <canvas id="signature-petugas" width="200" height="70"></canvas>
                            <button type="button" onclick="clearSignature('petugas')" style="position: absolute; bottom: 5px; right: 5px; font-size: 8px;">Hapus</button>
                        </div>
                        <button type="button" onclick="saveSignature('petugas')" style="margin-top: 5px; font-size: 8px; padding: 3px 8px;">Save TTD</button>
                    </td>
                </tr>
            </table>

            <div style="text-align: center; margin-top: 20px;">
                <button type="button" onclick="saveBA()" style="padding: 10px 30px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt;">
                    <i class="fas fa-save"></i> Simpan BA ke Database
                </button>
                <button type="button" onclick="document.getElementById('baFormPage').style.display='none';document.getElementById('dashboardPage').style.display='block';" 
                    style="padding: 10px 30px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12pt; margin-left: 10px;">
                    <i class="fas fa-times"></i> Batal
                </button>
            </div>
        </div>
    </div>

    <script>
        // === FIREBASE CONFIGURATION ===
        const firebaseConfig = {
            apiKey: "AIzaSyDtoOYW8SCReBXngT4kc_WtEdOo0LoGvdE",
            authDomain: "ba-lmj.firebaseapp.com",
            projectId: "ba-lmj",
            storageBucket: "ba-lmj.appspot.com",
            messagingSenderId: "757213966308",
            appId: "1:757213966308:web:07d158f711b8c8037e21f1",
            measurementId: "G-Q3J1T124PN"
        };

        // === GLOBAL VARIABLES ===
        let firebaseApp;
        let firestore;
        let auth;
        let currentUser = null;

        // === INITIALIZE FIREBASE ===
        async function initializeFirebase() {
            try {
                // Cek apakah Firebase SDK sudah di-load
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK tidak terload!');
                    alert('Firebase SDK tidak terload. Muat ulang halaman.');
                    return false;
                }
                
                // Initialize Firebase
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firestore = firebase.firestore();
                auth = firebase.auth();
                
                console.log(' Firebase initialized successfully');
                
                // Setup auth state listener
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log(' User logged in:', user.email);
                        await handleLoggedInUser(user);
                    } else {
                        console.log(' User logged out');
                        currentUser = null;
                    }
                });
                
                return true;
                
            } catch (error) {
                console.error(' Firebase initialization error:', error);
                alert('Firebase gagal diinisialisasi. Periksa koneksi internet.');
                return false;
            }
        }

        async function handleLoggedInUser(user) {
            try {
                // Ambil data user dari Firestore
                const userDoc = await firestore.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    // USER TIDAK TERDAFTAR - LOGOUT DAN BLOCK
                    console.log(' User tidak terdaftar, auto logout:', user.email);
                    await auth.signOut();
                    alert('Akun Anda tidak terdaftar dalam sistem');
                    return;
                }
                
                const userData = userDoc.data();
                
                // SET CURRENT USER
                currentUser = {
                    id: user.uid,
                    name: userData.name || user.email.split('@')[0],
                    email: user.email,
                    jabatan: userData.jabatan || 'Teknisi',
                    role: userData.role || 'teknisi',
                    avatar: user.email.charAt(0).toUpperCase(),
                    mitra: userData.mitra || ''  // TAMBAH INI
                };
                
                // AUTO MASUK KE DASHBOARD
                if (document.getElementById('loginPage').style.display !== 'none') {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboardPage').style.display = 'block';
                    
                    // UPDATE UI
                    document.getElementById('userName').textContent = currentUser.name;
                    document.getElementById('userRole').textContent = currentUser.jabatan;
                    document.getElementById('userAvatar').textContent = currentUser.avatar;
                    
                    // UPDATE FORM BA - AUTO FILL MITRA
                    if (currentUser.role === 'teknisi') {
                        document.getElementById('namaTeknisiDisplay').textContent = currentUser.name;
                        document.getElementById('namaTeknisiTTD').textContent = currentUser.name;
                        
                        // AUTO-FILL MITRA JIKA ADA
                        if (currentUser.mitra) {
                            document.querySelector('input[name="nama_mitra"]').value = currentUser.mitra;
                        }
                    }
                    
                    // LOAD DATA
                    loadDashboardData();
                    loadTechnicians();
                    loadBASaya();
                    loadReports();
                }
            } catch (error) {
                console.error('Error handling logged in user:', error);
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                // Login ke Firebase
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Cek user di Firestore
                const userDoc = await firestore.collection('users').doc(user.uid).get();
                
                // Jika user belum ada di Firestore, BUAT OTOMATIS
                if (!userDoc.exists) {
                    const isAdmin = email.includes('admin');
                    
                    await firestore.collection('users').doc(user.uid).set({
                        name: email.split('@')[0],
                        email: email,
                        jabatan: isAdmin ? 'Admin' : 'Teknisi',
                        role: isAdmin ? 'admin' : 'teknisi',
                        mitra: '',
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Lanjut ke dashboard
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'block';
                
                // Set UI
                document.getElementById('userName').textContent = email.split('@')[0];
                document.getElementById('userRole').textContent = email.includes('admin') ? 'Admin' : 'Teknisi';
                document.getElementById('userAvatar').textContent = email.charAt(0).toUpperCase();
                
                // Load data
                loadDashboardData();
                loadTechnicians();
                loadBASaya();
                loadReports();
                
            } catch (error) {
                alert('SOPO KON, HAH !!!!');
                console.error(error);
            }
        }

        // === FUNGSI LOGOUT ===
        async function logout() {
            try {
                // LOGOUT DARI FIREBASE
                if (auth) {
                    await auth.signOut();
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // RESET SEMUA
            currentUser = null;
            document.getElementById('dashboardPage').style.display = 'none';
            document.getElementById('baFormPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            
            // Reset form login
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        function showContent(contentId) {
            // Hide all content areas
            document.querySelectorAll('.content-area').forEach(el => {
                el.classList.remove('active');
            });

            // AUTO CLOSE SIDEBAR DI MOBILE
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('open');
            }
            
            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected content
            document.getElementById(contentId + 'Content').classList.add('active');
            
            // Add active class to clicked sidebar item
            event.currentTarget.classList.add('active');
            
            if (contentId === 'createBA') {
                // Tunggu sebentar biar DOM siap
                setTimeout(() => {
                    loadBASaya();
                }, 100);
            }

            // Update header berdasarkan menu
            const header = document.querySelector('.header-left');
            if (contentId === 'technician') {
                header.innerHTML = '<h1>Manajemen Teknisi</h1><p>Kelola data teknisi</p>';
            } else if (contentId === 'createBA') {
                header.innerHTML = '<h1>Buat Berita Acara</h1><p>Form pengisian BA</p>';
            } else if (contentId === 'masterTech') {
                header.innerHTML = '<h1>Data Master</h1><p>Import dan kelola data master</p>';
            } else if (contentId === 'reports') {
                header.innerHTML = '<h1>Laporan</h1><p>Analisis data BA</p>';
            } else if (contentId === 'dashboard') {
                header.innerHTML = '<h1>Dashboard</h1><p>Sistem Manajemen Berita Acara</p>';
            }
        }

        // === DASHBOARD FUNCTIONS ===
        function loadDashboardData() {
            // Sample recent activity data
            const activities = [
                { no: 'BA-001', customer: 'Budi Santoso', technician: 'Ahmad Rizki', date: '2024-01-15', status: 'Selesai' },
                { no: 'BA-002', customer: 'Siti Aisyah', technician: 'Muhammad Ali', date: '2024-01-14', status: 'Pending' },
                { no: 'BA-003', customer: 'Joko Widodo', technician: 'Ahmad Rizki', date: '2024-01-13', status: 'Selesai' },
                { no: 'BA-004', customer: 'Ani Wijaya', technician: 'Budi Hartono', date: '2024-01-12', status: 'Selesai' },
                { no: 'BA-005', customer: 'Rina Melati', technician: 'Muhammad Ali', date: '2024-01-11', status: 'Pending' }
            ];
            
            const tbody = document.getElementById('recentActivity');
            if (tbody) {
                tbody.innerHTML = '';
                
                activities.forEach(activity => {
                    const statusClass = activity.status === 'Selesai' ? 'status-active' : 'status-inactive';
                    tbody.innerHTML += `
                        <tr>
                            <td>${activity.no}</td>
                            <td>${activity.customer}</td>
                            <td>${activity.technician}</td>
                            <td>${activity.date}</td>
                            <td class="${statusClass}">${activity.status}</td>
                        </tr>
                    `;
                });
            }
        }

        // === TECHNICIAN MANAGEMENT ===
        // === TECHNICIAN MANAGEMENT ===
async function loadTechnicians() {
    try {
        if (!firestore) return;
        
        // AMBIL SEMUA USER DARI FIRESTORE
        const techniciansSnapshot = await firestore.collection('users').get();
        
        const tbody = document.getElementById('technicianTable');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (techniciansSnapshot.empty) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #666; padding: 20px;">
                        <i class="fas fa-users-slash"></i> Belum ada data teknisi
                    </td>
                </tr>
            `;
            return;
        }
        
        let index = 0;
        techniciansSnapshot.forEach(doc => {
            const tech = doc.data();
            index++;
            
            // FILTER HANYA USER YANG ROLE NYA TEKNISI/ADMIN
            if (tech.role !== 'teknisi' && tech.role !== 'admin' && 
                tech.jabatan !== 'Teknisi' && tech.jabatan !== 'Admin') {
                return; // Skip user yang bukan teknisi/admin
            }
            
            const statusClass = tech.status === 'active' ? 'status-active' : 'status-inactive';
            const statusText = tech.status === 'active' ? 'Aktif' : 'Nonaktif';
            
            // NIK column
            let nikColumn = `<span>${tech.nik || doc.id.substring(0, 8)}</span>`;
            
            // Jabatan column - HANYA admin yang bisa edit
            let jabatanColumn;
            if (currentUser && currentUser.role === 'admin') {
                jabatanColumn = `
                    <select class="jabatan-select" data-id="${doc.id}" onchange="updateJabatan('${doc.id}', this.value)">
                        <option value="Teknisi" ${tech.jabatan === 'Teknisi' ? 'selected' : ''}>Teknisi</option>
                        <option value="Admin" ${tech.jabatan === 'Admin' ? 'selected' : ''}>Admin</option>
                    </select>
                `;
            } else {
                jabatanColumn = `<span>${tech.jabatan || 'Teknisi'}</span>`;
            }
            
            // Mitra column - HANYA admin yang bisa edit
            let mitraColumn;
            if (currentUser && currentUser.role === 'admin') {
                mitraColumn = `
                    <input type="text" class="mitra-input" data-id="${doc.id}" value="${tech.mitra || ''}" 
                           style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"
                           onchange="updateMitra('${doc.id}', this.value)">
                `;
            } else {
                mitraColumn = `<span>${tech.mitra || ''}</span>`;
            }
            
            // Action buttons
            let actionButtons = `
                <button class="btn-action btn-toggle" onclick="toggleTechnician('${doc.id}')" 
                        ${currentUser && currentUser.role === 'admin' ? '' : 'disabled'}
                        title="${currentUser && currentUser.role === 'admin' ? 'Ubah Status' : 'Hanya Admin'}">
                    ${tech.status === 'active' ? 'Nonaktifkan' : 'Aktifkan'}
                </button>
            `;
            
            if (currentUser && currentUser.role === 'admin') {
                actionButtons += `
                    <button class="btn-action btn-delete" onclick="deleteTechnician('${doc.id}')" title="Hapus">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            }
            
            tbody.innerHTML += `
                <tr>
                    <td>${tech.name || 'Tidak ada nama'}</td>
                    <td>${tech.email || 'Tidak ada email'}</td>
                    <td>${nikColumn}</td>
                    <td>${jabatanColumn}</td>
                    <td>${mitraColumn}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${actionButtons}</td>
                </tr>
            `;
        });
        
    } catch (error) {
        console.error('Error loading technicians:', error);
        const tbody = document.getElementById('technicianTable');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #ff4757; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i> Error loading data
                    </td>
                </tr>
            `;
        }
    }
}

        // === FUNGSI TOGGLE SIDEBAR ===
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
        }

        // === FUNGSI UPDATE JABATAN ===
        async function updateJabatan(userId, newJabatan) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Hanya Admin yang dapat mengubah jabatan');
                loadTechnicians(); // Refresh untuk reset pilihan
                return;
            }
            
            if (confirm(`Ubah jabatan menjadi ${newJabatan}?`)) {
                try {
                    await firestore.collection('users').doc(userId).update({
                        jabatan: newJabatan,
                        role: newJabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi'
                    });
                    
                    alert('Jabatan berhasil diubah');
                    loadTechnicians();
                    
                } catch (error) {
                    console.error('Error updating jabatan:', error);
                    alert('Gagal mengubah jabatan');
                }
            }
        }

        async function updateMitra(userId, newMitra) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Hanya Admin yang dapat mengubah data mitra');
                return;
            }
            
            try {
                // UPDATE DI FIRESTORE
                await firestore.collection('users').doc(userId).update({
                    mitra: newMitra
                });
                
                // JIKA USER YANG SEDANG LOGIN, UPDATE CURRENT USER
                if (userId === currentUser.id) {
                    currentUser.mitra = newMitra;
                    
                    // UPDATE DI FORM BA JIKA SEDANG TERBUKA
                    if (document.getElementById('baFormPage').style.display === 'block') {
                        document.querySelector('input[name="nama_mitra"]').value = newMitra;
                    }
                }
                
                console.log('Mitra berhasil diubah');
                
            } catch (error) {
                console.error('Error updating mitra:', error);
                alert('Gagal mengubah mitra');
            }
        }

        // === FUNGSI TOGGLE STATUS TEKNISI ===
        async function toggleTechnician(userId) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Hanya Admin yang dapat mengubah status teknisi');
                return;
            }
            
            try {
                const userDoc = await firestore.collection('users').doc(userId).get();
                if (!userDoc.exists) return;
                
                const currentStatus = userDoc.data().status;
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                
                await firestore.collection('users').doc(userId).update({
                    status: newStatus
                });
                
                alert(`Status berhasil diubah menjadi ${newStatus === 'active' ? 'Aktif' : 'Nonaktif'}`);
                loadTechnicians();
                
            } catch (error) {
                console.error('Error toggling technician:', error);
                alert('Gagal mengubah status');
            }
        }

        // === FUNGSI DELETE TEKNISI ===
        async function deleteTechnician(userId) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Hanya Admin yang dapat menghapus teknisi');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
                try {
                    await firestore.collection('users').doc(userId).delete();
                    alert('User berhasil dihapus');
                    loadTechnicians();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Gagal menghapus user');
                }
            }
        }

        // === FUNGSI TAMBAH USER BARU ===
       function showAddUserModal() {
    if (!currentUser || currentUser.role !== 'admin') {
        alert('Hanya Admin yang dapat menambahkan user');
        return;
    }
    
    document.getElementById('addUserModal').style.display = 'block';
    document.getElementById('newUserError').style.display = 'none';
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserNIK').value = '';
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUserJabatan').value = 'Teknisi';
    document.getElementById('newUserMitra').value = '';
}
        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        async function submitNewUser() {
    if (!currentUser || currentUser.role !== 'admin') {
        alert('Hanya Admin yang dapat menambahkan user');
        return;
    }
    
    const name = document.getElementById('newUserName').value.trim();
    const nik = document.getElementById('newUserNIK').value.trim();
    const email = document.getElementById('newUserEmail').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const jabatan = document.getElementById('newUserJabatan').value;
    const mitra = document.getElementById('newUserMitra').value.trim();
    
    // Validasi
    if (!name || !nik || !email || !password || password.length < 6) {
        document.getElementById('newUserError').textContent = 'Harap isi semua field dengan benar (password minimal 6 karakter)';
        document.getElementById('newUserError').style.display = 'block';
        return;
    }
    
    // Validasi NIK (hanya angka)
    if (!/^\d+$/.test(nik)) {
        document.getElementById('newUserError').textContent = 'NIK hanya boleh berisi angka';
        document.getElementById('newUserError').style.display = 'block';
        return;
    }
    
    // Validasi panjang NIK (minimal 16 digit untuk KTP)
    if (nik.length < 6) {
        document.getElementById('newUserError').textContent = 'NIK minimal 6 digit';
        document.getElementById('newUserError').style.display = 'block';
        return;
    }
    
    try {
        // Buat user di Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Simpan data ke Firestore
        await firestore.collection('users').doc(user.uid).set({
            name: name,
            nik: nik,
            email: email,
            jabatan: jabatan,
            role: jabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi',
            mitra: mitra,
            status: 'active',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser.id
        });
        
        alert('Teknisi berhasil ditambahkan');
        closeAddUserModal();
        loadTechnicians();
        
    } catch (error) {
        console.error('Error adding user:', error);
        let errorMessage = 'Gagal menambahkan user: ';
        
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'Email sudah terdaftar';
                break;
            case 'auth/invalid-email':
                errorMessage = 'Format email tidak valid';
                break;
            case 'auth/weak-password':
                errorMessage = 'Password terlalu lemah';
                break;
            default:
                errorMessage += error.message;
        }
        
        document.getElementById('newUserError').textContent = errorMessage;
        document.getElementById('newUserError').style.display = 'block';
    }
}

        function searchTechnicians() {
            const searchTerm = document.getElementById('searchTech').value.toLowerCase();
            const rows = document.querySelectorAll('#technicianTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function exportTechnicians() {
            alert('Data teknisi berhasil diexport ke Excel');
        }

        function importTechData() {
            alert('Fitur Import Data - Buka file Excel untuk import data teknisi');
        }

        
        // === MASTER DATA FUNCTIONS ===
function loadMasterData() {
    try {
        // AMBIL DATA DARI LOCALSTORAGE ATAU FIRESTORE
        const masterData = localStorage.getItem('masterData');
        let data = [];
        
        if (masterData) {
            data = JSON.parse(masterData);
        } else {
            // JIKA TIDAK ADA DI LOCALSTORAGE, AMBIL DARI FIRESTORE
            if (firestore) {
                firestore.collection('users').get().then(snapshot => {
                    const tempData = [];
                    snapshot.forEach(doc => {
                        const tech = doc.data();
                        if (tech.role === 'teknisi' || tech.role === 'admin' || 
                            tech.jabatan === 'Teknisi' || tech.jabatan === 'Admin') {
                            tempData.push({
                                no: tempData.length + 1,
                                name: tech.name || 'Tidak ada nama',
                                email: tech.email || 'Tidak ada email',
                                nik: tech.nik || doc.id.substring(0, 8),
                                jabatan: tech.jabatan || 'Teknisi',
                                mitra: tech.mitra || '',
                                importDate: tech.createdAt ? new Date(tech.createdAt.toDate()).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
                            });
                        }
                    });
                    
                    // SIMPAN KE LOCALSTORAGE
                    localStorage.setItem('masterData', JSON.stringify(tempData));
                    renderMasterTable(tempData);
                }).catch(error => {
                    console.error('Error fetching master data:', error);
                    renderMasterTable(getSampleMasterData());
                });
                return;
            } else {
                data = getSampleMasterData();
            }
        }
        
        renderMasterTable(data);
        
    } catch (error) {
        console.error('Error loading master data:', error);
        renderMasterTable(getSampleMasterData());
    }
}

function renderMasterTable(data) {
    const tbody = document.getElementById('masterTable');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (data.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 20px;">
                    <i class="fas fa-database"></i> Belum ada data master
                </td>
            </tr>
        `;
        return;
    }
    
    data.forEach(item => {
        tbody.innerHTML += `
            <tr>
                <td>${item.no}</td>
                <td>${item.name}</td>
                <td>${item.email}</td>
                <td>${item.nik}</td>
                <td>${item.jabatan}</td>
                <td>${item.mitra}</td>
                <td>${item.importDate}</td>
            </tr>
        `;
    });
}

function getSampleMasterData() {
    return [
        { no: 1, name: 'Ahmad Rizki', email: 'ahmad@example.com', nik: 'TK001', jabatan: 'Teknisi', mitra: 'PT Mitra Abadi', importDate: '2024-01-10' },
        { no: 2, name: 'Muhammad Ali', email: 'ali@example.com', nik: 'TK002', jabatan: 'Teknisi', mitra: 'CV Teknik Sejahtera', importDate: '2024-01-10' },
        { no: 3, name: 'Budi Hartono', email: 'budi@example.com', nik: 'TK003', jabatan: 'Admin', mitra: 'PT Sistem Informasi', importDate: '2024-01-09' },
        { no: 4, name: 'Siti Aisyah', email: 'siti@example.com', nik: 'TK004', jabatan: 'Teknisi', mitra: 'PT Jaya Makmur', importDate: '2024-01-09' },
        { no: 5, name: 'Joko Susanto', email: 'joko@example.com', nik: 'TK005', jabatan: 'Teknisi', mitra: 'CV Mandiri Teknik', importDate: '2024-01-08' }
    ];
}
        
        function searchMasterData() {
            const searchTerm = document.getElementById('searchMaster').value.toLowerCase();
            const rows = document.querySelectorAll('#masterTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function importExcel() {
    if (!currentUser || currentUser.role !== 'admin') {
        alert('Hanya Admin yang dapat import data');
        return;
    }
    
    document.getElementById('excelFile').click();
}

function handleExcelUpload(input) {
    const file = input.files[0];
    if (file) {
        alert(`File ${file.name} berhasil diupload. Data sedang diproses...`);
        
        // SIMULASI IMPORT DATA
        setTimeout(() => {
            const sampleData = getSampleMasterData();
            
            // SIMPAN KE LOCALSTORAGE
            localStorage.setItem('masterData', JSON.stringify(sampleData));
            
            // JIKA FIREBASE TERSEDIA, SIMPAN JUGA KE FIRESTORE
            if (firestore) {
                sampleData.forEach(async (item, index) => {
                    try {
                        // Cek apakah user sudah ada berdasarkan email
                        const existingUser = await firestore.collection('users')
                            .where('email', '==', item.email)
                            .get();
                        
                        if (existingUser.empty) {
                            // Buat user baru di Firebase Auth
                            const tempPassword = 'Password123'; // Password default
                            const userCredential = await auth.createUserWithEmailAndPassword(item.email, tempPassword);
                            const user = userCredential.user;
                            
                            // Simpan data ke Firestore
                            await firestore.collection('users').doc(user.uid).set({
                                name: item.name,
                                email: item.email,
                                nik: item.nik,
                                jabatan: item.jabatan,
                                role: item.jabatan.toLowerCase() === 'admin' ? 'admin' : 'teknisi',
                                mitra: item.mitra,
                                status: 'active',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                importedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                importedBy: currentUser.id
                            });
                        }
                    } catch (error) {
                        console.error('Error importing user:', item.email, error);
                    }
                });
            }
            
            alert('Data berhasil diimport dari Excel');
            loadMasterData();
            loadTechnicians();
        }, 1500);
    }
}
        
        function refreshMaster() {
    // HAPUS CACHE LOCALSTORAGE
    localStorage.removeItem('masterData');
    
    // AMBIL DATA BARU DARI FIRESTORE
    if (firestore) {
        firestore.collection('users').get().then(snapshot => {
            const data = [];
            snapshot.forEach(doc => {
                const tech = doc.data();
                if (tech.role === 'teknisi' || tech.role === 'admin' || 
                    tech.jabatan === 'Teknisi' || tech.jabatan === 'Admin') {
                    data.push({
                        no: data.length + 1,
                        name: tech.name || 'Tidak ada nama',
                        email: tech.email || 'Tidak ada email',
                        nik: tech.nik || doc.id.substring(0, 8),
                        jabatan: tech.jabatan || 'Teknisi',
                        mitra: tech.mitra || '',
                        importDate: tech.createdAt ? new Date(tech.createdAt.toDate()).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
                    });
                }
            });
            
            // SIMPAN KE LOCALSTORAGE
            localStorage.setItem('masterData', JSON.stringify(data));
            renderMasterTable(data);
            
            alert('Data master diperbarui');
        }).catch(error => {
            console.error('Error refreshing master data:', error);
            alert('Gagal memperbarui data master');
        });
    } else {
        renderMasterTable(getSampleMasterData());
        alert('Data master diperbarui');
    }
}

// === SYNC DATA DARI FIREBASE ===
async function syncDataFromFirebase() {
    if (!firestore) {
        alert('Firebase tidak tersedia');
        return;
    }
    
    try {
        const snapshot = await firestore.collection('users').get();
        const data = [];
        
        snapshot.forEach(doc => {
            const tech = doc.data();
            if (tech.role === 'teknisi' || tech.role === 'admin' || 
                tech.jabatan === 'Teknisi' || tech.jabatan === 'Admin') {
                data.push({
                    no: data.length + 1,
                    name: tech.name || 'Tidak ada nama',
                    email: tech.email || 'Tidak ada email',
                    nik: tech.nik || doc.id.substring(0, 8),
                    jabatan: tech.jabatan || 'Teknisi',
                    mitra: tech.mitra || '',
                    importDate: tech.createdAt ? new Date(tech.createdAt.toDate()).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
                });
            }
        });
        
        // SIMPAN KE LOCALSTORAGE
        localStorage.setItem('masterData', JSON.stringify(data));
        
        // RENDER KEDUA TABEL
        renderMasterTable(data);
        loadTechnicians();
        
        alert('Data berhasil disinkronisasi dari Firebase');
        
    } catch (error) {
        console.error('Error syncing data:', error);
        alert('Gagal sinkronisasi data: ' + error.message);
    }
}
        
        function filterReports() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const month = document.getElementById('monthFilter').value;
            const inetSearch = document.getElementById('searchInet').value.toLowerCase();
            
            alert(`Filter diterapkan:\nTanggal: ${startDate} - ${endDate}\nBulan: ${month}\nNo Internet: ${inetSearch}`);
            
            // Simulate filtered results
            loadReports();
        }
        
        function exportReports() {
            alert('Laporan berhasil diexport ke Excel');
        }

        function openBAForm() {
            document.getElementById('dashboardPage').style.display = 'none';
            document.getElementById('baFormPage').style.display = 'block';
            
            // Tampilkan next number bulan ini
            const { counter } = getBACounter();
            const now = new Date();
            const tahun = now.getFullYear();
            const bulan = String(now.getMonth() + 1).padStart(2, '0');
            const nextNumber = counter + 1;
            const nomorUrut = String(nextNumber).padStart(3, '0');
            const noBA = `BA/${tahun}/${bulan}/${nomorUrut}`;
            
            document.getElementById('noBADisplay').textContent = noBA;
            
            // Set nama teknisi
            if (currentUser) {
                document.getElementById('namaTeknisiDisplay').textContent = currentUser.name;
                document.getElementById('namaTeknisiTTD').textContent = currentUser.name;
                
                // AUTO-FILL MITRA DARI DATA USER
                if (currentUser.mitra) {
                    document.querySelector('input[name="nama_mitra"]').value = currentUser.mitra;
                } else {
                    // JIKA MITRA KOSONG, AMBIL DARI DATABASE
                    loadUserMitraFromFirebase();
                }
            }
            
            // Set tanggal hari ini
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="tanggal_lumajang"]').value = today;
            
            // Initialize signature canvas
            setupSignatureCanvas();
        }

        async function saveBA() {
            if (!currentUser) {
                alert('Anda harus login terlebih dahulu');
                return;
            }
            
            // Validasi
            const noInet = document.querySelector('input[name="no_inet"]').value;
            const namaPelanggan = document.querySelector('input[name="nama_pelanggan"]').value;
            const tanggalLumajang = document.querySelector('input[name="tanggal_lumajang"]').value;
            
            if (!noInet || !namaPelanggan || !tanggalLumajang) {
                alert('Harap isi No Internet, Nama Pelanggan, dan Tanggal!');
                return;
            }
            
            try {
                // 1. TAMBAH COUNTER BULAN INI
                const newCounter = incrementBACounter();
                
                // 2. BUAT NO BA DENGAN FORMAT: BA/TAHUN/BULAN/NOMOR
                const now = new Date();
                const tahun = now.getFullYear();
                const bulan = String(now.getMonth() + 1).padStart(2, '0');
                const nomorUrut = String(newCounter).padStart(3, '0');
                const noBA = `BA/${tahun}/${bulan}/${nomorUrut}`;
                
                // 3. BUAT DATA
                const baData = {
                    id: 'BA-' + Date.now() + '-' + currentUser.id.substring(0, 4),
                    noBA: noBA,
                    tanggal: tanggalLumajang,
                    noInet: noInet,
                    namaPelanggan: namaPelanggan,
                    namaTeknisi: currentUser.name,
                    teknisiId: currentUser.id,
                    userEmail: currentUser.email,
                    status: 'Draft',
                    tanggalDibuat: new Date().toISOString(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 4. SIMPAN
                await firestore.collection('ba_documents').doc(baData.id).set(baData);
                
                alert(`BA berhasil disimpan!\nNo BA: ${noBA}`);
                
            } catch (error) {
                // 5. KALAU GAGAL, KURANGI COUNTER
                decrementBACounter();
                
                alert('Gagal menyimpan BA: ' + error.message);
            }
        }

        async function loadUserMitraFromFirebase() {
            if (!currentUser || !firestore) return;
            
            try {
                // Ambil data user dari Firestore untuk dapat mitra
                const userDoc = await firestore.collection('users').doc(currentUser.id).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // UPDATE CURRENT USER
                    currentUser.mitra = userData.mitra || '';
                    
                    // AUTO-FILL DI FORM
                    if (currentUser.mitra) {
                        document.querySelector('input[name="nama_mitra"]').value = currentUser.mitra;
                    }
                }
            } catch (error) {
                console.error('Error loading user mitra:', error);
            }
        }

        // === FUNGSI LOAD BA SAYA ===
        async function loadBASaya() {
            if (!currentUser || !firestore) return;
            
            try {
                const baSnapshot = await firestore.collection('ba_documents')
                    .where('userEmail', '==', currentUser.email)
                    .orderBy('tanggalDibuat', 'desc')
                    .limit(20)
                    .get();
                
                const tbody = document.getElementById('myBATable');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (baSnapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #666; padding: 30px;">
                                <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                Belum ada BA yang Anda buat
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                baSnapshot.forEach((doc) => {
                    const ba = doc.data();
                    const statusClass = ba.status === 'Selesai' ? 'status-active' : 
                                     ba.status === 'Draft' ? 'status-inactive' : '';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${ba.noBA || doc.id}</td>
                            <td>${ba.tanggal || '-'}</td>
                            <td>${ba.namaPelanggan || '-'}</td>
                            <td>${ba.noInet || '-'}</td>
                            <td>${ba.sto || '-'}</td>
                            <td class="${statusClass}">${ba.status || 'Draft'}</td>
                            <td>
                                <button class="btn-action btn-edit" onclick="viewBASaya('${doc.id}')" title="Lihat">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-toggle" onclick="downloadBASaya('${doc.id}')" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteBASaya('${doc.id}')" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
            } catch (error) {
                console.error('Error loading BA:', error);
                const tbody = document.getElementById('myBATable');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #ff4757; padding: 30px;">
                                <i class="fas fa-exclamation-triangle"></i> Error loading data
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function refreshBASaya() {
            console.log('Merefresh list BA...');
            loadBASaya();
        }

        function filterBASaya() {
            const searchTerm = document.getElementById('searchNoInetSaya').value.toLowerCase();
            const rows = document.querySelectorAll('#myBATable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function exportBASaya() {
            alert('Data BA berhasil diexport ke Excel!');
        }

        async function viewBASaya(id) {
            try {
                const baDoc = await firestore.collection('ba_documents').doc(id).get();
                if (baDoc.exists) {
                    const baData = baDoc.data();
                    alert(`Detail BA:\nNo: ${baData.noBA}\nPelanggan: ${baData.namaPelanggan}\nStatus: ${baData.status}`);
                }
            } catch (error) {
                console.error('Error viewing BA:', error);
            }
        }

        function downloadBASaya(id) {
            alert('Download BA: ' + id);
        }

        async function deleteBASaya(id) {
            if (confirm('Apakah Anda yakin ingin menghapus BA ini?')) {
                try {
                    await firestore.collection('ba_documents').doc(id).delete();
                    alert('BA berhasil dihapus!');
                    loadBASaya();
                } catch (error) {
                    console.error('Error deleting BA:', error);
                    alert('Gagal menghapus BA');
                }
            }
        }

        function getBACounter() {
            const now = new Date();
            const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            // Ambil counter bulan ini
            const counterKey = `baCounter_${yearMonth}`;
            let counter = localStorage.getItem(counterKey) || 0;
            counter = parseInt(counter);
            
            return { counter, counterKey };
        }

        function incrementBACounter() {
            const { counter, counterKey } = getBACounter();
            const newCounter = counter + 1;
            localStorage.setItem(counterKey, newCounter);
            return newCounter;
        }

        function decrementBACounter() {
            const { counter, counterKey } = getBACounter();
            const newCounter = Math.max(0, counter - 1);
            localStorage.setItem(counterKey, newCounter);
            return newCounter;
        }

        function resetBACounter() {
            if (confirm('Reset nomor BA ke 0?')) {
                localStorage.setItem('baCounter', 0);
                alert('Counter BA direset ke 0');
            }
        }

        // === ORIGINAL BA FORM FUNCTIONS ===
        let pelangganSigned = false;

        function saveSignature(type) {
            if (type === 'petugas' && !pelangganSigned) {
                alert('Pelanggan harus menyimpan tanda tangan terlebih dahulu!');
                return;
            }
            
            if (type === 'pelanggan') {
                pelangganSigned = true;
            }
            
            alert(`Tanda tangan ${type} berhasil disimpan!`);
        }

        function changePageSize(size) {
            const container = document.getElementById('page-container');
            const sizeClass = size === 'A4 landscape' ? 'landscape' : size.toLowerCase().replace(' ', '-');
            
            container.className = 'container-' + sizeClass;
            
            document.querySelectorAll('.page-size-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Script tanda tangan
        function setupSignatureCanvas() {
            const canvases = {
                'pelanggan': document.getElementById('signature-pelanggan'),
                'petugas': document.getElementById('signature-petugas')
            };

            Object.keys(canvases).forEach(key => {
                const canvas = canvases[key];
                const ctx = canvas.getContext('2d');
                let isDrawing = false;

                // Prevent touch scroll when signing
                canvas.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    startDrawing(e);
                }, { passive: false });
                
                canvas.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                    draw(e);
                }, { passive: false });
                
                canvas.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    stopDrawing();
                }, { passive: false });

                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);

                function startDrawing(e) {
                    isDrawing = true;
                    draw(e);
                }

                function draw(e) {
                    if (!isDrawing) return;
                    
                    const rect = canvas.getBoundingClientRect();
                    let x, y;
                    
                    if (e.type.includes('touch')) {
                        x = e.touches[0].clientX - rect.left;
                        y = e.touches[0].clientY - rect.top;
                    } else {
                        x = e.clientX - rect.left;
                        y = e.clientY - rect.top;
                    }

                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.strokeStyle = '#000';

                    ctx.lineTo(x, y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                }

                function stopDrawing() {
                    isDrawing = false;
                    ctx.beginPath();
                }
            });
        }

        function clearSignature(type) {
            const canvas = document.getElementById(`signature-${type}`);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (type === 'pelanggan') {
                pelangganSigned = false;
            }
        }

        // === FUNGSI UPLOAD GAMBAR ===
function uploadImage(posisi, input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const imgId = posisi === 'kiri' ? 'logoKiri' : 'logoKanan';
            const placeholderId = posisi === 'kiri' ? 'placeholderKiri' : 'placeholderKanan';
            const img = document.getElementById(imgId);
            const placeholder = document.getElementById(placeholderId);
            
            img.src = e.target.result;
            img.style.display = 'block';
            placeholder.style.display = 'none';
            
            // Add overlay change button on image
            img.parentElement.innerHTML += `
                <div id="overlay${posisi}" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                           background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; 
                           opacity: 0; transition: opacity 0.3s ease; cursor: pointer;"
                     onmouseover="this.style.opacity='1'"
                     onmouseout="this.style.opacity='0'"
                     onclick="document.getElementById('upload${posisi}').click()">
                    <div style="color: white; text-align: center;">
                        <i class="fas fa-camera" style="font-size: 16px; margin-bottom: 2px; display: block;"></i>
                        <div style="font-size: 8px;">Ganti Logo</div>
                    </div>
                </div>
            `;
            
            // Simpan ke localStorage
            localStorage.setItem('logo_' + posisi, e.target.result);
        };
        
        reader.readAsDataURL(file);
    }
}

// === LOAD GAMBAR DARI LOCAL STORAGE ===
function loadSavedImages() {
    const logoKiri = localStorage.getItem('logo_kiri');
    const logoKanan = localStorage.getItem('logo_kanan');
    
    if (logoKiri) {
        const imgKiri = document.getElementById('logoKiri');
        const placeholderKiri = document.getElementById('placeholderKiri');
        imgKiri.src = logoKiri;
        imgKiri.style.display = 'block';
        placeholderKiri.style.display = 'none';
        
        // Add overlay for existing image
        imgKiri.parentElement.innerHTML += `
            <div id="overlaykiri" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                       background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; 
                       opacity: 0; transition: opacity 0.3s ease; cursor: pointer;"
                 onmouseover="this.style.opacity='1'"
                 onmouseout="this.style.opacity='0'"
                 onclick="document.getElementById('uploadKiri').click()">
                <div style="color: white; text-align: center;">
                    <i class="fas fa-camera" style="font-size: 16px; margin-bottom: 2px; display: block;"></i>
                    <div style="font-size: 8px;">Ganti Logo</div>
                </div>
            </div>
        `;
    }
    
    if (logoKanan) {
        const imgKanan = document.getElementById('logoKanan');
        const placeholderKanan = document.getElementById('placeholderKanan');
        imgKanan.src = logoKanan;
        imgKanan.style.display = 'block';
        placeholderKanan.style.display = 'none';
        
        // Add overlay for existing image
        imgKanan.parentElement.innerHTML += `
            <div id="overlaykanan" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                       background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; 
                       opacity: 0; transition: opacity 0.3s ease; cursor: pointer;"
                 onmouseover="this.style.opacity='1'"
                 onmouseout="this.style.opacity='0'"
                 onclick="document.getElementById('uploadKanan').click()">
                <div style="color: white; text-align: center;">
                    <i class="fas fa-camera" style="font-size: 16px; margin-bottom: 2px; display: block;"></i>
                    <div style="font-size: 8px;">Ganti Logo</div>
                </div>
            </div>
        `;
    }
}

// === RESET GAMBAR ===
function resetImages() {
    if (confirm('Reset semua logo ke default?')) {
        localStorage.removeItem('logo_kiri');
        localStorage.removeItem('logo_kanan');
        
        // Reset kiri
        const imgKiri = document.getElementById('logoKiri');
        const placeholderKiri = document.getElementById('placeholderKiri');
        imgKiri.style.display = 'none';
        imgKiri.src = '';
        placeholderKiri.style.display = 'block';
        
        // Reset kanan
        const imgKanan = document.getElementById('logoKanan');
        const placeholderKanan = document.getElementById('placeholderKanan');
        imgKanan.style.display = 'none';
        imgKanan.src = '';
        placeholderKanan.style.display = 'block';
        
        // Remove overlays
        const overlayKiri = document.getElementById('overlaykiri');
        const overlayKanan = document.getElementById('overlaykanan');
        if (overlayKiri) overlayKiri.remove();
        if (overlayKanan) overlayKanan.remove();
    }
}

// === TOMBOL RESET ===
function addResetButton() {
    const controls = document.querySelector('.page-size-controls');
    if (controls && !document.getElementById('resetImagesBtn')) {
        const resetBtn = document.createElement('button');
        resetBtn.id = 'resetImagesBtn';
        resetBtn.className = 'page-size-btn';
        resetBtn.innerHTML = '<i class="fas fa-redo"></i> Reset Logo';
        resetBtn.onclick = resetImages;
        resetBtn.style.marginTop = '10px';
        controls.appendChild(resetBtn);
    }
}

// === LOAD GAMBAR DARI LOCAL STORAGE ===
function loadSavedImages() {
    const logoKiri = localStorage.getItem('logo_kiri');
    const logoKanan = localStorage.getItem('logo_kanan');
    
    if (logoKiri) {
        const imgKiri = document.getElementById('logoKiri');
        const btnKiri = imgKiri.nextElementSibling;
        imgKiri.src = logoKiri;
        imgKiri.style.display = 'block';
        btnKiri.style.display = 'none';
    }
    
    if (logoKanan) {
        const imgKanan = document.getElementById('logoKanan');
        const btnKanan = imgKanan.nextElementSibling;
        imgKanan.src = logoKanan;
        imgKanan.style.display = 'block';
        btnKanan.style.display = 'none';
    }
}

// === RESET GAMBAR ===
function resetImages() {
    if (confirm('Reset semua logo ke default?')) {
        localStorage.removeItem('logo_kiri');
        localStorage.removeItem('logo_kanan');
        
        const imgKiri = document.getElementById('logoKiri');
        const btnKiri = imgKiri.nextElementSibling;
        imgKiri.style.display = 'none';
        imgKiri.src = '';
        btnKiri.style.display = 'block';
        
        const imgKanan = document.getElementById('logoKanan');
        const btnKanan = imgKanan.nextElementSibling;
        imgKanan.style.display = 'none';
        imgKanan.src = '';
        btnKanan.style.display = 'block';
    }
}

// === TOMBOL RESET ===
function addResetButton() {
    const controls = document.querySelector('.page-size-controls');
    if (controls && !document.getElementById('resetImagesBtn')) {
        const resetBtn = document.createElement('button');
        resetBtn.id = 'resetImagesBtn';
        resetBtn.className = 'page-size-btn';
        resetBtn.innerHTML = '<i class="fas fa-redo"></i> Reset Logo';
        resetBtn.onclick = resetImages;
        resetBtn.style.marginTop = '10px';
        controls.appendChild(resetBtn);
    }
}



        // === AUTO CLOSE SIDEBAR ===
        document.addEventListener('DOMContentLoaded', function() {
            // Tutup sidebar saat klik menu
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        document.querySelector('.sidebar').classList.remove('open');
                    }
                });
            });
            
            // Tutup sidebar saat klik di luar
            document.addEventListener('click', function(event) {
                const sidebar = document.querySelector('.sidebar');
                const hamburger = document.querySelector('.hamburger-btn');
                
                if (window.innerWidth <= 768 && 
                    sidebar.classList.contains('open') &&
                    !sidebar.contains(event.target) && 
                    !hamburger.contains(event.target)) {
                    sidebar.classList.remove('open');
                }
            });
        });



        // === INITIALIZE ===
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Memulai inisialisasi...');
            
            // Initialize Firebase
            const firebaseInitialized = await initializeFirebase();
            
            if (firebaseInitialized) {
                // Set today's date for reports filter
                const today = new Date().toISOString().split('T')[0];
                const startDate = document.getElementById('startDate');
                const endDate = document.getElementById('endDate');
                
                if (startDate) startDate.value = today;
                if (endDate) endDate.value = today;
                
                // Load initial data
                loadDashboardData();
                loadMasterData();
                loadReports();
            }
            
            // Add back button to BA form
            const pageContainer = document.getElementById('page-container');
            if (pageContainer) {
                const backButton = document.createElement('button');
                backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Kembali ke Dashboard';
                backButton.style.cssText = `
                    position: fixed;
                    top: 10px;
                    left: 10px;
                    z-index: 1001;
                    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 12px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                `;
                backButton.onclick = closeBAForm;
                document.getElementById('baFormPage').insertBefore(backButton, pageContainer);
            }
        });
        
        // Add keyboard shortcut for BA form
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('baFormPage').style.display === 'block') {
                closeBAForm();
            }
        });

        function closeBAForm() {
            document.getElementById('baFormPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';
        }
    </script>
</body>
</html>


